---
title: "intro"
output: bookdown::html_document2
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```

```{r setup}
library(here)
source(here("R", "misc.R"))
source_dir(here("R"))

theme_set(theme_bw())
```

# Load data

```{r}
tar_load(timeseries)
```


# Get some information 

```{r}
summary(timeseries)
```

- I want histograms et summary of quantitative variables 

```{r}
mask_num_var <- map_lgl(timeseries, is.numeric)

lg_timeseries_num <- timeseries[, mask_num_var] %>%
  pivot_longer(cols = everything(),
    names_to = "variable",
    values_to = "values")
```

```{r hist_num}
lg_timeseries_num %>%
  ggplot(aes(x = values)) +
  geom_histogram() +
  facet_wrap(vars(variable), scales = "free")
```

```{r}
map2_dfr(
  timeseries[, mask_num_var], c(4, 2, 3, 3, 3, 8, 3, 4, 2, 2),
  ~summary_distribution(.x, na.rm = TRUE) %>% formatC(., digits = .y),
  .id = "variable") %>%
kable(., caption = "Descriptive statistics of Global timeseries", label = "d-num")
```

# Site characteristics

- Site are described by siteid  
- Gathering info such as protocol, year range, location (gps, region),

```{r}
var_site <- c("species", "date", "year", "month", "quarter", "protocol",
  "protocol_detail", "sampledlength_m", "speciesstatus", "unitabundance",
  "unitbiomass", "country", "abundance", "biomass", "ecoregion", "region",
  "latitude", "longitude", "province", "waterbody")

var_localisation <- get_var_localisation()

var_protocol <- get_var_protocol()
```


```{r}
get_unique_values_c <- compiler::cmpfun(get_unique_values)
```

```{r}
x <- rep(list(c(runif(1e3), rep(NA, 1000))), 100)
bench::mark(
  map(x, get_unique_values),
  map(x, get_unique_values_c)
)[c("expression", "min", "median", "itr/sec", "n_gc")]
```


```{r}
site_desc_loc <- timeseries %>%
  group_by(siteid) %>%
  summarise_at(.vars = var_localisation, .funs = ~get_unique_values_c(x = .x, na.omit = FALSE)) %>%
  ungroup()
```


- Check that location are unique for all site 

```{r}
map(site_desc_loc, ~ tibble(
    no_unique = .x[.x %in% c("no_unique")] %>% length,
    na = .x[.x %in% NA] %>% length)) %>%
  enframe(., name = "variable", value = "count") %>%
  unnest(cols = c(count)) %>%
  kable(., caption = "Nb sites which have NAs or no unique values")
```

- Some sites have no or several provinces, region and waterbody, looks
  manageable

```{r}
site_desc_loc %>%
  filter(waterbody == "no_unique")

timeseries %>%
  filter(siteid == filter(site_desc_loc, waterbody == "no_unique")$siteid[1:6]) %>%
  group_by(siteid) %>%
  summarise(unique(waterbody))
```

- Well, there are some problems with the waterbody name but I do not think that it is
  really important

```{r}
usethis::use_data(site_desc_loc, overwrite = TRUE)
```

- I will described:
  - Quantitative: 
    - [x] Total species number, total, median, mean, sd, min, max 
    - [x] year: min, max, median, range, sd, cover,
    - [x] month: min, max, median, mean, sd 
    - [x] sampledlength_m:  min, max, median, mean, sd
  - Qualitative:
    - [x] protocol: unique
    - [x] protocol_detail: unique
    - [x] speciesstatus: unique
    - [x] unitabundance: unique
    - [x] unitbiomass: unique

## Species number and species traits 

```{r}
## Species number
species_number_op <- timeseries %>%
  group_by(siteid, op_id) %>%
  summarise(species_nb = length(unique(species)), .groups = "drop")
usethis::use_data(species_number_op, overwrite = TRUE)

species_total_site <- timeseries %>%
  group_by(siteid) %>%
  summarise(species_tot_nb = length(unique(species)), .groups = "drop")

species_number_site <- species_number_op %>%
  group_by(siteid) %>%
  summarise(enframe(summary_distribution(x = species_nb)), .groups = "drop") %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  left_join(species_total_site, by = "siteid")
usethis::use_data(species_number_site, overwrite = TRUE)


## Species traits
species_status <- timeseries %>%
  group_by(species) %>%
  summarise(status = get_unique_values_c(speciesstatus))
usethis::use_data(species_status, overwrite = TRUE)
```

## Fish operation


```{r}
# Fish operation description


## Used Protocol
quali_protocol <- timeseries %>%
  group_by(siteid, op_id) %>%
  summarise_at(vars(all_of(var_protocol)),
    get_unique_values_c, na.omit = FALSE) %>%
  ungroup()

#unitbiomass is full of na bc often
#biomass is not reported

# Check if there are only single values by operation:
check_quali <- map_lgl(quali_protocol, ~all(.x != "no_unique", na.rm = TRUE))

```

- Make sure that each operation is described by a unique protocol, sampling
  effort, measurement unit, date: `r all(check_quali)`
  - This is not the case for `r names(check_quali)[!check_quali]`, let's check 

```{r}
quali_protocol %>%
  filter(unitbiomass == "no_unique")

timeseries %>%
  filter(op_id == filter(quali_protocol, unitbiomass ==
      "no_unique")$op_id[2]) %>%
select(species, abundance, biomass, unitbiomass)

timeseries %>%
  filter(is.na(unitbiomass), !is.na(biomass))

# Check if there are biomass measurements without biomass unit:
all((!is.na(timeseries$biomass) & is.na(timeseries$unitbiomass)) == FALSE)
# Good

# Check if there are biomass unit without biomass measurement:
all((!is.na(timeseries$unitbiomass) & is.na(timeseries$biomass)) == FALSE)
# Yes, but not important
```

- So, when biomass unit has not been reported, it means that biomass has not
  been recorded. For site and operation description, we keep the unique non-na
  values 

```{r}
biomass_unit <- timeseries %>%
  group_by(op_id) %>%
  summarise(unitbiomass = get_unique_values_c(x = unitbiomass, na.omit = TRUE))

# check
all(!biomass_unit$unitbiomass %in% c("no_unique", NA))
# Good
```

- Merge data 

```{r}
op_protocol <- quali_protocol %>%
  select(-unitbiomass) %>%
  left_join(biomass_unit, by = c("op_id"))
usethis::use_data(op_protocol, overwrite = TRUE)
```

```{r}
site_protocol_quanti <- op_protocol %>%
  group_by(siteid) %>%
  select_if(is.numeric) %>%
  pivot_longer(!siteid, names_to = "variable", values_to = "value") %>%
  group_by(siteid, variable) %>%
  summarise(enframe(summary_distribution(value, na.rm = TRUE)), .groups = "drop") %>%
  pivot_wider(names_from = "name", values_from = "value")

site_protocol_quali <- op_protocol %>%
  group_by(siteid) %>%
  summarise_at(vars(all_of(c("protocol", "protocol_detail", "unitbiomass", "unitabundance"))),
    get_unique_values_c, na.omit = FALSE) %>%
  ungroup()
unique(site_protocol_quali$protocol)
unique(site_protocol_quali$protocol_detail)

op_protocol %>%
  filter(siteid == filter(site_protocol_quali, protocol ==
      "no_unique")$siteid[14])
```
- Ok, there are 
  `r site_protocol_quali[site_protocol_quali$protocol == "no_unique",] %>% nrow`
  sites that do not have an unique protocol in a site

- There are 
  `r site_protocol_quali[site_protocol_quali$unitabundance == "no_unique",] %>% nrow`
  sites that do not have an unique unit of abundance measurement in a site

```{r}

usethis::use_data(site_protocol_quanti, overwrite = TRUE)
usethis::use_data(site_protocol_quali, overwrite = TRUE)
```


## Measurements 

- I save a data with only `op_id`, `species`, `abundance` and `biomass`

```{r}
measurement <- timeseries %>%
  select(op_id, species, abundance, biomass)
usethis::use_data(measurement, overwrite = TRUE)
```

# Map 

```{r}
data(site_desc_loc)
data(species_number_site)
data(site_protocol_quali)
data(site_protocol_quanti)
```
```{r}
site_protocol_loc <- site_desc_loc %>%
  select(siteid, latitude, longitude, ecoregion) %>%
  left_join(species_number_site %>% select(siteid, species_tot_nb), by = "siteid") %>%
  left_join(site_protocol_quali %>% select(siteid, protocol, protocol_detail, unitabundance), by = "siteid")
```

```{r}
site_protocol_loc_sf <- st_as_sf(site_protocol_loc, coords = c("longitude", "latitude"),
  crs = 4326)
```

- See ecoregion:
  (idea: do a panel with the 6 ecoregion to better see species number)

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = site_protocol_loc_sf, aes(size =
        species_tot_nb), shape = 1) +
    ggtitle("Total number of species by site")

```

- We have plenty of site that have a constant protocol and unit of abundance. 

```{r}
#https://www.graphpad.com/support/faq/graph-tip-dont-use-a-log-scale-on-a-bar-graph/
site_protocol_loc %>%
  ggplot(aes(x = protocol, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Protocol", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_protocol_loc %>%
  ggplot(aes(x = unitabundance, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Abundance unit", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

- Let's see them on a map

```{r}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = site_protocol_loc_sf, aes(color = protocol)) +
    xlab("Longitude") + ylab("Latitude") +
    ggtitle("Protocol")
```

```{r}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = site_protocol_loc_sf, aes(color = unitabundance)) +
    ggtitle("Unit of abundance")
```

```{r}
site_protocol_quanti %>%
  filter(variable == "year") %>%
  ggplot(aes(x = max -min )) +
  geom_histogram() +
  labs(x = "Year span (years)", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
ti <- site_protocol_quanti %>%
  filter(variable == "year") %>%
  left_join(site_protocol_loc, by = "siteid") %>%
  mutate(
    span = max - min,
    cat_span = cut(span, c(0, 10, 20, 30, 40, 70), right = TRUE,
#      labels=c("<=10","10<x<=20","20<x<=30","30<x<=40", "40<x<=70"),
      include.lowest=TRUE
    ),
    cat_completness = cut(n / span, c(0, .1, .25, .5, .75, 1), right = TRUE,
#      labels=c("<=10","10<x<=20","20<x<=30","30<x<=40", "40<x<=70"),
      include.lowest=TRUE
    ),
  )
```
- Completeness

```{r}
ti %>%
  ggplot(aes(x = cat_completness, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Completness (nb sampling years / year span)", y = "Number of sites")
```

```{r}
ti %>%
  ggplot(aes(x = cat_span, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Year span", y = "Number of sites")
```

- Year baseline:

```{r}
site_protocol_quanti %>%
  filter(variable == "year") %>%
  ggplot(aes(x = min )) +
  geom_histogram() +
  labs(x = "First year of monitoring", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

# Abundance data

```{r}
abun_check <- measurement %>%
  group_by(op_id) %>%
  summarise(
    enframe(
      c(
        summary_distribution(abundance, na.rm = TRUE),
        sum = sum(abundance, na.rm = TRUE)
        )
      ),
    .groups = "drop"
  )
abun_check <- abun_check %>%
  ungroup() %>%
  left_join(op_protocol %>% select(op_id, unitabundance), by = "op_id") %>%
  pivot_wider(names_from = "name", values_from = "value")
```
```{r}
abun_check %>%
  ggplot(aes(x = sum)) +
  geom_histogram() +
  labs(y = "Count", x = "Total abundance", title = "Total abundance by sampling
    events") +
  facet_wrap(vars(unitabundance), scales = "free_x")
```

```{r}
total_abundance_distribution <- abun_check %>%
  group_by(unitabundance) %>%
  summarise(enframe(summary_distribution(sum)), .groups = "drop") %>%
  pivot_wider(names_from = "name", values_from = "value") 

total_abundance_distribution %>%
  kable(., label = "tot-abun-dist", caption = "Distribution of total abundance
    by sampling event by unit of abundance")
```






