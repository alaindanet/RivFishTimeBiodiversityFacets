---
title: "Community structure"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
```
```{r}
library(vegan)
```

```{r load-targets, include=FALSE}
tar_load(filtered_dataset)
```

# Diversity

## Hill numbers

### Test on the BCI dataset

```{r}
data(BCI)
H <- diversity(BCI)
simp <- diversity(BCI, "simpson")
invsimp <- diversity(BCI, "inv")
bci_div <- tibble(
  species_nb = specnumber(BCI),
  shannon = H,
  simp = simp,
  inv_simp = invsimp,
  evenness = H / log(species_nb)
)
```

```{r}
kable(bci_div) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "400px")
```


### Test on my dataset

```{r}
tar_load(c(hillnb, chao_hillnb))

colnames(chao_hillnb) <- str_replace(colnames(chao_hillnb), "chao_", "")
chao_hillnb <- chao_hillnb %>%
  mutate(type = "chao") %>%
  select(op_id, richness:last_col())

chao_hillnb %>%
  filter(is.na(evenness)) %>%
  mutate(evenness2 = shannon / log(richness))

hillnb <- hillnb %>%
  rename(richness = species_nb) %>%
  mutate(type = "classic") %>%
  select(op_id, type, richness, shannon, simpson, evenness)

div <- rbind(chao_hillnb, hillnb)
```

```{r}
div_summary <- div %>%
  group_by(type) %>%
  summarise(
    across(
      where(is.double),
      ~list(
        enframe(
          summary_distribution(x = .x)
        )
      )
    )
    ) %>%
  pivot_longer(cols = c(richness:evenness), names_to = "facet", values_to =
    "biodiversity") %>%
  unnest(cols = "biodiversity") %>%
  pivot_wider(names_from = "name", values_from = "value")
```

```{r}
div_summary %>%
  kable(.,
    caption = "Summary of diversity indices distribution",
    label = "tab:div-comp"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

- Chao indices leads to higher values of evenness, shannon and simpson, in
  average and also to more spread values 

```{r}
div %>%
  pivot_longer(cols = c(richness:evenness), names_to = "facet", values_to =
    "diversity") %>%
ggplot(aes(y = diversity, x = type)) +
geom_violin() +
facet_grid(rows = vars(facet), scales = "free_y")
```

- Look at infinit values (now fixed, it was for richness == 1)

- Computed on chao estimations of shannon and richness, most values pielou evenness are
  above one:

```{r}
chao_hillnb %>%
  filter(evenness > 1) %>%
  slice(1:30) %>%
  kable %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "400px")
```

### Relationships between Chao and classic number

- Species richness: in Chao we see interpolation and extrapolation to put everyone on
  the level (exemple: community with 70 species had 55 species equivalent
  according to Chao).

```{r}
div <- div %>%
  arrange(op_id, type)
stopifnot(all(div[div$type == "chao", ]$op_id == div[div$type == "classic", ]$op_id))
```

```{r}
old_par <- par()
png(here("doc", "fig", "index_chao_classic_comparison.png"))
par(mfrow = c(2, 2))
for (i in c("richness", "shannon", "simpson", "evenness")) {
  plot(
    div[div$type == "chao", ][[i]] ~ div[div$type == "classic", ][[i]],
    ylab = "Chao",
    xlab = "Classic"
  )
  abline(1, 1)
  title(i)
}
dev.off()
for (i in c("richness", "shannon", "simpson", "evenness")) {
  plot(
    div[div$type == "chao", ][[i]] ~ div[div$type == "classic", ][[i]],
    ylab = "Chao",
    xlab = "Classic"
  )
  abline(1, 1)
  title(i)
}
par(old_par)
```

## Chao

### Test 

```{r, eval=FALSE}
test <- filtered_dataset$measurement %>%
  filter(op_id %in% unique(op_id)[1:2])
ti <- get_chao_hillnb(
  x = test,
  coverage = .985,
  confidence_int = NULL)
```

# Turnover

## Data

```{r}
tar_load(c(
    rigal_trends,
    var_temporal_trends,
    turnover_types_chr,
    vegdist_index
  )
)
names(rigal_trends) <- var_temporal_trends
trend_vegdist <- rigal_trends[
  names(rigal_trends) %in% c(turnover_types_chr, vegdist_index, "hillebrand")
  ]
trend_vegdist_slope <- map_dfr(trend_vegdist,
  ~.x[, c("siteid", "linear_slope")], .id = "response")
```

```{r}
p_trend_vegdist_slope <- trend_vegdist_slope %>%
  ggplot(aes(x = linear_slope)) +
  geom_histogram() +
  facet_wrap(~response) +
  labs(y = "Count", x = "Slope of similarity vs year")
p_trend_vegdist_slope
save_plot(
  here("doc", "fig", "slope_hist_vegdist.png"),
  p_trend_vegdist_slope
)
```

```{r}
trend_vegdist_slope_summary <-
  trend_vegdist_slope %>%
  group_by(response) %>%
  summarise(
    summary_dist = list(
      enframe(summary_distribution(linear_slope))
    )
    ) %>%
  unnest(cols = summary_dist) %>%
  pivot_wider(names_from = "name", values_from = "value")

trend_vegdist_slope_summary %>%
  kable %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


## Null model (Unified Neutral theory of biodiversity)

- See `untb::untb()` and [neutral_model.R](https://github.com/alaindanet/RivFishTimeBiodiversityFacets/blob/main/R/neutral_model.R)

```{r}
library(untb)

data(butterflies)
test <- untb(start = butterflies, prob=0, gens=100)

rich_quant <- summary_distribution(filtered_dataset$abun_rich$species_nb)
count_site <- filtered_dataset$site_quali %>%
  filter(unitabundance == "Count") %>%
  .[["siteid"]]

tot_abun_quant <- summary_distribution(
  filtered_dataset$abun_rich %>%
    filter(siteid %in% count_site) %>%
    .$total_abundance
)

null_mod <- get_untb_abun_mat(
  start = sample(1:3, size = 64, replace = TRUE),
  D = 0.1 * 64,
  prob = 0.01,
  gens = 1300
)
sparse <- Matrix::Matrix(null_mod$abun_mat, sparse=TRUE)
object.size(sparse) * 10^-6
object.size(null_mod$abun_mat) * 10^-6

jaccard_test <-  1 - as.matrix(
  vegdist(
    null_mod$abun_mat[301:nrow(null_mod$abun_mat), ],
    method = "jaccard"
  )
)

lm(as.matrix(jaccard_test)[1,] ~ as.integer(names(as.matrix(jaccard_test)[1,])))
```

```{r, eval=TRUE}
tar_load(c(neutral_turnover))
```
```{r}
neutral_turnover <- neutral_turnover %>%
  rowwise(rowid) %>%
  mutate(
    model = list(lm(jaccard ~ year, jaccard)),
    coef = list(broom::tidy(model))
  ) %>%
  ungroup()
```

```{r}
neutral_turnover_trends <- neutral_turnover %>%
  select(-jaccard, -model) %>%
  unnest(coef) %>%
  filter(term == "year")
```


- Neutral community dynamics generally produce turnover through time:
  (jaccard mean slope: `r round(mean(neutral_turnover_trends$estimate), 4)`)
- Immigration increases turnover through time (jaccard decrease):
  - when death rate is low
- Higher death rate increases also turnover except when immigration is high

```{r}
p <- neutral_turnover_trends %>%
  ggplot(aes(y = estimate, x = as.factor(richness), color = as.factor(abun))) +
  geom_boxplot() +
  facet_grid(
    rows = vars(death_rate), cols = vars(immigration),
    labeller = labeller(.cols = label_both, .rows = label_both)
    ) +
  labs(x = "Species Richness", y = "Slope Jaccard vs Year", color = "Abundance")+
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "Death rate", breaks = NULL, labels = NULL)) +
  theme(legend.position = "bottom")
p
```

- Empirical data are far more variable than neutral dynamics, but:
  - also negative in average
  - average close to neutral when immigration is strong and low death rate 
  - neutral trends computed over 250 years, data over 10s years
  - Data displays quite a lot of positive turnover


```{r}
p + geom_boxplot(
  data = trend_vegdist_slope %>%
    filter(response == "jaccard") %>%
    mutate(abun = as.factor(0)) %>%
    filter(
      linear_slope >= quantile(linear_slope, 0.05) &
      linear_slope <= quantile(linear_slope, 0.95)
    ),
  aes(y = linear_slope, x = abun)) +
labs(title = "Neutral model + empirical data", subtitle = "Abundance = 0, in red")
```

## Partition in nestedness and turnover 

### TEST

```{r}
library(betapart)
tar_load(com_mat_site)
ti <- com_mat_site$mat[[1]]
```

```{r}
core <- betapart.core(decostand(ti, method = "pa"))

data(bbsData)
bbs.t <- beta.temp(bbs1980, bbs2000, index.family="jac")
bbs.t
```

```{r}
x <- matrix(
  c(1, 0, 1, 1, 0, 1, 1, 0),
  ncol = 2,
  byrow = TRUE,
  dimnames = list(NULL, c("pika", "sala"))
)
x <- as.matrix(decostand(x, method = "pa"))

x[x == 1] <- rpois(n = sum(x == 1), lambda = 5)
x[x > 0] <- 1

compute_jaccard_decomp(x = x[1, ], y = x[2, ])
compute_jaccard_decomp(x = x[1, ], y = x[3, ])
compute_jaccard_decomp(x = x[1, ], y = x[1, ])
```

### DATA

```{r}
tar_load(c(baselga_c, analysis_dataset))
baselga_c

baselga_summary <-
  baselga_c %>%
  select(-year) %>%
  pivot_longer(cols = -siteid, names_to = "response", values_to = "beta") %>%
  group_by(response) %>%
  summarise(
    summary_dist = list(
      enframe(summary_distribution(beta))
    )
    ) %>%
  unnest(cols = summary_dist) %>%
  pivot_wider(names_from = "name", values_from = "value")

baselga_summary %>%
  kable %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
baselga_c %>%
  select(-year) %>%
  pivot_longer(cols = -siteid, names_to = "response", values_to = "beta") %>%
  ggplot(aes(x = beta)) +
  geom_histogram() +
  facet_grid(cols = vars(response)) +
  labs(x = "Beta-div values", main = "Baselga decomposition of dissimilarity in nestedness and turnover")
```



## Partition in abundance change and relative abundance change 

### TEST

```{r}
DD <- function(
  x,
  ref.t = 1,
  zero.rm = FALSE
  ) {

  lmb <- apply(x, 1, sum)
  D2 <- log(lmb / lmb[ref.t])

  x.p <- t(apply(x, 1, function(z) z / sum(z)))
  Pt <- x.p[ref.t,]

  if(zero.rm == FALSE) {
    D1 <- -t(apply(x.p, 1, function(z) ifelse(Pt==0, 0, log(Pt/z)))) %*% Pt
  }else{
    D1 <- -t(apply(x.p, 1, function(z)ifelse(Pt==0|z==0, 0, log(Pt/z)))) %*% Pt
  }

  D <- D1 + D2
  data.frame(D, D1, D2)
}

```

```{r}
DD(ti, zero.rm = TRUE)
```


# Metacommunity by basin 


- Basin with more than 10 sites and followed more than 10 years

```{r}
tar_load(com_mat_basin)
loc <- filtered_dataset$location %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

```{r, out.width="100%"}
loc_com_basin <- loc %>%
  filter(main_bas %in% unique(com_mat_basin$main_bas))

ggplot(data = ne_countries(returnclass = "sf")) +
    geom_sf() +
    geom_sf(data = loc_com_basin,
      aes(color = as.factor(main_bas)), shape = 1) +
    theme(legend.position = "none")
```

- Basin with 10 same sites followed more than 10 years: 

```{r}
tar_load(filtered_com_mat_basin)

filtered_com_mat_basin$mean_dissimilarity <- 
  map_dbl(filtered_com_mat_basin$mat, ~mean(vegdist(.x, method = "bray")))
```


```{r}
loc_com_basin <- loc %>%
  filter(main_bas %in% unique(filtered_com_mat_basin$main_bas))

ggplot(data = ne_countries(returnclass = "sf")) +
    geom_sf() +
    geom_sf(data = loc %>%
      filter(main_bas %in% unique(filtered_com_mat_basin$main_bas)),
      aes(color = as.factor(main_bas)), shape = 1) +
    theme(legend.position = "none")
```


```{r, eval=FALSE}
filtered_com_mat_basin %>%
  ggplot(aes(x = year, mean_dissimilarity)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~main_bas)
```



## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
