---
title: "Meeting report"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
bibliography: "bibliography.bib"
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(dotwhisker)
library(broom.mixed)
library(ade4)
library(factoextra)
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, modelling_data))


tar_load(pca_riv_str)
tar_load(var_analysis)
tar_load(c(mod_tmb, mod_tmb_comp, mod_tmb_comp_std))
tar_load(binded_gaussian_tmb)
var_to_keep <- c("jaccard_dis_scaled", "turnover_scaled", "nestedness_scaled",
  "hillebrand_dis_scaled", "appearance_scaled", "disappearance_scaled",
  "evenness_scaled", "chao_richness", "log_total_abundance", "total_abundance_tps")
gaussian_tmb <- binded_gaussian_tmb %>%
  filter(year_var == "log1_year_nb", intercept == 1, response %in% var_to_keep)
obj_mb(gaussian_tmb)
rm(binded_gaussian_tmb)
gc()

tar_load(random_effect_self_c)
tar_load(world_site_sf)
```

```{r map-setup, include=FALSE}
world <- world_site_sf$world
loc <- world_site_sf$site
```

# Abstract/summary (so far)

- Downstream gradient is related more dissimilarity through time  
- Cluster analysis reveals that there are only 4 scenarios of biodiversity
  trends, indicating a low dimensionality of biodiversity trends
- Cluster analysis seems reveal that biodiversity changes are
  heterogenous at lower scale that previously shown [@blowes_geography_2019;
  @klink_meta-analysis_2020]

# Introduction 

## Why do we want to assess community changes ?

- Global changes have affect a tremendous effect communities
- Understanding assembly and disassembly rules
- Give a more complex and complete picture of what is going on ?

## Documenting community changes

- Many papers report  temporal trends of local species richness and turnover
  - Abundance [@klink_meta-analysis_2020]
  - Species richness and or turnover: [@vellend_global_2013, @dornelas_assemblage_2014, @blowes_geography_2019]
  - They describe basically no trends in species richness but high turnover  
  - Species turnover vary a lot according to geography and taxa
    [@blowes_geography_2019]
  - Species turnover (as opposite of nestedness [@baselga_temporal_2013]) has
    been reported to be the major change, i.e. change in species identity, which
    is coherent with the absence of species richness trends  

## Research gap

- Biodiversity trends are all about geographical variation, i.e. few ecological drivers are involved

## Research questions 

### Drivers of temporal changes 

- What are the drivers of community changes ?
  - Climate change: more appearance and disappearance in the upper basin
  - More species turnover far from the source because of dispersal ability

```{r}
cap_turn <- paste0(
  "The hypothesis is that sites located at the middle of the stream network
  will experience the more composition change through time because of two
  opposites constraints. Climate change is expected to drive species upward in
  the stream network but an opposite constrain gathered into hydrological
  contrain, such as water flowand obstacles to migration will restrain the
  upward migration. The sum of those constrains is hypothesized to result in a
  quadratic relationship between jaccard turnover and distance from source.")
```


```{r, fig.cap=cap_turn}
knitr::include_graphics(here::here("doc/fig/turnover_hyp.png"))
```

### Within and basin scale 

- Temporal homogeneization at the basin scale?

```{r}
dis_cap <- paste0("If sites within basin becomes more dissimilar from their
  reference (first year of observation), we
  should observe at the same time an homogeneization of sites at the basin scale")
```

```{r, fig.cap=dis_cap}
ggplot(tibble(x = c(0, .1)), aes(x)) +
  stat_function(fun = function(x) x, geom = "line") +
  labs(
    x = "Average temporal dissimalitiry within basin",
    y = "Temporal similarity at the basin scale"
  )
```


- Product:
  - Map of temperature and distance to effect on turnover by basin ?

## Fish freshwater in streams 

- Streams are a good model to study turnover:  
  - They are spatially delimited at the basin level
  - Stream fishes are strongly constrained by hydrological constrains, which are
    highly variable at a small spatial scale, making possible to ecological
    drivers at multiple places, here the basin scale.

# Methods

## Data selection

- Unique protocol and unique unit of abundance by site
- One sampling by year and site
- In each site, samplings should be in the median (more or less one month and half, i.e. 1.5 month)
- 5 samplings by site, span 10 years 

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

```{r}
fig_sites <- paste0(
  "Australia absence because span is superior to 10 years of 100s of sites but number of samplings < 10.")
```

```{r, fig.cap=fig_sites}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
#    coord_sf(xlim = bb[c("xmin", "xmax")],
#      ylim = bb[c("ymin", "ymax")],
#      datum = 4326, expand = TRUE) +
    theme(legend.position = "bottom") +
    labs(title = paste0("Number of sites: ", nrow(loc)))
```

## Biodiversity

### Quantity

- Hill numbers 
  - $H^0$: Species richness 
  - $H^1$: Shannon
  - $H^2$: Simpson

We used also hill numbers with coverage-based correction proposed by
@chao_coverage-based_2014

- Evenness:
  - Pielou: $J = H^1 / log(S)$ 



### Betadiversity 

Betadiversity metrics compares the composition of two communities. In our case, we
compare the composition of each time step relatively to the baseline, i.e. the
first year of sampling. 

- Species exchange index: [@hillebrand_biodiversity_2018]
  - Presence-absence: $J = SER_r = \dfrac{S_{imm} + S_{lost}}{S_{tot}}$
  - Relative abundance: $SER_a = \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}$ 

  - $S_{imm}$, $S_{lost}$, $S_{tot}$: number of immigrant, lost and total species respectively
  - $i$: species $i$, $p$: relative abundance, $\prime$: second community
  - $J$: Jaccard index

Turnover metrics based on presence/absence can be decomposed in
appearance/disappearance and nestedness / turnover.

- appearance: $\dfrac{S_{imm}}{S_{tot}}$, disappearance: $\dfrac{S_{lost}}{S_{tot}}$

- Turnover: $J_t = \dfrac{2 * min(S_{lost}, S_{imm})}{S_{common} + (2 * min(S_{lost}, S_{imm})}$
- Nestedness: $SER_r - J_t$


# Environment

```{r}
var_pca <- dimnames(pca_riv_str$rotated$loadings)[[1]]
clean_var_pca <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% var_pca]
high_load_rc1 <- pca_riv_str$rotated$loadings[
pca_riv_str$rotated$loadings[, "RC1"] > .90,
  "RC1"] 
clean_high_load_rc1_var <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% names(high_load_rc1)]
```


- The environment was characterized by the stream structure and human footprint
  difference between 2009 and 1993
- The stream structure was characterized by a rotated PCA axis (fig
  \@ref(fig:p-rot-pca-riv-str)). The PCA included
  `r paste0(clean_var_pca, collapse = ", ")`, which are respectively 
  `r paste0(names(clean_var_pca), collapse = ", ")`. Then, the first axis
  included in the analysis is associated with the following variables:
  `r paste0(names(clean_high_load_rc1_var), collapse = ", ")`.

```{r}
fig_cap_pca <- "Rotated PCA on stream structure. The first axis is related to
the distance from the source, stralher order and discharge (m3/s). The second
axis is related to the altitude and slope degree of the site. Only the first
axis was included in the analysis"
```

```{r p-rot-pca-riv-str, fig.cap=fig_cap_pca}
p <- plot_rotated_pca(pca_riv_str)
p$rotated
```
```{r}
h_hft_cap <- "Distribution of difference between human footprint in 1993 and
2009."
```


```{r h-hft, fig.cap = h_hft_cap}
hist(analysis_dataset$hft_ix_c9309_diff)
s_hft_diff <- round(summary_distribution(analysis_dataset$hft_ix_c9309_diff, na.rm = T))
```
- The human footprint difference between 1993 and 2009 is biaised toward an
  decrease of human footprint (average difference (sd):
  `r s_hft_diff["mean"]` (`r s_hft_diff["sd"]`)), meaning that in average the
  human footprint index decreased in 16 years.

# Statistical analysis 

## Species composition change

In each site and at each sampling point, we computed the dissimilarity (Jaccard,
Appearance, Disappearance, Turnover & Nestedness) between the time step and the
reference time, i.e. the first year of sampling. Regarding the reference time
step, there are two different strategies. First is to include it, i.e. setting a
dissimilarity of 0 at each beginning of a time series [@blowes_geography_2019].
Another strategy is to exclude the first year from the analysis
[@dornelas_assemblage_2014]. The first option logically constrains the analysis
toward increasing dissimilarity as the second can capture recovery from
perturbation soon after the first samplings. I guess that the first option makes
more sense more it removes to sensibility to community changes happening just
after the references year.

However as the relationship between most dissimilarity indices and time is
highly non linear (like a Michaelis-Menten), we decided to relax the intercept.

## Model 

- Simple linear models by site: [@rigal_method_2020]
  - Fit a polynomial in each site and characterize linear slope
  - Pro: easy to implement
  - Cons: necessitates a lot of points to work

- Model all in one:
  - Pro:
    - Necessitates less data per site
    - Take in account variability in all sites 
  - Cons:
    - Complicated models that takes a long time to run.
    - Basically we try to model a lot more variables (biodiversity dimensions)
      than previous studies at this scale [@dornelas_assemblage_2014;
      @blowes_geography_2019; @klink_meta-analysis_2020]


### Turnover

Jaccard dissimilarity, nestedness, turnover, appearance, disappearance and
hillebrand were modelled in two ways, Beta and gaussian regression. Beta
regressions are more appropriate for distribution borned by [0,1] and are
linearized by a logit link. Logit links have the cons that coefficients are less
easy to interpret. So we run both gaussian and beta regressions and investigate
the relationship among coefficients of those type modelling types. Values of
turnover were slightly transformed such as values of one and zero fitted beta
regression requirements ($x' = \dfrac{x \times (N - 1) + 0.5}{N}$).

The model is defined like this: 

$$
B_i = \alpha + \beta_0Y_i + \beta_1R_i + \beta_2Y_iR_i + \beta_3H_i + \beta_4Y_iH_i + \epsilon
$$
where

\begin{align}
\\ \alpha&=\alpha_0 + u_{0i|j}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0k}
\\ \beta_{2}&=\beta_{2} + u_{2j}
\\ \beta_{4}&=\beta_{4} +u_{4j}
\end{align}

- where:
  - $\alpha$: intercept
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin
  - $k$: span period in a site 

- The model formula in:

```{r}
"biodiv_facet ~ 
1 + year * river_structure + year * human_footprint_diff +
(1 +  year | basin/site) +
(0 +  year | span) +
(0 +  year:human_footprint_diff | basin) +
(0 +  year:river_structure | basin)"
```

- `year`: number of year since the beginning of the monitoring (site scale) 
- `river_structure`: PCA from upstream to downstream (centered and scaled)
- `human_footprint_diff`: difference between 1993 and 2009 (centered and scaled)
- `basin`: Hydrographic basin
- `site`: site 
- `span`: Number of years between the end and the beginning of the monitoring in
  a given site

Our objective was to assess the temporal turnover and its ecological drivers. We
estimated the effects of the basin and of the site on the temporal trends (`1 +
year | basin/site`), the site effect being nested in the basin effect.
We also evaluated the effects of the span of monitoring on the temporal trends,
because it is generally expected that longer timeseries displays stronger
temporal trends. We also captured the effect of human pressure and river
structure on temporal trends will be different according to basin. As an example, 
we consider that the effects of river structure (related to
upstream/downstream gradient) on temporal trends will depend on basin because
they are highly different in their network structure and their sampling
locations along this network.

All the statistical models were computed in R with the `glmmTMB` package. In
order to facilitate the comparison of the effects, the reported slope
coefficients were standardised as $r_\delta = \beta \dfrac{\s_x}{\s_y}$, $\beta$
being the unstandardised slope, $s_x$ and $s_y$ respectively the standard
deviation of the explicative and response variable. 

### Estimation of fixed effects for each level of random effects

The fixed effect coefficients for each level of random effects were computed as
sum of the random effects and its corresponding fixed effects, known as BLUPs
(Best Linear Unbiased Predictions, `coef.merMod` in R). However, the associated 
standard errors and confidence intervals are not computable on BLUPs. As an
example, it means that while we are able to compute the temporal trends as each
site, those temporal trends have no associated errors.

```{r}
site_temporal_trends <- random_effect_self_c %>%
  filter(intercept == 1, year_var == "year_nb") %>%
  select(response, random_site) %>%
  unnest(random_site) %>%
  select(response, siteid, year_nb)
```

```{r}
site_temporal_trends %>%
  ggplot(aes(x = year_nb)) +
  geom_histogram() +
  facet_wrap(vars(response), scales = "free")
```

## Cluster analysis

```{r}
wide_site_tps <- site_temporal_trends  %>%
  pivot_wider(names_from = "response", values_from = "year_nb")
```

```{r}
site_tps_clust <- wide_site_tps %>%
  select(-siteid, -species_nb, -log_species_nb) %>%
  as.data.frame()
rownames(site_tps_clust) <- wide_site_tps$siteid
```
```{r}
kmeans_opt_nb_gr_sil_cap <- "Optimal number of clusters according to silhouette
criteria and kmeans clustering."
```
```{r cl-sil, fig.cap=kmeans_opt_nb_gr_sil_cap}
fviz_nbclust(scale(site_tps_clust), kmeans, method = "silhouette")
kclust_tps <- kmeans(scale(site_tps_clust), centers = 4, iter.max = 10, nstart = 25)
```
Site were clustered based on the temporal trends of biodiversity facets using
k-means method. Temporal trends were scaled before clustering. According to the
silhouette method, the optimal number of clusters was four (Fig.
\@ref(fig:cl-sil)). We used Hartigan and Wong partition algorithm with 25 random
starts and a maximum of 10 iterations. Clustering was computed with
`stats::kmeans` R function.

```{r}
# Composition of groups 
group_tps <- wide_site_tps %>%
  select(-species_nb, -log_species_nb) %>%
  left_join(enframe(kclust_tps$cluster, name = "siteid", value = "cluster"),
    by = "siteid"
  ) 

clust_var_summary <- group_tps %>% 
  pivot_longer(-c(cluster, siteid), names_to = "variable", values_to = "values") %>%
  group_by(cluster, variable) %>%
  summarise(mean = mean(values), se = sd(values) / sqrt(n()), .groups = "drop") %>%
  mutate(ci_low = mean - 1.96 * se, ci_high = mean + 1.96 * se)
```

We then analysed the composition of the groups by computing the average temporal
trends by cluster groups and their confidence intervals at 95% (CI width: $1.96
\sigma/\sqrt{N}$).

# Results

## Model

- Effect of models: 

```{r}
mod_slp_unstd_cap <- paste0("Estimated effects of the gaussian models.
  Coefficients are unstardardized. See the other plot for standized effects.")
```

```{r mod-slp-unstd, fig.cap=mod_slp_unstd_cap}
plot(mod_tmb_comp) +
  theme(legend.position = "bottom")
```

```{r}
mod_slp_std_cap <- paste0("Estimated fixed effects of the gaussian models.
  Coefficients are stardardized by the standard deviation of each variable
  (response and predictor). Cleaner way of standardize would be to refit the
  models with all the variables being scaled. Note that for hillebrand, the
  temporal trends is negative. That is because it is a similarity index, that is
  meaning that similarity is decreasing through time in average. Bars represent
  CI at 95% computed with Wald approximation.")
```


```{r mod-slp-std, fig.cap=mod_slp_std_cap}
mod_tmb_comp_std_df <- mod_tmb_comp_std %>%
  as_tibble() %>%
  select(Parameter, starts_with("CI_"), starts_with("Std_")) %>%
  pivot_longer(-Parameter, names_to = "names", values_to = "values") %>%
  separate(col = names, into  = c("type", "response"), sep = "\\.") %>%
  pivot_wider(names_from = "type", values_from = "values") %>%
  filter(Parameter != "(Intercept)") %>%
  filter(!response %in% c("species_nb", "log_species_nb"))
mod_tmb_comp_std_df %>%
  ggplot(
    aes(y = Parameter, x = Std_Coefficient, color = response, xmin = CI_low,
      xmax = CI_high)) +
  geom_pointrange(position = position_dodge(width = .2)) +
  theme(legend.position = "bottom")
```

- Summary of results (Figure \@ref(fig:mod-slp-std)):
  - Temporal trends (year nb effect):
    - Overall the magnitude of the effect of temporal trend was higher than the
      environmental variables
    - All the dissimiliraty indices increased in time :
      - Hillebrand, Jaccard and Appearance have the higher temporal trends
        ($r_\delta$ around 0.37), followed by disappearance, nestedness and
        turnover ($r_\delta$ around 0.25)
    - Species richness has a tiny increase around 0.02 (ten time less) and
      evenness did not change through time in average
  - River structure (upstream -> downstream, called hereafter stream gradient):
    - Species richness was higher toward downstream, as well as species appearance and disappearance
    - Linked to last point, jaccard dissimilarity and hillebrand similarity were
      respectively higher and lower downstream
    - The stream gradient had an effect of the same magnitude for turnover and
      jaccard dissimilarity ($r_\delta$ around 0.12) but was 0 for nestedness.
      It means that temporal jaccard dissimilarity downstream is due to 
      change in species identity (turnover) rather than change in number of
      species (nestedness).
    - Appearance and Disappearance were also higher downstream but the effect is
      the effect is half as great as for the other dissimilarity indices.
  - Human footprint difference (2009 - 1993):
    - Overall effect of human footprint difference is half as great as the
      effect of stream gradient
    - All variables but evenness increased with human footprint difference
      - It means that for example jaccard dissimilarity is overall lower when
        human footprint had decreased and that jaccard dissimilarity is overall
        higher when human footprint had increased (which makes sense but check
        difference in human footprint is not related to something else)
  - Interaction between temporal trends and stream gradient (year nb riv str rc1 effect):
    - Stream gradient had not significant effects on the temporal trends of
      biodiversity indices.
  - Interaction between temporal trends and human footprint difference (year nb
     effect):
     - The interactions are slightly significant and negative for the
       nestedness, appearance and richness (chao richness). Since the global
       temporal trends are positive for those variables (see year nb effect), it
       means that the effect of human footprint difference is antagonistic. 
       It means that species richness increase less (or worse) where human
       footprint increased and conversely that species richness increase more
       when human footprint decreased (!!!).
       Idem for appearance and nestedness, which are kind of linked to species
       richnness variation (I find this result so cool).

```{r, eval = FALSE}
# just to guide me
mod_tmb_comp_std_df %>%
  filter(Parameter == "year nb * hft ix c9309 diff scaled") %>%
  filter(CI_low > 0 | CI_high < 0)
```

```{r est-log-year}
mod_logyear_tmb_comp_std <- compare_parameters(
  setNames(gaussian_tmb$mod, gaussian_tmb$response),
  standardize = "basic")

mod_logyear_tmb_comp_std_df <-
  mod_logyear_tmb_comp_std %>%
  as_tibble() %>%
  select(Parameter, starts_with("CI_"), starts_with("Std_")) %>%
  pivot_longer(-Parameter, names_to = "names", values_to = "values") %>%
  separate(col = names, into  = c("type", "response"), sep = "\\.") %>%
  pivot_wider(names_from = "type", values_from = "values") %>%
  filter(Parameter != "(Intercept)") %>%
  filter(!response %in% c("species_nb", "log_species_nb"))
mod_logyear_tmb_comp_std_df %>%
  ggplot(
    aes(y = Parameter, x = Std_Coefficient, color = response, xmin = CI_low,
      xmax = CI_high)) +
  geom_pointrange(position = position_dodge(width = .2)) +
  theme(legend.position = "bottom")
```



```{r, fig.cap="Bad looking figure from modelbased R package"}
pred <- estimate_relation(gaussian_jaccard_tmb$mod[[2]])
plot(pred)
```

```{r}
knitr::opts_chunk$set(eval = FALSE)
```


```{r, eval=FALSE}
tar_load(pred_gaussian_tmb)
```


```{r p-pred-riv, fig.height = 16}
pred_year_riv_str_fe <- gaussian_jaccard_tmb  %>%
  filter(year_var == "year_nb", intercept == 1) %>%
  mutate(pred = map(mod,
      ~ggemmeans(.x,
        terms = c("year_nb", "riv_str_rc1 [quart2]"),
        type = "fe") 
      ),
    pred_plot = map(pred, plot),
    pred_plot = map(pred_plot, 
                    ~.x +
        theme(legend.position = "bottom") +
          labs(title ="")
          
        )
  ) %>%
  select(-mod)
plot_grid(plotlist = pred_year_riv_str_fe$pred_plot, ncol = 2)
```
```{r, fig.height = 16}
pred_log1_year_riv_str_fe <- gaussian_jaccard_tmb  %>%
  filter(year_var == "log1_year_nb", intercept == 1) %>%
  mutate(pred = map(mod,
      ~ggemmeans(.x,
        terms = c("log1_year_nb", "riv_str_rc1 [quart2]"),
        type = "fe")
      ),
    pred_plot = map(pred, plot),
    pred_plot = map(pred_plot, 
                    ~.x +
        theme(legend.position = "bottom") +
          labs(title ="")
          
        )
  ) %>%
  select(-mod)
plot_grid(plotlist = pred_log1_year_riv_str_fe$pred_plot, ncol = 2)
```

```{r, fig.height=16}
pred_year_hft_fe <- gaussian_jaccard_tmb  %>%
  filter(year_var == "year_nb", intercept == 1) %>%
  mutate(pred = map(mod,
      ~ggemmeans(.x,
        terms = c("year_nb", "hft_ix_c9309_diff_scaled [quart2]"),
        type = "fe")
      ),
    pred_plot = map(pred, plot),
    pred_plot = map(pred_plot, 
                    ~.x +
        theme(legend.position = "bottom") +
          labs(title ="")
          
        )
  ) %>%
  select(-mod)
plot_grid(plotlist = pred_year_hft_fe$pred_plot, ncol = 2)
```
```{r, fig.height=16}
pred_log1_year_hft_fe <- gaussian_jaccard_tmb  %>%
  filter(year_var == "log1_year_nb", intercept == 1) %>%
  mutate(pred = map(mod,
      ~ggemmeans(.x,
        terms = c("log1_year_nb", "hft_ix_c9309_diff_scaled [quart2]"),
        type = "fe")
      ),
    pred_plot = map(pred, plot),
    pred_plot = map(pred_plot, 
                    ~.x +
        theme(legend.position = "bottom") +
          labs(title ="")
        )
  ) %>%
  select(-mod)
plot_grid(plotlist = pred_log1_year_hft_fe$pred_plot, ncol = 2)
```


## Species richness

```{r, eval = FALSE}

lry <- gaussian_rich_tmb$mod[[5]]
cry <- gaussian_rich_tmb$mod[[1]]
```

```{r}
knitr::opts_chunk$set(eval = TRUE)
```


## Cluster 

```{r}
kclust_cap <- "PCA on the temporal trends with identified clusters based on
kmeans method (See methods). Convex ellipses are displayed."
```
```{r, fig.cap=kclust_cap}
# Kmeans
p_pca_clust <- fviz_cluster(
  object = kclust_tps,
  data = site_tps_clust,
  geom = "point",
  ellipse.type = "convex", 
  ggtheme = theme_bw()
)
```

```{r}
# Map
cluster_loc <- loc %>%
  left_join(enframe(kclust_tps$cluster, name = "siteid", value = "cluster"),
    by = "siteid"
    ) %>%
filter(!is.na(cluster))
ggplot(data = world) +
  geom_sf() +
  geom_sf(data = cluster_loc, aes(color = as.factor(cluster)), shape = 16) +
  theme(legend.position = "bottom")
```


- Cluster analysis: 
  - Cluster 1: low appearance + decrease richness
  - Cluster 2: low jaccard dis + increase richness
  - Cluster 3: high jaccard dis + high turnover + low nestedness + increase richness
  - Cluster 4: high richness increase + high evenness + high jaccard dis + high nestedness +
   low turnover

```{r}
clust_var_summary %>%
  ggplot(
    aes(
      x = variable, y = mean,
      ymin = ci_low, ymax = ci_high,
      color = as.factor(cluster))
    ) +
  geom_pointrange(position = position_dodge(width = .2)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "bottom")
```


```{r}
knitr::opts_chunk$set(eval = FALSE)
```

- Map:


```{r}
pred_slope <- gaussian_jaccard_tmb %>%
  mutate(
    site_slope = map(mod, function(m) {
      coef(m)$cond[["siteid:main_bas"]] %>%
        rownames_to_column(var = "siteid_main_bas") %>%
        separate(
          col = "siteid_main_bas",
          into = c("siteid", "main_bas"),
          sep = ":") %>%
        select(-main_bas)
    }),
    basin_slope = map(mod, function(m) {
      coef(m)$cond[["main_bas"]] %>%
        rownames_to_column(var = "main_bas") 
    }),
  ) %>%
select(-mod)
pred_slope$basin_slope[[1]] %>%
  as_tibble()

pred_slope <- pred_slope %>%
  mutate(
    sf_site = map(site_slope,
      ~left_join(.x, select(loc, siteid, geometry), by = "siteid") %>%
        st_as_sf()
      ),
    sf_basin = map(basin_slope,
      ~left_join(.x, loc %>%
        mutate(main_bas = as.character(main_bas)) %>%
        select(main_bas, geometry), by = "main_bas") %>%
        st_as_sf()
      ),
    sf_site_map = map2(sf_site, year_var,
      ~ggplot(data = world) +
        geom_sf() +
        geom_sf(data = .x, aes_string(color = .y), shape = 16) +
        scale_color_viridis() +
        theme(legend.position = "bottom")),
    sf_basin_map = map2(sf_basin, year_var,
      ~ggplot(data = world) +
        geom_sf() +
        geom_sf(data = .x, aes_string(color = .y), shape = 16) +
        scale_color_viridis() +
        theme(legend.position = "bottom"))
  )
```

#### Site

```{r}
pred_slope$sf_site_map[[1]] +
  labs(title = "Jaccard")

pred_slope$sf_site_map[[3]] +
  labs(title = "Turnover")

pred_slope$sf_site_map[[5]] +
  labs(title = "Nestedness")
```

#### Basin

```{r}
pred_slope$sf_basin_map[[1]] +
  labs(title = "Jaccard")

pred_slope$sf_basin_map[[3]] +
  labs(title = "Turnover")

pred_slope$sf_basin_map[[5]] +
  labs(title = "Nestedness")
```

```{r, eval=FALSE}
paste0(var_temporal_trends,
  " ~ ",
  "dist_up_km + tmp_dc_cyr +
  (1 + dist_up_km + tmp_dc_cyr | main_bas)"
) %>%
as.formula
```

```{r}
library(spaMM)
```

```{r}
ti_trends <- map(var_temporal_trends,
  ~fitme(
  as.formula(paste0("scale(", .x, ") ~ dist_up_km + tmp_c_cyr + (1 | main_bas)")),
  data = slp_env[,
    colnames(slp_env) %in%
    c(.x, "siteid", "dist_up_km", "tmp_c_cyr", "main_bas", "ecoregion")
  ]
  )
)
names(ti_trends) <- var_temporal_trends
```

```{r}
ci <- map_dfr(ti_trends[names(ti_trends) %in% c("log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand")], function(v) {
  x <- confint(v, c("dist_up_km", "tmp_c_cyr"), verbose = FALSE)
  tmp <- map_dfr(x, function(x) {
    tm <- x$interval
    names(tm) <- c("lower", "upper")
    return(tm)
  }, .id = "parm"
  )
  return(tmp)
}, .id = "response")
ci %>%
  kable(.,
    caption = "Confidence interval (bootstrap)")
```

```{r}
from_data_to_predict <- function(
  model_list = NULL,
  dataset = NULL,
  re = NULL
) {

  pred <- na.omit(dataset)
  for (i in seq_along(names(model_list))) {
    tmp <- predict(model_list[[i]],
      re.form = as.formula(re),
      intervals = "predVar"
      )[,1]
    names(tmp) <- NULL
    pred[[names(model_list)[i]]] <- tmp
  }
  return(pred)
}
```

```{r, eval = FALSE}
xx <- list(
    tmp_c_cyr = seq(min(na.omit(slp_env$tmp_c_cyr)), max(na.omit(slp_env$tmp_c_cyr)), length.out = 10),
    dist_up_km = seq(min(na.omit(slp_env$dist_up_km)), max(na.omit(slp_env$dist_up_km)), length.out = 10),
    main_bas = unique(na.omit(slp_env$main_bas))
)
new_data <- expand.grid(xx) %>%
    as_tibble()
pred <- predict(ti_trends[[1]], newdata = new_data, re.form = re, intervals="predVar")
int <- cbind(pred[,1], attr(pred, "intervals")) %>%
    as_tibble() %>%
    rename(y = V1)
```
```{r, eval = FALSE}
xxx <- cbind(int, new_data) %>%
    as_tibble
xxx %>%
    ggplot(aes(y = y, x = dist_up_km, color = main_bas)) +
    geom_point() +
    theme(legend.position = "none")
```



```{r}
re <- paste0("~ tmp_c_cyr + (1 | main_bas)")
pred_tmp <- from_data_to_predict(
  model_list = ti_trends,
  dataset = slp_env,
  re = re
)
p_tmp <- map(
  c(
      "log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand"),
  function(x) {
    pred_tmp %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_c_cyr,
          color = main_bas
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp, ncol = 3)
```

```{r}
re <- paste0("~ dist_up_km + (1 | main_bas)")
pred <- na.omit(slp_env)
for (i in seq_along(var_temporal_trends)) {
  tmp <- predict(trend_env[[i]],
    re.form = as.formula(re)
    )[, 1]
  names(tmp) <- NULL
  pred[[var_temporal_trends[i]]] <- tmp
}
p <- map(
  c("log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand"),
  function(x) {

    pred %>%
      ggplot(aes(
          y = !!sym(x),
          x = dist_up_km,
          color = as.factor(main_bas),
          shape = as.factor(ecoregion)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p, ncol = 3)
```

```{r}
re <- paste0("~ tmp_dc_cyr + (1 | main_bas)")
pred_tmp <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
p_tmp <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {
    pred_tmp %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_dc_cyr,
          color = as.factor(main_bas)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp, ncol = 3)
```

- Ecoregion:

```{r}
re <- paste0("~ dist_up_km + (1 + dist_up_km | ecoregion)")
pred_dist_ecoregion <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
```

```{r}
p_dist_ecoregion <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {

    pred_dist_ecoregion %>%
      ggplot(aes(
          y = !!sym(x),
          x = dist_up_km,
          color = as.factor(ecoregion)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_dist_ecoregion, ncol = 3)
```

```{r}
re <- paste0("~ tmp_dc_cyr + (1 + tmp_dc_cyr | ecoregion)")
pred_tmp_ecoregion <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
```

```{r}
p_tmp_ecoregion <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {
    pred_tmp_ecoregion %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_dc_cyr,
          color = as.factor(main_bas)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp_ecoregion, ncol = 3)
```

## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>

# References {-}

<div id="refs"></div>

# (APPENDIX) Appendix {-} 


## Correlation among temporal trends 

```{r}
cor_site_tps_tmp_cap <-  "Spearman correlation among the temporal trends of
biodiversity facets. Temporal trends at each site computed as BLUPs predictions
(i.e. estimated from random effects). " 

```

```{r, fig.cap=cor_site_tps_tmp_cap}
cor_site_tps <- cor(
  as.matrix(select(wide_site_tps, -siteid)),
  method = "spearman")
corrplot::corrplot(cor_site_tps)
```


