---
title: "Meeting report"
author: "Alain Danet"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    code_folding: "hide" 
bibliography: "bibliography.bib"
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(ade4)
library(factoextra)
library(tclust)
library(hrbrthemes)
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, modelling_data, analysis_dataset))

tar_load(pca_riv_str)
tar_load(c(var_analysis, tps_var, clust_var))
tar_load(c(gaussian_comp_std,
    gaussian_int_env_comp_std,
    gaussian_no_drivers_re_self_c))

tar_load(world_site_sf)
tar_load(p_clust_prop)

tar_load(c(
    clust_curv_site, k6_fac_1,
    clust_curv_site_fac_50, k6_fac_50,
    discr_k6_fac_50,
    site_cl_rm
    ))
```

```{r map-setup, include=FALSE}
world <- world_site_sf$world
loc <- world_site_sf$site
```

# Abstract/summary (so far)

- Downstream gradient is related more dissimilarity through time  
- Human pressure recent increase is related more dissimilarity through time and 
  less species richness increase 
- Cluster analysis reveals that there are only 6 scenarios of biodiversity
  trends, indicating a low dimensionality of biodiversity trends
- Cluster analysis seems reveal that the spatial heterogeneity of biodiversity
  changes takes place at lower scale that previously shown
  [@blowes_geography_2019; @klink_meta-analysis_2020]

# Introduction 

## Why do we want to assess community changes ?

- Global changes have affect a tremendous effect communities
- Understanding assembly and disassembly rules
- Give a more complex and complete picture of what is going on ?

## Documenting community changes

- Many papers report  temporal trends of local species richness and turnover
  - Abundance [@klink_meta-analysis_2020]
  - Species richness and or turnover: [@vellend_global_2013, @dornelas_assemblage_2014, @blowes_geography_2019]
  - They describe basically no trends in species richness but high turnover  
  - Species turnover vary a lot according to geography and taxa
    [@blowes_geography_2019]
  - Species turnover (as opposite of nestedness [@baselga_temporal_2013]) has
    been reported to be the major change, i.e. change in species identity, which
    is coherent with the absence of species richness trends  

### Environment

- Human footprint decreased between 1993 and 2009 in Occidental countries:
  https://www.nature.com/articles/ncomms12558

## Research gap

- Biodiversity trends are often analysed one facet at a time 
- Ecological drivers are often not included in Biodiversity trends assessment at global scale 
- Spatial grain is often at the continental scale, hiding more local variation


## Fish freshwater in streams 

- Streams are a good model to study turnover:  
  - They are spatially delimited at the basin level
  - Stream fishes are strongly constrained by hydrological constrains, which are
    highly variable at a small spatial scale, making possible to ecological
    drivers at multiple places, here the basin scale.

# Methods

## Data selection

- Unique protocol and unique unit of abundance by site
- One sampling by year and site
- In each site, samplings should be in the median (more or less one month and half, i.e. 1.5 month)
- 5 samplings by site, span 10 years 

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

```{r}
fig_sites <- paste0(
  "Australia absence because span is superior to 10 years of 100s of sites but number of samplings < 10.")
```

```{r, fig.cap=fig_sites}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
#    coord_sf(xlim = bb[c("xmin", "xmax")],
#      ylim = bb[c("ymin", "ymax")],
#      datum = 4326, expand = TRUE) +
    theme(legend.position = "bottom") +
    labs(title = paste0("Number of sites: ", nrow(loc)))
```

## Biodiversity

### Total abundance

Total abundance was reported in four different units: Count, Count by 100m^2,
Leslie index & CPUE. The two first units account for 80% of the data.

### Species richness 

We computed species richness with coverage-based correction proposed by
@chao_coverage-based_2014. The Chao index correct the species richness for the
sampling coverage. The sampling coverage of each sampling is evaluated by the
total number of individual and the number of singleton and (double) species. All
the sampling events were set at the same coverage of .80,
interpolation and rarefaction for respectively low and high coverage sampling.
Chao index was logged to express the temporal trends of species richness of
percentage variation. The temporal trends estimated from uncorrected species
richness gave the same results (Figure SXX).

### Betadiversity 

Betadiversity metrics compares the composition of two communities. In our case, we
compare the composition of each time step relatively to the baseline, i.e. the
first year of sampling. 

- Species exchange index: [@hillebrand_biodiversity_2018]
  - Presence-absence: $J = SER_r = \dfrac{S_{imm} + S_{lost}}{S_{tot}}$
  - Relative abundance: $SER_a = \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}$ 
  - $S_{imm}$, $S_{lost}$, $S_{tot}$: number of immigrant, lost and total species respectively
  - $i$: species $i$, $p$: relative abundance, $\prime$: second community
  - $J$: Jaccard index

Turnover metrics based on presence/absence can be decomposed in
appearance/disappearance and nestedness / turnover.

- appearance: $\dfrac{S_{imm}}{S_{tot}}$, disappearance: $\dfrac{S_{lost}}{S_{tot}}$

- Turnover: $J_t = \dfrac{2 * min(S_{lost}, S_{imm})}{S_{common} + (2 * min(S_{lost}, S_{imm})}$
- Nestedness: $SER_r - J_t$


# Environment

```{r}
var_pca <- dimnames(pca_riv_str$rotated$loadings)[[1]]
clean_var_pca <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% var_pca]
high_load_rc1 <- pca_riv_str$rotated$loadings[
pca_riv_str$rotated$loadings[, "RC1"] > .90,
  "RC1"] 
clean_high_load_rc1_var <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% names(high_load_rc1)]
```


- The environment was characterized by the stream structure and human footprint
  difference between 2009 and 1993
- The stream structure was characterized by a rotated PCA axis (fig
  \@ref(fig:p-rot-pca-riv-str)). The PCA included
  `r paste0(clean_var_pca, collapse = ", ")`, which are respectively 
  `r paste0(names(clean_var_pca), collapse = ", ")`. Then, the first axis
  included in the analysis is associated with the following variables:
  `r paste0(names(clean_high_load_rc1_var), collapse = ", ")`.

```{r}
fig_cap_pca <- "Rotated PCA on stream structure. The first axis is related to
the distance from the source, stralher order and discharge (m3/s). The second
axis is related to the altitude and slope degree of the site. Only the first
axis was included in the analysis"
```

```{r p-rot-pca-riv-str, fig.cap=fig_cap_pca}
p <- plot_rotated_pca(pca_riv_str)
my_pca_plot(pca_riv_str$rotated)
```
```{r}
h_hft_cap <- "Distribution of difference between human footprint in 1993 and
2009."
```


```{r h-hft, fig.cap = h_hft_cap}
hist(analysis_dataset$hft_ix_c9309_diff,
  xlab = "human footprint difference (1993-2009)")
s_hft_diff <- round(summary_distribution(analysis_dataset$hft_ix_c9309_diff, na.rm = T))
```

- The human footprint difference between 1993 and 2009 is biaised toward an
  decrease of human footprint (average difference (sd):
  `r s_hft_diff["mean"]` (`r s_hft_diff["sd"]`)), meaning that in average the
  human footprint index decreased in 16 years.

# Statistical analysis 

## Species composition change

In each site and at each sampling point, we computed the dissimilarity (Jaccard,
Appearance, Disappearance, Turnover & Nestedness) between each time step and the
reference time, i.e. the first year of sampling. Regarding the reference time
step, there are two different strategies. First is to include it, i.e. setting a
dissimilarity of 0 at each beginning of a time series [@blowes_geography_2019].
Another strategy is to exclude the first year from the analysis
[@dornelas_assemblage_2014]. The first option logically constrains the analysis
toward increasing dissimilarity as the second can capture recovery from
perturbation soon after the first samplings. I guess that the first option makes
more sense more it removes to sensibility to community changes happening just
after the references year.

However as the relationship between most dissimilarity indices and time is
highly non linear (like a Michaelis-Menten), we logged the number of year since
the first year of sampling (plus one)  to linearize the relationship. AIC of
the models with logged years were up to twice lower (Table
SXX).


## Model 

### Turnover

Jaccard dissimilarity, nestedness, turnover, appearance, disappearance and
hillebrand were modelled in two ways, Beta and gaussian regression. Beta
regressions are more appropriate for distribution bounded by [0,1] and are
linearized by a logit link. Logit links have the cons that coefficients are less
easy to interpret. So we run both gaussian and beta regressions and investigate
the sensitivity of our results to modelling choice. Values of
turnover were slightly transformed such as values of one and zero fitted beta
regression requirements ($x' = \dfrac{x \times (N - 1) + 0.5}{N}$).

The model is defined like this: 

$$
B_i = \beta_0Y_i +  \beta_1Y_iR_i + \beta_2Y_iH_i + \epsilon
$$
where

$$
\begin{align}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0i}
\end{align}
$$

- where:
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin

- The model formula in:

```{r}
"biodiv_facet ~ 
0 + year/river_structure + year/human_footprint_diff +
(0 +  year | basin/site)"
```

- `year`: logged number of year (+1) since the beginning of the monitoring (site scale) 
- `river_structure`: PCA from upstream to downstream (centered and scaled)
- `human_footprint_diff`: difference between 1993 and 2009 (centered and scaled)
- `basin`: Hydrographic basin
- `site`: site 

As temporal trends of biodiversity facets had a Michaelis-Menten shape,
we linearized the trends by taking the log of year number added to 1. Models
with logged year had a lower AIC, up to twice (Table SXX).

At each site, all the dissimilarity indices had a value of 0 the first year.
Then we constrained the intercept to 0 and kept only random effect on the slope.
Models comparison shows that the results are qualitatively the same (Appendix
SXX).


### Species richness

At the difference with dissimilarity index, we modelled species richness with
the intercept and the main effect of ecological drivers. We modelled logged species
richness with Chao index. 

$$
B_i = \alpha + \beta_0Y_i + \beta_1R_i + \beta_2Y_iR_i + \beta_3H_i + \beta_4Y_iH_i + \epsilon
$$

where
$$
\begin{align}
\\ \alpha&=\alpha_0 + u_{0i|j} + u_{0j}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0j}
\end{align}
$$

- where:
  - $\alpha$: intercept
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin

### Total abundance

In the dataset, total abundance was described as raw count, counts by $100m^2$,
CPUE, and Leslie index representing respectively XX% of the sites. To account
for this hererogeneity, we included the unit of measurement as a main affect
explaining total abundance but also as an interaction with the year effect, in a
similar way than previous studies [@klink_meta-analysis_2020].  Similar to
species richness modelling, we modelled the log of total abundances. 


$$
B_i = \alpha + \beta_0Y_i + \beta_1U_i + \beta_2Y_iU_i + \beta_3R_i + \beta_4Y_iR_i + \beta_5H_i + \beta_6Y_iH_i + \epsilon
$$

where
$$
\begin{align}
\\ \alpha&=\alpha_0 + u_{0i|j} + u_{0j}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0j}
\end{align}
$$

- where:
  - $\alpha$: intercept
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin
  - $U$: abundance unit


### Implementation

All the statistical models were computed in R with the `glmmTMB` package. In
order to facilitate the comparison of the effects, the reported slope
coefficients were standardised as $r_\delta = \beta \dfrac{\s_x}{\s_y}$, $\beta$
being the unstandardised slope, $s_x$ and $s_y$ respectively the standard
deviation of the explicative and response variable. 

### Estimation of fixed effects for each level of random effects

The fixed effect coefficients for each level of random effects were computed as
sum of the random effects and its corresponding fixed effects, known as BLUPs
(Best Linear Unbiased Predictions, `coef.merMod` in R). However, the associated 
standard errors and confidence intervals are not computable on BLUPs. As an
example, it means that while we are able to compute the temporal trends as each
site and basin, those temporal trends have no associated errors.

```{r}
site_temporal_trends <- gaussian_no_drivers_re_self_c %>%
  select(response, random_site) %>%
  unnest(random_site) %>%
  select(response, siteid, log1_year_nb)
```

```{r}
site_temporal_trends %>%
  filter(response %in% clust_var) %>%
  mutate(response = get_var_replacement()[response]) %>%
  ggplot(aes(x = log1_year_nb)) +
  geom_histogram() +
  facet_wrap(vars(response), scales = "free")
```

The estimated temporal trends of total abundance were corrected according to
abundance units, with the estimated fixed effect from the model.

## Cluster analysis

```{r}
wide_site_tps <- site_temporal_trends  %>%
  pivot_wider(names_from = "response", values_from = "log1_year_nb")
```

```{r}
site_tps_clust <- wide_site_tps %>%
  select(all_of(clust_var)) %>%
  as.data.frame()
rownames(site_tps_clust) <- wide_site_tps$siteid
```
```{r}
kmeans_opt_nb_gr_sil_cap <- "Objective function value according to the
proportion of outliers data trimmed and the number of cluster(colored lines). Up
to 6 cluster, the proportion of trimmed data does not change the ranking of the clustering. We chose to stick with 6 clusters with a removal 0.05 of the outliers"
```

```{r cl-curv, fig.cap=kmeans_opt_nb_gr_sil_cap, fig.height=7}
plot(clust_curv_site_fac_50)
```

```{r}
kmeans_sites <- "Distribution of the sites in discriminant space, colored by
their cluster assignement (left). Stilhouette profile. Black points represent sites that have been trimmed
at the 5% threshold."
```

```{r cl-p, fig.cap=kmeans_sites}
plot(discr_k6_fac_50)
```

Site were clustered based on the temporal trends of biodiversity facets using
trimmed robust cluster method [REF]. Temporal trends were scaled but not
centered before clustering.  According to the optimal function, the optimal
number of clusters was between 6 and 8 (Fig. \@ref(fig:cl-curve)). We used 25 starting
positions and a maximum of 100 iterations. We trimmed 5% of outliers in the
multidimentional space. We set cluster assignement as NA for sites that had an
assignement improvement of 10% in another cluster. Clustering was computed with
`tclust` R package. 

# Results

## Temporal trends of biodiversity facets

```{r}
mod_comp_std_df <- gaussian_comp_std %>%
  as_tibble() %>%
  select(Parameter, starts_with("CI_"), starts_with("Coefficient")) %>%
  pivot_longer(-Parameter, names_to = "names", values_to = "values") %>%
  separate(col = names, into  = c("type", "response"), sep = "\\.") %>%
  pivot_wider(names_from = "type", values_from = "values") %>%
  filter(
    !Parameter %in% "(Intercept)",
    !str_detect(Parameter, "unitabundance"),
    response %in% clust_var
  ) %>%
  mutate(
    response = get_var_replacement()[response],
    Parameter = str_replace_all(Parameter, "([a-z|0-9])\\s([a-z|0-9])", "\\1_\\2"),
    Parameter = str_replace_all(Parameter, get_model_term_replacement()),
    facet = ifelse(str_detect(Parameter, "\\*"), "interaction", "main")
  )
```

```{r}
mod_slp_std_cap <- paste0("Estimated fixed effects of the gaussian models.
  Coefficients were standardized by refiting the models with scaled response and
  explicative variables. Bars represent CI at 95% computed with Wald
  approximation.")
```

```{r mod-slp-std, fig.cap=mod_slp_std_cap, layout="l-page", fig.width=8, fig.height=6}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")

pal <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
pal2 <- palette_coolors("https://coolors.co/palette/01befe-ffdd00-ff7d00-ff006d-adff02-8f00ff")


p <- mod_comp_std_df %>%
  filter(facet == "main") %>%
  mutate(Parameter = fct_reorder(Parameter, CI_high, .fun="max")) %>%
  ggplot(
    aes(y = Parameter, x = Coefficient, color = response, xmin = CI_low,
      xmax = CI_high)) +
  geom_vline(xintercept = 0) +
  geom_pointrange(position = position_dodge(width = .7)) +
  labs(x = "Standardized coefficients", colour = "Response variables") +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 4, byrow = TRUE))


#withr::with_options(
#  list(ggplot2.discrete.colour = pal),
#  print(p + scale_color_discrete())
#)

p1 <- mod_comp_std_df %>%
  filter(facet == "interaction") %>%
  ggplot(
    aes(y = Parameter, x = Coefficient, color = response,
      xmin = CI_low, xmax = CI_high)
    ) +
  geom_vline(xintercept = 0) +
  geom_pointrange(position = position_dodge(width = .7)) +
  theme(
    axis.title = element_blank(),
    legend.position = "none"
    )

p2 <- p +
  theme(
    plot.margin = margin(0, 5.5, 6, 64),
    axis.title.y = element_blank()
  )

p_mod_coef <- plot_grid(p1, p2, nrow = 2)
```

- In average, all biodiversity facets had a positive temporal trend:
  - Jaccard, abundance based dissimilarity and appearance have the higher temporal trends
        ($r_\delta$ around 0.37), followed by disappearance, nestedness and
        turnover ($r_\delta$ around 0.25)
  - Species richness and total abundance has a tiny increase around 0.025 (ten time less)
- Stream gradient (upstream -> downstream, called hereafter stream gradient):
  - Total abundance was higher toward downstream
  - No effect on species richness
- Human footprint change (1993-2009):
  - Species richness was overall lower where pressure increased
  - Total abundance was overall higher where pressure increased
- Effect of stream gradient on temporal trends:
  - **Higher increase in dissimilarity downstream**: turnover and abundance based dissimilarity
  - **Higher increase in total abundance and species richness downstream**
  - No effect on Jaccard, appearance and disappearance
- Effect of human footprint change (1993-2009) on temporal trends: 
  - **Higher increase in turnover and abundance based dissimilarity where
    pressure increased** (change in species identity)
  - **Lower increase in species richness where pressure increased**

```{r}
cor_site_tps <- cor(site_tps_clust,
  method = "spearman"
)
dimnames(cor_site_tps) <- map(
  dimnames(cor_site_tps),
  ~get_var_replacement()[.x]
)
#corrplot::corrplot(cor_clust, type = "upper", diag = FALSE, tl.srt = 15)
cor_p <- ggcorrplot::ggcorrplot(
  cor_site_tps, hc.order = TRUE, type = "lower",
  lab = TRUE, tl.srt = 15, legend.title = "Spearman Corr") +
theme(legend.position = c(.45, .95), legend.direction = "horizontal") +
guides(colour = guide_legend(title.position = "top"))
```

```{r}
pca_clust <- compute_rotated_pca(site_tps_clust)
p_pca_clust <- plot_rotated_pca(pca_clust)
p_rotated_pca_clust <- my_pca_plot(
  pca_clust$rotated,
  replace_var = get_var_replacement())
tt <- pca_clust$rotated$scores %>%
  as.data.frame() %>%
  rownames_to_column("siteid") %>%
  as_tibble() %>%
  left_join(site_cl_rm[, c("siteid", "cl")], by = "siteid") %>%
  na.omit()
p_rot_clust_ell <- p_rotated_pca_clust +
  geom_point(data = tt, aes(x = RC1, y = RC2, colour = as.factor(cl))) +
  stat_ellipse(data = tt, aes(x = RC1, y = RC2, colour = as.factor(cl)), level = .9)
```


```{r}
mod_slp_std_cap <- paste0("(A) Estimated fixed effects of the gaussian models.
  Coefficients were standardized by refiting the models with scaled response and
  explicative variables. Bars represent CI at 95% computed with Wald
  approximation.",
  " (B) Spearman correlation among temporal trends.",
  " (C) Rotated PCA on temporal trends."
)
```

```{r mod-tps, fig.cap=mod_slp_std_cap, fig.height=10}
leg <- get_legend(p2 + theme(legend.direction = "vertical"))

plot_grid(
  plot_grid(p1, p2 + theme(legend.position = "none"), nrow = 2) ,
  plot_grid(cor_p, p_rotated_pca_clust, leg, nrow = 1, labels = c("B", "C")),
  nrow = 2,
  labels = c("A", "")
)
```




## Typology of biodiversity trends 

- Cluster signification (Figure \@ref(fig:cl-bp)):
  - Cluster 1: Low change 
  - Cluster 2: High turnover + medium increase abundance + high dissimilarity +
    medium increase richness
  - Cluster 3: High increase richness + high nestedness + increase abundance +
    medium dissimilarity
  - Cluster 4: Decrease richness + No abundance change + medium dissimilarity
  - Cluster 5: Decrease abundance + medium dissimilarity 
  - Cluster 6: Increase abundance + medium dissimilarity + low richness change 

- Summary: **Cluster are determined by abundance, species richness and turnover,
  meaning that there isa  low dimensionality of biodiversity trends**


```{r}
world_site_sf$cl <- world_site_sf$site %>%
    left_join(site_cl_rm[, c("siteid", "cl")], by = "siteid") %>%
    mutate(cl = relevel(as.factor(cl), ref = 1))

main_map <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(color = cl))

zoom_map <- list(
  north_am = "USA",
  south_eu = c("FRA", "GBR", "HUN", "ESP", "BEL"),
  north_eu = c("FIN", "NOR", "SWE"),
  aus = "AUS"
)

zoom_map_coord <- map(zoom_map,
  ~world_site_sf$cl %>%
    filter(country %in% .x) %>%
    st_bbox()
)

zoom_map_coord_df <- map_dfr(zoom_map_coord,
  ~setNames(as.numeric(.x), names(zoom_map_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(label = LETTERS[seq_len(4)])

main_map_rect <- main_map +
  geom_rect(
    data = zoom_map_coord_df,
  aes(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax),
    fill = NA,
    colour = "black",
    size = 0.6) +
  geom_text(
    data = zoom_map_coord_df,
    aes(x = xmin, y = ymax, label = label),
    vjust = 1, hjust = 1, size = 15
  )

p_zoom_map <- map2(zoom_map_coord, zoom_map_coord_df$label,
  ~main_map_rect +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 15, vjust = 1, hjust = 0) +
    theme(legend.position = "none")
)
```

```{r cl-heat}
te <- expand.grid(
  list(
    cluster = c(seq_len(6)),
    response = clust_var
  )
)

avg_cl_var <- site_cl_rm %>%
  select(-riv_str_rc1, -hft_c9309_scaled_no_center) %>%
  pivot_longer(-c(siteid, cl),
    names_to = "response",
    values_to = "value") %>%
  group_by(cl, response) %>%
  summarise(value = median(value), .groups = "drop") %>%
  rename(cluster = cl)

# Ajouter moyenne par cluster
te <- te %>%
  left_join(avg_cl_var, by = c("cluster", "response"))

heat_map_df <- te %>%
  pivot_wider(names_from = "response", values_from = "value")
```

```{r}
cl_label <- c(
  "1: No change",
  "2: High turnover",
  "3: Increase of species richness",
  "4: Decrease of species richness",
  "5: Decrease of abundance",
  "6: Increase of abundance")
heat_cl <- te %>%
  ggplot(aes(
      x = get_var_replacement()[response],
      y = str_replace_all(as.character(cluster),
        setNames(cl_label, seq_len(6))),
      fill = value)) +
  geom_tile() +
  hrbrthemes::theme_ipsum(base_family = "Helvetica") +
  coord_fixed() +
  scale_fill_gradient2(
    high = muted("red"),
    mid = "white",
    low = muted("blue"),
    midpoint = 0,
    space = "Lab") +
  labs(x = "", y = "") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```

```{r}
# Build heatmap
site_cl_rm$cl <- relevel(as.factor(site_cl_rm$cl), ref = 1)

cl_mod <- nnet::multinom(
  cl ~ riv_str_rc1 + hft_c9309_scaled_no_center,
  data = site_cl_rm)
```

```{r}
ci_cl_mod <- exp(confint(cl_mod)) - 1
exp_cl_mod <- exp(coef(cl_mod))
z_cl_mod <- summary(cl_mod)$coefficients / summary(cl_mod)$standard.errors


s_cl_mod <- map_dfr(list(exp_coef = exp_cl_mod, z = z_cl_mod),
  ~.x[, c("riv_str_rc1", "hft_c9309_scaled_no_center")] %>%
    as.data.frame() %>%
    rownames_to_column(var = "cluster"), .id = "type"
) %>%
  pivot_longer(c("riv_str_rc1", "hft_c9309_scaled_no_center"),
    names_to = "variable", values_to = "value") %>%
  pivot_wider(names_from = "type", values_from = "value") %>%
  mutate(pc = exp_coef - 1)
```

```{r}
p_cl_mod <- s_cl_mod %>%
  ggplot(aes(
      x = get_model_term_replacement()[variable],
      y = str_replace_all(as.character(cluster),
        setNames(cl_label, seq_len(6))),
      fill = pc 
      )) +
  geom_tile(aes(alpha = abs(z))) +
  hrbrthemes::theme_ipsum(base_family = "Helvetica") +
  scale_fill_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_fixed() +
  labs(x = "", y = "", alpha = "Z-score", fill = "Probability") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))
```

```{r}
map_cl_cap <- "(a) Distribution of the cluster biodiversity trends. NAs cluster
displays sites that could not be attributed clearly to one cluster (cf methods).
(b) Median of the scaled variables (but not centered) for each cluster. (c)
Results of the multinomial model. Color scale displays exponentiated
coefficients minus 1 while opacity displays absolute Z-scores. Color scale means that
a site has XX% more probability to be in cluster Y than in cluster 1.
"
```


```{r}
p_map_cl <- plot_grid(
  plot_grid(main_map_rect, heat_cl, p_cl_mod, nrow = 1, labels = "auto"),
  plot_grid(plotlist = p_zoom_map, nrow = 1),
  nrow = 2
)
save_plot(here("doc/fig/p_map_cl.png"),
  p_map_cl, base_height = 4, nrow = 2, ncol = 3)
```

```{r map-cl, layout="l-page", fig.height=16, fig.width = 12, fig.cap=map_cl_cap}
knitr::include_graphics(here("doc/fig/p_map_cl.png"))
```


- Results of the multinomial model: 
  - 72% more probable to be in cluster 2 (high turnover) than in cluster 1 (no
    change) if PCA coordinates related to stream gradient increase by 1% 
  - 76% more probable to be in cluster 6 (increase in abundance) than in cluster
    1 if PCA coordinates related to stream gradient increase by 1% 
  - *I have to find a more clear story for this*
  - **We basically find the same results than the general model but more blurry**


```{r, layout="l-page", fig.height=10, fig.width = 14}
main_map_rect
heat_cl
p_cl_mod
p_zoom_map
```

```{r}
map(p_clust_prop,
  ~.x +
  scale_fill_discrete(
    name = "Cluster",
    breaks = c(0, seq_len(6)),
    labels = c("NA: undefined cluster", cl_label)
  )
)
```


# Discussion 

- We find in average an increase in species richness and total abundance
- Environmental drivers and pressure explain temporal trends 
- The different biodiversity facets are necessary to characterize the change
  scenario: abundance change or presence/absence, change in identity or
  nestedness 
- The typology of temporal trends reveals that only three dimensions matters:
  total abundance, species richness, turnover. The combination of their
  temporal trends characterize the 6 clusters
- The spatial heterogeneity of the cluster distribution is pretty high ! 

# References {-}

<div id="refs"></div>

# (APPENDIX) Appendix {-} 


## Correlation among temporal trends 

```{r}
cor_site_tps_tmp_cap <-  "Spearman correlation among the temporal trends of
biodiversity facets. Temporal trends at each site computed as BLUPs predictions
(i.e. estimated from random effects). " 

```

```{r, fig.cap=cor_site_tps_tmp_cap}
cor_site_tps <- cor(
  as.matrix(select(wide_site_tps, -siteid)),
  method = "spearman")
corrplot::corrplot(cor_site_tps)
```

## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>

