---
title: "Meeting report"
author: "Alain Danet"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    code_folding: "hide" 
bibliography: "bibliography.bib"
---

<style type="text/css">
.main-container {
  max-width: 1600px !important;
  margin: auto;
}
</style>


```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(ade4)
library(factoextra)
library(tclust)
library(hrbrthemes)
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, modelling_data, measurement_exo))

loc <- filtered_dataset$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic"))

tar_load(pca_riv_str)
tar_load(c(var_analysis, tps_var, clust_var))
tar_load(c(gaussian_comp_std,
    gaussian_int_env_comp_std,
    gaussian_no_drivers_re_self_c))

tar_load(world_site_sf)
tar_load(p_clust_prop)

tar_load(c(
    clust_curv_site, k6_fac_1,
    clust_curv_site_fac_50,
    site_k6_fac_1_cl,
    discr_k6_fac_1,
    site_cl_rm
    ))

tar_load(p_int_mod)
tar_load(bp_random_effect)
```

```{r map-setup, include=FALSE}
world <- world_site_sf$world
loc <- world_site_sf$site
```

# Abstract/summary (so far)

- Downstream gradient is related more dissimilarity through time  
- Human pressure recent increase is related more dissimilarity through time and 
  less species richness increase 
- Cluster analysis reveals 6 contrasted scenarios of biodiversity
  trends, indicating a low dimensionality of biodiversity trends
- Cluster analysis seems reveal that the spatial heterogeneity of biodiversity
  changes takes place at lower scale that previously shown
  [@blowes_geography_2019; @klink_meta-analysis_2020] (might be a caracteristic
  of a stream)

# Introduction 

## Documenting community changes

- Global changes have affect a tremendous effect communities
- Understanding assembly and disassembly rules
- Give a more complex and complete picture of what is going on ?

- Many papers report  temporal trends of local species richness and turnover
  - Abundance [@klink_meta-analysis_2020]
  - Species richness and or turnover: [@vellend_global_2013, @dornelas_assemblage_2014, @blowes_geography_2019]
  - They describe basically no trends in species richness but high turnover  
  - Species turnover vary a lot according to geography and taxa
    [@blowes_geography_2019]
  - Species turnover (as opposite of nestedness [@baselga_temporal_2013]) has
    been reported to be the major change, i.e. change in species identity, which
    is coherent with the absence of species richness trends  

## Multiple facets of biodiversity

- To complete

## Long-term and short term pressure 

- Occidental environment has been the most modified
- Human footprint decreased between 1993 and 2009 in Occidental countries:
  https://www.nature.com/articles/ncomms12558

## Research gap

- Biodiversity trends are often analysed one facet at a time 
- Ecological drivers are often not included in Biodiversity trends assessment at global scale 
- Spatial grain is often at the continental scale, hiding more local
  heterogeneity

## Fish freshwater in streams

- Streams are a good model to study turnover:  
  - They are spatially delimited at the basin level
  - Stream fishes are strongly constrained by hydrological constrains, which are
    highly variable at a small spatial scale, making possible to ecological
    drivers at multiple places, here the basin scale.

# Methods

## Data selection

```{r}
filtered_dataset  <- map(filtered_dataset,
  ~.x %>%
    filter(siteid %in% unique(modelling_data$siteid))
)

uabun <- tabyl_df(filtered_dataset$site_quali, "unitabundance") %$%
  setNames(.$percent, .$unitabundance)
protocol <- tabyl_df(filtered_dataset$site_quali, "protocol")
electro <- str_detect(filtered_dataset$site_quali$protocol, "Electro") %>%
  sum / nrow(filtered_dataset$site_quali) * 100

year_samp <- modelling_data %>%
  summarise(enframe(summary_distribution(year))) %>%
  mutate(value = round(value)) %>%
  deframe()

year_samp_hft <- modelling_data %>%
  summarise(
    be93 = sum(year <= 1993) / n(),
    a93 = sum(year > 1993) / n(),
    bw9309 = sum(year > 1993 & year <= 2009) / n(),
    a09 = sum(year > 2009) / n()
    ) %>%
  mutate(across(everything(), scales::percent)) %>%
  pivot_longer(everything(), names_to = "name", values_to = "value") %>%
  deframe()
```


- Unique protocol and unique unit of abundance by site
- One sampling by year and site
- In each site, samplings should be in the median (more or less one month and
  half, i.e. 1.5 month)
- 5 samplings minimum by site, span 10 years

- `r nrow(filtered_dataset$site_quali)` sites
- `r round(electro, 1)`% of the sites were monitored with electrofishing
- The year of samplings goes from `r year_samp["min"]` to `r year_samp["max"]`
  with first, second and third quartile being respectively 
  `r paste0(year_samp[c("1st_quart", "median", "2nd_quart")], collapse = ", ")`.

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

```{r}
fig_sites <- paste0(
  "Distribution of the sites.")
```

```{r, fig.cap=fig_sites}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
#    coord_sf(xlim = bb[c("xmin", "xmax")],
#      ylim = bb[c("ymin", "ymax")],
#      datum = 4326, expand = TRUE) +
    theme(legend.position = "bottom") +
    labs(title = paste0("Number of sites: ", nrow(loc)))
```

## Biodiversity

### Total abundance

Total abundance was reported in four different units: Count, Count by 100m^2,
Leslie index & CPUE. The two first units account for 80% of the data.

### Species richness 

We computed species richness with coverage-based correction proposed by
@chao_coverage-based_2014. The Chao index correct the species richness for the
sampling coverage. The sampling coverage of each sampling is evaluated by the
total number of individual and the number of singleton and (double) species. All
the sampling events were set at the same coverage of .80,
interpolation and rarefaction for respectively low and high coverage sampling.
Chao index was logged to express the temporal trends of species richness of
percentage variation. The temporal trends estimated from uncorrected species
richness gave the same results (Figure SXX).

### Betadiversity 

Betadiversity metrics compares the composition of two communities. In our case, we
compare the composition of each time step relatively to the baseline, i.e. the
first year of sampling. 

- Species exchange index: [@hillebrand_biodiversity_2018]
  - Presence-absence: $J = SER_r = \dfrac{S_{imm} + S_{lost}}{S_{tot}}$
  - Relative abundance: $SER_a = \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}$ 
  - $S_{imm}$, $S_{lost}$, $S_{tot}$: number of immigrant, lost and total species respectively
  - $i$: species $i$, $p$: relative abundance, $\prime$: second community
  - $J$: Jaccard index

Turnover metrics based on presence/absence can be decomposed in
appearance/disappearance and nestedness / turnover.

- appearance: $\dfrac{S_{imm}}{S_{tot}}$, disappearance: $\dfrac{S_{lost}}{S_{tot}}$

- Turnover: $J_t = \dfrac{2 * min(S_{lost}, S_{imm})}{S_{common} + (2 * min(S_{lost}, S_{imm})}$
- Nestedness: $SER_r - J_t$


# Environment

```{r}
var_pca <- dimnames(pca_riv_str$rotated$loadings)[[1]]
clean_var_pca <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% var_pca]
high_load_rc1 <- pca_riv_str$rotated$loadings[
pca_riv_str$rotated$loadings[, "RC1"] > .90,
  "RC1"] 
clean_high_load_rc1_var <- get_river_atlas_significant_var()[
  get_river_atlas_significant_var() %in% names(high_load_rc1)]
```


- The environment was characterized by the stream structure and human footprint
  difference between 2009 and 1993
- The stream structure was characterized by a rotated PCA axis (fig
  \@ref(fig:p-rot-pca-riv-str)). The PCA included
  `r paste0(clean_var_pca, collapse = ", ")`, which are respectively 
  `r paste0(names(clean_var_pca), collapse = ", ")`. Then, the first axis
  included in the analysis is associated with the following variables:
  `r paste0(names(clean_high_load_rc1_var), collapse = ", ")`.

```{r}
fig_cap_pca <- "Rotated PCA on stream structure. The first axis is related to
the distance from the source, stralher order and discharge (m3/s). The second
axis is related to the altitude and slope degree of the site. Only the first
axis was included in the analysis"
```

```{r p-rot-pca-riv-str, fig.cap=fig_cap_pca}
my_pca_plot(pca_riv_str$rotated)
```
```{r}
h_hft_cap <- "Distribution of log base 2 ratio between human footprint in 1993 and
2009. -1 and +1 means an Human footprint respectively divided and multiplied by
      two"
```


```{r h-hft, fig.cap = h_hft_cap}
modelling_data %>%
  group_by(siteid) %>%
  summarise(hft_ix_c9309_log2_ratio = unique(hft_ix_c9309_log2_ratio)) %>%
  ggplot(aes(x = hft_ix_c9309_log2_ratio)) +
  geom_histogram() +
  labs(
    x = "Human footprint ratio (1993-2009, Log base 2)",
    y = "Number of sites"
  ) +
theme_cowplot()
s_hft_diff <- round(summary_distribution(modelling_data$hft_ix_c9309_log2_ratio, na.rm = T), 2)
```

- The human footprint difference between 1993 and 2009 is biaised toward an
  decrease of human footprint (average difference (sd):
  `r s_hft_diff["mean"]` (`r s_hft_diff["sd"]`)), meaning that in average the
  human footprint index decreased in 16 years.

# Statistical analysis 

## Species composition change

In each site and at each sampling point, we computed the dissimilarity (Jaccard,
Appearance, Disappearance, Turnover & Nestedness) between each time step and the
reference time, i.e. the first year of sampling. Regarding the reference time
step, there are two different strategies. First is to include it, i.e. setting a
dissimilarity of 0 at each beginning of a time series [@blowes_geography_2019].
Another strategy is to exclude the first year from the analysis
[@dornelas_assemblage_2014]. The first option logically constrains the analysis
toward increasing dissimilarity as the second can capture recovery from
perturbation soon after the first samplings. I guess that the first option makes
more sense more it removes to sensibility to community changes happening just
after the references year.

However as the relationship between most dissimilarity indices and time is
highly non linear (like a Michaelis-Menten), we logged the number of year since
the first year of sampling (plus one)  to linearize the relationship. AIC of
the models with logged years were up to twice lower (Table
SXX).


## Model 

### Turnover

Jaccard dissimilarity, nestedness, turnover, appearance, disappearance and
hillebrand were modelled in two ways, Beta and gaussian regression. Beta
regressions are more appropriate for distribution bounded by [0,1] and are
linearized by a logit link. Logit links have the cons that coefficients are less
easy to interpret. So we run both gaussian and beta regressions and investigate
the sensitivity of our results to modelling choice. Values of
turnover were slightly transformed such as values of one and zero fitted beta
regression requirements ($x' = \dfrac{x \times (N - 1) + 0.5}{N}$).

The model is defined like this: 


$$
\begin{align}
\\ B_i &= \beta_0Y_i +  \beta_1Y_iR_i + \beta_2Y_iH_i + \beta_3Y_i{HD}_i + 
\\& \beta_4Y_iR_iH_i + \beta_5Y_iR_i{HD}_i +
\\& \beta_6Y_iH_i{HD}_i + \epsilon
\end{align}
$$

- where:
  - $Y$: log year number + 1 
  - $R$: First component of the PCA on the river structure related to the
    distance from spring, annual discharge, stralher order
  - $H$: Human footprint of 1993
  - ${HD}$: Log 2 of Human footprint ratio (1993-2009)

$$
\begin{align}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0i}
\end{align}
$$

- where:
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin

- The model formula in:

```{r}
"biodiv_facet ~ 
0 + year/river_structure + year/human_footprint_diff +
(0 +  year | basin/site)"
```

- `year`: logged number of year (+1) since the beginning of the monitoring (site scale) 
- `river_structure`: PCA from upstream to downstream (centered and scaled)
- `human_footprint_diff`: difference between 1993 and 2009 (centered and scaled)
- `basin`: Hydrographic basin
- `site`: site 

As temporal trends of biodiversity facets had a Michaelis-Menten shape,
we linearized the trends by taking the log of year number added to 1. Models
with logged year had a lower AIC, up to twice (Table SXX).

At each site, all the dissimilarity indices had a value of 0 the first year.
Then we constrained the intercept to 0 and kept only random effect on the slope.
Models comparison shows that the results are qualitatively the same (Appendix
SXX).


### Species richness

At the difference with dissimilarity index, we modelled species richness with
the intercept and the main effect of ecological drivers. We modelled logged species
richness with Chao index. 

$$
\begin{align}
\\ B_i &= \alpha + \beta_0Y_i + \beta_1R_i + \beta_2Y_iR_i + \beta_3H_i + \beta_4Y_iH_i + 
\\& \beta_5Y_iR_iH_i + \beta_6Y_iR_i{HD}_i +
\\& \beta_7Y_iH_i{HD}_i + \epsilon
\end{align}
$$

$$
\begin{align}
\\ \alpha&=\alpha_0 + u_{0i|j} + u_{0j}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0j}
\end{align}
$$

- where:
  - $\alpha$: intercept
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin

### Total abundance

In the dataset, total abundance was described as raw count, counts by $100m^2$,
CPUE, and Leslie index representing respectively XX% of the sites. To account
for this hererogeneity, we included the unit of measurement as a main affect
explaining total abundance but also as an interaction with the year effect, in a
similar way than previous studies [@klink_meta-analysis_2020].  Similar to
species richness modelling, we modelled the log of total abundances. 


$$
\begin{align}
\\ B_i &= \alpha + \beta_0Y_i + \beta_1U_i + \beta_2Y_iU_i + \beta_3R_i + 
\\& \beta_4Y_iR_i + \beta_5H_i + \beta_6Y_iH_i + 
\\& \beta_7Y_iR_iH_i + \beta_8Y_iR_i{HD}_i +
\\& \beta_9Y_iH_i{HD}_i + \epsilon
\end{align}
$$

where
$$
\begin{align}
\\ \alpha&=\alpha_0 + u_{0i|j} + u_{0j}
\\ \beta_{0}&=\beta_0 + u_{0i|j} + u_{0j}
\end{align}
$$

- where:
  - $\alpha$: intercept
  - $\beta$: slope
  - $u$: random effect
  - $i$: site 
  - $j$: basin
  - $U$: abundance unit


### Implementation

All the statistical models were computed in R with the `glmmTMB` package. In
order to facilitate the comparison of the effects, the reported slope
coefficients were standardised as $r_\delta = \beta \dfrac{\s_x}{\s_y}$, $\beta$
being the unstandardised slope, $s_x$ and $s_y$ respectively the standard
deviation of the explicative and response variable. 

### Estimation of fixed effects for each level of random effects (TO UPDATE)

The fixed effect coefficients for each level of random effects were computed as
sum of the random effects and its corresponding fixed effects, known as BLUPs
(Best Linear Unbiased Predictions, `coef.merMod` in R). However, the associated 
standard errors and confidence intervals are not computable on BLUPs. As an
example, it means that while we are able to compute the temporal trends as each
site and basin, those temporal trends have no associated errors.

```{r}
tar_load(site_no_drivers_inla_tot)
```

The estimated temporal trends of total abundance were corrected according to
abundance units, with the estimated fixed effect from the model.

## Cluster analysis

```{r}
kmeans_opt_nb_gr_sil_cap <- "Objective function value according to the
proportion of outliers data trimmed and the number of cluster(colored lines). Up
to 6 cluster, the proportion of trimmed data does not change the ranking of the clustering. We chose to stick with 6 clusters with a removal 0.05 of the outliers"
```

```{r cl-curv, fig.cap=kmeans_opt_nb_gr_sil_cap, fig.height=7, include=FALSE}
plot(clust_curv_site)
```

```{r}
kmeans_sites <- "Distribution of the sites in discriminant space, colored by
their cluster assignement (left). Stilhouette profile. Black points represent sites that have been trimmed
at the 5% threshold."
```

```{r cl-p, fig.cap=kmeans_sites, include=FALSE}
plot(discr_k6_fac_1)
```

Site were clustered based on the temporal trends of biodiversity facets using
trimmed robust cluster method [@fritz_tclust_2012]. Temporal trends were scaled but not
centered before clustering.  According to the optimal function, the optimal
number of clusters was between 6 and 8 (Fig. \@ref(fig:cl-curve)). We used 25 starting
positions and a maximum of 100 iterations. We trimmed 5% of outliers in the
multidimentional space. We set cluster assignement as NA for sites that had an
assignement improvement of 50% in another cluster. Clustering was computed with
`tclust` R package. 

# Results

## Temporal trends of biodiversity facets and its drivers



```{r mod-slp-std, include=FALSE}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")

pal <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
pal2 <- palette_coolors("https://coolors.co/palette/01befe-ffdd00-ff7d00-ff006d-adff02-8f00ff")

tar_load(c(gaussian_inla_exo_std_effects, gaussian_inla_std_effects))
```

```{r}
restricted_dimension <- c(
  "hillebrand_dis_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_sp", "perc_exo_abun")
tu <- rbind( gaussian_inla_std_effects,
  gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    term = str_replace_all(term, get_model_term_replacement()),
    response = get_var_replacement()[response]
    )
```

```{r, fig.show="hide"}
library(ggbreak)
p1 <- tu %>%
  filter(facet == "main") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect() +
  scale_x_break(c(.25, .65))

p2 <- tu %>%
  filter(facet == "interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect() +
  scale_x_break(c(.10, .17))

p3 <- tu %>%
  filter(facet == "dbl_interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    legend_present = TRUE,
    xaxis_title = TRUE
    ) +
  labs(x = "Standardized coefficients")

leg_dis <- get_legend(p3 +
 guides(colour = guide_legend(nrow = 2) ) +
  theme(legend.position = "bottom")
)

fig1 <- plot_grid(
  print(p1),
  print(p2),
  p3 + theme(legend.position = "none"),
  leg_dis,
  rel_heights = c(1, 1, 1, .3),
  ncol = 1)
```

```{r, fig.height = 10}
fig1
```



```{r}
tar_load(site_no_drivers_inla)
cor_site_tps <- cor(site_no_drivers_inla,
  method = "spearman"
)
dimnames(cor_site_tps) <- map(
  dimnames(cor_site_tps),
  ~get_var_replacement()[.x]
)
#corrplot::corrplot(cor_clust, type = "upper", diag = FALSE, tl.srt = 15)
cor_p <- ggcorrplot::ggcorrplot(
  cor_site_tps, hc.order = TRUE, type = "lower",
  lab = TRUE, tl.srt = 15, legend.title = "Spearman Corr") +
theme(legend.position = c(.45, .95), legend.direction = "horizontal") +
guides(colour = guide_legend(title.position = "top"))
```



```{r}
mod_slp_std_cap <- paste0("(A) Estimated fixed effects of the gaussian models.
  Coefficients were standardized by refiting the models with scaled response and
  explicative variables. Bars represent CI at 95% computed with Wald
  approximation. (B) Interactions effects of pressures on temporal trends
  (Antagonistic or synergetic).")
```

1. Take home results
   1. Temporal dissimilarity within sites increases faster in degraded sites (long & short term)  
   1. Evidences of recovery in long-term degraded sites in term of total
      abundances and species richness, but not in term of exotic species
   1. Even in a dataset containing locations more degraded (hft 1993) than the global
     freshwater, we found that recent increases in pressure (93-09) increase
     temporal trends of exotic species percentage (not in abundance, i.e.
     meaning recent colonisation?), and a decrease of the temporal trends of
     species richness and of total abundance.
   1. Long & short term pressure interact:
     - Synergistic on dissimilarity and % of exotic species
     - Recent increase in pressure decreases the recovery of total abundance
 

1. Biodiversity facets:
   1. General: 
      1. Positive temporal trends of species richness, total abundance & very weak
         evidence for exotic species. In accordance with [@klink_meta-analysis_2020].
         We found high species recomposition over time
         [@dornelas_assemblage_2014; @blowes_geography_2019]
      1. Jaccard & Simpson based dissimilarity have the same trends everywhere, changes are driven by abundant species
      1. Community temporal changes in composition are mainly driven by turnover
         [@blowes_geography_2019]

1. Dissimilarity Temporal trends 
   - stronger along the stream gradient, long term degraded sites and in sites
     that have recently increased in degradation 
   - Evidences that long term degradation decrease the signature of stream
     gradient but not for recent degradation
   - Long-term & recent degradation have a synergistic on dissimilarity
1. Richness, abundance & exotic species
   1. More richness downstream, weak evidence for higher abundances
   1. Long-term degradation: strong evidence for higher richness, higher
      percentage of exotic species and exotic abundance but lower total
      abundance
   1. Sites that had an recent increase in degradation have overall lower total
      abundance, weak evidence for lower species richness, strong evidence for
      higher percentage of exotic species and exotic abundance
   1. Strong evidences that sites that have been degraded (long term)  
      have an higher temporal trends in richness and total abundance (recovery
      hypothesis @klink_meta-analysis_2020) but no change in exotic species 
   1. Sites that recently increase in pressure had higher temporal trends of
      percentage of exotic species, moderate evidence for temporal decrease of total
      abundance, very weak evidence for temporal decrease of species richness
   1. Long-term degraded sites had a synergistic effect with stream gradient on
      exotic species but antagonistic on total abundance
   1. Sites that recently increase in pressure had a synergistic effect with stream gradient on
      the temporal trends of species richness, total abundance, percentage of
      exotic species and exotic abundance (can't find justification for total
      abundance and species richness)
   1. Long-term degraded sites that had a short term increase in degradation leads to
      increase of temporal trends of percentage of exotic species and decrease
      of temporal trends of total abundance (no effect of richness and
      percentage of exotic abundances)



## Typology of biodiversity trends 



```{r}
color_cl_scale <- setNames(pal2, unique(site_cl_rm$cl))
```


```{r}
pca_clust_cap <- "PCA biplot on site temporal trends (model without
drivers). The sites are colored by their cluster belongings."
```

```{r}
tar_load(c(pca_clust, site_cl_rm))
pca_clust <- compute_rotated_pca(site_no_drivers_inla_tot, naxis = 5)
p_rotated_pca_clust <- my_pca_plot(
  pca_clust$rotated,
  replace_var = get_var_replacement())
```
```{r}
tar_load(p_pca_clust)
p_pca_clust <- plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80
   )
```

```{r pca-cor-tps, fig.cap=pca_clust_cap, fig.height=8}
axis_l <- list(
  c("RC1", "RC2"),
  c("RC1", "RC3"),
  c("RC1", "RC4"),
  c("RC1", "RC5"),
  c("RC2", "RC3"),
  c("RC2", "RC4"),
  c("RC2", "RC5"),
  c("RC3", "RC4"),
  c("RC3", "RC5"),
  c("RC4", "RC5")
)
p_pca_cl_ell <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 3.5
   ) +
 theme(legend.position = "bottom") +
 scale_color_manual(values = color_cl_scale)
)
leg_cl <- get_legend(p_pca_cl_ell[[1]])
p_pca_cl_ell <- map(p_pca_cl_ell, ~.x + theme(legend.position = "none"))

p_pca_cl_top <- plot_grid(plotlist = p_pca_cl_ell[c(1, 5, 6, 7)], nrow = 2)
p_pca_cl_bt <- target_bp_cl_dist(cl_obj = site_cl_rm) +
  scale_fill_manual(values = color_cl_scale) +
  scale_color_manual(values = color_cl_scale) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))

plot_grid(
  p_pca_cl_top,
  p_pca_cl_bt,
  nrow = 2,
  rel_heights = c(1, .5)
)

```

1. PCA analysis shows 4 independant dimensions: (Figure 2)
  - Dissimilarity, Species richness, Exotic species, Total abundance
  - Confirms the choice of variable in figure 1
1. Cluster results: (Figure 2)
  1. Average (positive temporal trends of richness and abundance,  average
     species composition)
  1. High turnover
  1. Temporal increase in species richness
  1. Temporal decrease in total abundance
  1. Temporal decrease in species richness
  1. No change
1. Spatial scale of change (Figure 3):
   - Realms vary little in term of cluster composition
   - Site variance on temporal trends is twice higher the one of basin,
     indicating that spatial heterogeneity happens at low spatial scale


```{r}
site_cl_rm_loc <- site_cl_rm %>%
  select(siteid, cl) %>%
  left_join(loc, by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia")) %>%
  left_join(
    measurement_exo %>%
      distinct(siteid, basin_name),
    by = "siteid")

n_clust_basin <- site_cl_rm_loc %>%
  group_by(ecoregion, country, basin_name) %>%
  summarise(
    n = n(),
    div = length(unique(cl)),
    evenness = ifelse(div == 1, 1, diversity(table(cl)) / log(div))
  )

basin_name_palearctic <- n_clust_basin %>%
  filter(ecoregion == "Palearctic", div == 6) %>%
  arrange(desc(n), desc(evenness))
#Derwent.UK, Loire, Seine

fq_pal_bas <- site_cl_rm_loc %>%
  filter(basin_name %in% c("Derwent.UK", "Umealven", "Seine")) %>%
  group_by(basin_name, cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq)) %>%
  ungroup()

fq_pal <- site_cl_rm_loc %>%
  filter(ecoregion == "Palearctic") %>%
  group_by(cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq), basin_name = toupper("Palearctic")) %>%
  ungroup()

fq_tab <- rbind(
  fq_pal, fq_pal_bas
)

get_fq_tab_from_basin <- function(
  x = site_cl_rm_loc,
  ecoregion = NULL,
  basins = NULL) {

  fq_pal_bas <- x %>%
    filter(basin_name %in% basins) %>%
    group_by(basin_name, cl) %>%
    summarise(freq = n()) %>%
    mutate(pc = prop.table(freq)) %>%
    ungroup()

  ecoregion2 <- ecoregion# to not mess up filter
  fq_pal <- site_cl_rm_loc %>%
    filter(ecoregion == ecoregion2) %>%
    group_by(cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = toupper(ecoregion)
      ) %>%
    ungroup()

  fq_tab <- rbind(fq_pal, fq_pal_bas) %>%
    mutate(
      basin_name = factor(
        basin_name, levels = c(toupper(ecoregion), basins)),
      ecoregion = ecoregion
    )
  return(fq_tab)

}

basin_name_palearctic <- n_clust_basin %>%
  filter(ecoregion == "Nearctic", div >= 5) %>%
  arrange(desc(n), desc(evenness))

tab_palearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Palearctic",
  basins = c("Seine", "Derwent.UK", "Umealven")
)

tab_nearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Nearctic",
  basins = c("Mississippi", "Saint.Laurent", "Columbia")
)



basin_name_australasia <- n_clust_basin %>%
  filter(ecoregion == "Australasia", div >= 5) %>%
  arrange(desc(n), desc(evenness))

tab_australasia <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Australasia",
  basins = c("Murray.Darling", "Brisbane", "Logan")
)

tot_tab <- rbind(
  tab_palearctic,
  tab_nearctic,
  tab_australasia) %>%
  group_by(basin_name) %>%
  mutate(
    total_n = sum(freq)) %>%
  ungroup() %>%
  arrange(ecoregion, total_n) %>%
  mutate(
    basin_name_n = paste0(basin_name, " (", total_n, ")"),
    basin_name_f = factor(basin_name_n, levels = unique(basin_name_n))
  )
```

```{r}
p_tot_tab <- tot_tab %>%
  ggplot(aes(x = pc, y = basin_name_f, fill = as.factor(cl))) +
  geom_col() +
  labs(x = "Proportion") +
  scale_x_continuous(expand = c(0, 0)) +
  theme_cowplot() +
  theme(axis.title.y = element_blank(), legend.position = "none") +
  facet_grid(rows = vars(ecoregion), scale = "free_y") +
  scale_fill_manual(values = color_cl_scale)
```



```{r}
tar_load(rivers10)
world_site_sf$cl <- world_site_sf$site %>%
    left_join(site_cl_rm[, c("siteid", "cl")], by = "siteid") %>%
    mutate(cl = relevel(as.factor(cl), ref = 1))

main_map <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3) +
  scale_fill_manual(values = color_cl_scale) +
  theme(legend.position = "none")

main_map4zoom <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 5) +
  scale_fill_manual(values = color_cl_scale) +
  theme(legend.position = "none")

zoom_map <- list(
  north_am = "USA",
  eng = "GBR",
  south_eu = c("FRA", "ESP", "BEL"),
  north_eu = c("FIN", "NOR", "SWE"),
  aus = "AUS"
)

zoom_map_coord <- map(zoom_map,
  ~world_site_sf$cl %>%
    filter(country %in% .x) %>%
    st_bbox()
)

zoom_map_coord_df <- map_dfr(zoom_map_coord,
  ~setNames(as.numeric(.x), names(zoom_map_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  label = LETTERS[seq_len(length(zoom_map_coord))],
)
```

```{r}
main_map_rect <- main_map +
  geom_text(
    data = zoom_map_coord_df,
    aes(x = xmax, y = ymax, label = label),
    vjust = 0.5, hjust = 0, size = 7) +
  coord_sf(expand = FALSE) +
  theme(legend.position = "none")
save_plot(
  here("doc", "fig", "global_map.png"),
  main_map_rect,
  base_height = 3.71,
  base_asp = 2.618,
)

p_zoom_map <- map2(zoom_map_coord, zoom_map_coord_df$label,
  ~main_map4zoom +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 15, vjust = 1, hjust = 0) +
    theme(legend.position = "none")
)
```


```{r}
map_cl_cap <- "Distribution of the clusters of biodiversity trends (without
cluster being NAs). Bottom boxplots display the distribution of the biodiversity
trends (scaled) by cluster and facets. On the left is displayed the proportion
of cluster by realm for the three main ones.
"
```


```{r map-cl, fig.height=14, fig.width = 14*1.618, fig.cap=map_cl_cap}
fig3_left <- p_tot_tab
fig3_right <- plot_grid(
  main_map_rect, p_zoom_map$eng,  p_zoom_map$north_eu,
  p_zoom_map$north_am, p_zoom_map$south_eu, p_zoom_map$aus,
  ncol = 3, axis = "l"
)
fig3 <- plot_grid(fig3_left, fig3_right, ncol = 2, rel_widths = c(.5, 1))
fig3

save_plot(
  here("doc", "fig", "fig3_left.png"),
  fig3_left,
  base_height = 3.71,
  base_asp = 2.618,
)
save_plot(
  here("doc", "fig", "fig3_right.png"),
  fig3_right,
  base_height = 3.71,
  base_asp = 2.618,
)
save_plot(here("doc/fig/fig3.png"),
  fig3, base_height = 4, nrow = 1, ncol = 2)
```

```{r map-cl-old, eval=FALSE, fig.height=16, fig.width = 16*1.618, fig.cap=map_cl_cap}
knitr::include_graphics(here("doc/fig/map_cluster.png"))
```

1. Low scale heterogeneity: 
    - Cluster distribution is similar across ecoregion
    - Variability on temporal trends is twice higher on site than basin: low scale
      heterogeneity

# Discussion 

1. We find in average an increase in species richness, total abundance and
   dissimilarity:
   - in accordance with @klink_meta-analysis_2020, @dornelas_assemblage_2014,
     @blowes_geography_2019
   - Dissimilarity mainly due to change in species composition and abundant
     species
1. Stream gradient and human pressure drive temporal changes 
   1. Downstream areas becomes more dissimilar than upstream, by higher changes
     in species identity [REF] 
   1. Most degraded have higher increase in species richness, dissimilarity and
     appearance [REF]
   1. Recent increase in degradation decresase species richness but increase
      dissimilarity
1. Interactions between pressures
   1. Long-term and short term increase in human pressure counteract effect of
      stream gradient
   1. Synergistic effects of long-term and short term pressures on change in
      species identity
1. Clusters reveals that scenarios of biodiversity change are driven by few
   variables: change in species composition, total abundance and species
   richness
1. High local heterogeneity in biodiversity changes:
   - Same cluster composition by realms 
   - In contrast with @blowes_geography_2019, @klink_meta-analysis_2020
   - Due to freshwater systems?

# References {-}

<div id="refs"></div>

# (APPENDIX) Appendix {-} 

```{r, fig.show = "hide"}
tu_full <- rbind(gaussian_inla_std_effects,
  gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  mutate(
    term = str_replace_all(term, get_model_term_replacement()),
    response = get_var_replacement()[response]
    )

p1_f <- tu_full %>%
  filter(facet == "main") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect() +
  scale_x_break(c(.21, .5))

p2_f <- tu_full %>%
  filter(facet == "interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect()

p3_f <- tu_full %>%
  filter(facet == "dbl_interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    legend_present = TRUE,
    xaxis_title = TRUE
    ) +
  labs(x = "Standardized coefficients")

leg_dis_f <- get_legend(p3_f +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 4))
)

figS1 <- plot_grid(
  print(p1_f),
  print(p2_f),
  p3_f + theme(legend.position = "none"),
  leg_dis_f,
  rel_heights = c(1, 1, 1, .2),
  ncol = 1)
```

```{r std-tot, fig.height = 12}
 figS1
```


## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>

