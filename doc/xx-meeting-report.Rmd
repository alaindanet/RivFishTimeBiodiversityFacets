---
title: "Meeting report"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
bibliography: "bibliography.bib"
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
knitr::opts_chunk$set(cache = TRUE)
library(skimr)
library(dotwhisker)
library(broom.mixed)
library(ggeffects)
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, analysis_dataset, modelling_data))
tar_load(c(rigal_trends, var_temporal_trends))
names(rigal_trends) <- var_temporal_trends
```
# Introduction 

## Why do we want to assess community changes ?

- Global changes have affect a tremendous effect communities
- Understanding assembly and disassembly rules
- Give a more complex and complete picture of what is going on ?

## Documenting community changes

- Many papers report  temporal trends of local species richness and turnover
  - Abundance [@klink_meta-analysis_2020]
  - Species richness and or turnover: [@vellend_global_2013, @dornelas_assemblage_2014, @blowes_geography_2019]
  - They describe basically no trends in species richness but high turnover  
  - Species turnover vary a lot according to geography and taxons
    [@blowes_geography_2019]
  - Species turnover (as opposite of nestedness [@baselga_temporal_2013]) has
    been reported to be the major change, i.e. change in species identity, which
    is coherent with the absence of species richness trends  

## Research gap

- Biodiversity trends are all about geographical variation, i.e. few ecological drivers are involved

## Research questions 

### Drivers of temporal changes 

- What are the drivers of community changes ?
  - Climate change: more appearance and disappearance in the upper basin
  - More species turnover far from the source because of dispersal ability

```{r}
cap_turn <- paste0(
  "The hypothesis is that sites located at the middle of the stream network
  will experience the more composition change through time because of two
  opposites constraints. Climate change is expected to drive species upward in
  the stream network but an opposite constrain gathered into hydrological
  contrain, such as water flowand obstacles to migration will restrain the
  upward migration. The sum of those constrains is hypothesized to result in a
  quadratic relationship between jaccard turnover and distance from source.")
```


```{r, fig.cap=cap_turn}
knitr::include_graphics(here::here("doc/fig/turnover_hyp.png"))
```

### Within and basin scale 

- Temporal homogeneization at the basin scale?

```{r}
dis_cap <- paste0("If sites within basin becomes more dissimilar from their
  reference (first year of observation), we
  should observe at the same time an homogeneization of sites at the basin scale")
```

```{r, fig.cap=dis_cap}
ggplot(tibble(x = c(0, .1)), aes(x)) +
  stat_function(fun = function(x) x, geom = "line") +
  labs(
    x = "Average temporal dissimalitiry within basin",
    y = "Temporal similarity at the basin scale"
  )
```


- Product:
  - Map of temperature and distance to effect on turnover by basin ?

## Fish freshwater in streams 

- Streams are a good model to study turnover:  
  - They are spatially delimited at the basin level
  - Stream fishes are strongly constrained by hydrological constrains, which are
    highly variable at a small spatial scale, making possible to ecological
    drivers at multiple places, here the basin scale.

# Methods

## Data selection

- Unique protocol and unique unit of abundance by site
- One sampling by year and site
- In each site, samplings should be in the median (more or less one month and half, i.e. 1.5 month)
- 5 samplings by site, span 10 years 

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

```{r}
fig_sites <- paste0(
  "Australia absence because span is superior to 10 years of 100s of sites but number of samplings < 10.")
```

```{r, fig.cap=fig_sites}
world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  st_transform(crs = 4326)
bb <- st_bbox(loc)
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
#    coord_sf(xlim = bb[c("xmin", "xmax")],
#      ylim = bb[c("ymin", "ymax")], 
#      datum = 4326, expand = TRUE) +
    theme(legend.position = "bottom") +
    labs(title = paste0("Number of sites: ", nrow(loc)))
```

## Biodiversity

### Quantity

- Hill numbers 
  - $H^0$: Species richness 
  - $H^1$: Shannon
  - $H^2$: Simpson

We used also hill numbers with coverage-based correction proposed by
@chao_coverage-based_2014

- Evenness:
  - Pielou: $J = H^1 / log(S)$ 


```{r}
skim(analysis_dataset, starts_with("chao_"), "species_nb", "shannon", "simpson",
"evenness")
```

### Betadiversity 

Betadiversity metrics compares the composition of two communities. In our case, we
compare the composition of each time step relatively to the baseline, i.e. the
first year of sampling. 

- Species exchange index: [@hillebrand_biodiversity_2018]
  - Presence-absence: $J = SER_r = \dfrac{S_{imm} + S_{lost}}{S_{tot}}$
  - Relative abundance: $SER_a = \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}$ 

  - $S_{imm}$, $S_{lost}$, $S_{tot}$: number of immigrant, lost and total species respectively
  - $i$: species $i$, $p$: relative abundance, $\prime$: second community
  - $J$: Jaccard index

Turnover metrics based on presence/absence can be decomposed in
appearance/disappearance and nestedness / turnover.

- appearance: $\dfrac{S_{imm}}{S_{tot}}$, disappearance: $\dfrac{S_{lost}}{S_{tot}}$

- Turnover: $J_t = \dfrac{2 * min(S_{lost}, S_{imm})}{S_{common} + (2 * min(S_{lost}, S_{imm})}$
- Nestedness: $SER_r - J_t$

```{r}
skim(analysis_dataset, "jaccard", "turnover", "nestedness", "appearance",
  "disappearance", "hillebrand")
```

# Environment

##

```{r}
tar_load(riveratlas_site)
riv <- riveratlas_site %>%
  select(all_of(c("siteid", setNames(get_river_atlas_significant_var(), NULL)))) %>%
  mutate(across(starts_with("tmp_"), ~.x / 10)) %>%
  st_drop_geometry()
```

```{r}
riv %>%
  rename(get_river_atlas_significant_var()) %>%
  pivot_longer(cols = -siteid, names_to = "variable", values_to = "values") %>%
  ggplot(aes(x = values)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free")
```
```{r}
tar_load(pca_riv_str)

p <- plot_rotated_pca(pca_riv_str)
p$rotated
```


# Statistical analysis 

```{r}
skim(modelling_data)
```


## Species composition change

In each site and at each sampling point, we computed the dissimilarity (Jaccard,
Appearance, Disappearance, Turnover & Nestedness) between the time step and the
reference time, i.e. the first year of sampling. Regarding 
the reference time step, there are two different strategies. First is to include it,
i.e. setting a dissimilarity of 0 at each beginning of a time series
[@blowes_geography_2019]. Another strategy is to exclude the first year from the
analysis [@dornelas_assemblage_2014]. The first option logically constrains the analysis
toward increasing dissimilarity as the second can capture recovery from
perturbation soon after the first samplings. I guess that the first option makes
more sense more it removes to sensibility to community changes happening just
after the references year.

## Model 

- Simple lm by site

- Model all in one: 

### Turnover

Jaccard similarity, nestedness and turnover were modelled in two ways, Beta and
gaussian regression. Beta regressions are more appropriate for distribution
borned by [0,1] and are linearized by a logit link. Logit links have the
cons that coefficients are less easy to interpret. So we run both gaussian and
beta regressions and investigate the relationship among coefficients of those
type modelling types. Values of turnover were slightly transformed such as
values of one and zero to fit beta regression requirements 
($x' = \dfrac{x \times (N - 1) + 0.5}{N}$).

The model is defined like this: 

```{r}
paste0(
  "jaccard_scaled ~
  0 + year_nb * scaled_dist_up_km +
  (0 + year_nb | main_bas/siteid) +
  (0 + year_nb | span) +
  (0 + year_nb:scaled_dist_up_km | main_bas)"
)
```

- `year_nb`: number of year since the beginning of the monitoring (site scale) 
- `scaled_dist_up_km`: Distance from the source (centered and scaled)

- `main_bas`: Hydrographic basin
- `siteid`: site 
- `span`: Number of years between the end and the beginning of the monitoring

Our objective was to assess the temporal turnover and its ecological drivers. We
set intercept to equal 1.0 because year_nb = 0 at the beginning of each series,
jaccard is always equal to 1.0. We estimated the effects of the basin and of the
site on the temporal trends (`0 + year_nb | main_bas/siteid`), the site effect
being nested in the basin effect. We also evaluated the effects of span on the
temporal trends, because it is generally expected that longer timeseries
displays stronger temporal trends.  Finally, we acknowledged that the effect of
the distance from source can be different among basin.

# Results

## Direction of trends 

```{r}
tar_load(var_analysis)
ti <- map_dfr(rigal_trends, ~tabyl_df(x = .x, group = "direction"),
  .id = "response"
)
ti %>%
  filter(direction != "Total", response %in% var_analysis) %>%
  select(response, direction, percent) %>%
  mutate(response = str_replace_all(response, get_var_replacement())) %>%
  pivot_wider(names_from = "direction", values_from = "percent") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```

```{r}
ti <- map_dfr(rigal_trends, ~tabyl_df(x = .x, group = "shape_class"),
  .id = "response"
)

ti %>%
  filter(shape_class != "Total") %>%
  select(response, shape_class, percent) %>%
  mutate(response = str_replace_all(response, get_var_replacement())) %>%
  pivot_wider(names_from = "shape_class", values_from = "percent") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```


## Average

```{r}
slope <- map_dfr(rigal_trends,
  ~.x %>%
  select(siteid, linear_slope),
.id = "response"
)
```

```{r}
rigal_trends_df <-  map2_dfr(
  rigal_trends, names(rigal_trends),
  ~.x %>% mutate(variable = .y)
  ) %>%
select(variable, siteid, linear_slope) %>%
pivot_wider(names_from = "variable", values_from = "linear_slope")
```


```{r}
summary_slope <- slope %>%
  filter(response %in% var_analysis) %>%
  group_by(response) %>%
  summarise(summ = list(enframe(summary_distribution(linear_slope, na.rm = TRUE)))) %>%
  unnest(cols = summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  select(response, mean, median, sd)
summary_slope %>%
  mutate(response = get_var_replacement()[response]) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover")) %>%
  scroll_box(width = "100%", height = "1000px")
```
```{r, include=FALSE}
j_med_tr <- summary_slope[summary_slope$response == "jaccard", ]$median
r_med_tr <- summary_slope[summary_slope$response == "log_species_nb", ]$median

```

```{r}
p_jt_sup_ne <- sum(abs(rigal_trends_df$turnover) > abs(rigal_trends_df$nestedness)) /
  nrow(rigal_trends_df)
```
```{r, include=FALSE}
cor(rigal_trends_df$hillebrand, rigal_trends_df$jaccard, method = "spearman")
cor(rigal_trends_df$hillebrand, rigal_trends_df$evenness, method = "spearman")
```

- To compare with @dornelas_assemblage_2014:
  - Species richness:
    - @dornelas_assemblage_2014: 1557 measurements of species richness in two
      consecutive times, 629 (40%) increase, 624 (40%) decrease, and 304 (20%)
      do not change.
    - Our study: 13% increase, 7% decrease, 78% do not change, 
      median: + `r percent(r_med_tr * 10)` species by decade (i.e from 2 to 3
      species, 10 to 15 species in 10 years)
  - Jaccard:
    - 10% species replaced per decade [@dornelas_assemblage_2014] 
    - 28% of species replaced per decade [@blowes_geography_2019]
    - our study: `r percent(abs(j_med_tr) * 10)` of species per decade
  - Turnover / nestedness:
    - @blowes_geography_2019: 97% of study shows turnover exceeding nestedness
    - our study: `r percent(p_jt_sup_ne)`
  - Jaccard vs dominance-based SER:
    - low correlation: $0.52$


```{r}
tar_load(mod_tps_comp)
plot(mod_tps_comp)
```


```{r}
rigal_trends_df %>%
  ggplot(aes(x = jaccard , y = hillebrand)) +
  geom_point() +
#  geom_smooth(method = "gam") +
  labs(x = "Jaccard trends (similarity, binary)", y = "Hillebrand trends
    (similarity, relative abundance)")
```

```{r}
rigal_trends_df_loc <- filtered_dataset$location %>%
  left_join(rigal_trends_df, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```

## Relationships between temporal trends 

```{r}
knitr::include_graphics(here("doc", "fig", "p_cor_slope_tot.png"))
```


```{r, fig.height=12}
ti <- expand.grid(
  resp1 = unique(slope$response),
  resp2 = unique(slope$response)
  ) %>%
  filter(resp2 != resp1) %>%
  filter(
    resp1 %in% c("chao_richness", "species_nb", "log_species_nb",
      "total_abundance", "log_total_abundance")) %>%
  mutate_all(as.character) %>%
  arrange(resp1)

test <- map2(ti$resp1, ti$resp2,
  function(x, y) {
    bi <- slope %>%
      filter(response %in% c(x, y)) %>%
      select(siteid, response, linear_slope) %>%
      pivot_wider(names_from = "response", values_from = "linear_slope")

    return(bi)
  }
)

p_trends_trends <- map(test, function(x) {
  l <- colnames(x)
  x %>%
    ggplot(aes(x = !!sym(l[2]), y = !!sym(l[3]))) +
    geom_point() +
    geom_smooth(method = "loess") +
    labs(
      x = get_var_replacement()[l[2]],
      y = get_var_replacement()[l[3]]
    )
})
names(p_trends_trends) <- map_chr(test, ~colnames(.x)[2])
```

```{r, fig.height=12}
plot_grid(
  plotlist = p_trends_trends[names(p_trends_trends) %in% "log_species_nb"],
  ncol = 3
)
```

## Spatial trends


## Rarity

Cf other document

## Spatial scale

- Selection on basin data 

## Environment

### PCA

```{r}
library(ade4)
library(factoextra)
tar_load(rigal_slp_df)
slope_df <- rigal_slp_df
```

```{r}
res.pca <- dudi.pca(select(slope_df, -siteid),
  scannf = FALSE,   # Hide scree plot
  nf = 5            # Number of components kept in the results
)
```

```{r}
fviz_eig(res.pca)
```

```{r, fig.height = 12}
p_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),
  ~fviz_pca_var(res.pca,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

plot_grid(plotlist = p_pca, ncol = 1)
```

#### Environment


```{r}
riv_data_pca <- riv %>%
  select(-siteid) %>%
  mutate(across(c(dist_up_km, dis_m3_pyr, urb_pc_cse, ele_mt_cav, pac_pc_cse),
      ~log(.x + 2))
  ) %>%
  rename(get_river_atlas_significant_var()) %>%
  na.omit()
pca_riv <- dudi.pca(df = scale(riv_data_pca), scannf = FALSE, nf = 3)
```

- We see two main axis (as I found in France):
  - First axis related to stream size (distance from source, River area)
  - Second axis related to Temperature 

```{r}
fviz_eig(pca_riv)

p_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),
  ~fviz_pca_var(pca_riv,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

p_pca[[1]]
p_pca[[2]]
p_pca[[3]]
```
#### Environment - Trends

```{r}
tar_load(slp_env)
slp_env_for_pca <- slp_env %>%
  select(-all_of(c("siteid", "main_bas", "ecoregion", "geometry"))) %>%
  rename(get_river_atlas_significant_var())
slp_env_for_pca$geometry <- NULL
  
pca_slp_env <- dudi.pca(
  df = scale(na.omit(slp_env_for_pca)),
  scannf = FALSE, nf = 3)
```

```{r}
p_slp_env_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),

  ~fviz_pca_var(pca_slp_env,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

p_slp_env_pca[[1]]
p_slp_env_pca[[2]]
p_slp_env_pca[[3]]
```



## Model

### Jaccard 

```{r}
tar_load(c(gaussian_jaccard_tmb, beta_jaccard_tmb))
```

```{r}
tidy_gaus_jy  <- gaussian_jaccard_tmb %>%
  filter(year_var == "year_nb") %>%
  .$mod
names(tidy_gaus_jy) <- gaussian_jaccard_tmb[
  gaussian_jaccard_tmb$year_var == "year_nb",
  ]$var_jaccard
dw <- dwplot(tidy_gaus_jy,
  vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)) +
  xlab("Coefficient")
dw
```


```{r}
diagnose(gaussian_jaccard_tmb$mod[[1]])
diagnose(gaussian_jaccard_tmb$mod[[3]])
diagnose(gaussian_jaccard_tmb$mod[[5]])
```


```{r}
pred <- ggemmeans(gaussian_jaccard_tmb$mod[[1]],
  terms = c("year_nb", "scaled_dist_up_km [quart2]"),
  type = "re")
plot(pred)

pred <- ggemmeans(gaussian_jaccard_tmb$mod[[3]],
  terms = c("year_nb", "scaled_dist_up_km [quart2]"),
  type = "re.zi")
plot(pred)

pred <- ggemmeans(gaussian_jaccard_tmb$mod[[5]],
  terms = c("year_nb", "scaled_dist_up_km [quart2]"),
  type = "re.zi")
plot(pred)
```

- Map:

```{r}
hist(coef(gaussian_jaccard_tmb$mod[[1]])$cond[["siteid:main_bas"]]$year_nb)
hist(coef(gaussian_jaccard_tmb$mod[[1]])$cond[["main_bas"]]$year_nb)
```

```{r}
tar_load(filtered_dataset)
loc <- filtered_dataset$location %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
world <- ne_countries(scale = "medium", returnclass = "sf")
```

```{r}
pred_slope <- gaussian_jaccard_tmb %>%
  mutate(
    site_slope = map(mod, function(m) {
      coef(m)$cond[["siteid:main_bas"]] %>%
        rownames_to_column(var = "siteid_main_bas") %>%
        separate(
          col = "siteid_main_bas",
          into = c("siteid", "main_bas"),
          sep = ":") %>%
        select(-main_bas)
    }),
    basin_slope = map(mod, function(m) {
      coef(m)$cond[["main_bas"]] %>%
        rownames_to_column(var = "main_bas") 
    }),
  ) %>%
select(-mod)
pred_slope$basin_slope[[1]] %>%
  as_tibble()

pred_slope <- pred_slope %>%
  mutate(
    sf_site = map(site_slope,
      ~left_join(.x, select(loc, siteid, geometry), by = "siteid") %>%
        st_as_sf()
      ),
    sf_basin = map(basin_slope,
      ~left_join(.x, loc %>%
        mutate(main_bas = as.character(main_bas)) %>%
        select(main_bas, geometry), by = "main_bas") %>%
        st_as_sf()
      ),
    sf_site_map = map2(sf_site, year_var,
      ~ggplot(data = world) +
        geom_sf() +
        geom_sf(data = .x, aes(color = year_nb), shape = 16) +
        scale_color_viridis() +
        theme(legend.position = "bottom")),
    sf_basin_map = map2(sf_basin, year_var,
      ~ggplot(data = world) +
        geom_sf() +
        geom_sf(data = .x, aes(color = year_nb), shape = 16) +
        scale_color_viridis() +
        theme(legend.position = "bottom"))
  )
```

#### Site

```{r}
pred_slope$sf_site_map[[1]] +
  labs(title = "Jaccard")

pred_slope$sf_site_map[[3]] +
  labs(title = "Turnover")

pred_slope$sf_site_map[[5]] +
  labs(title = "Nestedness")
```

#### Basin

```{r}
pred_slope$sf_basin_map[[1]] +
  labs(title = "Jaccard")

pred_slope$sf_basin_map[[3]] +
  labs(title = "Turnover")

pred_slope$sf_basin_map[[5]] +
  labs(title = "Nestedness")
```

## Species richness

```{r, eval = FALSE}
tar_load(gaussian_rich_tmb)

lry <- gaussian_rich_tmb$mod[[5]]
cry <- gaussian_rich_tmb$mod[[1]]
```



```{r}
knitr::opts_chunk$set(eval = FALSE)
```


```{r, eval=FALSE}
paste0(var_temporal_trends,
  " ~ ",
  "dist_up_km + tmp_dc_cyr +
  (1 + dist_up_km + tmp_dc_cyr | main_bas)"
) %>%
as.formula
```

```{r}
library(spaMM)
tar_load(c(trend_env))
names(trend_env) <- var_temporal_trends
```

```{r}
ti_trends <- map(var_temporal_trends,
  ~fitme(
  as.formula(paste0("scale(", .x, ") ~ dist_up_km + tmp_c_cyr + (1 | main_bas)")),
  data = slp_env[,
    colnames(slp_env) %in%
    c(.x, "siteid", "dist_up_km", "tmp_c_cyr", "main_bas", "ecoregion")
  ]
  )
)
names(ti_trends) <- var_temporal_trends
```

```{r}
ci <- map_dfr(ti_trends[names(ti_trends) %in% c("log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand")], function(v) {
  x <- confint(v, c("dist_up_km", "tmp_c_cyr"), verbose = FALSE)
  tmp <- map_dfr(x, function(x) {
    tm <- x$interval
    names(tm) <- c("lower", "upper")
    return(tm)
  }, .id = "parm"
  )
  return(tmp)
}, .id = "response")
ci %>%
  kable(.,
    caption = "Confidence interval (bootstrap)")
```

```{r}
from_data_to_predict <- function(
  model_list = NULL,
  dataset = NULL,
  re = NULL
) {

  pred <- na.omit(dataset)
  for (i in seq_along(names(model_list))) {
    tmp <- predict(model_list[[i]],
      re.form = as.formula(re),
      intervals = "predVar"
      )[,1]
    names(tmp) <- NULL
    pred[[names(model_list)[i]]] <- tmp
  }
  return(pred)
}
```

```{r, eval = FALSE}
xx <- list(
    tmp_c_cyr = seq(min(na.omit(slp_env$tmp_c_cyr)), max(na.omit(slp_env$tmp_c_cyr)), length.out = 10),
    dist_up_km = seq(min(na.omit(slp_env$dist_up_km)), max(na.omit(slp_env$dist_up_km)), length.out = 10),
    main_bas = unique(na.omit(slp_env$main_bas))
)
new_data <- expand.grid(xx) %>%
    as_tibble()
pred <- predict(ti_trends[[1]], newdata = new_data, re.form = re, intervals="predVar")
int <- cbind(pred[,1], attr(pred, "intervals")) %>%
    as_tibble() %>%
    rename(y = V1)
```
```{r, eval = FALSE}
xxx <- cbind(int, new_data) %>%
    as_tibble
xxx %>%
    ggplot(aes(y = y, x = dist_up_km, color = main_bas)) +
    geom_point() +
    theme(legend.position = "none")
```



```{r}
re <- paste0("~ tmp_c_cyr + (1 | main_bas)")
pred_tmp <- from_data_to_predict(
  model_list = ti_trends,
  dataset = slp_env,
  re = re
)
p_tmp <- map(
  c(
      "log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand"),
  function(x) {
    pred_tmp %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_c_cyr,
          color = main_bas
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp, ncol = 3)
```

```{r}
re <- paste0("~ dist_up_km + (1 | main_bas)")
pred <- na.omit(slp_env)
for (i in seq_along(var_temporal_trends)) {
  tmp <- predict(trend_env[[i]],
    re.form = as.formula(re)
    )[, 1]
  names(tmp) <- NULL
  pred[[var_temporal_trends[i]]] <- tmp
}
p <- map(
  c("log_total_abundance", "log_species_nb", "jaccard",
      "appearance", "disappearance", "turnover",
      "nestedness", "hillebrand"),
  function(x) {

    pred %>%
      ggplot(aes(
          y = !!sym(x),
          x = dist_up_km,
          color = as.factor(main_bas),
          shape = as.factor(ecoregion)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p, ncol = 3)
```

```{r}
re <- paste0("~ tmp_dc_cyr + (1 | main_bas)")
pred_tmp <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
p_tmp <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {
    pred_tmp %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_dc_cyr,
          color = as.factor(main_bas)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp, ncol = 3)
```

- Ecoregion:

```{r}
re <- paste0("~ dist_up_km + (1 + dist_up_km | ecoregion)")
pred_dist_ecoregion <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
```

```{r}
p_dist_ecoregion <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {

    pred_dist_ecoregion %>%
      ggplot(aes(
          y = !!sym(x),
          x = dist_up_km,
          color = as.factor(ecoregion)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_dist_ecoregion, ncol = 3)
```

```{r}
re <- paste0("~ tmp_dc_cyr + (1 + tmp_dc_cyr | ecoregion)")
pred_tmp_ecoregion <- from_data_to_predict(
  model_list = trend_env,
  dataset = slp_env,
  re = re
)
```

```{r}
p_tmp_ecoregion <- map(
  c("log_species_nb", "jaccard", "appearance", "disappearance", "turnover", "hillebrand"),
  function(x) {
    pred_tmp_ecoregion %>%
      ggplot(aes(
          y = !!sym(x),
          x = tmp_dc_cyr,
          color = as.factor(main_bas)
          )) +
      geom_line() +
      theme(legend.position = "none")
  }
)
plot_grid(plotlist = p_tmp_ecoregion, ncol = 3)
```

## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>

# References {-}
