---
title: Biblio and research questions
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
## target knits Rmds in their own session, so load libraries here.
source(here::here("start_rmd.R"))
```

- Database to add: 
  - USGS: https://www.sciencebase.gov/catalog/item/529e0108e4b0516126f68e3c


# Introduction

## Treats on streams 

- Land-use changes: @piet_climate_2010 in Climate change ...
  - Forest vs drained = retained water vs greater run-off 
  - River morphology: canalization, lost of connection

- Climate change on stream hydrology:@piet_climate_2010
  - More variable discharge regimes (south england): higher peaks in winters
    (less winter droughts)
    - higher flow redistributes resources homogenize water chemestry 
    - lower flow: less oxygen, dried banks -> decrease stability

- Temperature and hydrological factors on fishes: @hering_monitoring_2010
  - changes of rivers discharges: decrease species richness and change life
    cycles 
  - Increasing temperature: threat to cold stenothermic species, confined in
    headwaters due to the reduction of available cold waters

```{r , fig.cap="fig/fish-trait-composition-temperature-rainfall-europe"}
knitr::include_graphics(
  here::here("doc/fig/fish-trait-composition-temperature-rainfall-europe.jpeg")
)
```

- Acidication due to emission of S and N in the atmosphere @wright_interaction_2010
  - Highest pick in the 1980's, particularly severe in scandinavia
  - Dramatic reduction after worldwide agreement on S and N emission (goal in
    1999: -50% S and -20% N in 2010 relative to 1980) 
  - increasing temperature: accelerated mineralization and increase of acidification

- Freshwater ecology: a scientific introduction
  - Get a look from chapter 5 to 10
    
- Conservation biology: to read

## Biodiversity

- Land-use change and species climatic tolerance: 
  - loss of semi-natural habitat leaded to faster declines of thermal sensitive fishes [@williams_vertebrate_2021]
  - temperature differences linked to land-use (average daily maximum temperature)

# Research questions

- Biodiversity: 
  - facets of biodiversity trends
  - Biodiversity index
  - species characteristics

- Biological scale:
  - Population: LPI
  - Community: CWM, extirpation, colonisation
  - Metacommunity: homogenization (betadiv)? 

- climatic debts:
  - [@vaughan_water_2019; @vaughan_using_2021]

1. How do community of freshwater change through time ?
   - Scale community / population
   - Quantity / Heterogeneity

# Methods

## Data selection

- Check the utility functions of `codyn`:

```{r, eval = FALSE}
source("https://raw.githubusercontent.com/NCEAS/codyn/master/R/utilities.R")
check_single_onerep
```

### Spatial scale 

### Script of [Lise to select Basin](/run/user/1000/gvfs/smb-share:server=caslab.ad.ilstu.edu,share=bio/Comte/ENV_LAYERS/Script_optimization_time_window.R)

```{r, eval=FALSE}
select_data <- continuous_data[
  continuous_data$span >= 10 & continuous_data$completeness >= 0.8,
  ]
```
- Select basin that have at least 5 sites:

```{r, eval=FALSE}
#////////////////////////////////////////
#select basins with at least 5 sites
    data_basins <- NULL
    for (oo in levels(select_data_all$ORIGIN)) {
      dat_sel <- select_data_all[select_data_all$ORIGIN == oo, ]
      tab <- table(dat_sel$MAIN_BAS)
      keep <- names(which(tab >= 5))
      data_basins <- rbind(data_basins, dat_sel[dat_sel$MAIN_BAS %in% keep, ])
    }
```

- Over the basin, find the nb of (op / sites) by year and by basin to find the
  optimal period of sampling, i.e.  max(year) - min(year) with the most
  sampling
  - Keep by basin site span 10 years of data
  - Keep by basin the year with the maximum number of sampled sites

```{r, eval=FALSE}
for (idx in 1:totalNbas) {
  select_data <- data_basins[data_basins$MAIN_BAS == ID[idx], ]

  data_summary <- NULL

  for (ii in min(select_data$begin):max(select_data$begin)) {

    for (jj in min(select_data$end):max(select_data$end)) {

      dat_sel <- select_data[select_data$begin <= ii & select_data$end >= jj, ]
      span <- jj - ii + 1

      data_summary <- rbind(
        data_summary,
        data.frame(BEG = ii, END = jj, SPAN = span, NB = nrow(dat_sel))
      )
    }
  }

  data_summary <- data_summary[data_summary$SPAN >= 10, ]
  RES <- rbind(RES, data.frame(MAIN_BAS = ID[idx], data_summary[which.max(data_summary$NB), ]))
}
```

- With the period most sampled by basin
  - Keep the basins that have at leat 5 sites in this period

```{r, eval= FALSE}
data_basins <- read.table("Segments_per_basin.txt", h = T)

select_basins <- NULL
for (idx in 1:nrow(RES)) {
  selec <- data_basins[
    data_basins$MAIN_BAS == RES$MAIN_BAS[idx] &
      data_basins$begin <= RES$BEG[idx] &
      data_basins$end >= RES$END[idx],
    ]

  if (nrow(selec) >= 5) {
    select_basins <- rbind(select_basins, selec)
  }
}
```

- By site:
  - Check that the consecutive temporal series, non consecutive if more than two
    years between two samplings 
  - Compute span and completeness for each consecutive segment of each site

```{r}
x <- seq(10)
s <- split(x, cumsum(c(TRUE, diff(x) > 2)))
s

x <- x[!x %in% c(3, 4, 5)]
s <- split(x, cumsum(c(TRUE, diff(x) > 2)))
s
sapply(s, length)
```


```{r, eval=FALSE}
continuous_data <- NULL
for (kk in 1:length(files)) {
  fishdata <- read.table(files[kk], h = T)

  fishdata$Abundances <- as.numeric(fishdata$Abundances)

  summarized_fishdata <- fishdata %>%
    group_by(sYNGEO_ID, Year) %>%
    summarise(Total_abund = sum(Abundances, na.rm = T))

  totalNsites <- length(unique(summarized_fishdata$sYNGEO_ID))
  print(c(totalNsites, length(unique(fishdata$SiteID))))
  ID <- unique(summarized_fishdata$sYNGEO_ID)

  for (idx in 1:totalNsites) {
    df <- summarized_fishdata %>%
      subset(sYNGEO_ID == ID[idx])
    site_no <- ID[idx]

    x <- df$Year
    s <- split(x, cumsum(c(TRUE, diff(x) > 2)))
    nb <- sapply(s, length)
    begin <- sapply(s, min)
    end <- sapply(s, max)
    span <- end - begin + 1
    completeness <- nb / span

    continuous_data <- rbind(
      continuous_data,
      data.frame(
        sYNGEO_ID = as.character(ID[idx]),
        # segment=rep(1:length(s)),
        begin,
        end,
        span,
        completeness,
        unique(
          chara[
            chara$sYNGEO_ID == as.character(ID[idx]) &
              chara$Origin == as.character(unique(fishdata$Origin)),
            c(1, 8, 9, 13:15)
            ]
        )
      )
    )

  }
}
```

- Check problem:
  - Check which consecutive segments has completeness inferior to 80%
  - By basin:
    - remove segments that do not repect completeness ? i.e. keep sevel several
      segements by sites ?
    - remove basin that has less than 5 sites after segments selection 
    - *Note: no selection on the length of the segements ?*


```{r, eval=FALSE}
BAS_pb <- NULL
pb <- continuous_data[which(continuous_data$completeness < 0.8), ]
pb_basin <- unique(pb$MAIN_BAS)
for (ii in pb_basin) {
  dat_pb <- read.table(files[grep(ii, files)])
  enl <- pb$sYNGEO_ID[pb$MAIN_BAS == ii]
  dat_pb <- dat_pb[-which(dat_pb$sYNGEO_ID %in% enl), ]
  aa <- nlevels(factor(dat_pb$SiteID))
  if (aa < 5) {
    BAS_pb <- c(BAS_pb, as.character(ii)) # no sites
  }
  write.table(dat_pb, files[grep(ii, files)], row.names = FALSE, sep = "\t")
}

```

```{r, eval=FALSE}
continuous_data <- continuous_data[
  -which(
    continuous_data$completeness < 0.8 | continuous_data$MAIN_BAS %in% BAS_pb
  ), ]
write.table(
  continuous_data,
  "sites_selection_basins_stability.txt", sep = "\t",
  row.names = FALSE)
```

- **Summary** (from what I believe I understood):
  1. Select sites that span at least 10 years and completeness >= 0.8
  2. Select basins that have 5 sites at least 
  3. Find optimal sampled period by basin: 
     - combination of `min(year)` and `max(year)` with the most sampling
  4. By basin
     1. select site in most sampled period
     2. select basins that have at least 5 sites
  5. Separate non consecutive segments by sites: 
    1. Select segments which have completeness > .8 
    2. Several segments by site ?
  6. Keep basin with at least 5 sites

- I am not sure that the sites are same each year in each basin with this
  selection
- What is average number of site by year?



## Environmental characteristics 

- Site protection status: 
  - US database, Australian database
  - [wdpar R package](https://prioritizr.github.io/wdpar/)

- Land use:
  - biais in studied land-use types in ecology: @martin_mapping_2012
  - from 1700 to 2000: https://ecotope.org/anthromes/v2/ 
  - Anthropogenic land use estimates for the Holocene – HYDE 3.2: -10000 to
    2015: https://essd.copernicus.org/articles/9/927/2017/essd-9-927-2017.html, https://essd.copernicus.org/articles/9/927/2017/essd-9-927-2017.html 
    - (1,000 y increments from 10,000 BCE to 1 CE, 100 y increments from 100 CE
      to 1700 CE, 10 y increments from 1710 to 1990 CE, and 1 y increments from
      2000 CE to 2017 CE). 
    - HYDE1 https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/1999GB001232 
    - Copernicus land cover 2016 to 2020: https://github.com/bluegreen-labs/ecmwfr
    - 1995 à 2015 ESA: https://catalogue.ceda.ac.uk/uuid/b382ebe6679d44b8b0e68ea4ef4b701c 

- Riveratlas: See `L://ENV_LAYERS`

- Water temperature:`L://ENV_LAYERS`

- Air temperature: chelsa

# Biodiversity

## LPI

### Get data 

#### Chain method

Chain method is for poor timeseries with (n < 6) [@collen_monitoring_2009].

$i$: a population
$j$: a species
$t$: a time step 

$d_{i,j,t} = \log_{10}(\dfrac{N_{i,j,t}}{N_{i,j,t-1}}) = \log_{10}N_{i,j,t} - \log_{10}N_{i,j,t-1}$

where $N_t$ is the abundance of a given population $i$ of the species $j$ at time $t$.

One percent of the mean population measure value for the whole time series was
added to all years in time series for which N was zero in any year. Missing
values were imputed with log-linear interpolation:

$N_t = N_p (\dfrac{N_s}{N_p})^{\dfrac{t-s}{s-p}}$ 

with $p$ the previous time step with measured value and $s$ the subsequent year
with a measured value.

#### GAM method

Set a GAM for each timeseries and report the predicted abundance values each
year. There are rules of thumbs to automatically set the smoothing parameters [see @collen_monitoring_2009].

Following, $d_{i,j,t}$ are computed with the predicted abundance values.

### LPI computation 

If a species has several populations, the annual species trends is computed as
the average[^1] of local population trends:

$d_{j,t} = \dfrac{1}{n}\sum_{i = 1}^{n} d_{i,j,t}$

It is a geometric mean because it the arithmetic mean of log transformed values of $N$: 

$\sum_{i = 1}^{n} d_{i,j,t} = \sum_{i = 1}^{n} (\log_{10}N_{i,j,t} - \log_{10}N_{i,j,t-1})$

The standardized index for a species is then computed as:

$I_{j, t} = I_{j, t - 1} 10^{d_{j,t}}$, $I_0 = 1$

### Confidence limits

Bootstrap on the selection of the $n_j$ population.

### Misc

- LPI:
  - @mcrae_diversity-weighted_2017; @capdevila_global_2021
  - [rlpi R package](https://github.com/Zoological-Society-of-London/rlpi)

#### Note on the geometric mean: @buckland_geometric_2011

- Because it measures proportional changes, low change in absolute abundance in a rare
    species can lead a big change in the geometric mean
- Based on above, the geometric is linked to eveness

How $G_t$ is linked to eveness ?

$G_t = exp(\dfrac{1}{n} \sum_{i = 1}^{n} (\log N_{i,j,t} - \log N_{i,j,t-1}))$

If we look at multicative change in species proportion:

$\dfrac{p_{i,t}}{p_{i,t-1}} = exp((\log N_{j, t} - \log N_t) - (\log N_{j, t-1} - \log N_{t-1}))$

where $N_t = \sum_{j=1} N_{j,t}$

if $n$ stays constant between $G_t$ and  $G_{t-1}$ 

If total abundances stays constant between years, i.e. $N_t = N_{t-1}$,

$\dfrac{p_{i,t}}{p_{i,t-1}} = exp(\log N_{j, t} - \log N_{j, t-1})$, then

$G_t = exp(\dfrac{1}{n} \sum_{i = 1}^{n} \log p_{i,j,t} - \dfrac{1}{n} \sum_{i = 1}^{n} \log p_{i,j,t-1})$

"The mean of the log species proportions has the key property of an evenness
measure, in that it attains its maximum value when all the species proportions
are equal: $p_{i,t} = 1/n$ for all $i$".


### Avantages

- Not biais for detectability variation between species
  - but biais if detectability change through time within species
- LPI change even if evenness stays the same (contrary to shannon and simpson)


- Linked to within-species (population) construction and reference to a baseline year:
  - no differences if units are abundance, biomass, density
  - combine trends of really different survey 

- Rescale:
  - if a new survey began in 2000, the index of 2000 for the this new survey
    should be scaled to value of the composite index of 2000 
  - if an abundant species become too rate to be included in the index, rescale
    as this: for the final year which the species is included compute the index
    with and without the species, the latter need to be rescale to match the
    former. Same rescaling is necessary for all subsequent years.

### Disaventages

- Do not work when when relative abundance is 0: 
  - one can add small numbers to 0 but the indice is sensible to the chosen
    quantity + poor precision with rarely recorded species. 
  - Shannon and Simpson are not influenced by rare species 
  - Problem can be reduced if observed count are modeled before index
    computation


### Computation 

- NA = 0 or missing values to interpolate ? It is 0 if a monitoring took place
  and that the species was missing

## Quantity index 

### Rarefaction

- @chao_coverage-based_2012: A temperate-zone tree community with 10 species might be completely
  characterized by a sample of 100 individuals, but the same size sample would
  greatly underestimate the richness of a tropical rain forest with 300 tree
  species. If we compared the richnesses of these two communities using samples
  standardized to 100 individuals, the richnesses we obtain would not give a
  meaningful idea of the real degree of difference between the communities'
  richnesses.

### Coverage-based species richness [@chao_coverage-based_2012]

- Ecologists often do rarefaction analysis but this can be really bad estimation
  and also constrains ecologists to throw data [@chao_coverage-based_2012] 

- There are theoretical expectations on the link between species richness,
  sample size and distribution of species abundance, which is used for rarefaction:
  - $E(S_m)$ = \sum_{i=1}^S [1 - (1 - p_i)^m] = S - \sum_{i=1}^S (1 - p_i)^m

- But instead, it is better to relate on the coverage of a sample rather than its size. 
  Coverage is a measure of sampling completeness. Completeness is the proportion
  of individuals in the community that belongs to the species present in the sample.
  $1 - C = C_d$, $C_d$ being the coverage deficit.

```{r}
x <- c(rep(.3, 1), rep(.1, 1), rep(.05, 3), rep(.01, 45))

# we sample 20 indiv randomly, imagine that we add the 12
#most abundant species:

sample1 <- x[1:12]
# proportion of individuals in the community that belongs to species that were
# represented in the sample:
coverage <- sum(sample1)
# proportion of individuals in the community that belongs to species that were
# NOT represented in the sample:
deficit_coverage <- 1 - coverage
```

- There is a theoretical relationship between the coverage (completeness),
  species relative abundance and sample size: 
  $E(C_m) = \sum_{i=1}^S p_i[1 - (1 - p_i)^m] = 1 - \sum_{i=1}^S p_i(1 - p_i)^m $

- Coverage can be estimated [@chao_coverage-based_2012] and then individual
  sample can be compared by bringing them to the same coverage, by rarefaction
  or extrapolation (should not go more than double than the sample size).

```{r}
# Polynome
tar_load(rigal_trends)
ti <- rigal_trends[[1]]
ti %>%
  filter(direction == "stable", linear_slope_pvalue < 0.05) %>%
  ggplot(aes(x = (exp(linear_slope) - 1) * 100)) +
  geom_histogram() +
  facet_grid(cols = vars(shape_class))
```



### Hill numbers

- Chao: [iNEXT](https://github.com/JohnsonHsieh/iNEXT), [BES paper](https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.12613) 

```{r}
library(iNEXT)
data(spider)
```

```{r}
div_spider <- iNEXT::iNEXT(spider, q = c(0, 1, 2), datatype = "abundance")
```

- Hill numbers 0 (species richness), 1 (shannon), 2 (simpson)

```{r}
ggiNEXT(div_spider, type = 1, facet.var = "site")
```

- Coverage based rarefaction/extrolation: 

```{r}
ggiNEXT(div_spider, type = 3, facet.var = "site")
```

```{r}
tar_load(filtered_dataset)
fish <- filtered_dataset$measurement %>%
  filter(
    siteid == unique(siteid)[1],
    year == 2007
  )
div_fish <- iNEXT::iNEXT(fish$abundance, q = c(0, 1, 2), datatype = "abundance")
```

```{r}
test <- filtered_dataset$measurement %>%
  filter(op_id %in% unique(op_id)[1:2])
ti <- get_chao_hillnb(
  x = test,
  coverage = .985,
  confidence_int = NULL)
```

- Coverage based rarefaction/extrolation: 

```{r}
ggiNEXT(div_spider, type = 3, facet.var = "site")
```



## Compositional changes 

- Multi-site based on presence/absence probability [@baeten_model-based_2014]
  - Based on deviance:   
    - $D_i = -2n [p_i\log(p_i) + (1-p_i)\log(1-p_i)]$
    - Omnipresent and rare species have the same contribution to the
      heterogeneity in community composition

- extirpation / colonisation:
  - Species exchange index:
    - $SER_r = \dfrac{S_{imm} + S_{lost}}{S_{tot}}$ based on presence absence
      - Implemented in [`codyn`](https://github.com/NCEAS/codyn)
    - $SER_a = \dfrac{\sum_i (p_i - p'_i)^2}{\sum_i p_i^2 + \sum_i p'_i^2 - \sum p_i p'_i}$ 
      - [See the math](https://besjournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1111%2F1365-2664.12959&file=jpe12959-sup-0005-AppendixS3.pdf)
      - Complement Jaccard index as: $J_a = 1-SER_a = S_{comm} / S_{tot}$
      - Here diversity is measured with the Simpson index: $\lambda = \sum_i{p_i^2}$  
        if all species are equally abundant: $\lambda = \sum_i \dfrac{1}{S}^2 = \dfrac{S}{S^2} = \dfrac{1}{S}$
        so $S = \dfrac{1}{\lamda}$
      - Based on proportion of each species, so not affected by change of total
        abundance

- Temporal turnover:
  - abundance based:
    - @shimadzu_measuring_2015 (between two time steps), considers a turnover
      metric decomposed based either on total abundance or species composition.
      - Linked to Shannon's: species richness and heterogeneity
      - Linked to Bray-Curtis decomposition: species richness and heterogeneity
  - See [BAT R package](https://cran.r-project.org/web/packages/BAT/index.html) [@cardoso_bat_2015]

- [@dornelas_assemblage_2014]:
  - Indices (vegdist):
    - Jaccard similarity index
    - Morisita-Horn
    - Chao community similarity index
    - pearson correlation of species abundances
  - Null models:
    - MacArthur & Wilson
    - Hubbell model  (see [untb package](https://cran.r-project.org/web/packages/untb/index.html))


## Species traits

- Species traits:
  - sti: @comte_climate_2021
  - Freshwater known species number by ecoregion (representativity of our data):
    @abell_freshwater_2008,
    [data](https://databasin.org/datasets/0b6963be65074bca9306b1b6f05149d2/)


# Modelling

## Interesting links {-}

- Statistical modelling: 
  - [spaMM](https://gitlab.mbb.univ-montp2.fr/francois/spamm-ref)
  - [INLA](https://becarioprecario.bitbucket.io/inla-gitbook/ch-temporal.html#sec:spacetime)
  - [Tutorial on spde spatial autocorrelation](https://www.flutterbys.com.au/stats/tut/tut12.13.html)
  - [Interesting massive statistical model for marine data](https://academic.oup.com/icesjms/article/74/5/1311/2907795?login=true)

## One model by site / species

- Easy to implement: GAM, polynomial [@rigal_method_2020]

- Cons:
  - Non robust temporal trends: to much parameters to estimate with few data
    points, i.e. low degree of freedom. [@desquilbet_adequate_2020]
  - How to assess imperfect detection  

## Model all in one

### Community abundance and species richness

- [vanklink script](https://github.com/roelvanklink/Final-insect-abundance-changes/blob/master/Full%20INLA%20analysis%20FINAL%20cleaned%2020191230.R)

#### Temporal biais

- Sampling effort
- Sampling area ?

#### Model

- Reponse variable: Count
- Distribution: Poisson or negative binomial
- Fixed effect: year:Unit (Unit only for abundances)
- Random effect:
  - Realm: intercept + slope
  - Basin: intercept + slope
  - Spatial autocorrelation: SPDE (inla or spaMM)
  - temporal autocorrelation: AR1 

### Species abundances

#### Biais

- species detectability [@gotelli_detecting_2010] but see this [McGill's
  post](https://dynamicecology.wordpress.com/2014/09/15/detection-probabilities-statistical-machismo-and-estimator-theory/)
  Finally, I believe that @gotelli_detecting_2010 did not model detection
  probability at all, it took one afternoon to understand that `r emo::ji("sweat_smile")`
- sampling effort

#### Model

- Reponse variable: Count
- Distribution: Poisson or negative binomial
- Fixed effect: Species:year:Unit (Unit only for abundances)
- Random effect:
  - Realm: intercept + slope
  - Basin: intercept + slope
  - Spatial autocorrelation: SPDE (inla or spaMM)
  - temporal autocorrelation: AR1

# Meetings

## 17 december 2021 

### Can we change individual density to raw counts ? 

```{r}
tar_load(filtered_op_protocol)
tabyl_df(filtered_op_protocol, group = "unitabundance")
```

```{r}
check_ind100m2 <- filtered_op_protocol$unitabundance == "Ind.100m2" &
  is.na(filtered_op_protocol$sampledlength_m)
length(which(check_ind100m2))
length(which(check_ind100m2)) / length(check_ind100m2)
```

```{r}
na_sampling_effort <- filtered_op_protocol %>%
  nest_by(unitabundance) %>%
  mutate(
    na_sampling_effort = length(which(is.na(data$sampledlength_m))),
    percent_na_sampling_effort =
      length(which(is.na(data$sampledlength_m))) /
      nrow(data)
  ) %>%
  select(-data)
```
```{r}
na_sampling_effort %>%
  kable()
```

- looks not possible since we miss a lot of sampling effort

### Baseline reference

No simple solution:  
  - average first years ?
  - take first year

### Can we resume polynomial equation by first order coefficents ? 

- No! the formula of "positive" parabol for example has a negative first order
  coefficent. 

```{r}
dfd <- tibble(
  x = seq(-5, 6),
  y = x^2 - x
)
lm(y ~ x + I(x^2), data = dfd)
plot(y~x, dfd)
abline(lm(y ~ x + I(x^2), data = dfd), col = "red")
title("second order equation")
```

- actually, we can do it if we do a first order modelling

```{r}
plot(y~x, dfd)
abline(lm(y ~ x, data = dfd), col = "red")
title("first order equation")
```

## 13 january 2022

- Caracterize changes in numbers:
  - number of species, etc... 
  - coefficents per decade 
- Plot tendancies by classification category: Jaccard vs richness

```{r}
knitr::include_graphics(here::here("doc", "fig", "meeting-2022-01-13.jpeg"))
```


# References {-}
