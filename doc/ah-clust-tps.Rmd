---
title: "Clustering analysis"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    df_print: paged
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
bibliography: "bibliography.bib"
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
```

```{r load-targets, include=FALSE}
tar_load(c(abun_var, var_jaccard, rich_var, clust_var, clust_var_alter))
tar_load(c(site_no_drivers_inla, site_no_drivers_inla_tot, site_no_drivers_inla_red))
tar_load(site_env)
```


# Clusters

```{r}
tar_load(c(clust_curv_site, clust_curv_site_fac_50))
tar_load(c(clust_curv_site_red_fac_1, clust_curv_site_red_fac_50))
tar_load(c(clust_curv_site_tot_fac_1, clust_curv_site_tot_fac_50))
tar_load(c(site_cl_rm, site_cl_rm_red, site_cl_rm_tot))

tar_load(c(
    gaussian_inla_no_drivers_adj_re,
    gaussian_inla_exo_no_drivers_adj_re)
)
tot <- rbind(
     gaussian_inla_no_drivers_adj_re,
     gaussian_inla_exo_no_drivers_adj_re
     )

```

- Distribution of all biodiversity facets:

```{r dist-tps}
tot %>%
  ggplot(aes(x = mean)) +
  geom_histogram() +
  facet_wrap(vars(response), nrow = 2, scales = "free")
```

- Even with scaling, we see that the variability of the temporal trends of
  percentage of exotic species and abundance are very low (Fig.
  \@ref(fig:dist-tps-sc)). It is the reason why we exclude those variables from
  the clustering method (but see below), i.e. they cannot discriminate cluster because they vary very little.  

```{r dist-tps-sc}
tot %>%
  group_by(response) %>%
  mutate(mean = mean / sd(mean)) %>%
  ggplot(aes(x = mean)) +
  geom_histogram() +
  facet_wrap(vars(response), nrow = 2, scales = "free")
```

# PCA

- With only variables presented in the first figure: 

```{r red-pca, fig.height = 12}
pca_clust_red <- compute_rotated_pca(
  site_no_drivers_inla_tot[,
    clust_var_alter
    #clust_var_alter[clust_var_alter != "perc_exo_sp"]
    ],
  naxis = 5
)

axis_l <- list(
  c("RC1", "RC2"),
  c("RC1", "RC3"),
  c("RC1", "RC4"),
  c("RC1", "RC5"),
  c("RC2", "RC3"),
  c("RC2", "RC4"),
  c("RC2", "RC5"),
  c("RC3", "RC4"),
  c("RC3", "RC5"),
  c("RC4", "RC5")
)
p_pca_red <- map(axis_l,
  ~ plot_pca_clust(
     .data = pca_clust_red$rotated,
     site_cl = site_cl_rm_red,
     add_point = FALSE,
     add_ellipse = FALSE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-1, 1),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 1
   )
)
plot_grid(plotlist = p_pca_red, ncol = 2)
```

The PCA on the variables displayed in fig 1 shows (Fig. \@ref(fig:red-pca))
that those variables represent independant facets of biodiversity as the five
variables are well represented on 5 axis, each axis explaining the same amountof
the variation, i.e. 20%. 


## PCA with all facets of biodiversity

```{r pca-tot, fig.height = 12}
pca_clust_tot <- compute_rotated_pca(site_no_drivers_inla_tot, naxis = 5)

p_pca_tot <- map(axis_l,
  ~ plot_pca_clust(
     .data = pca_clust_tot$rotated,
     site_cl = site_cl_rm_tot,
     add_point = FALSE,
     add_ellipse = FALSE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-1, 1),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 1
   )
)
plot_grid(plotlist = p_pca_tot, ncol = 2)
```

Those PCA containing all biodiversity facets shows (Fig. \@ref(fig:pca-tot))
relatively similar results than the one in the main text (i.e. without exotic
species variables). We see the same independant partitions: temporal trends of species
richness, dissimilarity, percentage of exotic species and abundance, Nestedness
and of total abundance are respectively related to axis 1, 2, 3, 4 and 5.

## PCA presented in the main text

```{r pca, fig.height = 12}

pca_clust <- compute_rotated_pca(site_no_drivers_inla, naxis = 4)

axis_l4 <- axis_l[!map_lgl(axis_l, ~any(str_detect(.x, "RC5")))]
axis_l3 <- axis_l[!map_lgl(axis_l, ~any(str_detect(.x, "RC5|RC4")))]
p_pca <- map(axis_l4,
  ~ plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm_tot,
     add_point = FALSE,
     add_ellipse = FALSE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-1, 1),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 1
   )
)
plot_grid(plotlist = p_pca, ncol = 2)
```

Comparing the PCA without (main text and here, Fig. \@ref(fig:pca)) and the PCA 
containing the exotic species variables (Fig. \@ref(fig:pca-tot)), we see that
they contain the same independant axis, except obviously the one related of
exoctic species. 

In the PCA figure of the main text, I then suggest that we keep all the
variables, i.e. including the percentage of exotic species and the percentage of
exotic species abundance. Concerning the clusters, the story is a bit different.

- So the PCA figure, without the clusters could look like this: 

```{r, fig.height = 12}
plot_grid(plotlist = p_pca_tot[c(1, 5, 6, 7)], ncol = 2
)
```

# Clusters 



The clustering failed with the inclusion of percentage of exotic
species and abundance. It resulted in a cluster partition only based on exotic
fishes temporal trends. One explanation is that kmeans is known for giving
more weight to variable with less variation
([ref1](https://stats.stackexchange.com/a/21226)). Moreover, it does not make a
lot of sense to include variables that mostly have no trends and little
variation in a cluster analysis.

```{r}
target_bp_cl_dist(cl_obj = site_cl_rm_red) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

- The same problematic behavior of cluster applies if we include all
  the facets of biodiversity (meaning jaccard in this decomposition), exotic
  species trends are still found the be the most discriminant variable although
  their relative weak variability:

```{r}
target_bp_cl_dist(cl_obj = site_cl_rm_tot) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

- Cluster of the main text: 

```{r}
target_bp_cl_dist(cl_obj = site_cl_rm) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

- If we add exotic species variable:

```{r}
add_to_boxplot <- site_no_drivers_inla_tot %>%
  select(perc_exo_sp, perc_exo_abun) %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])) %>%
  rownames_to_column("siteid") %>%
  as_tibble()
target_bp_cl_dist(
  cl_obj = left_join(site_cl_rm, add_to_boxplot,
    by = "siteid"
    )
) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

So, outcome of PCA and cluster tries conclude that we should stay with all
biodiversity facets without exotic species. 

## Choice of clusters 

```{r, fig.height = 8}
plot(clust_curv_site)
plot(clust_curv_site_fac_50)
```

```{r}
k4_fac_50_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 4,
  alpha = 0.05,
  restr.fact = 50,
  warnings = 2
)
```

- Clusters defined by richness change (cl 4), turnover (cl 2), disappearance / richness
  change (cl 3):

```{r}
site_k4_fac_50_cl <- get_cluster_df(
     tclust_obj = k4_fac_50_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k4_fac_50_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

```{r}
k4_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 4,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k4_fac_1_cl)
```

```{r}
site_k4_fac_1_cl <- get_cluster_df(
     tclust_obj = k4_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k4_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

#### 5 clusters

```{r}
k5_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 5,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k5_fac_1_cl)
```

- With 5 clusters, we see a bit a better but still without abundances 

```{r}
site_k5_fac_1_cl <- get_cluster_df(
     tclust_obj = k5_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k5_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

```{r}
k5_fac_50_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[, 1])),
  iter.max = 150,
  k = 5,
  alpha = 0.05,
  restr.fact = 50,
  warnings = 2
)
plot(k5_fac_1_cl)
```

### 6 clusters

```{r}
k6_fac_50_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[, 1])),
  iter.max = 150,
  k = 6,
  alpha = 0.05,
  restr.fact = 50,
  warnings = 2
)
plot(k6_fac_50_cl)
```

- With 6 clusters, we see a bit a better but still without abundances 


```{r}
site_k6_fac_50_cl <- get_cluster_df(
     tclust_obj = k6_fac_50_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k6_fac_50_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

##### More restricted cluster

```{r}
k6_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 6,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k6_fac_1_cl)
```

- With 6 clusters, we have the no change cluster with is really interestingly 


```{r}
site_k6_fac_1_cl <- get_cluster_df(
     tclust_obj = k6_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k6_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

#### 7 clusters

The added cluster is a super increase in abundance 

```{r}
k7_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 7,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k7_fac_1_cl)
```


```{r}
site_k7_fac_1_cl <- get_cluster_df(
     tclust_obj = k7_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k7_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

#### 8 clusters

The added cluster is one with both increase in species richness and turnover

```{r}
k8_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 8,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k8_fac_1_cl)
```


```{r}
site_k8_fac_1_cl <- get_cluster_df(
     tclust_obj = k8_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k8_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```

## Cluster number check

- With our analysis, we could have go up to 8 clusters:

```{r}
plot(clust_curv_site)
plot(clust_curv_site_fac_50)
```


- Clusters with exotic variables: 

```{r}
plot(clust_curv_site_tot_fac_50)
plot(clust_curv_site_tot_fac_1)
```

- With only independant variables:

```{r}
plot(clust_curv_site_red_fac_1)
plot(clust_curv_site_red_fac_50)
```

## Conclusion

- The goal of the PCA is to show the dimensionality of biodiversity facets: 
  - We show Five over 10 variables (i.e. same number of dimension than of number
    of variables than in the figure one!!!)
- Cluster analysis allows to display the heterogeneity of temporal trends
  locally and a relative homogeneity globally  

```{r}
p_pca_cl <- map(axis_l,
  ~ plot_pca_clust(
     .data = pca_clust_tot$rotated,
     site_cl = site_k6_fac_1_cl,
     add_point = TRUE,
     add_ellipse = FALSE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 3.5
   )
)
plot_grid(plotlist = p_pca_cl, ncol = 2)
```

- Paper figure:

```{r, fig.height = 8}
plot_grid(plotlist = p_pca_cl[c(1, 5, 6, 7)], ncol = 2
)
```


```{r}
p_pca_cl_ell <- map(axis_l,
  ~ plot_pca_clust(
     .data = pca_clust_tot$rotated,
     site_cl = site_k6_fac_1_cl,
     add_point = TRUE,
     add_ellipse = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .2,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 3.5
   )
)
plot_grid(
  plotlist = p_pca_cl_ell[c(1, 5, 6, 7)], ncol = 2
)
```


## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
