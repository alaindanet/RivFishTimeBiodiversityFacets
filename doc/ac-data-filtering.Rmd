---
title: "Filter sites and operation"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
## target knits Rmds in their own session, so load libraries here.
source(here::here("start_rmd.R"))
```

```{r load-targets, include=FALSE}
tar_load(c(op_protocol, site_protocol_quali, site_protocol_quanti))
```

- Keep good sampling month +- month 
- Delete yearly duplicate
 
```{r}

```
- Some op have no date, but a month, option `convert_month_to_date` added to
  `filter_op()` 

```{r}
op_protocol %>%
  filter(is.na(date), !is.na(month))
op_protocol %>%
  filter(is.na(month), is.na(quarter))
```

```{r}
test_filter <- filter_op(
      op_protocol = op_protocol,
      selected_protocol = NULL,
      nb_sampling = 5,
      extent_month = 1.5,
      return_no_filtered = FALSE,
      convert_month_to_date = TRUE
      )
```

```{r}
test_filter %>%
  ggplot(aes(x = (month_duration %% 12))) +
  geom_histogram() +
  geom_vline(xintercept = c(12 - 2, 2)) +
  geom_vline(xintercept = c(12 - 1, 1), color = "red") +
  geom_vline(xintercept = c(12 - 1.5, 1.5), color = "blue")
```

```{r}
filtered <- test_filter %>%
  filter(month_check | (is.na(month) & is.na(year) & quarter_check))
```

# Summary of analysis 

```{r}
tar_load(filtered_op_protocol)
```

```{r}
tabyl_df <- function(x = NULL, group = NULL) {

  gr_sym <- rlang::sym(group)

  x %>%
    tabyl(!!gr_sym) %>%
    arrange(desc(n)) %>%
    adorn_totals("row") %>%
    adorn_pct_formatting(digits = 1)

}
```


```{r}
tabyl_df(filtered_op_protocol, "protocol")
```


```{r}
tabyl_df(filtered_op_protocol, "unitabundance")
```

```{r}
tar_load(filtered_dataset)
```


- No much site in South America and Africa

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```



```{r}
mapView(loc, zcol = c("protocol"))
```


```{r, eval=FALSE}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1)
```

```{r}
loc %>%
  ggplot(aes(x = protocol, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Protocol", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r}
loc %>%
  ggplot(aes(x = unitabundance, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Abundance unit", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_year <- filtered_dataset$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  mutate(
    span = max - min,
    completeness = n / (span + 1),
    cat_span = cut(span, c(0, 10, 20, 30, 40, 70), right = TRUE,
      include.lowest = TRUE
    ),
    cat_completeness = cut(
      completeness, c(0, .1, .25, .5, .75, 1), right = TRUE,
      include.lowest = TRUE
    )
    )
```

```{r}
site_year %>%
  ggplot(aes(x = max - min)) +
  geom_histogram() +
  labs(x = "Year span (years)", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_year %>%
  ggplot(aes(x = cat_completeness, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Completness (nb sampling years / year span)", y = "Number of sites")
```


# The super map

```{r}
site_richness <- filtered_dataset$measurement %>%
  left_join(select(filtered_op_protocol, siteid, op_id), by = "op_id") %>%
  group_by(siteid) %>%
  summarise(tot_nb_species = length(unique(species)))

op_richness_summary <-
  filtered_dataset$abun_rich_op %>%
  left_join(select(filtered_op_protocol, siteid, op_id), by = "op_id") %>%
  group_by(siteid) %>%
  summarise(enframe(summary_distribution(species_nb)), .groups = "drop") %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  rename(median_richness = median)
```


- Too long:

```{r, eval=TRUE}
mask_row <- sample(1:nrow(loc2), 50)
mapView(loc2[mask_row,], zcol = "protocol",
  popup = popupGraph(loc2[mask_row,]$p_abun)
)
```



## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
