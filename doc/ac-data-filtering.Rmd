---
title: "Filter sites and operation"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
## target knits Rmds in their own session, so load libraries here.
source(here::here("start_rmd.R"))
library(INLA)
library(inlabru)
```

```{r load-targets, include=FALSE}
tar_load(c(op_protocol, site_protocol_quali, site_protocol_quanti))
```

```{r}
op_protocol %>%
  filter(is.na(date), !is.na(month))
op_protocol %>%
  filter(is.na(month), is.na(quarter))
```

```{r}
test_filter <- filter_op(
      op_protocol = op_protocol,
      selected_protocol = NULL,
      nb_sampling = 5,
      extent_month = 1.5,
      return_no_filtered = TRUE,
      convert_month_to_date = TRUE
      )
```

```{r}
ti <- tibble(x = c(1,2))
test_filter %>%
  ggplot(aes(x = (month_duration %% 12))) +
  geom_histogram() +
  geom_vline(data = ti, aes(xintercept = c(12 - 2, 2), color = "2 month")) +
  geom_vline(data = ti, aes(xintercept = c(12 - 1, 1), color = "1 month")) +
  geom_vline(data = ti, aes(xintercept = c(12 - 1.5, 1.5), color = "1.5 month")) +
  scale_color_manual(name = "Number of month",
    values = c(
      "1 month" = "red",
      "1.5 month" = "blue",
      "2 month" = "black"
    )) +
  labs(x = "Number of month ",
    title = "Difference of sampling time between the median time and each
    sampling",
    y = "Frequency")
```

# Summary of analysis 

```{r}
tar_load(filtered_op_protocol)
tar_load(filtered_dataset)
```

```{r}
tabyl_df <- function(x = NULL, group = NULL) {

  gr_sym <- rlang::sym(group)

  x %>%
    tabyl(!!gr_sym) %>%
    arrange(desc(n)) %>%
    adorn_totals("row") %>%
    adorn_pct_formatting(digits = 1)

}
```


```{r}
tabyl_df(filtered_dataset$site_quali, "protocol") %>%
  kable()
```


```{r}
tabyl_df(filtered_dataset$site_quali, "unitabundance") %>%
  kable()
```

- No much site in South America and Africa

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```


```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
    theme(legend.position = "bottom")
```

```{r}
loc %>%
  ggplot(aes(x = protocol, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Protocol", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r}
loc %>%
  ggplot(aes(x = unitabundance, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Abundance unit", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_year <- filtered_dataset$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  mutate(
    span = max - min,
    completeness = n / (span + 1),
    cat_span = cut(span, c(0, 10, 20, 30, 40, 70), right = TRUE,
      include.lowest = TRUE
    ),
    cat_completeness = cut(
      completeness, c(0, .1, .25, .5, .75, 1), right = TRUE,
      include.lowest = TRUE
    )
    )
```

```{r}
site_year %>%
  ggplot(aes(x = min)) +
  geom_histogram() +
  labs(x = "Baseline year", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r}
site_year %>%
  ggplot(aes(x = cat_span, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Year span (year)", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_year %>%
  ggplot(aes(x = cat_completeness, fill = ecoregion)) +
  geom_bar() +
  labs(
    x = "Completeness of sampling (nb sampling / year span )",
    y = "Number of sites"
  )
```

# Spatial assessment

```{r}
site_il <- filtered_dataset$location %>%
  filter(region == "ILLINOIS")
fish_il <- filtered_dataset$measurement %>%
  filter(siteid %in% site_il$siteid)
il_dataset <- fish_il %>%
  left_join(site_il, by = "siteid")
```

```{r}
coo <- cbind(il_dataset$longitude, il_dataset$latitude)
mesh <- inla.mesh.2d(
  loc = coo, max.edge = c(1, 10),
  cutoff = 0.01
)
plot(mesh)
points(coo, col = "red")
```

```{r}
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
# Build index
indexs <- inla.spde.make.index("s", spde$n.spde)
# Project gaussian random field to vertices
A <- inla.spde.make.A(mesh = mesh, loc = coo)
```

- With all data:

```{r, eval=FALSE}
loc <- filtered_dataset$location
coords_loc <- cbind(loc$longitude, loc$latitude)

mesh <- inla.mesh.2d(
  loc = coords_loc, max.edge = c(1, 15),
  cutoff = 0.01
)
plot(mesh)
points(coords_loc, col = "red")
```

```{r}
spde_loc <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
# Build index
indexs_loc <- inla.spde.make.index("s", spde_loc$n.spde)
# Project gaussian random field to vertices
A <- inla.spde.make.A(mesh = mesh, loc = coords_loc)
```





## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
