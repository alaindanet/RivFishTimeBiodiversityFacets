---
title: "Filter sites and operation"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
## target knits Rmds in their own session, so load libraries here.
source(here::here("start_rmd.R"))
knitr::opts_chunk$set(cache = TRUE)
library(skimr)
library(ade4)
library(factoextra)
```

```{r load-targets, include=FALSE}
tar_load(c(op_protocol, site_protocol_quali, site_protocol_quanti))
tar_load(slp_env)
```

```{r}
op_protocol %>%
  filter(is.na(date), !is.na(month))
op_protocol %>%
  filter(is.na(month), is.na(quarter))
```

```{r, eval=TRUE}
test_filter <- filter_op(
      op_protocol = op_protocol,
      selected_protocol = NULL,
      nb_sampling = 5,
      extent_month = 1.5,
      return_no_filtered = TRUE,
      convert_month_to_date = TRUE
      )
```

```{r}
ti <- tibble(x = c(1,2))
test_filter %>%
  ggplot(aes(x = (month_duration %% 12))) +
  geom_histogram() +
  geom_vline(data = ti, aes(xintercept = c(12 - 2, 2), color = "2 month")) +
  geom_vline(data = ti, aes(xintercept = c(12 - 1, 1), color = "1 month")) +
  geom_vline(data = ti, aes(xintercept = c(12 - 1.5, 1.5), color = "1.5 month")) +
  scale_color_manual(name = "Number of month",
    values = c(
      "1 month" = "red",
      "1.5 month" = "blue",
      "2 month" = "black"
    )) +
  labs(x = "Number of month ",
    title = "Difference of sampling time between the median time and each
    sampling",
    y = "Frequency")
```

# Summary of analysis 

```{r}
tar_load(filtered_op_protocol)
tar_load(filtered_dataset)
```
```{r}
skim(filtered_dataset$site_quali)
```


```{r}
tabyl_df(filtered_dataset$site_quali, "protocol") %>%
  kable()
```


```{r}
tabyl_df(filtered_dataset$site_quali, "unitabundance") %>%
  kable()
```

- No much site in South America and Africa

```{r}
loc <- filtered_dataset$location %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```


```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc, aes(color = protocol), shape = 1) +
    theme(legend.position = "bottom")
```

```{r}
unique(loc$main_bas) %>% length
unique(loc$waterbody) %>% length

ti <- table(as.factor(loc$main_bas)) %>%
  enframe() %>%
  arrange(desc(value))

ggplot(data = world) +
    geom_sf() +
    geom_sf(data = filter(loc, main_bas %in% ti$name[1:20]),
      aes(color = as.factor(main_bas)), shape = 1) +
    theme(legend.position = "bottom")
```

```{r}
loc %>%
  ggplot(aes(x = protocol, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Protocol", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r}
loc %>%
  ggplot(aes(x = unitabundance, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Abundance unit", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```



```{r}
site_year <- filtered_dataset$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span),
    cat_span = cut(span, c(0, 10, 20, 30, 40, 70), right = TRUE,
      include.lowest = TRUE
    ),
    cat_completeness = cut(
      completeness, c(0, .1, .25, .5, .75, 1), right = TRUE,
      include.lowest = TRUE
    )
    )
```

```{r, results="hide"}
map_dfr(c("span", "completeness", "min", "median", "max", "n"),
  ~tibble(
    variable = .x, 
    median = median(site_year[[.x]]))
)
```


```{r}
site_year %>%
  ggplot(aes(x = min)) +
  geom_histogram() +
  labs(x = "Baseline year", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r}
site_year %>%
  ggplot(aes(x = cat_span, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Year span (year)", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
site_year %>%
  ggplot(aes(x = cat_completeness, fill = ecoregion)) +
  geom_bar() +
  labs(
    x = "Completeness of sampling (nb sampling / year span )",
    y = "Number of sites"
  )
```

```{r}
site_year %>%
  ggplot(aes(x = n, fill = ecoregion)) +
  geom_bar() +
  labs(
    x = "nb sampling",
    y = "Number of sites"
  )
```

# Diversity

```{r}
tar_load(c(chao_hillnb, hillebrand, filtered_dataset))
```

```{r}
var_chao <- c("chao_richness", "chao_shannon", "chao_simpson")
chao_summary <- map_dfr(chao_hillnb[, var_chao],
  ~summary_distribution(.x, na.rm = TRUE), .id = "variable"
  )

chao_summary %>%
  kable()
```

```{r}
chao_hillnb[, var_chao] %>%
  pivot_longer(., cols = c(var_chao)) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_grid(cols = vars(name), scales = "free_x")
```

- Chao methods on abundance density seems to fail
  - Update: fixed

```{r}
stopifnot(all(chao_summary$n_na == 0))
```

- However, chao shannon is NA when all abundances are equal
  - When all abundances are equal and since hill numbers are computed with the
    natural logarythm, shannon should be equal to ln($D^0$), $D^O$ being the
    species richness
  - Let's replace equal abundances NA's shannon by ln(chao richness) 

```{r, eval=FALSE}
chao_hillnb %>%
  filter(is.na(chao_shannon))

mask_na <- chao_hillnb[is.na(chao_hillnb$chao_shannon), ]$op_id
ti <- filtered_dataset$measurement %>%
  filter(op_id == na.omit(mask_na)[4])
ti <- filtered_dataset$measurement %>%
  group_by(op_id) %>%
  mutate(abundance = round(adjust_abun_chao(abundance))) %>%
  ungroup() %>%
  nest_by(op_id)
tid <- map(ti$data, "abundance")
names(tid) <- ti$op_id 
mesure <- furrr::future_map_dfr(
  tid, ~c(n_unique = length(unique(.x))),
    .id = "op_id"
    )
mesure[is.na(chao_hillnb$chao_shannon), ]$n_unique == 1


vegan::diversity(round(adjust_abun_chao(ti$abundance)))
invChat.Ind_c(round(adjust_abun_chao(ti$abundance)), C = .985, conf = NULL)

shannon_na_unique_abun <- filtered_dataset$measurement %>%
  filter(op_id %in% na.omit(mask_na)) %>%
  group_by(op_id) %>%
  mutate(abun_adjusted = round(adjust_abun_chao(abundance))) %>%
  summarise(
    n_unique = length(unique(abundance)),
    n_ajust = length(unique(abun_adjusted))
  )
```

- Same thing with Chao, simpson should be 0 when one species only.

```{r, eval=FALSE}
chao_hillnb %>%
  filter(is.na(chao_simpson))


mask_na <- chao_hillnb[is.na(chao_hillnb$chao_simpson), ]$op_id
ti <- filtered_dataset$measurement %>%
  filter(op_id == na.omit(mask_na)[4])


vegan::diversity(round(adjust_abun_chao(ti$abundance)), index = "simpson")
invChat.Ind_c(round(adjust_abun_chao(ti$abundance)), C = .985, conf = NULL)

filtered_dataset$measurement %>%
  filter(op_id %in% na.omit(mask_na))

simpson_na_unique_abun <- filtered_dataset$measurement %>%
  filter(op_id %in% na.omit(mask_na)) %>%
  group_by(op_id) %>%
  mutate(abun_adjusted = round(adjust_abun_chao(abundance))) %>%
  summarise(
    n = n(),
    n_unique = length(unique(abundance)),
    n_ajust = length(unique(abun_adjusted))
  )
```



```{r, eval=FALSE}
chao_hillnb %>%
  filter(chao_shannon == c("-Inf", "Inf"))
chao_hillnb[42923, ]

mask_minus_inf <- chao_hillnb[chao_hillnb$chao_shannon == "-Inf", ]$op_id
ti <- filtered_dataset$measurement %>%
  filter(op_id == na.omit(mask_minus_inf)[1])

rec <- adjust_abun_chao(ti$abundance)
invChat.Ind_c(ti$abundance, C = .985, conf = NULL)
invChat.Ind_c(as.integer(round(ti$abundance)), C = .985, conf = NULL)
invChat.Ind_c(rec, C = .985, conf = NULL)
invChat.Ind_c(as.integer(round(rec)), C = .985, conf = NULL)
Dqhat.Ind


mask_inf <- chao_hillnb[chao_hillnb$chao_shannon == "Inf", ]$op_id

ti <- filtered_dataset$measurement %>%
  filter(op_id %in% na.omit(mask_inf)[2])

invChat.Ind_c(ti$abundance %>% round, C = .985, conf = NULL)
invChat.Ind_c(ti$abundance, C = .985, conf = NULL)
vegan::diversity(ti$abundance)
```

```{r, eval=FALSE}
chao_hillnb %>%
  filter(chao_shannon == "Inf")
any(chao_hillnb$chao_shannon == "Inf" & chao_hillnb$method == "interpolated")
any(chao_hillnb$chao_shannon == "Inf" & chao_hillnb$method != "interpolated")

ti <- filtered_dataset$measurement %>%
  filter(op_id == "nfp136")

chao_hillnb[4230, ]
invChat.Ind_c((ti$abundance), C = .985, conf = NULL)
invChat.Ind_c((ti$abundance) * 100, C = .985, conf = NULL)
```

- On va multiplier les densité d'abondances par le minimum pour que l'abondance minimal soit de 1 pour les calculs de chao
  - ça va pas affecter négativement le chao car il n'est pas basé sur l'effort
    d'échantillonnage
  - ça fait sens
  - ça augmente le nombre de singleton mais au augmentant au minimum le nombre
    d'individus total dans la communauté

# Spatial assessment


```{r, eval=FALSE}
tar_load(spde)
plot(spde)
```



# Environment

## Water and air temperature

```{r}
tar_load(c(at_mv_avg, wt_mv_avg))

awt <- full_join(at_mv_avg, wt_mv_avg, by = c("siteid", "year"))
write_csv(awt, file = here("data", "awt.csv"))
skim(awt)
```

```{r}
wt_site_avg <- wt_mv_avg %>%
  group_by(siteid) %>%
  summarise(avg_w_tmp = mean(tmp_w_ama))
```

```{r}
loc_wt <- loc %>%
  left_join(wt_site_avg, by = "siteid")

ggplot(data = world) + geom_sf() +
  geom_sf(data = loc_wt, aes(fill = avg_w_tmp), shape = 21) +
  scale_fill_viridis() +
  theme(legend.position = "bottom")
```

- Check if NA:

```{r}
tar_load(analysis_dataset)
skim(analysis_dataset)
```


```{r}
na_tmp <- analysis_dataset %>%
  left_join(wt_mv_avg, by = c("siteid", "year")) %>%
  left_join(at_mv_avg, by = c("siteid", "year")) %>%
  select(siteid, year, tmp_w_ama, tmp_a_ana) %>%
  pivot_longer(
    cols = c(tmp_w_ama, tmp_a_ana),
    names_to = "variable", values_to = "tmp") %>%
  group_by(variable, year) %>%
  summarise(n_na = sum(is.na(tmp)), p_na = n_na / n(), .groups = "drop")
```

- Air temperature can be interesting to complete water temperature data:
  - between 2007 and 2016
  - `analysis_dataset %>% filter(variable == "tmp_a_ana")`

```{r}
na_tmp %>%
  ggplot(aes(y = p_na, x = year, color = variable)) +
  geom_line() +
  labs(y = "Percentage of NAs in temperature variable",
    x = "Year", color = "Temperature variable") +
  scale_color_manual(values = c("red", "blue"), labels = c("Air (Chelsa)", "Water (DynWat)"))
```

```{r}
ti <- analysis_dataset %>%
  left_join(wt_mv_avg, by = c("siteid", "year")) %>%
  left_join(at_mv_avg, by = c("siteid", "year")) %>%
  select(siteid, year, tmp_w_ama, tmp_a_ana) %>%
  skim_tee() %>%
  mutate(
    w_tmp_na = is.na(tmp_w_ama),
    a_tmp_na = is.na(tmp_a_ana),
    a_tmp_na = is.na(tmp_a_ana),
    tmp_w_ama = ifelse( is.na(tmp_w_ama) & !is.na(tmp_a_ana),
      tmp_a_ana, tmp_w_ama)
  )
```


```{r}
na_w_not_na_a <- ti %>%
  group_by(year) %>%
  summarise(w_tmp_na = sum(w_tmp_na) /n(), a_tmp_na = sum(a_tmp_na) / n()) %>%
  filter(w_tmp_na == 1 & a_tmp_na < .01)
ratio_data_na_w_no_na_a <-
  analysis_dataset[analysis_dataset$year %in% na_w_not_na_a$year, ] %>%
  nrow /
  nrow(analysis_dataset)
```

- NA period in water temperature but not in air temperature: 
  - `r percent(ratio_data_na_w_no_na_a)` of the data 



## River atlas 

```{r}
tar_load(riveratlas_site)
```

```{r}
# Elevation
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "ele_")]
# Slope
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "slp_")]
# Temperature
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "tmp_")]
# River position
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "tmp_")]
# River discharge 
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "dis_m3")]
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "ria_")]
# Human footprint
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "hft_")]
# Population density
colnames(riveratlas_site)[str_detect(colnames(riveratlas_site), "pnv_")]
```

```{r}
riveratlas_site <- riveratlas_site %>%
  mutate(across(starts_with("tmp_"), ~.x / 10))
```


```{r}
riv <- riveratlas_site %>%
  select(all_of(get_river_atlas_significant_var())) %>%
  st_drop_geometry()
```

```{r}
skim(riv)
```


### Human footprint

```{r}
hist(riveratlas_site$hft_ix_c09 - riveratlas_site$hft_ix_c93)
hist(riveratlas_site$hft_ix_u09 - riveratlas_site$hft_ix_u93)
```
- Diff scaled no center:

```{r}
hist(scale(riveratlas_site$hft_ix_c09 - riveratlas_site$hft_ix_c93, center =
    FALSE))
```

- Ratio and log ratio: 
```{r}
hist(riveratlas_site$hft_ix_c09 / riveratlas_site$hft_ix_c93)
hist(log2(riveratlas_site$hft_ix_c09 / riveratlas_site$hft_ix_c93))
```


```{r}
loc_hft <- loc %>%
  left_join(riveratlas_site %>%
      select(c("siteid", starts_with("hft_"))) %>%
      st_drop_geometry(),
    by = "siteid"
  )
skim_tee(st_drop_geometry(loc_hft))

ggplot(data = world) +
  geom_sf() +
  geom_sf(data = loc_hft, aes(color = hft_ix_c09), shape = 19) +
  scale_color_viridis() +
  theme(legend.position = "bottom") +
  labs(title = "Human footprint 2009 (catch)")

ggplot(data = world) +
  geom_sf() +
  geom_sf(data = loc_hft, aes(color = hft_ix_u09), shape = 19) +
  scale_color_viridis() +
  theme(legend.position = "bottom") +
  labs(title = "Human footprint 2009 (watershed)")
```

```{r}
ggplot(data = world) +
  geom_sf() +
  geom_sf(data = loc_hft, aes(color = hft_ix_u09 - hft_ix_u93), shape = 19) +
  scale_color_viridis() +
  theme(legend.position = "bottom") +
  labs(title = "Human footprint difference 2009-1993 (watershed)")
```


```{r}

pca_riv <- dudi.pca(df = scale(riv), scannf = FALSE, nf = 3)
```

- We see two main axis (as I found in France):
  - First axis related to stream size (distance from source, River area)
  - Second axis related to Temperature 

```{r}
fviz_eig(pca_riv)

p_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),
  ~fviz_pca_var(pca_riv,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

plot_grid(plotlist = p_pca, ncol = 1)
```

- With logged variables: 

```{r}
logged_riv <- riv %>%
  mutate(across(c("Distance from source", "Strahler order", "Average elevation (m)",
        "Annual average of discharge (m3/s)", "Protected area extent (%)", "Urban extent (%)"),
      ~log(.x  + min(.x) + 1)))
skim(logged_riv)
```

```{r}
pca_data_logged_riv <- logged_riv %>%
  filter(`Average elevation (m)` != -Inf)
pca_logged_riv <- dudi.pca(df = scale(na.omit(pca_data_logged_riv)), scannf = FALSE, nf = 3)
```
```{r, fig.height=12}
fviz_eig(pca_logged_riv)

p_pca_logged_riv <- map(list(c(1, 2), c(2, 3), c(1, 3)),
  ~fviz_pca_biplot(pca_logged_riv,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)
plot_grid(plotlist = p_pca_logged_riv, ncol = 1)
```

```{r}
lc_var <- c(
#  "Potential Natural Vegetation Extent (catchment)" = "pnv_pc_c01-c15",
#  "Potential Natural Vegetation Extent (watershed)" = "pnv_pc_u01-u15",
  "Forest Cover Extent (catchment)" = "for_pc_cse",
  "Forest Cover Extent (watershed)" = "for_pc_use",
  "Cropland Extent (catchment)" = "crp_pc_cse",
  "Cropland Extent (watershed)" = "crp_pc_use",
  "Pasture Extent (catchment)" = "pst_pc_cse",
  "Pasture Extent (watershed)" = "pst_pc_use",
  "Urban Extent (catchment)" = "urb_pc_cse",
  "Urban Extent (watershed)" = "urb_pc_use",
 "Population Density (catchment)" = "ppd_pk_cav",
 "Population Density (watershed)" = "ppd_pk_uav"
)
```

```{r}
lc_hft <- riveratlas_site %>%
  select(all_of(c(
        lc_var[str_detect(names(lc_var), "catchment")],
        get_river_atlas_significant_var()[
          str_detect(get_river_atlas_significant_var(), "hft_")
          ]
        )))
```

```{r}
pca_data_lc_hft <- lc_hft %>%
  st_drop_geometry()
skim(pca_data_lc_hft)
pca_lc_hft <- dudi.pca(
  df = scale(na.omit(pca_data_lc_hft)),
  scannf = FALSE, nf = 3)
```

- Human footprint is well correlated with forest extent,
  urban extent and population density, and at a less extent
  to urban extent. 

```{r}
corrplot::corrplot(
  cor(as.matrix(pca_data_lc_hft), method = "spearman"),
  type = "upper", tl.srt = 35, diag = FALSE)
```


```{r, fig.height=12}
fviz_eig(pca_lc_hft)
p_pca_lc_hft <- map(list(c(1, 2), c(2, 3), c(1, 3)),
  ~fviz_pca_biplot(pca_lc_hft,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)
plot_grid(plotlist = p_pca_lc_hft, ncol = 1)
```

```{r, fig.height=12}
pca_logged_data_lc_hft <- pca_data_lc_hft %>%
  mutate(across(where(is.numeric),
      ~log(.x  + min(.x) + 1)))

pca_logged_lc_hft <- dudi.pca(
  df = scale(na.omit(pca_logged_data_lc_hft)),
  scannf = FALSE, nf = 3
)

fviz_eig(pca_logged_lc_hft)

p_pca_logged_lc_hft <- map(list(c(1, 2), c(2, 3), c(1, 3)),
  ~fviz_pca_biplot(pca_logged_lc_hft,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)
plot_grid(plotlist = p_pca_logged_lc_hft, ncol = 1)
```

```{r}
riv_str_var <- colnames(riveratlas_site)[
  colnames(riveratlas_site) %in%
    c("dist_up_km", "ord_stra", "dis_m3_pyr", "ele_mt_cav", "slp_dg_cav")]
summary(riveratlas_site$ele_mt_cav)
logged_riv_str <- riveratlas_site %>%
  st_drop_geometry() %>%
  select(all_of(c("siteid", riv_str_var))) %>%
  mutate(across(where(is.numeric), ~log(.x + abs(min(.x)) + 1)))

```

- PCA on river structure: 

```{r}
tar_load(c(pca_riv_str, p_pca_riv_str))
plot_grid(plotlist = p_pca_riv_str)
```



#### Environment - Trends

```{r}
slp_env_for_pca <- slp_env %>%
  select(-all_of(c("siteid", "main_bas", "ecoregion", "geometry"))) %>%
  rename(get_river_atlas_significant_var())
slp_env_for_pca$geometry <- NULL
  
pca_slp_env <- dudi.pca(
  df = scale(na.omit(slp_env_for_pca)),
  scannf = FALSE, nf = 3)
```

```{r}
p_slp_env_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),

  ~fviz_pca_var(pca_slp_env,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

p_slp_env_pca[[1]]
p_slp_env_pca[[2]]
p_slp_env_pca[[3]]
```



## Water temperature 

```{r}
tar_load(c(wt_mv_avg, filtered_dataset))
wt_mv_avg  <- wt_mv_avg %>%
  ungroup()
```

```{r}
library(glmmTMB)
library(DHARMa)
library(ggeffects)
library(emmeans)
mod_wt_data <- wt_mv_avg  %>%
  left_join(
    filtered_dataset$location %>%
    select(siteid, ecoregion, main_bas) %>%
    mutate(main_bas = as.character(main_bas)),
    by = "siteid"
  )
```

```{r}
#https://stackoverflow.com/questions/66467641/partial-effect-plots-from-spamm
tar_load(mod_wt)

#vignette('troubleshooting')
diagnose(mod_wt)
broom.mixed::tidy(mod_wt, type = "fixed")
#emmeans::emmeans(mod_wt, "year", type = "response")
#sim_res <- DHARMa::simulateResiduals(mod_wt)
#plot(sim_res)
```
```{r}
pr <- ggpredict(mod_wt, "year")
plot(pr)

# No
me <- ggpredict(mod_wt,
  terms = c("year", "ecoregion"),
  type = "random")
plot(me)

#
bas <- ggpredict(mod_wt,
  terms = c("year", "main_bas [sample=8]"),
  type = "random")
plot(bas)
```


```{r}
coef_wt <- coef(mod_wt)
coef_site <- coef_wt$cond$`siteid:main_bas` %>%
  mutate(
    siteid = stringr::str_split(row.names(coef_wt$cond$`siteid:main_bas`), ":") %>%
  map_chr(., 1),
main_bas = stringr::str_split(row.names(coef_wt$cond$`siteid:main_bas`), ":") %>%
  map_chr(., 2)
  )

loc_wt_year_slp <- filtered_dataset$location %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326) %>%
left_join(coef_site, by = "siteid")
```

```{r}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc_wt_year_slp, aes(fill = year * 10), shape = 21) +
    scale_fill_viridis() +
    theme(legend.position = "bottom")
```

```{r}
coef_bas <- coef_wt$cond$`main_bas` %>%
  mutate( main_bas = row.names(coef_wt$cond$`main_bas`))
```

```{r}
loc_wt_year_slp_bas <- filtered_dataset$location %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  mutate(main_bas = as.character(main_bas)) %>%
  left_join(coef_bas, by = "main_bas")
```

```{r}
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = loc_wt_year_slp_bas, aes(fill = year * 10), shape = 21) +
    scale_fill_viridis() +
    theme(legend.position = "bottom")
```


```{r}
tar_load(analysis_dataset)
skim(analysis_dataset)
```


## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
