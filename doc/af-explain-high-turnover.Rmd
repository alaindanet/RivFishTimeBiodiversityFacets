---
title: "Explain high turnover"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, analysis_dataset))
tar_load(c(rigal_trends, var_temporal_trends))
names(rigal_trends) <- var_temporal_trends
```


```{r}
slope <- map_dfr(rigal_trends,
  ~.x %>%
  select(siteid, linear_slope),
.id = "response"
)
```

```{r}
slope_df <- slope %>%
  pivot_wider(names_from = "response", values_from = "linear_slope") 
```

## Neutral difference 

```{r}

```

# Rare species hypothesis 

## hypothesis

- Knowing that high evenness and turnover trends happens where there are no
  trends in species richness

- Turnover linked to shorted lived species
- To highly abundant but stochastic species
- Community that contains species more abundant globally have more turnover. 
- Community that contains species less occurent globally have more turnover. 
  -> CWM(rarity)
 
# Characterise variable species 

- Most abundant when present = average abundance 
- Rarely present = proportion occurence in sampling

```{r}
sp_mean_abun <- filtered_dataset$measurement %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  group_by(unitabundance, ecoregion, species) %>%
  summarise(summ =
    list(
      enframe(
        c(
          summary_distribution(abundance, na.rm = TRUE)
        )
      )
    )
    ) %>%
  unnest(cols = summ) %>%
  filter(name == c("mean")) %>%
  pivot_wider(names_from = "name", values_from = "value")
```

```{r}
species_fq <- filtered_dataset$measurement %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  group_by(unitabundance, ecoregion, species) %>%
  summarise(fq = n()) %>%
  ungroup()

op_fq <- filtered_dataset$measurement %>%
  left_join(filtered_dataset$site_quali, by = "siteid") %>%
  left_join(filtered_dataset$location, by = "siteid") %>%
  group_by(unitabundance, ecoregion) %>%
  summarise(n_op = n()) %>%
  ungroup()

species_fq_op <- species_fq %>%
  left_join(op_fq, by = c("unitabundance", "ecoregion")) %>%
  mutate(occurence = fq / n_op) %>%
  select(-fq, -n_op) %>%
  ungroup()
```

```{r}
ti <- ecdf(filtered_dataset$measurement$abundance)

get_proba_values_from_dist <- function(
  x = NULL,
  emp_pdf = NULL) {
  emp_pdf(x)
}
```

```{r}
emp_pdf <- sp_mean_abun %>%
  group_by(unitabundance, ecoregion) %>%
  summarise(emp_pdf = list(ecdf(mean))) %>%
  ungroup()
```
```{r}
rarity_species <- sp_mean_abun %>%
  ungroup() %>%
  left_join(emp_pdf, by = c("unitabundance", "ecoregion")) %>%
  mutate(
    prob_abun = map2_dbl(mean, emp_pdf,
      ~get_proba_values_from_dist(x = .x, emp_pdf = .y))
    ) %>%
  left_join(species_fq_op, by = c("unitabundance", "ecoregion", "species")) %>%
  select(-emp_pdf)
```

```{r}
rarity_species %>%
  ggplot(aes(y = prob_abun, x = log(occurence))) +
  geom_point()

rarity_species %>%
  ggplot(aes(x = prob_abun)) +
  geom_histogram()

rarity_species %>%
  ggplot(aes(x = log(occurence))) +
  geom_histogram()
```

## Occurrence


```{r}
library(ecocom)

```

```{r}
cwm_rarity <- filtered_dataset$measurement %>%
  left_join(select(filtered_dataset$site_quali, siteid, unitabundance), by = "siteid") %>%
  left_join(select(filtered_dataset$location, siteid, ecoregion), by = "siteid") %>%
  left_join(
    rarity_species,
    by = c("ecoregion", "unitabundance", "species")
    ) %>%
  group_by(op_id) %>%
  summarise(
    cwm_occurence = calc_cw_mean(
      trait = log(occurence),
      weight = abundance),
    cwm_prob_abun = calc_cw_mean(
      trait = prob_abun,
      weight = abundance
  )
    )
```

```{r}
site_median_cwm_rarity <- cwm_rarity %>%
  left_join(select(filtered_dataset$measurement, siteid, op_id), by = "op_id") %>%
group_by(siteid) %>%
  summarise(across(where(is.double), median))
```

```{r}
slope_df_rarity <- slope_df %>%
  left_join(site_median_cwm_rarity, by = "siteid")
```

```{r}
slope_df_rarity %>%
  ggplot(aes(
      x = cwm_occurence,
      y = jaccard,
      color = cwm_prob_abun
      )) +
  scale_color_viridis() +
  geom_point() +
  geom_smooth(method = "gam")

slope_df_rarity %>%
  ggplot(aes(
      x = cwm_prob_abun,
      y = jaccard,
      color = cwm_occurence
      )) +
  scale_color_viridis() +
  geom_point() +
  geom_smooth(method = "gam")
```



```{r}
tar_load(com_mat_site)

stab_sync <- com_mat_site %>%
  mutate(
    richness = purrr::map(mat, compute_sp_nb_from_com_mat),
    richness_med = purrr::map_dbl(richness, median),
    avg_sp = purrr::map(mat, colMeans),
    cov_mat = purrr::map(mat, cov),
    var_sp = purrr::map(cov_mat, diag),
    synchrony = purrr::map_dbl(cov_mat, compute_synchrony),
    cv_sp = purrr::map2_dbl(avg_sp, var_sp, compute_avg_cv_sp),
    cv_com = compute_cv_com(synchrony = synchrony, cv_sp = cv_sp),
    cv_classic = purrr::map2_dbl(cov_mat, mat, function(variance, abundance) {
      sqrt(sum(variance)) / mean(rowSums(abundance))
      })
  ) %>%
select(-starts_with("mat"))
```

```{r}
stab_sync %>%
  ggplot(aes(y = 1/cv_com, x = richness_med)) +
  geom_point() +
  geom_smooth(method = "lm")

stab_sync %>%
  ggplot(aes(y = synchrony, x = log(richness_med))) +
  geom_point() +
  geom_smooth(method = "lm")

stab_sync %>%
  ggplot(aes(y = cv_sp, x = richness_med)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
slope_df_stab <- slope_df %>%
  left_join(stab_sync, by = "siteid")
```

```{r}
slope_df_stab %>%
  ggplot(aes(y = jaccard, x = cv_sp)) +
  geom_point()
```

```{r}
slope_df_stab %>%
  ggplot(aes(y = jaccard, x = synchrony)) +
  geom_point()
```

```{r}
slope_df_stab %>%
  ggplot(aes(y = jaccard, x = 1 / cv_com)) +
  geom_point()
```

# PCAAAAAAAAAAAAAAAAAAAAAA

```{r}
library(ade4)
library(factoextra)
```


```{r}
res.pca <- dudi.pca(select(slope_df, -siteid),
  scannf = FALSE,   # Hide scree plot
  nf = 5            # Number of components kept in the results
)
```

```{r}
fviz_eig(res.pca)
```

```{r, fig.height = 12}
p_pca <- map(list(c(1,2), c(2, 3), c(1, 3)),
  ~fviz_pca_var(res.pca,
    axes = .x,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
    ) +
  theme(legend.position = "none") + labs(title = "")
)

plot_grid(plotlist = p_pca, ncol = 1)
```

```{r}
median_site <- analysis_dataset %>%
  select(
    siteid,
    starts_with("chao_"),
    evenness,
    total_abundance
  ) %>%
  group_by(siteid) %>%
  summarise(across(where(is.double), median, na.rm =TRUE)) %>%
  rename_with(~paste0("med_", .x), where(is.double)) %>%
  left_join(site_median_cwm_rarity, by = "siteid") %>%
  left_join(select(stab_sync, siteid, cv_com, synchrony, cv_sp), by = "siteid") %>%
  left_join(select(slope_df, siteid, hillebrand, jaccard, total), by = "siteid")
```

```{r}
pca_turnover <- dudi.pca(
  select(na.omit(median_site), -siteid),
  scannf = FALSE,   # Hide scree plot
  nf = 5            # Number of components kept in the results
)
```

```{r}
fviz_eig(pca_turnover)
```

```{r}
p_1_2 <- fviz_pca_var(pca_turnover,
  col.var = "contrib", # Color by contributions to the PC
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE     # Avoid text overlapping
)
p_1_2
```

## Jaccard distrribution vs classification_station

```{r}
slope_classification_station <- map_dfr(
  rigal_trends,
  ~.x %>%
    select(siteid, linear_slope, shape_class, direction),
  .id = "response"
)
```
```{r}
get_shape_class_x_trends_y <- function(dataset = NULL, x = NULL, y = NULL,
  type = "shape_class") {

  trends <- dataset %>%
    filter(response == y) %>%
    select(all_of(c("siteid", "linear_slope")))

  shape <- dataset %>%
    filter(response == x) %>%
    select(all_of(c("siteid", type)))

  output <- trends %>%
    left_join(shape, by = "siteid")
  return(output)
}
boxplot_trends_shape <- function(
dataset = NULL, x = NULL, y = NULL, type = "shape_class",
geom_fun = geom_boxplot
) {
  give.n <- function(x){
    return(c(y = median(x)*1.25, label = length(x))) 
    # experiment with the multiplier to find the perfect position
}

  get_shape_class_x_trends_y(
    dataset = slope_classification_station,
    x = x,
    y = y,
    type = type 
    ) %>%
  ggplot(aes_string(x = type, y = "linear_slope")) +
  geom_fun() +
  labs(y = paste0("Trends of ", y), x = paste0("Classification of ", x)) +
  stat_summary(fun.data = give.n, geom = "text", fun = median, 
    position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

}
```

```{r}
get_shape_class_x_trends_y(
  dataset = slope_classification_station,
  x = "total_abundance",
  y = "jaccard"
) %>%
  ggplot(aes(x = shape_class, y = linear_slope)) +
  geom_boxplot()
```

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "total_abundance",
  y = "jaccard",
  type = "direction"
)
```

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "species_nb",
  y = "total",
  type = "direction"
)
```

### Hillebrand

#### Species richness

```{r}
p <- map(c("hillebrand", "total"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(c("hillebrand", "total"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

#### Total abundance

```{r}
p <- map(c("hillebrand", "total"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(c("hillebrand", "total"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

### Baselga

#### Species richness

```{r}
p <- map(c("nestedness", "turnover", "jaccard_dis"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(c("nestedness", "turnover", "jaccard_dis"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

#### Total abundance

```{r}
p <- map(c("nestedness", "turnover", "jaccard_dis"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(c("nestedness", "turnover", "jaccard_dis"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

### Jaccard

#### Species richness

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "species_nb",
  y = "jaccard",
  type = "direction"
)
```

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "species_nb",
  y = "jaccard",
  type = "shape_class"
)
```

#### Total abundance

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "total_abundance",
  y = "jaccard",
  type = "direction"
)
```

```{r}
boxplot_trends_shape(
  dataset = slope_classification_station,
  x = "total_abundance",
  y = "jaccard",
  type = "shape_class"
)
```

```{r}
p <- map(c("nestedness", "turnover", "jaccard_dis"),
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

### Total turnover, appearance, disappearance

```{r}
var_y <- c("total", "appearance", "disappearance")
```

```{r}
p <- map(var_y,
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(var_y,
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "species_nb",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

#### Total abundance

```{r}
p <- map(var_y,
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "direction"
))

plot_grid(plotlist = p)
```

```{r}
p <- map(var_y,
  ~boxplot_trends_shape( dataset =
    slope_classification_station,
  x = "total_abundance",
  y = .x,
  type = "shape_class"
))

plot_grid(plotlist = p)
```

# In stable richness  

```{r}
stable_rich_siteid <- slope_classification_station %>%
  filter(response == "species_nb", direction == "stable") %>%
  .[["siteid"]]
```

```{r}
high_jaccard_slope <-
  slope_df %>%
  filter(siteid %in% stable_rich_siteid) %>%
  select(siteid, total_abundance, species_nb, jaccard) %>%
  arrange(desc(jaccard))

site_desc_jaccard_slope <-
  high_jaccard_slope %>%
  .[["siteid"]]
```

```{r, fig.height=12}
p_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, jaccard),
    y = "jaccard", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_high_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_pop_high_jaccard <-
  map(site_desc_jaccard_slope[1:20],
    ~plot_temporal_population(
      filtered_dataset$measurement %>%
        filter(siteid == .x)
      ) +
    theme(legend.position = "none")
    )
plot_grid(plotlist = p_pop_high_jaccard, ncol = 3)
```

```{r, fig.height=12}
p_turnover_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, turnover),
    y = "turnover", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_turnover_high_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_nestedness_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, nestedness),
    y = "nestedness", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_nestedness_high_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_appearance_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, appearance),
    y = "appearance", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_appearance_high_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_disappearance_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, disappearance),
    y = "disappearance", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_disappearance_high_jaccard_slope, ncol = 3)
```

```{r}
diff_baseline <- analysis_dataset %>%
    group_by(siteid) %>%
    arrange(year) %>%
    summarise(
      diff_baseline = year[2] - year[1],
      span = year[length(year)] - year[1] + 1
    )
```

```{r}
slope_df %>%
  left_join(diff_baseline, by = "siteid") %>%
  ggplot(aes(x = diff_baseline, y = jaccard)) +
  geom_point() +
  geom_smooth(method = "gam")
```

```{r}
slope_df %>%
  left_join(diff_baseline, by = "siteid") %>%
  ggplot(aes(x = span, y = jaccard)) +
  geom_point() +
  geom_smooth(method = "gam")
```

```{r}
```




- Lets see communities that becomes more dissimilar:


```{r, fig.height=12}
p_jaccard_low_jaccard <-
  map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
    ~plot_community_data(
      analysis_dataset %>%
        filter(siteid == .x) %>%
        select(siteid, year, jaccard),
      y = "jaccard", x = "year",
      smoothing_method = "lm"))
plot_grid(plotlist = p_jaccard_low_jaccard, ncol = 3)
```

```{r, fig.height=12}
p_pop_low_jaccard <-
  map(site_desc_jaccard_slope[
    (length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
    ~plot_temporal_population(
      filtered_dataset$measurement %>%
        filter(siteid == .x)
      ) +
    theme(legend.position = "none")
    )
plot_grid(plotlist = p_pop_low_jaccard, ncol = 3)
```


```{r, fig.height=12}
p_turnover_low_jaccard_slope <- map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, turnover),
    y = "turnover", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_turnover_low_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_nestedness_low_jaccard_slope <- map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, nestedness),
    y = "nestedness", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_nestedness_low_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_appearance_low_jaccard_slope <- map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, appearance),
    y = "appearance", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_appearance_low_jaccard_slope, ncol = 3)
```

```{r, fig.height=12}
p_disappearance_low_jaccard_slope <- map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, disappearance),
    y = "disappearance", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_disappearance_low_jaccard_slope, ncol = 3)
```


## Turnover and nestedness 

```{r}
stable_rich_slope <- slope_classification_station %>%
  filter(siteid %in% stable_rich_siteid) %>%
select(response, siteid, linear_slope) %>%
pivot_wider(names_from = "response", values_from = "linear_slope") %>%
mutate(
  turn_minus_nest = turnover - nestedness,
  turn_sup_0 = turnover > 0,
  nest_sup_0 = nestedness > 0,
  turn_sup_nest = turnover > nestedness,
  appearance_sup_disappearance = appearance > disappearance,
  jaccard_sup_0 = jaccard > 0,
  richness_sup_0 = species_nb > 0 
  )
```

### Blowes et al. (2019)

```{r}
ti <- table(stable_rich_slope$richness_sup_0, stable_rich_slope$turn_sup_0,
  dnn = list("richness > 0", "turnover > 0"))
ti
```

```{r}
ti <- table(stable_rich_slope$richness_sup_0, stable_rich_slope$nest_sup_0,
  dnn = list("richness > 0", "nestedness > 0"))
ti
```


```{r}
sum(stable_rich_slope$jaccard_sup_0)
ti <- table(stable_rich_slope$jaccard_sup_0, stable_rich_slope$turn_sup_nest,
  dnn = list("jaccard > 0", "turnover > nestedness"))
ti
```

```{r}
ti <- table(stable_rich_slope$jaccard_sup_0,
  stable_rich_slope$appearance_sup_disappearance,
  dnn = list("jaccard > 0", "appearance > disappearance"))
ti
```

```{r}
stable_rich_slope %>%
pivot_longer(-siteid, names_to = "response", values_to = "linear_slope") %>%
filter(response %in% c("jaccard_dis", "turnover", "nestedness", "turn_minus_nest")) %>%
select(response, siteid, linear_slope) %>%
ggplot(aes(x = response, y = linear_slope)) +
geom_boxplot()
```

```{r}
```


# Classification matrix

```{r}
#debugonce(get_matrix_classification)
get_matrix_classification <- function(dataset = NULL, x = NULL, y = NULL) {
  ti <- dataset %>%
    filter(response %in% c(x, y)) %>%
    select(siteid, response, shape_class) %>%
    pivot_wider(names_from = "response", values_from = "shape_class")

  table(
    ti[[x]],
    ti[[y]]
  )
}
```


```{r}
ti <- get_matrix_classification(
  dataset = slope_classification_station,
  x = "species_nb",
  y = "hillebrand"
  )

corrplot::corrplot(as.matrix(ti) / rowSums(ti))
```




## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
