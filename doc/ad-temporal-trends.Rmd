---
title: "Temporal trends"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: "readable"
    code_folding: hide
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, analysis_dataset))
tar_load(c(rigal_trends, var_temporal_trends))
names(rigal_trends) <- var_temporal_trends
```

```{r}
slope <- map_dfr(rigal_trends,
  ~.x %>%
  select(siteid, linear_slope),
.id = "response"
)
```

```{r}
slope_df <- slope %>%
  pivot_wider(names_from = "response", values_from = "linear_slope")
```

# Summary

```{r}
summary_slope <- slope %>%
  group_by(response) %>%
  summarise(summ = list(enframe(summary_distribution(linear_slope, na.rm = TRUE)))) %>%
  unnest(cols = summ) %>%
  pivot_wider(names_from = "name", values_from = "value")
summary_slope %>%
  mutate(response = get_var_replacement()[response]) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover")) %>%
  scroll_box(width = "100%", height = "400px")
```

```{r}
bs <- map(var_temporal_trends, ~summary_distribution(slope_df[[.x]]))
names(bs) <- var_temporal_trends
```
- Jaccard trends: `r round(bs$jaccard["mean"], 3)` (`r round(bs$jaccard["sd"],3)` s.d.)
  (-0.01 in @dornelas_assemblage_2014).
  - meaning `r round(bs$jaccard["mean"], 3) * 10` % change per decade in average 
  - Jaccard decreased in `r percent(sum(slope_df$jaccard < 0) / nrow(slope_df))`
    of the sites (79% in @dornelas_assemblage_2014) 
- Richness trends:
  - +`r round(bs$log_species_nb["mean"], 1)`% richness change per year
    (`r round(bs$log_species_nb["sd"], 1)` s.d.), i.e.
    `r round(bs$log_species_nb["mean"] * 10)`% per decade.
  - 

# Check trends

```{r, fig.height=12}
p <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
    ggplot(aes(x = linear_slope)) +
    geom_histogram() +
    labs(title = .y)
)
plot_grid(plotlist = p)
```

- no NA in slopes since fix [rigal_classification](https://github.com/alaindanet/RivFishTimeBiodiversityFacets/commit/1c8b8c48e39abbe7644f2ab1ea1ec175b550c149):


```{r}
na_siteid_slope <- unique(slope[is.na(slope$linear_slope), ]$siteid)

sd_num <- analysis_dataset %>%
  group_by(siteid) %>%
  summarise(across(where(is.numeric), ~(sd(.x))))

sd_num %>%
  filter(siteid %in% na_siteid_slope) %>%
  summary(.)
```

- Tremendous trends in abundance:

```{r}
high_abundance_slope <- slope_df %>%
  arrange(desc(abs(total_abundance)))
high_abundance_slope
site_desc_slope_total_abundance <-
  high_abundance_slope %>%
  .[["siteid"]]
```

- The most tremendous temporal trends in abundance are located in  
  Illinois and France 



```{r, out.width="100%"}
ti <- filtered_dataset$location %>%
  filter(siteid %in% site_desc_slope_total_abundance[1:20]) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 2154)

sp::plot(ne_countries())
sp::plot(st_geometry(ti), add = TRUE, col = "red", pch = 19)
```


```{r}
filtered_dataset$abun_rich_op %>%
  filter(siteid %in% site_desc_slope_total_abundance[1:20]) %>%
  group_by(siteid) %>%
  summarise(across(c("total_abundance", "species_nb"), list(median = median, mean = mean)))
```

```{r, out.width="100%", fig.height=12}
p_high_slope_abun <- map(site_desc_slope_total_abundance[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, total_abundance),
    y = "total_abundance", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_high_slope_abun, ncol = 3)
```



```{r}
s11735_com <- analysis_dataset %>%
  filter(siteid == site_desc_slope_total_abundance[1]) %>%
  arrange(year) %>%
  select(siteid, year, total_abundance)
s11735_com
plot_community_data(s11735_com, y = "total_abundance", x = "year",
  smoothing_method = "lm")
```

```{r}
mean(s11735_com$total_abundance) -  sd(s11735_com$total_abundance)
mean(s11735_com$total_abundance) +  5 * sd(s11735_com$total_abundance)
```

- Petit poissons [*Notropis
  atherinoides*](https://en.wikipedia.org/wiki/Emerald_shiner) and
  [*Notropis volucellus*](https://en.wikipedia.org/wiki/Mimic_shiner) have
  several tremendous abundance.  Since those bursts happened four times, there
  have little probability to be error in the data.

```{r}
s11735_pop <- filtered_dataset$measurement %>%
  filter(siteid == site_desc_slope_total_abundance[1]) %>%
  arrange(year) %>%
  select(siteid, year, species, abundance)

s11735_pop %>%
  group_by(species) %>%
  summarise(abun = sum(abundance)) %>%
  arrange(desc(abun))

plot_temporal_population(s11735_pop) +
  theme(legend.position = "bottom")
```

- Second highest temporal trends in abundance:

```{r}
s6466_com <- analysis_dataset %>%
  filter(siteid == site_desc_slope_total_abundance[2]) %>%
  arrange(year) %>%
  select(siteid, year, total_abundance)
s6466_com
plot_community_data(s6466_com, y = "total_abundance", x = "year",
  smoothing_method = "lm")

```

```{r}
s6466_pop <- filtered_dataset$measurement %>%
  filter(siteid == site_desc_slope_total_abundance[2]) %>%
  arrange(year) %>%
  select(siteid, year, species, abundance)

s6466_pop %>%
  group_by(species) %>%
  summarise(abun = sum(abundance)) %>%
  arrange(desc(abun))

plot_temporal_population(s6466_pop) +
  theme(legend.position = "bottom")
```

# Relationships among temporal trends


## Globally

```{r}
cor_slope <- slope_df %>%
  select(-siteid) %>%
  cor(., method = "spearman")
cor_slope

png(here("doc", "fig", "p_cor_slope.png"))
corrplot::corrplot(cor_slope[c("chao_richness", "species_nb", "log_species_nb",
      "total_abundance", "log_total_abundance"), ], type = "upper", tl.srt = 45, diag = FALSE)
dev.off()

png(here("doc", "fig", "p_cor_slope_tot.png"))
corrplot::corrplot(cor_slope, type = "upper", tl.srt = 35, diag = FALSE)
dev.off()
```

```{r}
corrplot::corrplot(cor_slope[c("chao_richness", "species_nb", "log_species_nb",
      "total_abundance", "log_total_abundance"), ], type = "upper", tl.srt = 45, diag = FALSE)

corrplot::corrplot(cor_slope, type = "upper", tl.srt = 35, diag = FALSE)
```


```{r, fig.height=12}
ti <- expand.grid(
  resp1 = unique(slope$response),
  resp2 = unique(slope$response)
  ) %>%
  filter(resp2 != resp1) %>%
  filter(
    resp1 %in% c("chao_richness", "species_nb", "log_species_nb",
      "total_abundance", "log_total_abundance")) %>%
  mutate_all(as.character) %>%
  arrange(resp1)

test <- map2(ti$resp1, ti$resp2,
  function(x, y) {
    bi <- slope %>%
      filter(response %in% c(x, y)) %>%
      select(siteid, response, linear_slope) %>%
      pivot_wider(names_from = "response", values_from = "linear_slope")

    return(bi)
  }
)

p_trends_trends <- map(test, function(x) {
  l <- colnames(x)
  x %>%
    ggplot(aes(x = !!sym(l[2]), y = !!sym(l[3]))) +
    geom_point() +
    geom_smooth(method = "loess") +
    labs(
      x = get_var_replacement()[l[2]],
      y = get_var_replacement()[l[3]]
    )
})
names(p_trends_trends) <- map_chr(test, ~colnames(.x)[2])

```

## Total abundance

```{r, fig.height=12}
plot_grid(
  plotlist = p_trends_trends[names(p_trends_trends) %in% "total_abundance"],
  ncol = 3)
```

## Species richness

```{r, fig.height=12}
plot_grid(
  plotlist = p_trends_trends[names(p_trends_trends) %in% "species_nb"],
  ncol = 3)
```

## Log species richness

```{r, fig.height=12}
plot_grid(
  plotlist = p_trends_trends[names(p_trends_trends) %in% "log_species_nb"],
  ncol = 3
)
```

- Trends of total abundance are linked to the one of species richness but not to
  shannon and simpson, suggesting that the trends of abundance are more link to
  trends of rare species. Logic: gain and loss of species should concern rare
  species.
- Species richness decrease linked to disappearance, but not increase 
- Species richness increase linked to appearance, but not decrease 


## Turnover vs nestedness:

```{r}
test <- slope_df %>%
  mutate(
    nes_sup_tu = nestedness > turnover,
    nes_inf_tu = nestedness < turnover,
    rich_inc = species_nb >= 0
  )
sum(test$nes_sup_tu)
sum(test$nes_inf_tu)
test %>%
  tabyl(rich_inc, nes_sup_tu) %>%
  adorn_totals("row") %>%
  adorn_title(placement = "top")
```

```{r}
median_site_rich <- analysis_dataset %>%
  select(c("siteid", starts_with("chao_"), "total_abundance")) %>%
  group_by(siteid) %>%
  summarise(across(where(is.double), median)) %>%
  rename_with(~paste0("med_", .x), where(is.double))
```

```{r}
slope_df_med <- slope_df %>%
  left_join(median_site_rich, by = "siteid") %>%
  mutate(
    nes_sup_tu = nestedness > turnover,
    nes_inf_tu = nestedness < turnover,
    rich_inc = species_nb >= 0
  )
```

```{r}
slope_df_med %>%
  ggplot(aes(
      x = log_species_nb,
      y = jaccard_dis,
      shape = nes_sup_tu,
      color = nes_sup_tu
      )) +
  geom_point() +
  geom_smooth(method = "gam")
```

```{r}
p_baselga_jaccard <- map(c("nestedness", "turnover"),
  ~slope_df_med %>%
    ggplot(aes(
        x = jaccard_dis,
        y = !!sym(.x),
      color = log(med_chao_richness))) +
    geom_point() +
    scale_color_viridis() +
    geom_abline(intercept = 0, slope = 1) +
    geom_smooth(method = "loess")
)
p_baselga_jaccard[[3]] <-
  slope_df_med %>%
  ggplot(aes(
      x = jaccard_dis,
      y = nestedness - turnover,
      color = log(med_chao_richness))) +
  geom_point() +
  scale_color_viridis() +
  geom_abline(intercept = 0, slope = 1) +
  geom_smooth(method = "loess")

plot_grid(plotlist = p_baselga_jaccard, ncol = 3)
```

```{r}
slope_df_med %>%
  ggplot(aes(x = med_chao_richness, y = jaccard_dis)) +
  geom_point()
```



# Look at strong turnover trends

- Check with Jaccard:

```{r}
high_jaccard_slope <-
  slope_df %>%
  select(siteid, total_abundance, species_nb, jaccard) %>%
  arrange(desc(jaccard))
high_jaccard_slope
site_desc_jaccard_slope <-
  high_jaccard_slope %>%
  .[["siteid"]]
```

```{r}
ti <- filtered_dataset$location %>%
  filter(siteid %in% site_desc_jaccard_slope[1:20]) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 2154)

sp::plot(ne_countries())
sp::plot(st_geometry(ti), add = TRUE, col = "red", pch = 19)
```


```{r}
filtered_dataset$abun_rich_op %>%
  filter(siteid %in% site_desc_jaccard_slope[1:20]) %>%
  group_by(siteid) %>%
  summarise(across(c("total_abundance", "species_nb"),
      list(median = median, mean = mean))) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover")) %>%
  scroll_box(width = "100%", height = "400px")
```

```{r, fig.height=12}
p_high_jaccard_slope <- map(site_desc_jaccard_slope[1:20],
  ~plot_community_data(
    analysis_dataset %>%
    filter(siteid == .x) %>%
    select(siteid, year, jaccard),
    y = "jaccard", x = "year",
  smoothing_method = "lm"))
plot_grid(plotlist = p_high_jaccard_slope, ncol = 3)
```

```{r}
tar_load(vegdist_turnover_c)
```

- Hum, do not understand why community are more similar at the end of the time-steps

```{r, fig.height=12}
p_pop_high_jaccard <-
  map(site_desc_jaccard_slope[1:20],
    ~plot_temporal_population(
      filtered_dataset$measurement %>%
        filter(siteid == .x)
      ) +
    theme(legend.position = "none")
    )
plot_grid(plotlist = p_pop_high_jaccard, ncol = 3)
```

- Lets see communities that becomes more dissimilar:


```{r, fig.height=12}
p_jaccard_low_jaccard <-
  map(site_desc_jaccard_slope[(length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
    ~plot_community_data(
      analysis_dataset %>%
        filter(siteid == .x) %>%
        select(siteid, year, jaccard),
      y = "jaccard", x = "year",
      smoothing_method = "lm"))
plot_grid(plotlist = p_jaccard_low_jaccard, ncol = 3)
```

```{r, fig.height=12}
p_pop_low_jaccard <-
  map(site_desc_jaccard_slope[
    (length(site_desc_jaccard_slope)-20):length(site_desc_jaccard_slope)],
    ~plot_temporal_population(
      filtered_dataset$measurement %>%
        filter(siteid == .x)
      ) +
    theme(legend.position = "none")
    )
plot_grid(plotlist = p_pop_low_jaccard, ncol = 3)
```




# Comparison rigal, lm

```{r}
rigal_trends_df <-  map2_dfr(
  rigal_trends, names(rigal_trends),
  ~.x %>% mutate(variable = .y)
  ) %>%
  select(variable, siteid, linear_slope) %>%
  pivot_wider(names_from = "variable", values_from = "linear_slope") %>%
  mutate(type = "rigal")
```

```{r}
slope_comp <- list()
slope_comp$rigal <- rigal_trends_df[order(rigal_trends_df$siteid), ]
slope_comp$simple_lm <- slope_df[order(slope_df$siteid), ]
stopifnot(all(slope_comp$rigal$siteid == slope_comp$simple_lm$siteid))
slope_comp$diff <- tibble(
  siteid = slope_comp$rigal$siteid)
for (i in var_temporal_trends) {
  slope_comp$diff[[i]] <- slope_comp$rigal[[i]] - slope_comp$simple_lm[[i]]
}
```

- All good !

```{r}
old_par <- par()
par(mfrow = c(3, 2))
for (i in var_temporal_trends) {
  plot(
    slope_comp$rigal[[i]] ~
      slope_comp$simple_lm[[i]],
    ylab = "Rigal (polynomial degree 2)",
    xlab = "Simple LM"
  )
  abline(0, 1)
  title(i)
}
par(old_par)
```

```{r}
# Compare Rigal and simple lm for few sites
plot_rigal_raw_data <- function(
  site = NULL,
  response = NULL,
  dataset = NULL,
  rigal_trends = NULL
  ) {

  raw_data <- dataset %>%
    filter(siteid == site)
  rigal_resp <- rigal_trends[[response]]
  rigal_resp_site <- rigal_resp[rigal_resp$siteid == site, ]
  plot(raw_data[[response]]~raw_data[["year"]], ylab = response, xlab = "Year")
  abline(rigal_resp_site$intercept, rigal_resp_site$linear_slope, col
  = "red")
  abline(lm(raw_data[[response]]~raw_data[["year"]]), col = "green")
  title(main = site)
}
```

```{r}
plot_rigal_raw_data(site = "S2672", response = "log_total_abundance", dataset =
analysis_dataset, rigal_trends = rigal_trends)
```


```{r}
slope_comp$diff <- slope_comp$diff %>%
  arrange(desc(abs(log_total_abundance)))
```

```{r}
old_par <- par()
par(mfrow = c(3, 2))
for (i in slope_comp$diff[1:6,]$siteid) {
  plot_rigal_raw_data(
    site = i,
    response = "log_total_abundance",
    dataset = analysis_dataset,
    rigal_trends = rigal_trends
  )
}
par(old_par)
```

# Classification of temporal trends 


- Classification:

```{r, fig.height=12}
classification_station <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
  ggplot(aes(x = shape_class)) +
  geom_bar() +
  labs(x = "Trajectory classification", y = "Nb station",
    title = get_var_replacement()[.y]) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
)


plot_grid(plotlist = classification_station)
p_classif_abun_rich <- plot_grid(
  plotlist = classification_station[
    names(classification_station)[str_detect(names(classification_station),
  "abundance|richness|species")]])
save_plot(
  here("doc", "fig", "classif_trends_abun_rich.png"),
  p_classif_abun_rich
)
p_classif_hill_evenness <- plot_grid(
  plotlist = classification_station[
    names(classification_station)[str_detect(names(classification_station),
  "shannon|simpson|evennes")]])
save_plot(
  here("doc", "fig", "classif_trends_hill_evenness.png"),
  p_classif_hill_evenness
)
p_classif_turnover <- plot_grid(
  plotlist = classification_station[
    names(classification_station)[names(classification_station) %in%
      c("jaccard", "horn", "chao", "hillebrand", "total", "appearance",
        "disappearance")]])
save_plot(
  here("doc", "fig", "classif_trends_classif_hill_evenness.png"),
  p_classif_turnover
)
```

```{r}
ti <- map_dfr(rigal_trends, ~tabyl_df(x = .x, group = "direction"),
  .id = "response"
)
ti %>%
  filter(direction != "Total") %>%
  select(response, direction, percent) %>%
  mutate(response = str_replace_all(response, get_var_replacement())) %>%
  pivot_wider(names_from = "direction", values_from = "percent") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```

- Linear trends:

```{r}
#3.3   Log-linear model:logYi=α+βXi+εiIn

#the log-linear model, the literal interpretation of the estimated
#coefficientˆβis that a one-unitincrease inXwill produce an expected increase in
#logYofˆβunits. 
#In terms ofYitself, this
#meansthat  the  expected  value  ofYis  multiplied  byeˆβ.   So  in  terms  of
#effects  of  changes  inXonY(unlogged):•Each 1-unit increase inXmultiplies the
#expected value ofYbyeˆβ.•To compute the effects onYof another change inXthan an
#increase of one unit, call thischangec, we need to includecin the exponent.  The
#effect of ac-unit increase inXis tomultiply the expected value ofYbyecˆβ. So the
#effect for a 5-unit increase inXwould bee5ˆβ.•For small values ofˆβ,
#approximatelyeˆβ≈1+ˆβ. We can use this for the following approxima-tion for a
#quick interpretation of the coefficients:  100·ˆβis the expected percentage
#changeinYfor a unit increase inX.  For instance forˆβ=.06,e.06≈1.06, so a 1-unit
#change inXcorresponds to (approximately) an expected increase inYof 6%
```


```{r, fig.height=12}
#https://data.library.virginia.edu/interpreting-log-transformations-in-a-linear-model/
hist_linear_plot <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
  ggplot(aes(x = linear_slope)) +
  geom_histogram() +
  labs(x = "Linear slope", y = "Number of station",
    title = get_var_replacement()[.y]) +
  ylim(c(0, 1000))
)
plot_grid(plotlist = hist_linear_plot)
```
```{r}
type_response <- list(
  abun_rich = str_detect(names(classification_station),
    "abundance|richness|species"),
  hill_evenness = str_detect(names(classification_station),
    "shannon|simpson|evennes"),
  turnover = names(classification_station) %in%
    c("jaccard", "horn", "chao", "hillebrand", "total", "appearance",
      "disappearance")
)

map2(type_response, names(type_response),
  function(x, y) {
  p <- plot_grid(
    plotlist = hist_linear_plot[
      names(hist_linear_plot)[x]
      ]
  )
  save_plot(
    here("doc", "fig", paste0("hist_linear_slope_", y, ".png")),
    p
  )

  }
)
```

# Spatialization of temporal trends

```{r}
rigal_trends_df_loc <-
  rigal_trends_df %>%
  left_join(
    select(filtered_dataset$location, siteid, ecoregion, country),
    by = c("siteid"))
```

- No obvious geographic patterns 

```{r}
rigal_trends_df_loc %>%
  ggplot(aes(x = country, y = log_species_nb, fill = ecoregion)) +
  geom_boxplot()

rigal_trends_df_loc %>%
  ggplot(aes(x = country, y = log_total_abundance, fill = ecoregion)) +
  geom_boxplot()

rigal_trends_df_loc %>%
  ggplot(aes(x = country, y = total, fill = ecoregion)) +
  geom_boxplot()

rigal_trends_df_loc %>%
  ggplot(aes(x = country, y = jaccard, fill = ecoregion)) +
  geom_boxplot()

rigal_trends_df_loc %>%
  ggplot(aes(x = country, y = jaccard_dis, fill = ecoregion)) +
  geom_boxplot()

rigal_trends_df_loc %>%
    ggplot(aes(x = country, y = hillebrand, fill = ecoregion)) +
    geom_boxplot()
```

```{r}
rigal_trends_df_loc <- filtered_dataset$location %>%
  left_join(rigal_trends_df, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```


```{r}
library(colorspace)
div_pal <- colorspace::sequential_hcl(11, "plasma")
world <- ne_countries(returnclass = "sf") 

bb <- st_bbox(rigal_trends_df_loc)
```


```{r}
map_world_trends(df = rigal_trends_df_loc, y = "log_species_nb")
```

```{r}
map_world_trends(df = rigal_trends_df_loc, y = "jaccard")
```

```{r}
map_world_trends(df = rigal_trends_df_loc, y = "log_total_abundance")
```

```{r}
rigal_trends_df %>%
  summarise(across(where(is.numeric), median, na.rm = T)) %>%
  unlist()

median(exp(rigal_trends_df$log_total_abundance) - 1)  * 100
sd(exp(rigal_trends_df$log_total_abundance) - 1) * 100
median(exp(na.omit(rigal_trends_df$log_species_nb))  - 1) * 100
sd(exp(na.omit(rigal_trends_df$log_species_nb)) - 1) * 100
```

# Sensibility analysis of temporal trends

```{r}
tar_load(c(rigal_trends_avg3y))
names(rigal_trends_avg3y) <- var_temporal_trends
```
```{r}
tar_load(c(analysis_dataset_avg3y, measurement_avg3y, measurement))
tar_load(c(turnover_avg3y_c))
tar_load(c(vegdist_turnover_c))
tar_load(c(hillnb_avg3y))
```


```{r}
slope_avg3y <- map_dfr(rigal_trends_avg3y[
  ! names(rigal_trends_avg3y) %in% c("jaccard_dis", "nestedness", "turnover")], ~.x %>%
  select(siteid, linear_slope),
.id = "response"
)
```

- Number of sites that are in the different datasets:

```{r}
u_site <- map(list(classic = slope, avg_3y = slope_avg3y), ~unique(.x$siteid))
sum(u_site[[1]] %in% u_site[[2]])
sum(u_site[[2]] %in% u_site[[1]])
```

```{r}
comparison_baseline <- rbind(
  slope %>%
    mutate(type = "classic") %>%
    filter(siteid %in% u_site[["avg_3y"]]),
  slope_avg3y %>%
    mutate(type = "avg_3y")
  ) %>%
pivot_wider(names_from = type, values_from = linear_slope)
```

- It is not too bad, but we can see some differences:  
  - slope negatively biaised for `log_species_nb` in
    3 years baseline 
  - Bunch of trends in appearance/disappearance trends disappears with  
    3 years baseline 
  - But note that in three years baseline, there are three points less data 


```{r, fig.height=8}
comparison_baseline %>%
  ggplot(aes(x = classic, y = avg_3y)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap(~response, scale = "free")
```

# Environment 

```{r}
tar_load(c(wt_mv_avg, riveratlas_site))
col_to_keep <- get_river_atlas_significant_var()
names(col_to_keep) <- NULL

riv <- riveratlas_site %>%
  clean_names() %>%
  select(all_of(c("siteid", col_to_keep))) %>%
  st_drop_geometry()
```

```{r}
slp_riv <- slope_df %>%
  select(siteid, log_species_nb, evenness, turnover, nestedness, hillebrand,
    appearance, disappearance, jaccard) %>%
left_join(riv, by = "siteid") %>%
left_join(select(filtered_dataset$location, siteid, ecoregion, main_bas, latitude, longitude), by = "siteid")

length(unique(slp_riv$main_bas))
```

```{r}
slp_riv %>%
  ggplot(aes(y = jaccard, x = as.factor(ord_stra), color = ecoregion)) +
  geom_boxplot()

slp_riv %>%
  ggplot(aes(y = jaccard, x = log(dist_up_km), color = ecoregion)) +
  geom_point() +
  geom_smooth(method = "lm")

slp_riv %>%
  ggplot(aes(y = jaccard, x = as.factor(ord_flow), color = ecoregion)) +
  geom_boxplot()

slp_riv %>%
  ggplot(aes(y = jaccard, x = tmp_dc_cyr /10, color = ecoregion)) +
  geom_point() +
  geom_smooth(method = "lm")
```
```{r}
slp_riv %>%
  ggplot(aes(y = hillebrand, x = as.factor(ord_stra), color = ecoregion)) +
  geom_boxplot()

slp_riv %>%
  ggplot(aes(y = hillebrand, x = log(dist_up_km), color = ecoregion)) +
  geom_point() +
  geom_smooth(method = "lm")

slp_riv %>%
  ggplot(aes(y = hillebrand, x = as.factor(ord_flow), color = ecoregion)) +
  geom_boxplot()

slp_riv %>%
  ggplot(aes(y = hillebrand, x = tmp_dc_cyr /10, color = ecoregion)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
slp_riv %>%
  ggplot(aes(y = hillebrand, x = log(dist_up_km), color = as.factor(main_bas))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) + 
  theme(legend.position = "none")

slp_riv %>%
  ggplot(aes(y = hillebrand, x = ord_stra, color = as.factor(main_bas))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme(legend.position = "none")

slp_riv %>%
  ggplot(aes(y = hillebrand, x = ord_flow, color = as.factor(main_bas))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme(legend.position = "none")
```
```{r}
ti <- slp_riv %>%
 nest_by(main_bas) %>%
 filter(nrow(data) > 10 & sum(!is.na(data$dist_up_km)) > 10) 

tu <- ti %>%
  mutate(
    m = list(lm(jaccard ~ log(dist_up_km), data = data)),
    coef = list(broom::tidy(m))
  ) %>%
  unnest(coef) %>%
  filter(term == "log(dist_up_km)") 

tu %>%
  ggplot(aes(x = estimate)) +
  geom_histogram()

summary(lm(jaccard ~ log(dist_up_km), slp_riv))
```

- Appearance:

```{r}
knitr::opts_chunk$set(eval = FALSE)
```


```{r}
library(spaMM)
tu <- ti %>%
  mutate(
    m = list(lm(appearance ~ ord_stra, data = data))
    ,
    coef = list(broom.mixed::tidy(m))
  ) %>%
  unnest(coef) %>%
  filter(term == "ord_stra") %>%
  ungroup()

stat_data <- slp_riv %>%
  mutate(
    appearance = scale(appearance),
    ord_stra = as.factor(ord_stra),
    main_bas = as.factor(main_bas),
    log_dist_up_km = log(dist_up_km)
  )

m0 <- spaMM::fitme(appearance ~ ord_stra, stat_data)
plot(m0)

m1 <- spaMM::fitme(appearance ~ ord_stra + (1 | main_bas),
  stat_data)

m2 <- spaMM::fitme(
  appearance ~ ord_stra + (1 + ord_stra | main_bas),
  stat_data
)

m2d <- spaMM::fitme(
  appearance ~ dist_up_km + (1 + dist_up_km | main_bas),
  stat_data
)
summary(m2d)

m2d <- spaMM::fitme(
  appearance ~ log_dist_up_km + (1 + log_dist_up_km | ecoregion/main_bas/siteid),
  stat_data
)
summary(m2d)
plot(m2d)


tm <- stat_data %>%
  na.omit() %>%
  mutate(
    pred_appearance = predict(m2d,
                              re.form = ~log_dist_up_km + (1 + log_dist_up_km | ecoregion))[,1]
  )
tm %>%
  ggplot(aes(x = log_dist_up_km, y = pred_appearance, color = ecoregion)) +
  geom_line()
```
```{r}
tar_load(analysis_dataset)
formula <- paste0(
  "jaccard",
  " ~ ",
  "year", "+", "year:ord_stra", " + ", "(1 + year:ord_stra| ecoregion/main_bas/siteid)"
)
spaMM::fitme(formula = formula, data = analysis_dataset)

formula <- paste0(
  "jaccard",
  " ~ ",
  "dis_up_km + tmp_dc_cyr + (1 + dist_up_km + tmp_dc_cyr | ecoregion/main_bas/siteid)"
)



```


```{r, eval=FALSE}
m3 <- spaMM::fitme(scale(appearance) ~ ord_stra + (1 | main_bas) +
  Matern(1 | longitude + latitude),
  na.omit(slp_riv), control.HLfit = list(algebra = "decorr"))
```


- Disappearance:

```{r}
tu <- ti %>%
  mutate(
    m = list(lm(disappearance ~ log(dist_up_km), data = data)),
    coef = list(broom::tidy(m))
  ) %>%
  unnest(coef) %>%
  filter(term == "log(dist_up_km)") %>%
  ungroup()

tu %>%
  ggplot(aes(x = estimate)) +
  geom_histogram()

summary(lm(disappearance ~ log(dist_up_km), slp_riv))
```

```{r}
cor_slp_env <-
  slp_riv[, !colnames(slp_riv) %in% c("siteid", "ecoregion", "main_bas")] %>%
  na.omit() %>%
  cor(., method = "spearman")
```


```{r cor_slp_env}
corrplot::corrplot(
  cor_slp_env
)
```

```{r}

```


```{r}

library(INLA)
a3 <- inla(scale(appearance) ~ ord_stra + f(main_bas, model = "iid"),
  family = "gaussian",
  control.predictor = list(link = 1, compute = TRUE),
  control.compute = list(cpo = TRUE, dic = TRUE, config = TRUE),
  data = slp_riv)
```





## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
