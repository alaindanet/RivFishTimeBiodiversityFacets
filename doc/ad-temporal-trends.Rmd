---
title: "Temporal trends"
author: "Alain Danet"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    code_folding: hide
---

```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
```

```{r load-targets, include=FALSE}
tar_load(c(filtered_dataset, analysis_dataset))
tar_load(c(rigal_trends, var_temporal_trends))
```


```{r}
tar_load(rigal_trends)
names(rigal_trends) <- var_temporal_trends
```
```{r}
slope <- map_dfr(rigal_trends, ~.x %>%
  select(siteid, linear_slope),
.id = "response"
)
```

```{r}
slope_df <- slope %>%
  pivot_wider(names_from = "response", values_from = "linear_slope")
```

- NA in slopes:

```{r}
summary_slope <- slope %>%
  group_by(response) %>%
  summarise(summ = list(enframe(summary_distribution(linear_slope, na.rm = TRUE)))) %>%
  unnest(cols = summ) %>%
  pivot_wider(names_from = "name", values_from = "value")
summary_slope %>%
  kable()
```

```{r}
na_siteid_slope <- unique(slope[is.na(slope$linear_slope), ]$siteid)

sd_num <- analysis_dataset %>%
  group_by(siteid) %>%
  summarise(across(where(is.numeric), ~(sd(.x))))

sd_num %>%
  filter(siteid %in% na_siteid_slope) %>%
  summary(.)

analysis_dataset %>%
  filter(siteid %in% na_siteid_slope[5])
```


```{r}
cor_slope <- slope_df %>%
  mutate(across(where(is.numeric), ~ifelse(is.na(.x), 0, .x))) %>%
  select(-siteid) %>%
  cor(.)
cor_slope
corrplot::corrplot(cor_slope, type = "lower", tl.srt = 30)
```

```{r}
ti <- expand.grid(
  resp1 = unique(slope$response),
  resp2 = unique(slope$response)
  ) %>%
  filter(resp2 != resp1) %>%
  filter(
    resp1 %in% c("chao_richness", "species_nb", "log_species_nb",
      "total_abundance", "log_total_abundance")) %>%
  mutate_all(as.character) %>%
  arrange(resp1)

test <- map2(ti$resp1, ti$resp2,
  function(x, y) {
    bi <- slope %>%
      filter(response %in% c(x, y)) %>%
      select(siteid, response, estimate) %>%
      pivot_wider(names_from = "response", values_from = "estimate")

    return(bi)
  }
)

p <- map(test, function(x) {
  l <- colnames(x)
  x %>%
    ggplot(aes(x = !!sym(l[2]), y = !!sym(l[3]))) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(x = l[2], y = l[3])
})
names(p) <- map_chr(test, ~colnames(.x)[2])

plot_grid(plotlist = p[names(p) %in% "total_abundance"])
```

- Trends of total abundance are linked to the one of species richness but not to
  shannon and simpson, suggesting that the trends of abundance are more link to
  trends of rare species. Logic: gain and loss of species should concern rare
  species.

```{r}
names(rigal_trends) <- var_temporal_trends

p <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
    ggplot(aes(x = linear_slope)) +
    geom_histogram() +
    labs(title = .y)
)
plot_grid(plotlist = p)
```

# Comparison rigal, lm

```{r}
rigal_trends_df <-  map2_dfr(
  rigal_trends, names(rigal_trends),
  ~.x %>% mutate(variable = .y)
  ) %>%
  select(variable, siteid, linear_slope) %>%
  pivot_wider(names_from = "variable", values_from = "linear_slope") %>%
  mutate(type = "rigal")
```

```{r}
slope_comp <- list()
slope_comp$rigal <- rigal_trends_df[order(rigal_trends_df$siteid), ]
slope_comp$simple_lm <- slope_df[order(slope_df$siteid), ]
stopifnot(all(slope_comp$rigal$siteid == slope_comp$simple_lm$siteid))
slope_comp$diff <- tibble(
  siteid = slope_comp$rigal$siteid)
for (i in var_temporal_trends) {
  slope_comp$diff[[i]] <- slope_comp$rigal[[i]] - slope_comp$simple_lm[[i]]
}
```

- All good !

```{r}
old_par <- par()
par(mfrow = c(3, 2))
for (i in var_temporal_trends) {
  plot(
    slope_comp$rigal[[i]] ~
      slope_comp$simple_lm[[i]],
    ylab = "Rigal (polynomial degree 2)",
    xlab = "Simple LM"
  )
  abline(0, 1)
  title(i)
}
par(old_par)
```

```{r}
# Compare Rigal and simple lm for few sites
plot_rigal_raw_data <- function(
  site = NULL,
  response = NULL,
  dataset = NULL,
  rigal_trends = NULL
  ) {

  raw_data <- dataset %>%
    filter(siteid == site)
  rigal_resp <- rigal_trends[[response]]
  rigal_resp_site <- rigal_resp[rigal_resp$siteid == site, ]
  plot(raw_data[[response]]~raw_data[["year"]], ylab = response, xlab = "Year")
  abline(rigal_resp_site$intercept, rigal_resp_site$linear_slope, col
  = "red")
  abline(lm(raw_data[[response]]~raw_data[["year"]]), col = "green")
  title(main = site)
}
```

```{r}
plot_rigal_raw_data(site = "S2672", response = "log_total_abundance", dataset =
analysis_dataset, rigal_trends = rigal_trends)
```


```{r}
slope_comp$diff <- slope_comp$diff %>%
  arrange(desc(abs(log_total_abundance)))
```

```{r}
old_par <- par()
par(mfrow = c(3, 2))
for (i in slope_comp$diff[1:6,]$siteid) {
  plot_rigal_raw_data(
    site = i,
    response = "log_total_abundance",
    dataset = analysis_dataset,
    rigal_trends = rigal_trends
  )
}
par(old_par)
```

# Polynomial 


- Classification:

```{r}
classification_station <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
  ggplot(aes(x = shape_class)) +
  geom_bar() +
  labs(x = "Trajectory classification", y = "Number of station",
    title = get_var_replacement()[.y]) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
)

plot_grid(plotlist = classification_station)
```

- Linear trends:

```{r}
#3.3   Log-linear model:logYi=α+βXi+εiIn 

#the log-linear model, the literal interpretation of the estimated
#coefficientˆβis that a one-unitincrease inXwill produce an expected increase in
#logYofˆβunits. 
#In terms ofYitself, this
#meansthat  the  expected  value  ofYis  multiplied  byeˆβ.   So  in  terms  of
#effects  of  changes  inXonY(unlogged):•Each 1-unit increase inXmultiplies the
#expected value ofYbyeˆβ.•To compute the effects onYof another change inXthan an
#increase of one unit, call thischangec, we need to includecin the exponent.  The
#effect of ac-unit increase inXis tomultiply the expected value ofYbyecˆβ. So the
#effect for a 5-unit increase inXwould bee5ˆβ.•For small values ofˆβ,
#approximatelyeˆβ≈1+ˆβ. We can use this for the following approxima-tion for a
#quick interpretation of the coefficients:  100·ˆβis the expected percentage
#changeinYfor a unit increase inX.  For instance forˆβ=.06,e.06≈1.06, so a 1-unit
#change inXcorresponds to (approximately) an expected increase inYof 6%
```


```{r}
#https://data.library.virginia.edu/interpreting-log-transformations-in-a-linear-model/
hist_linear_plot <- map2(rigal_trends, names(rigal_trends),
  ~.x %>%
  ggplot(aes(x = (exp(linear_slope) - 1) * 100)) +
  geom_histogram() +
  labs(x = "Linear slope (% change per year)", y = "Number of station",
    title = get_var_replacement()[.y]) +
  ylim(c(0, 3000))
)
plot_grid(plotlist = hist_linear_plot)
```

# Turnover

```{r, eval=FALSE}
tar_load(hillebrand)
```



## Analysis

## Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
