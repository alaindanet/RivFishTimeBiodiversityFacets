---
title: "Main figures of the manuscript"
author: Danet, A., Giam, X., Olden, J. and Comte L.
output:
  bookdown::pdf_document2:
    keep_tex: true
  bookdown::word_document2:
always_allow_html: true
---


```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(ade4)
library(factoextra)
library(patchwork)
library(ggbreak)

knitr::opts_chunk$set(
  echo = FALSE,
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  fig.path = "fig_paper/knitr-",
  fig.retina = 1, # Control using dpi
  fig.width = 2.25,  # generated images
  fig.pos = "htp",  # pdf mode
  fig.align = "center",
  dpi = 300,
  dev = "png",
  dev.args = list(png = list(type = "cairo-png")),
  optipng = "-o1 -quiet"
)

options(kableExtra.latex.load_packages = TRUE)
library(kableExtra)
```

# Options

## Color blind palettes

- For variables: [palette from coolors.co](https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996)
- For clusters: the discrete version of the [viridis palette](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html)

```{r}
# control also the order of the legend
restricted_dimension <- c(
  "log_total_abundance", "log_chao_richness",
   "perc_exo_abun", "perc_exo_sp",
  "hillebrand_dis_scaled", "turnover_scaled"
  )
```


```{r set-color-palette}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")

#pal <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
#pal2 <- palette_coolors("https://coolors.co/palette/01befe-ffdd00-ff7d00-ff006d-adff02-8f00ff")
#pal_variable <- palette_coolors("https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")

names(pal_variable) <- get_var_replacement_vulgarisation()[restricted_dimension]
#scale_color_brewer(palette = "RdYlBu") +
#scale_color_viridis(discrete=TRUE) +

pal_variable2 <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
```

```{r loading-targets, include=FALSE}
tar_load(c(gaussian_inla_exo_std_effects, gaussian_inla_std_effects,
    measurement_exo, gaussian_inla_var_fitted, gaussian_inla_rand))
tar_load(site_no_drivers_inla_tot)
tar_load(c(clust_var, exo_resp_var))
```


# Figures

## Distibution of trends



```{r}
trends_cap <- "Distribution of temporal trends by decade of community metrics
across sites. Total abundance and species richness are expressed in percentage change per year."
```

```{r}
# Get average trends with credible intervals
tar_load(c(trends, trends90, trends80))
trends_y <- map2_dfr(
  list(trends, trends90, trends80),
  c("95%", "90%", "80%"),
  function(data, ci) {
    enframe(data, name = "response") %>%
      mutate(
        ci_level = ci,
        # Transform log variable
        value = map2(response, value,
          function (resp, val) {
            if (resp %in% c("log_total_abundance", "log_chao_richness")) {
              out = log_beta_to_perc_rate(val) * log(10 + 1)
            } else if(resp %in% c(
                "hillebrand_dis_scaled",
                "jaccard_dis_scaled",
                "nestedness_scaled",
                "turnover_scaled")
              ) {
              out = val * log(10 + 1) * 100
            } else {
              out = val * log(10 + 1)
            }
            out
          }),
        value = map(value, ~enframe(.x, name = "type"))
        ) %>%
      unnest(value) %>%
      pivot_wider(names_from = "type", values_from = "value")

  }
)

trends_y %<>%
  mutate(
    width_bar = 0,
    width_bar = case_when(
      ci_level == "95%" ~ .1,
      ci_level == "90%" ~ 1,
      ci_level == "80%" ~ 5,
      TRUE ~ width_bar

    )
  )
```

```{r}
perc_pal_variable <- setNames(pal_variable,
      c(
        "Abundance (total, %)", "Richness (%)",
        "Non-native abundance (proportion)", "Non-native richness (proportion)",
        "Dissimilarity (%)", "Turnover (%)"
      ))
tps_trends_y <- site_no_drivers_inla_tot %>%
  pivot_longer(everything(), names_to = "response", values_to = "value") %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    value = ifelse(response %in% c("Abundance (total)", "Richness"),
      log_beta_to_perc_rate(value) * log(10 + 1),
      value),
    value = ifelse(response %in% c("Dissimilarity", "Turnover"),
      value * log(10 + 1) * 100, value),
    value = ifelse(response %in% c("Non-native abundance", "Non-native richness"),
      value * log(10 + 1), value),
    response = str_replace_all(response,
      c(
        "Abundance \\(total\\)" = "Abundance (total, %)",
        "Richness" = "Richness (%)",
        "Non-native abundance" = "Non-native abundance (proportion)",
        "Non-native richness" = "Non-native richness (proportion)",
        "Dissimilarity" = "Dissimilarity (%)",
        "Turnover" = "Turnover (%)"
      )
      ),
    response_f = factor(response, levels = names(perc_pal_variable)),
    value = value
  ) %>%
  group_by(response_f) %>%
  mutate(
    med = median(value),
    avg = mean(value)
  )
ci_label_data <- trends_y %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    response = str_replace_all(response,
      c(
        "Abundance \\(total\\)" = "Abundance (total, %)",
        "Richness" = "Richness (%)",
        "Non-native abundance" = "Non-native abundance (proportion)",
        "Non-native richness" = "Non-native richness (proportion)",
        "Dissimilarity" = "Dissimilarity (%)",
        "Turnover" = "Turnover (%)"
      )
      ),
    response_f = factor(response, levels = names(perc_pal_variable)),
    )
```

```{r}
#expression(
#      paste("Standardized slope coefficients ",
#        beta, "' (", "s.d. unit)",
#        sep = "")
#)
abc_label <- setNames(
  map2_chr(letters[1:6], levels(ci_label_data$response_f),
    function(label, v) {
    x <- paste0(" bold(", label, ") ", v, "") %>%
      str_replace_all("\\s", "~") %>%
      str_replace_all(",", "','")  %>%
      str_replace_all("%", "")  %>%
      str_replace_all("\\~\\(", "~'('*") %>%
      str_replace("n\\)", "n')'") %>%
      str_replace("~\\)", "~')'") %>%
      str_replace("~'\\('\\)", "~'('')'")


#    if (!str_ends(x, "'")) {
#      x <- paste0(x, "'")
#    }
    x
    }

    #%>%
    #  str_replace_all("\\~\\(.*\\)", "") #"\'%\'*"

    ),
  levels(ci_label_data$response_f)
)

abc_label <- setNames(
  map2_chr(letters[1:6], levels(ci_label_data$response_f),
    function(label, v) {
    paste0(" ", label, " ", v, "")
    }

    #%>%
    #  str_replace_all("\\~\\(.*\\)", "") #"\'%\'*"

    ),
  levels(ci_label_data$response_f)
)

```



```{r, fig.width = 12, fig.asp = 1, fig.cap=trends_cap}
p_trends_site <- tps_trends_y %>%
  arrange(response_f) %>%
  ggplot(aes(x = value, fill = response_f)) +
  geom_histogram(bins = 60) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  #geom_vline(aes(xintercept = avg)) +
  labs(x = "Temporal trends per decade", y = "Number of sites") +
  scale_x_continuous(n.breaks = 8) +
  scale_fill_manual(
    values = perc_pal_variable,
    breaks = names(perc_pal_variable),
    name = "Community metrics"
    ) +
  facet_wrap(~response_f, scales = "free", ncol = 2,
    strip.position = "top",
    labeller = as_labeller(abc_label)
    ) +
  theme_cowplot(10) +
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    strip.background = element_blank(),
    legend.position = "none"
  )
```
```{r}
myrel_y = -8/100
ci_label_data %<>%
  mutate(
    error_bar_pos = case_when(
      response == "Abundance (total, %)" ~ 600 * myrel_y,
      response == "Richness (%)" ~ 600 * myrel_y,
      response == "Non-native abundance (proportion)" ~ 2000 * myrel_y,
      response == "Non-native richness (proportion)" ~ 2000 * myrel_y,
      response == "Turnover (%)" ~ 400 * myrel_y,
      response == "Dissimilarity (%)" ~ 160 * myrel_y,
      TRUE ~ 1000 * .10
    )
  )
p_trends_site2 <-
  p_trends_site +
  geom_pointrange(
    data = ci_label_data %>%
      filter(ci_level == "95%") %>%
      arrange(desc(width_bar)),
    aes(y = error_bar_pos, x = mean,
      xmin = low, xmax = high,
      color = response_f),
    size = .08,
    linewidth = .8,
    alpha = .8,
    position = position_dodge2(width = 1, padding = 0.5),
    show.legend = FALSE
    ) +
  scale_color_manual(
    values = perc_pal_variable,
    breaks = names(perc_pal_variable),
    name = "Community metrics"
  ) +
theme(
  strip.text = element_text(hjust = 0, margin = margin(0, 0, 0, 0, "pt"))
)
```

```{r}
ggsave(
  filename = "p_trends.pdf",
  plot = p_trends_site2,
  path = here("paper", "fig_paper"),
  scale = 2.0,
  width = 90,
  height = 90 * .90,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_trends.png",
  plot = p_trends_site2,
  path = here("paper", "fig_paper"),
  scale = 2.0,
  width = 90,
  height = 90 * .90,
  units = "mm",
  dpi = "print"
)
```

```{r}
supp_var_dist_trend <- c("jaccard_dis_scaled", "nestedness_scaled")
tps_trends_y_supp <- site_no_drivers_inla_tot %>%
  pivot_longer(everything(), names_to = "response", values_to = "value") %>%
  filter(response %in% supp_var_dist_trend) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    value = value * log(10 + 1) * 100,
    response_f = factor(response, levels = get_var_replacement_vulgarisation()[supp_var_dist_trend])
  ) %>%
  group_by(response_f) %>%
  mutate(
    med = median(value),
    avg = mean(value)
  )
ci_label_data_supp <- trends_y %>%
  filter(response %in% supp_var_dist_trend) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    response_f = factor(response, levels = get_var_replacement_vulgarisation()[supp_var_dist_trend])
    )
```

```{r, fig.width = 12, fig.asp = 1, fig.cap=trends_cap}
abc_label_supp <- setNames(
  map2_chr(letters[1:2], levels(ci_label_data_supp$response_f),
    ~paste0(" ", .x, " ", .y)
    ),
  levels(ci_label_data_supp$response_f)
)
p_trends_site_supp <- tps_trends_y_supp %>%
  arrange(response_f) %>%
  ggplot(aes(x = value, fill = response_f)) +
  geom_histogram(bins = 60) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  #geom_vline(aes(xintercept = avg)) +
  labs(x = "Temporal trends per decade (%)", y = "Number of sites") +
  scale_x_continuous(n.breaks = 10) +
  facet_wrap(~response_f, scales = "free", ncol = 2,
    strip.position = "top",
    labeller = as_labeller(abc_label_supp)
    ) +
  theme_cowplot(10) +
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    strip.background = element_blank(),
    legend.position = "none"
  ) +
scale_fill_brewer(palette="Set2")
```
```{r}
myrel_y = -6 / 100
ci_label_data_supp %<>%
  mutate(
    error_bar_pos = case_when(
      response == "Jaccard dissimilarity" ~ 250 * myrel_y,
      response == "Nestedness" ~ 330 * myrel_y,
      TRUE ~ 1000 * .10
    )
  )
p_trends_site_supp2 <-
  p_trends_site_supp +
  geom_pointrange(
    data = ci_label_data_supp %>%
      filter(ci_level == "95%") %>%
      arrange(desc(width_bar)),
    aes(y = error_bar_pos, x = mean,
      xmin = low, xmax = high,
      color = response_f),
    size = .08,
    linewidth = .8,
    alpha = .8,
    show.legend = FALSE
    ) +
  scale_fill_brewer(palette="Set2", direction = -1) +
  theme(
    strip.text = element_text(hjust = 0, margin = margin(0, 0, 0, 0, "pt"))
  )
```

```{r}
ggsave(
  filename = "p_trends_supp.pdf",
  plot = p_trends_site_supp2,
  path = here("paper", "fig_paper"),
  scale = 2.0,
  width = 90,
  height = 90 * .40,
  units = "mm",
  dpi = "print"
)
```

##

```{r}
theme_set(theme_grey())
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    term = str_replace_all(term,
      get_model_term_replacement_paper_figure()),
    response = get_var_replacement_vulgarisation()[response],
    response = factor(response, levels = rev(names(pal_variable)))
    )

term_level <- get_term_level()
# width_bar
base_width <- 1
increment <- .5
tu %<>%
  mutate(
    width_bar = case_when(
      width_bar == 1 ~ .1,
      width_bar == 2 ~ 1,
      width_bar == 3 ~ 10,
      TRUE ~ width_bar

    )
  )
```

```{r, fig.show="hide"}
p1 <- tu %>%
  filter(facet == "main") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable),
    term_level = term_level,
    xaxis_title = TRUE,
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
  ) +
  scale_x_break(c(.22, .55))

p2 <- tu %>%
  filter(facet == "interaction") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(scale_color = rev(pal_variable),
    term_level = term_level) +
  scale_x_break(c(.135, .195))

p3 <- tu %>%
  filter(facet == "dbl_interaction") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    scale_color = rev(pal_variable),
    term_level = term_level,
    legend_present = TRUE
    )  +
theme(
  plot.margin = margin(5, 5, 5, 5, "pt"),
  plot.background = element_rect(fill = NA, color = "black")
)

```

```{r}
p_tps_effect <- tu %>%
  filter(facet %in% c("interaction", "dbl_interaction")) %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable),
    term_level = term_level,
    xaxis_title = TRUE
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
    ) +
  scale_x_break(c(.15, .195)) +
  theme_bw() +
  theme(
    axis.line.y.right = element_blank(),
    axis.ticks.y.right = element_blank(),
    axis.text.y.right = element_blank(),
    #plot.margin = margin(5, 5, 5, 5, "pt"),
    #plot.background = element_rect(fill = NA, color = "black"),
    panel.border = element_rect(fill = "transparent")
  )
```

```{r}
p_space_effect <- tu %>%
  filter(facet == "main") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable),
    term_level = term_level,
    xaxis_title = TRUE,
    legend_present = TRUE
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
  ) +
  theme_bw() +
  scale_x_break(c(.22, .55))
```

```{r, fig.show = "hide"}
leg_dis <- get_legend(
  p_space_effect +
    guides(
      colour = guide_legend(ncol = 1, byrow = TRUE, title.position = "top",
        reverse = TRUE)) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10)) +
scale_color_manual(
  values = pal_variable,
  labels = names(rev(pal_variable)),
  name = "Community metrics"
)
)

p_space_legend <- plot_grid(
  ggdraw(
    p_space_effect + theme(legend.position = "none"),
    xlim = c(-.02, 1.015),
    ylim = c(-.01, 1.01)
  ),
  leg_dis,
  ncol = 1
)

fig1 <- plot_grid(
  print(p_tps_effect),
  p_space_legend,
  rel_heights = c(1, .2),
  labels = c(letters[1:2]),
  hjust = -1.25, vjust = 1.8,
  ncol = 2)
fig1
```

```{r save-fig1}
#fig1
ggsave(
  filename = "fig1_two_col.pdf",
  plot = fig1,
  path = here("paper", "fig_paper"),
  scale = 1.8,
  width = 180,
  height = 180 * .8,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "fig1_two_col.png",
  plot = fig1,
  path = here("paper", "fig_paper"),
  scale = 1.8,
  width = 180,
  height = 180 * .8,
  units = "mm",
  dpi = "print"
)
```


```{r}
p_space_effect2 <- tu %>%
  filter(!str_detect(term, "Time")) %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable)[3:6],
    term_level = term_level,
    xaxis_title = TRUE,
    legend = TRUE
    ) +
  labs(x = expression(atop(paste("Standardized slope coefficients ",
        beta, "'",sep = ""), "(s.d. unit)"))) +
guides(colour = guide_legend(nrow = 1, byrow = FALSE, reverse = TRUE)) +
theme_bw() +
theme(legend.position = "bottom", legend.justification = "right", text =
  element_text(size = 8))
ggsave(
  filename = "p_space_effect2.pdf",
  plot = p_space_effect2,
  path = here("paper", "fig_paper"),
  scale = 1.5,
  width = 88,
  height = 88 * .8,
  units = "mm",
  dpi = "print"
)

```

```{r}
p_tps_effect2 <- tu %>%
  filter(str_detect(term, "Time")) %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable),
    term_level = term_level,
    xaxis_title = TRUE,
    legend = TRUE
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
    ) +
  scale_x_break(c(.15, .195), scales = .2, ticklabels=c(.20, .25)) +
  scale_x_break(c(.29, .55),  scales = .2, , ticklabels=c(.55, .70)) +
  theme_bw() +
  theme(
    axis.line.y.right = element_blank(),
    axis.ticks.y.right = element_blank(),
    axis.text.y.right = element_blank(),
    #plot.margin = margin(5, 5, 5, 5, "pt"),
    #plot.background = element_rect(fill = NA, color = "black"),
    panel.border = element_rect(fill = "transparent")
  ) +
theme(legend.position = "bottom", legend.justification = "right") +
guides(colour = guide_legend(nrow = 1, byrow = FALSE, reverse = TRUE,
    title.position = "top"))

p_tps <- plot_grid(
  print(p_tps_effect2 + theme(legend.position = "none")),
  get_legend(p_tps_effect2),
  nrow = 2,
  rel_heights = c(.95, .05)
)
ggsave(
  filename = "p_tps_effect2.pdf",
  plot = p_tps,
  path = here("paper", "fig_paper"),
  scale = 2.2,
  width = 88,
  height = 88 * 1.25,
  units = "mm",
  dpi = "print"
)
```

```{r}
p_effect <- plot_grid(
  print(p_tps_effect2 +
    theme(
      legend.position = "none",
      text = element_text(size = 11),
      axis.title.x = element_text(hjust = .75),
      axis.title.y = element_blank(),
      plot.margin = margin(0, 0, 0, 0, "pt"),
      )
    ),
  plot_grid(
    NULL,
    p_space_effect2 +
      theme(
        text = element_text(size = 11),
        axis.title.y = element_blank(),
        legend.position = "none"
      ),
    get_legend(p_tps_effect2 +
      theme(legend.position = "right", legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        ) +
      guides(colour = guide_legend(ncol = 1, byrow = FALSE, reverse = TRUE,
          title.position = "top"))
      ),
    ncol = 1,
    rel_heights = c(.015, 1, 1)
    ),
  ncol = 2,
  labels = "auto",
  #hjust = -1.5
  label_x = c(.025, 0),
  label_y = c(.995, .995),
  rel_widths = c(1,.65)
  )
ggsave(
  filename = "p_effect.pdf",
  plot = p_effect,
  path = here("paper", "fig_paper"),
  scale = 2.9,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "p_effect.png",
  plot = p_effect,
  path = here("paper", "fig_paper"),
  scale = 2.9,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)

```

```{r}
tar_load(filtered_dataset_modelling)
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )
fnsite <- nrow(site_year)
fnop <- length(unique(filtered_dataset_modelling$measurement$op_id))
```


```{r}
fig1_cap <- paste0("**Response of riverine fish communities to time,
  anthropogenic pressures and stream gradient**. Community metrics include total
  community abundance, species richness, proportion of non-native species and
  non-native abundance, Simpson dissimilarity, and turnover. **a**, single
  effects. **b**, effects of anthropogenic pressures and stream gradient on
  temporal trends. **c**, interacting effects among anthropogenic pressures and
  stream gradient on temporal trends. Points depict the average of
  posterior distribution. Large, medium and thin bars depict the Bayesian
  credible intervals at 80, 90 and 95%, respectively. Please note the broken
  abscissa scale in the framed panels. N = ", fnop, " sampling events over ",
  fnsite, " sites.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```


```{r eff, fig.asp = 2.5, fig.width = 88* 0.0393701}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig1.pdf"))
```


## Typology of biodiversity trends

```{r}
tar_load(c(pca_clust, site_cl_rm))
tar_load(c(clust_var_alter, site_cl_rm_red, site_env))
pca_data <- site_no_drivers_inla_tot[,
    colnames(site_no_drivers_inla_tot) %in% restricted_dimension &
    !colnames(site_no_drivers_inla_tot) %in% c("perc_exo_sp", "perc_exo_abun")]
```

```{r}
pca_clust <- compute_rotated_pca(pca_data, naxis = 4)
pca_clust3 <- compute_rotated_pca(pca_data, naxis = 3)
pca_clust2 <- compute_rotated_pca(pca_data, naxis = 2)
pca3_var_expl <- scales::percent(max(pca_clust3$rotated$Vaccounted["Cumulative Var", ]))
pca2_var_expl <- scales::percent(max(pca_clust2$rotated$Vaccounted["Cumulative Var", ]))
```

```{r pca-cor-tps, fig.height=8}
axis_l <- list(
  c("CS1", "CS2"),
  c("CS1", "CS3"),
  c("CS1", "CS4"),
#  c("CS1", "CS5"),
  c("CS2", "CS3"),
  c("CS2", "CS4"),
#  c("CS2", "CS5"),
#  c("CS4", "CS5"),
#  c("CS3", "CS5"),
  c("CS3", "CS4")
)

cluster_names <- c(
  "Medium change", "High turnover",
  "Increase in\nrichness", "Decrease in\nabundance (total)",
  "Decrease in\nrichness", "Low change"
)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", scales::percent((fnsite - sum(nb_clusters)) / fnsite),")"
)

cluster_labels <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))

p_pca_cl_ell <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$normal,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     omit_na_site = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .4,
     replace_var = get_var_replacement_vulgarisation(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 1,
     var_scaling_factor = 3.5
   ) +
 guides(
   colour = guide_legend(
     #override.aes = list(size = 20),
     #title.theme = element_blank(),
     title.position = "top",
     title.hjust = .5,
     label.position = "top",
     ncol = 2)
 ) +
 theme(
   legend.position = "bottom",
   panel.background = element_blank(),
   legend.text = element_text(size = 7)
   ) +
 scale_color_viridis(
   discrete = TRUE,
   name = "Cluster assignment",
   labels = cluster_labels
 )
)
p_cl <- p_pca_cl_ell[[1]]
leg_cl <- get_legend(
  p_pca_cl_ell[[1]]
)

p_pca_cl_ell <- map(p_pca_cl_ell, ~.x + theme(legend.position = "none"))

p_pca_cl_top <- plot_grid(plotlist = p_pca_cl_ell[c(1, 6)], ncol = 2, labels =
  letters[1:2])
```

```{r}
tar_load(site_no_drivers_inla)
site_trends_dec <- site_no_drivers_inla %>%
  mutate(
    across(c(turnover_scaled, hillebrand_dis_scaled),
      ~.x * log(10 + 1) * 100)
    ) %>%
  mutate(across(
      c(log_chao_richness, log_total_abundance),
      ~log_beta_to_perc_rate(.x) * log(10 + 1)
      )) %>%
  select(turnover_scaled, hillebrand_dis_scaled,
    log_chao_richness, log_total_abundance) %>%
  rownames_to_column(var = "siteid")
```

```{r}
bp_data <- site_cl_rm[, colnames(site_cl_rm) %in% c(restricted_dimension, "siteid", "cl", "riv_str_rc1", "hft_c9309_scaled_no_center")]
bp_data_dec_no_scaled_trends <- bp_data[, !colnames(bp_data) %in% c("turnover_scaled", "hillebrand_dis_scaled",
    "log_chao_richness", "log_total_abundance")] %>%
left_join(site_trends_dec, by = "siteid")

p_pca_cl_bt <- target_bp_cl_dist(
  cl_obj = bp_data_dec_no_scaled_trends,
  fct_var_lvl = names(pal_variable)[c(1:2, 5:6)],
  dodge = .85
  ) +
  scale_color_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  scale_x_discrete(position = "top") +
  ylim(-75, 110) +
  labs(y = "Temporal trends per decade (%)") +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0),
    axis.title.y = element_text(angle = 90, vjust = 0),
    legend.position = "none"
  )
```



```{r}
pca_clust_cap <- paste0("**Covariation among the temporal trends in biodiversity metrics
and identification of community trajectories**. **a**, **b**, PCA biplot of the community
temporal trends and their cluster assignment (upper panel). **c**, boxplots
displaying the distribution of the temporal trends by cluster (lower panel). The
sites are colored by their cluster belongings. The ellipses represent the 95%
  intervals around the clusters assuming a Student’s t distribution. The
clusters were named according to their unique characteristics.",
" Sites not assigned to a cluster are not displayed (N = ", na_cluster, ").") %>%
str_remove_all("\n|\r") %>%
str_replace_all("  ", " ")
```

```{r}
fig2 <- plot_grid(
  p_pca_cl_top,
  plot_grid(p_pca_cl_bt, leg_cl, rel_widths = c(1, .25),
    labels = c(letters[3], NULL)),
  nrow = 2,
  rel_heights = c(1, .8)
)
#fig2
ggsave(
  filename = "fig2.pdf",
  plot = fig2,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "fig2.png",
  plot = fig2,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
```

### Plot NA cluster

```{r}
tar_load(c(site_cl_rm))
axis_l <- list(
  c("CS1", "CS2"),
  c("CS3", "CS4")
)
table_to_vec(table(site_cl_rm$cl))
nrow(filtered_dataset_modelling$location) - length(site_cl_rm$cl)

p_pca_cl_ell_na <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$normal,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     omit_na_site = FALSE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .4,
     replace_var = get_var_replacement_vulgarisation(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 1,
     var_scaling_factor = 3.5
   ) +
 guides(
   colour = guide_legend(
     #override.aes = list(size = 20),
     #title.theme = element_blank(),
     title.position = "top",
     title.hjust = .5,
     label.position = "top",
     ncol = 3)
 ) +
 theme(
   legend.position = "bottom",
   panel.background = element_blank(),
   legend.text = element_text(size = 7)
   ) +
 scale_color_viridis(
   discrete = TRUE,
   name = "Cluster assignment",
   labels = cluster_labels,
   na.value="black"
 )
)
p_cl_na <- p_pca_cl_ell_na[[1]]
leg_cl_na <- get_legend(
  p_pca_cl_ell_na[[1]]
)

p_pca_cl_ell_na <- map(p_pca_cl_ell_na, ~.x + theme(legend.position = "none"))

p_pca_cl_na_top <- plot_grid(plotlist = p_pca_cl_ell_na, ncol = 2, labels =
  letters[1:2])
```

```{r}
bp_data_na <- site_cl_rm[, colnames(site_cl_rm) %in% c(restricted_dimension, "siteid", "cl", "riv_str_rc1", "hft_c9309_scaled_no_center")]
bp_data_na_dec_no_scaled_trends <- bp_data_na[, !colnames(bp_data_na) %in% c("turnover_scaled", "hillebrand_dis_scaled",
    "log_chao_richness", "log_total_abundance")]

bp_data_na_dec_no_scaled_trends <- site_trends_dec %>%
left_join(bp_data_na_dec_no_scaled_trends, by = "siteid")

p_pca_cl_bt_na <- target_bp_cl_dist(
  cl_obj = bp_data_na_dec_no_scaled_trends,
  fct_var_lvl = names(pal_variable)[c(1:2, 5:6)],
  dodge = .85
  ) +
  scale_color_viridis(discrete = TRUE, na.value = "black") +
  scale_fill_viridis(discrete = TRUE, na.value = "black") +
  scale_x_discrete(position = "top") +
  ylim(-75, 110) +
  labs(y = "Temporal trends per decade (%)") +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0),
    axis.title.y = element_text(angle = 90, vjust = 0),
    legend.position = "none"
  )
```

```{r}
fig_clust_na <- plot_grid(
  p_pca_cl_na_top,
  plot_grid(p_pca_cl_bt_na, leg_cl_na, rel_widths = c(1, .25),
    labels = c(letters[3], NULL)),
  nrow = 2,
  rel_heights = c(1, .8)
)
#fig2
ggsave(
  filename = "clust_fig_na.pdf",
  plot = fig_clust_na,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "clust_fig_na.png",
  plot = fig_clust_na,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
```




```{r, fig.asp = .9, fig.width = 88 * 0.0393701}
# , fig.cap=pca_clust_cap
knitr::include_graphics(here("paper", "fig_paper", "fig2.pdf"))
```

```{r}
tar_load(c(site_cl_rm, filtered_dataset_modelling))
loc <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  left_join(filtered_dataset_modelling$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)

site_cl_rm_loc <- site_cl_rm %>%
  select(siteid, cl) %>%
  left_join(loc, by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia")) %>%
  left_join(
    measurement_exo %>%
      distinct(siteid, basin_name),
    by = "siteid")
```

```{r}
ecoregion_cl <- site_cl_rm_loc %>%
  group_by(cl, ecoregion) %>%
  summarise(freq = n()
    ) %>%
  group_by(ecoregion) %>%
  mutate(
    pc = prop.table(freq),
    basin_name = toupper(ecoregion),
    tot_n = sum(freq)
    ) %>%
  ungroup() %>%
  mutate(
    ecoregion_f = factor(ecoregion),
    label = paste0(ecoregion, "\n(N = ",tot_n, ")")
  )

p_ecoregion_cl <-
  ecoregion_cl %>%
  ggplot(
    aes(
      x = pc, y = label,
      fill = factor(cl, levels = rev(unique(cl)))
    )
    ) +
  geom_col() +
  geom_text(
    aes(label = paste0(round(pc*100), "%")),
    size = 3,
    colour = "white",
    position = position_fill(vjust = 0.5)) +
  labs(x = "Percentage") +
  scale_x_continuous(labels = scales::percent, expand = c(0, .01)) +
  theme_cowplot(10) +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(size = 1, color = "black"),
    strip.text = element_blank()
    ) +
#  facet_grid(rows = vars(ecoregion_f), scale = "free_y") +
  scale_fill_viridis(discrete = TRUE, name = "Cluster", direction = -1)
```

```{r}
clust_figure <- plot_grid(
  p_pca_cl_top,
  p_pca_cl_bt,
  plot_grid(
    p_ecoregion_cl, leg_cl,
    rel_widths = c(1, .40),
    align = "v", axis = "b"
    ),
  labels = c("", "c", "d"),
  nrow = 3,
  rel_heights = c(1, .8, .57)
)
clust_figure
#fig2
ggsave(
  filename = "clust_figure.pdf",
  plot = clust_figure,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * 1.1,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "clust_figure.png",
  plot = clust_figure,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * 1.1,
  units = "mm",
  dpi = "print"
)
```

### Cluster figure NA

```{r}
tar_load(c(filtered_dataset_modelling))
loc <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  left_join(filtered_dataset_modelling$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
    crs = 4326)

site_cl_rm_loc <- loc %>%
  left_join(site_cl_rm %>%
    select(siteid, cl),
  by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia"))
```

```{r}
ecoregion_cl_na <- site_cl_rm_loc %>%
  group_by(cl, ecoregion) %>%
  summarise(freq = n()
    ) %>%
  group_by(ecoregion) %>%
  mutate(
    pc = prop.table(freq),
    basin_name = toupper(ecoregion),
    tot_n = sum(freq)
    ) %>%
  ungroup() %>%
  mutate(
    ecoregion_f = factor(ecoregion),
    label = paste0(ecoregion, "\n(N = ",tot_n, ")")
  )

p_ecoregion_cl_na <-
  ecoregion_cl_na %>%
  ggplot(
    aes(
      x = pc, y = label,
      fill = factor(cl, levels = rev(unique(cl)))
    )
    ) +
  geom_col() +
  geom_text(
    aes(label = paste0(round(pc*100), "%")),
    size = 3,
    colour = "white",
    position = position_fill(vjust = 0.5)) +
  labs(x = "Percentage") +
  scale_x_continuous(labels = scales::percent, expand = c(0, .01)) +
  theme_cowplot(10) +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(size = 1, color = "black"),
    strip.text = element_blank()
    ) +
#  facet_grid(rows = vars(ecoregion_f), scale = "free_y") +
  scale_fill_viridis(
    discrete = TRUE,
    name = "Cluster",
    direction = -1,
    na.value = "black"
  )
```

```{r}
clust_figure_na <- plot_grid(
  p_pca_cl_na_top,
  p_pca_cl_bt_na,
  plot_grid(
    p_ecoregion_cl_na, leg_cl_na,
    rel_widths = c(1, .40),
    align = "v", axis = "b"
    ),
  labels = c("", "c", "d"),
  nrow = 3,
  rel_heights = c(1, .8, .57)
)
clust_figure_na
#fig2
ggsave(
  filename = "clust_figure_na.pdf",
  plot = clust_figure_na,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * 1.1,
  units = "mm",
  dpi = "print"
)
```



```{r}
tar_load(c(world_site_sf,filtered_basinatlas_modelling))

site_cl_rm_loc <- site_cl_rm %>%
  select(siteid, cl) %>%
  left_join(loc, by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia")) %>%
  left_join(
    measurement_exo %>%
      distinct(siteid, basin_name),
    by = "siteid")
```

```{r}
n_clust_basin <- site_cl_rm_loc %>%
  group_by(ecoregion, country, main_bas) %>%
  summarise(
    n = n(),
    div = length(unique(cl)),
    evenness = ifelse(div == 1, 1, diversity(table(cl)) / log(div))
  )

# Take the most sampled basin by country
fq_pal_bas <- site_cl_rm_loc %>%
  filter(basin_name %in% c("Avon.Moors", "Loire", "Gota.alv")) %>%
  group_by(basin_name, cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq)) %>%
  ungroup()

fq_pal <- site_cl_rm_loc %>%
  filter(ecoregion == "Palearctic") %>%
  group_by(cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq), basin_name = toupper("Palearctic")) %>%
  ungroup()

fq_tab <- rbind(
  fq_pal, fq_pal_bas
)

get_fq_tab_from_basin <- function(
  x = site_cl_rm_loc,
  ecoregion = NULL,
  basin_var = basin_name,
  basins = NULL) {

  if (is.null(names(basins))) {
    names(basins) <- basins
  }

  fq_pal_bas <- x %>%
    filter({{basin_var}} %in% basins) %>%
    group_by({{basin_var}}, cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = str_replace_all(as.character({{basin_var}}), setNames(names(basins), as.character(basins)))
      ) %>%
    ungroup()

  ecoregion2 <- ecoregion# to not mess up filter
  fq_pal <- x %>%
    filter(ecoregion == ecoregion2) %>%
    group_by(cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = toupper(ecoregion)
      ) %>%
    ungroup()

  fq_tab <- rbind(fq_pal, select(fq_pal_bas, cl, freq, pc, basin_name)) %>%
    mutate(
      basin_name = factor(
        basin_name, levels = c(toupper(ecoregion), names(basins))),
      ecoregion = ecoregion
    )
  return(fq_tab)

}

basin_name_palearctic <- n_clust_basin %>%
  filter(ecoregion == "Palearctic", div == 6) %>%
  arrange(desc(n))

basin_names_pal <- site_cl_rm_loc %>%
  filter(main_bas %in% c(2080021030, 2080053790, 2080033320)) %>%
  distinct(main_bas, basin_name) %>%
  filter(basin_name != "Lagan.Swe")

pal_basin <- deframe(basin_names_pal[, 2:1])

tab_palearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Palearctic",
  basin_var = main_bas,
  basins = pal_basin
)

basin_name_nearctic <- n_clust_basin %>%
  filter(ecoregion == "Nearctic", div >= 5) %>%
  arrange(desc(n))

basin_names_nea <- site_cl_rm_loc %>%
  filter(main_bas %in% basin_name_nearctic$main_bas[1:4]) %>%
  distinct(main_bas, basin_name) %>%
  filter(!is.na(basin_name) & basin_name != "Red")

nea_basin <- deframe(basin_names_nea[, 2:1])

tab_nearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Nearctic",
  basin_var = main_bas,
  basins = nea_basin
)

basin_name_australasia <- n_clust_basin %>%
  filter(ecoregion == "Australasia", div >= 5) %>%
  arrange(desc(n))

basin_names_aus <- site_cl_rm_loc %>%
  filter(main_bas %in% basin_name_australasia$main_bas[1:3]) %>%
  distinct(main_bas, basin_name) %>%
  filter(!is.na(basin_name)) %>%
  slice(-1,-3)
aus_basin <- deframe(basin_names_aus[, 2:1])

tab_australasia <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Australasia",
  basin_var = main_bas,
  basins = aus_basin
)

filtered_basinatlas_modelling %>%
  filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
  mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))))%>%
  ggplot() +
  geom_sf(aes(color = main_bas)) +
  geom_sf_text(aes(label = basin_name), colour = "black")


all_basin <- c("NEARCTIC", "Mississippi", "Saint.Laurent", "Potomac", "PALEARCTIC", "Thames.UK", "Loire", "Gota.alv", "AUSTRALASIA", "Avoca", "Brisbane", "Logan")
names(all_basin) <- letters[seq_along(all_basin)] #c("a", "b", "c", "d", "f", "g", "h", "j", "k", "l") #

tot_tab <- rbind(
  tab_nearctic,
  tab_palearctic,
  tab_australasia) %>%
  left_join(
    site_cl_rm_loc %>%
      filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
      mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))))%>%
      mutate(country = ifelse(basin_name == "Saint.Laurent", "CAN/USA", country)) %>%
      distinct(basin_name, country),
    by = "basin_name"
  ) %>%
  mutate(
    label = map_chr(basin_name,
      ~ifelse(
        any(all_basin %in% .x),
        names(all_basin)[all_basin == .x],
        NA)
      ),
    basin_name = str_replace(basin_name, "\\.", " "),
    basin_name = str_replace(basin_name, "UK|alv", "")
    ) %>%
  group_by(basin_name) %>%
  mutate(
    total_n = sum(freq)) %>%
  ungroup() %>%
  arrange(label) %>%
  mutate(
    country = ifelse(is.na(country), "", paste0(", ", country)),
    basin_name_n = paste0(basin_name, " (", total_n, ")"),
    basin_name_n = ifelse(
      !is.na(label),
      paste0("(", label,") ", basin_name_n),
      basin_name_n
      ),
    basin_name_n = str_replace(basin_name_n, "\\s{2}", " "),
    basin_name_f = factor(basin_name_n, levels = unique(basin_name_n))

  )
lvl_basin <- c(
  "(l) Logan (32)",
  "(k) Brisbane (89)",
  "(j) Avoca (129)",
  "(i) AUSTRALASIA (330)",
  "(h) Gota (50)",
  "(g) Loire (240)",
  "(f) Thames (139)",
  "(e) PALEARCTIC (3470)",
  "(d) Potomac (66)",
  "(c) Saint Laurent (164)",
  "(b) Mississippi (574)",
  "(a) NEARCTIC (1083)"
)
lvl_ecoregion <- c(Nearctic = "(a) Nearctic", Palearctic = "(b) Palearctic", Australasia = "(c) Australasia")
```
```{r}
p_tot_tab <- tot_tab %>%
  mutate(
     basin_name_f = factor(basin_name_n, levels = lvl_basin),
     ecoregion2 = str_replace_all(ecoregion, lvl_ecoregion),
     ecoregion_f = factor(ecoregion2)
    ) %>%
  ggplot(aes(x = pc, y = basin_name_f, fill = factor(cl, levels = rev(unique(cl))))) +
  geom_col() +
  labs(x = "Percentage") +
  scale_x_continuous(labels = scales::percent, expand = c(0, .01)) +
  theme_cowplot() +
  theme(
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(size = 1, color = "black"),
    legend.position = "none",
    strip.text = element_blank()
    ) +
  facet_grid(rows = vars(ecoregion_f), scale = "free_y") +
  scale_fill_viridis(discrete = TRUE, name = "Cluster", direction = -1)
```
```{r}
unique(tot_tab$basin_name)
tot_tab %>%
  filter(basin_name == "Thames ")
```



```{r}
tar_load(rivers10)
world_site_sf$cl <- world_site_sf$site %>%
    left_join(site_cl_rm_loc[, c("siteid", "cl", "basin_name")], by = "siteid") %>%
    mutate(cl = relevel(as.factor(cl), ref = 1))

zoom_map_world <- world_site_sf$cl %>%
  st_buffer(dist = .2) %>%
    st_bbox()
unique(world_site_sf$world$continent)

main_map <-
  world_site_sf$world %>%
  filter(continent != "Antarctica") %>%
  ggplot() +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none") +
  coord_sf(
    #xlim = zoom_map_world[c("xmin", "xmax")],
    #ylim = zoom_map_world[c("ymin", "ymax")],
    expand = FALSE)

main_map4zoom <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 4) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none")


zoom_map <- list(
  north_am = "USA",
  eng = "GBR",
  south_eu = c("FRA", "ESP", "BEL"),
  north_eu = c("FIN", "NOR", "SWE"),
  aus = "AUS"
)
zoom_map_basin_coord <- map(all_basin,
  ~world_site_sf$cl %>%
    filter(basin_name %in% .x) %>%
    st_bbox()
)

zoom_map_coord <- map(zoom_map,
  ~world_site_sf$cl %>%
    filter(country %in% .x) %>%
    st_bbox()
)

zoom_map_coord_df <- map_dfr(zoom_map_coord,
  ~setNames(as.numeric(.x), names(zoom_map_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  label = LETTERS[seq_len(length(zoom_map_coord))],
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
zoom_map_basin_coord_df <- map_dfr(zoom_map_basin_coord,
  ~setNames(as.numeric(.x), names(zoom_map_basin_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  LABEL = LETTERS[seq_len(length(zoom_map_basin_coord))],
  label = letters[seq_len(length(zoom_map_basin_coord))],
  width_basin = xmax - xmin,
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
```

```{r}
basin_map <- filtered_basinatlas_modelling %>%
  filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
  mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))),
    label = str_replace_all(basin_name, get_rev_vec_name_val(all_basin)),
    label2 = str_replace_all(label, c("l" = "\n  l", g = "g", d = " d")),
  )

main_map_rect_basin <- main_map +
  geom_sf(data = basin_map, color = "black", fill = NA) +
  geom_sf_text(data = basin_map, aes(label = label2), colour = "black", size = 7, vjust = -.3, hjust = 0) +
theme(legend.position = "none")
```

```{r}
p_main_map_rect <- main_map_rect_basin +
  draw_plot(leg_cl, x = -100, y = zoom_map_world["ymin"] + 5, vjust = 0, hjust = 0)

save_plot(
  here("doc", "fig", "global_map.png"),
  p_main_map_rect,
  base_height = 3.71,
  base_asp = 2.618,
)
```

```{r}
box_inset_country <- list(
  usa_can = c(-126, 25, -65, 51),
  eu = c(-15, 41, 30, 68),
  aus = c(112, -39, 155, -10.5)
)
box_inset_country <- map(box_inset_country,
  ~setNames(.x, c("xmin", "ymin", "xmax", "ymax")))
usa_can <- main_map_rect_basin +
  coord_sf(
    xlim = c(-126, -65),
    ylim = c(25, 51),
    expand = FALSE)
aus <- main_map_rect_basin +
  coord_sf(
    xlim = c(112, 155),
    ylim = c(-39, -10.5),
    expand = FALSE)
eu <- main_map_rect_basin +
  coord_sf(
    xlim = c(-13, 30),
    ylim = c(41, 68),
    expand = FALSE)
```


```{r inset-basin}
inset_basin <- map(sort(basin_map$label),
  function(l) {
    x <- basin_map %>%
    filter(label == l)
   x %>%
    ggplot() +
    geom_sf(color = NA) +
    #annotate(geom = 'text', label = l, x = -Inf, y = Inf, hjust = 0, vjust = 1, size = 7) +
    theme_void() +
    geom_sf(data = st_intersection(rivers10, x), colour = "lightblue", alpha = .4) +
    geom_sf(data = st_intersection(world_site_sf$cl %>%
        filter(!is.na(cl)), x),
      aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 4) +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position = "none") +
    coord_sf(expand = FALSE)
  }
)
names(inset_basin) <- sort(basin_map$label)
box_basin <- map(setNames(basin_map$geometry, basin_map$label), ~st_bbox(.x))
width_height_box <- map(box_basin,
  ~setNames(
    c(.x["xmax"] - .x["xmin"], .x["ymax"] - .x["ymin"]),
    c("width", "height")
  )
)
```

```{r}
cluster_labels2 <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))
leg_cl_right <- get_legend(
  p_pca_cl_ell[[1]] +
    theme(legend.position = "right") +
    guides(col = guide_legend(
        ncol = 2, override.aes = list(size = 10)
        )) +
    scale_color_viridis(discrete = TRUE, name = "Cluster", labels = cluster_labels2)
)
```

```{r}
inset_country <- list(usa_can = usa_can, eu = eu, aus = aus)
width_height_box <- map(box_inset_country,
  ~setNames(
    c(.x["xmax"] - .x["xmin"], .x["ymax"] - .x["ymin"]),
    c("width", "height")
  )
)
refs <- width_height_box[["usa_can"]]
ref_height_country <- .33
ratio_width_to_a <- map_dbl(width_height_box, ~round(.x["width"] / refs["width"], 2))
ratio_height_to_a <- map_dbl(width_height_box, ~round(.x["height"] / refs["height"], 2))

fig3_inset_country <- ggdraw() +
  draw_plot(
    usa_can, x = 0, y = 1,
    width = ref_height_country*width_height_box$usa_can["width"]/width_height_box$usa_can["height"],
    height = .33,
    vjust = 1, hjust = .2
    ) +
  draw_plot(
    eu, x = 0, y = .66,
    width = ref_height_country*width_height_box$eu["width"]/width_height_box$eu["height"],
    height = .33,
    vjust = 1, hjust = .2
    ) +
  draw_plot(
    aus, x = 0, y = .33,
    width = ref_height_country * width_height_box$aus["width"] / width_height_box$aus["height"],
    height = .33,
    vjust = 1, hjust = .3
  )
```

```{r}
fig3_inset_country <-
  plot_grid(plotlist = inset_country, ncol = 1)
```



```{r}
leg_cl_right <- get_legend(
  p_pca_cl_ell[[1]] +
    theme(
      legend.position = "bottom",
      legend.text = element_text(size = 7),
      legend.title = element_blank()
      ) +
    guides(col = guide_legend(
        nrow = 1, override.aes = list(size = 7)
        ))
    )
bottom <- plot_grid(
  p_tot_tab + theme(
    text = element_text(size = 7),
    axis.text = element_text(size = 7)
    ),
  leg_cl_right, ncol = 1,
  rel_heights = c(1, .11),
  label_size = 7,
  labels = c("iv)", ""))

leg_cl2 <- get_legend(
  p_pca_cl_ell[[1]] +
    theme(
      legend.position = "right",
      legend.text = element_text(size = 7),
      legend.title = element_text(size = 7)
      ) +
    guides(col = guide_legend(
        ncol = 1, override.aes = list(size = 7)
        ))
    )
bottom2 <- plot_grid(
  p_tot_tab + theme(
    text = element_text(size = 7),
    axis.text = element_text(size = 7)
    ),
  leg_cl2, ncol = 2,
  rel_widths = c(1, .2),
  label_size = 7,
  labels = c("m", ""))
#fig3_alt <- plot_grid(top, bottom, nrow = 2, rel_heights = c(1, .40))

basin_map <- filtered_basinatlas_modelling %>%
  filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
  mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))),
    label = str_replace_all(basin_name, get_rev_vec_name_val(all_basin)),
    label2 = str_replace_all(label, c("l" = "", g = "   g", d = " d", "k" = "kl")),
  )
basin_map$label2
main_map_rect_basin <- main_map +
  geom_sf(data = basin_map, color = "black", fill = NA) +
  geom_sf_text(data = basin_map, aes(label = label2),
    #fontface = "bold",
    colour = "black",
    size = 4,
    vjust = -.2, hjust = 0) +
theme(legend.position = "none")
usa_can <- main_map_rect_basin +
  coord_sf(
    xlim = c(-126, -65),
    ylim = c(25, 51),
    expand = FALSE)
aus <- main_map_rect_basin +
  coord_sf(
    xlim = c(112, 155),
    ylim = c(-39, -10.5),
    expand = FALSE)
eu <- main_map_rect_basin +
  coord_sf(
    xlim = c(-13, 30),
    ylim = c(41, 68),
    expand = FALSE)
inset_country <- list(usa_can = usa_can, eu = eu, aus = aus)

inset_basin <- map(sort(basin_map$label),
  function(l) {
    x <- basin_map %>%
    filter(label == l)
   x %>%
    ggplot() +
    geom_sf(color = NA) +
    #annotate(geom = 'text', label = l, x = -Inf, y = Inf, hjust = 0, vjust = 1, size = 7) +
    theme_void() +
    geom_sf(data = st_intersection(rivers10, x), colour = "lightblue", alpha = .4) +
    geom_sf(data = st_intersection(world_site_sf$cl %>%
        filter(!is.na(cl)), x),
      aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 2) +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position = "none") +
    coord_sf(expand = FALSE)
  }
)
names(inset_basin) <- sort(basin_map$label)

inset_tot <- plot_grid(
  plotlist = append(
    inset_country[1], append(inset_basin[1:3],
    append(inset_country[2], append(inset_basin[4:6],
    append(inset_country[3], inset_basin[7:9]))))
    ),
  ncol = 4,
  rel_widths = c(1, .70, .7, .50),
  rel_heights = c(1, 1.5, 1),
  label_size = 7,
  labels = "auto"
  )
fig3_alt <- plot_grid(
  inset_tot,
  bottom2, nrow = 2, rel_heights = c(1, .80))
ggsave(
  filename = "fig3_alt2.pdf",
  plot = fig3_alt,
  path = here("paper", "fig_paper"),
  scale = 1,
  width = 180,
  height = 180 * 1.0,
  units = "mm",
  dpi = "print"
)
ggsave(
  filename = "fig3_alt2.png",
  plot = fig3_alt,
  path = here("paper", "fig_paper"),
  scale = 1,
  width = 180,
  height = 180 * 1.0,
  units = "mm",
  dpi = "print"
)
```





```{r}
map_cl_cap <- "**Spatial distribution of community trajectories**.  Insets of
 the most sampled Realms, namely a) Palearctic, e) Nearctic and i) Australasia
 displaying the location of their three most sampled basins (b, c, d, f, g, h, j, k). (l)
 Cluster frequency distribution in the three most represented Realms (in capital
 letters) and their most sampled hydrographic basins, corresponding to the
 insets (a to i). The numbers of sites are displayed between parentheses. Site
 not assigned to a cluster (N = 630, see Methods) are not displayed. See
 supplementary material for an interactive world map of the cluster
 distribution." %>%
str_remove_all("\n|\r") %>%
str_replace_all("  ", " ")
```

```{r cl-map, fig.asp = .65, fig.width = 88* 0.0393701}
knitr::include_graphics(here("paper", "fig_paper", "fig3_alt2.pdf"))
```




# Figure legends

- Figure 1: `r knitr::knit(text = fig1_cap)`

- Figure 2: `r knitr::knit(text = pca_clust_cap)`

- Figure 3: `r knitr::knit(text = map_cl_cap)`

\newpage

# Table

```{r}
tar_load(c(gaussian_inla_rand, r2))
library(coda)

tu <- r2 %>%
  filter(response %in% c(clust_var, exo_resp_var))
tab_rand <- gaussian_inla_rand %>%
  filter(
    term %in% paste0("Precision for ", c("main_bas1", "siteid1")),
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
  select(-ci_level) %>%
  mutate(across(c(mean, low, high), ~round(., 3))) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    term = str_remove(term, "Precision for the |Precision for |"),
    term = replacement_random_term_table()[term],
    ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
  arrange(response, desc(term)) %>%
  select(
    `Response variable` = response,
    `Spatial scale` = term,
    `Temporal trends s.d.` = ci
  )

tab_rand2 <- tab_rand %>%
  left_join(
    tu %>%
      mutate(response = get_var_replacement_vulgarisation()[response]) %>%
      select(
        `Response variable` = response,
        `Cond. R2` = r2_mvp_cond95hpdci
        ),
    by = "Response variable"
    ) %>%
  select(1, 4, 2, 3) %>%
  mutate(`Response variable` = factor(`Response variable`, levels = names(pal_variable))) %>%
  arrange(`Response variable`)
```

```{r}
tab_rand_cap <- " Mean conditional R-squared of the models and the mean standard deviation estimated for the random temporal trends. [95% CI]: Credible Interval computed using Highest Posterior Density method."
tab_rand2 %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap) %>%
  collapse_rows(columns = c(1, 2), latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

# Instructions from  NEE


Effective figure preparation will enhance the readability of your manuscript –
our image preparation guidelines will help you to produce effective
publication-quality figures. In addition, please consider the following
important requirements:

## Images

All figures must be cited in sequence within the main article text in the form Fig. 1, Fig. 2.

Figure panels should be prepared at a minimum resolution of 300 dpi and saved at
a maximum width of 180 mm.

Use a 5–7 pt san serif font for standard text labelling and Symbol font for Greek characters.

Use scale bars, not magnification factors, and include error bars where appropriate.

Do not flatten labelling or scale/error bars onto images – uneditable or low-resolution images are two of the most common reasons for delay in manuscript preparation.

## Figure legends

Include a brief title for each figure with a short description of each panel cited in sequence.

Ensure the legend does not exceed the word limit of the article type.

Avoid methodological detail.

Use verbal cues to describe keys, eg. "open red triangles", not visual cues or symbols.

Include a description of centre values (median or average) and all error
bars and how they were calculated.  Give an indication of sample size (n
number), state the statistical test used and provide P values.




