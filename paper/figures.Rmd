---
title: "Main figures of the manuscript"
author: Danet, A., Giam, X., Olden, J. and Comte L.
output:
  bookdown::word_document2:
  bookdown::pdf_document2:
    toc: true
---


```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(ade4)
library(factoextra)
library(patchwork)

knitr::opts_chunk$set(
  echo = FALSE,
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  fig.path = "fig_paper/knitr-",
  fig.retina = 1, # Control using dpi
  fig.width = 2.25,  # generated images
  fig.pos = "htp",  # pdf mode
  fig.align = "center",
  dpi = 300,
  dev = "png",
  dev.args = list(png = list(type = "cairo-png")),
  optipng = "-o1 -quiet"
)
```

# Options

## Color blind palettes

- For variables: [palette from coolors.co](https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996)
- For clusters: the discrete version of the [viridis palette](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html)

```{r}
# control also the order of the legend
restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_abun", "perc_exo_sp")
```


```{r set-color-palette}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")

#pal <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
#pal2 <- palette_coolors("https://coolors.co/palette/01befe-ffdd00-ff7d00-ff006d-adff02-8f00ff")
#pal_variable <- palette_coolors("https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")

names(pal_variable) <- get_var_replacement_vulgarisation()[restricted_dimension]
#scale_color_brewer(palette = "RdYlBu") +
#scale_color_viridis(discrete=TRUE) +
```

```{r loading-targets, include=FALSE}
tar_load(c(gaussian_inla_exo_std_effects, gaussian_inla_std_effects,
    measurement_exo, gaussian_inla_var_fitted, gaussian_inla_rand))
tar_load(c(clust_var, exo_resp_var))
```


# Figures


```{r}
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    term = str_replace_all(term,
      get_model_term_replacement_paper_figure()),
    response = get_var_replacement_vulgarisation()[response],
    response = factor(response, levels = rev(names(pal_variable)))
    )

term_level <- get_term_level()
# width_bar
base_width <- .2
increment <- .25
tu %<>%
  mutate(
    width_bar = case_when(
      width_bar == 1 ~ base_width,
      width_bar == 2 ~ base_width + increment,
      width_bar == 3 ~ base_width + increment * 2,
      TRUE ~ width_bar

    )

  )

```

```{r, fig.show="hide"}
library(ggbreak)
p1 <- tu %>%
  filter(facet == "main") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(pal_variable),
    term_level = term_level) +
  scale_x_break(c(.22, .55))

p2 <- tu %>%
  filter(facet == "interaction") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(scale_color = rev(pal_variable),
    term_level = term_level) +
  scale_x_break(c(.135, .195))

p3 <- tu %>%
  filter(facet == "dbl_interaction") %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    scale_color = rev(pal_variable),
    term_level = term_level,
    legend_present = TRUE,
    xaxis_title = TRUE
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
  )
```

```{r, fig.show = "hide"}
r2 <- gaussian_inla_var_fitted %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  left_join(
    get_std_inla_from_rand(inla_rand_tab = gaussian_inla_rand),
    by = "response") %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    r2_mvp_marg = pmap(
      list(var_pred, intercept_main_bas, intercept_main_bassiteid, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2, ..3), epsilon = ..4, type = "marginal")
      ),
    r2_mvp_cond = pmap(
      list(var_pred, intercept_main_bas, intercept_main_bassiteid, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2, ..3), epsilon = ..4, type = "conditional")
      ),
    r2_mvp_marg_mean = map_dbl(r2_mvp_marg, mean),
    r2_mvp_marg_med = map_dbl(r2_mvp_marg, median),
    r2_mvp_cond_mean = map_dbl(r2_mvp_cond, mean),
    r2_mvp_cond_med = map_dbl(r2_mvp_cond, median),
    lab_r2_marg = paste0("~~~~R^2 == ", round(r2_mvp_marg_med, 2)),
    lab_r2_cond = paste0("~~~~R^2 == ", round(r2_mvp_cond_med, 2))
  )

var_labels <- map_chr(names(pal_variable),
  ~paste0(
    "'", .x,"'",
    "~(R^2 == ",
    round(r2[r2$response == .x, ]$r2_mvp_cond_med, 2),
    ")")
)
leg_dis <- get_legend(
  p3 +
    guides(
      colour = guide_legend(nrow = 2)) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    legend.title = element_blank()
  ) +
scale_color_manual(
  values = pal_variable,
  labels = names(pal_variable)#map(var_labels, ~parse(text = .x))
)
)

fig1 <- plot_grid(
  print(p1),
  print(p2),
  p3 + theme(legend.position = "none"),
  leg_dis,
  rel_heights = c(1.2, 1, 1, .2),
  ncol = 1)
```


```{r}
tar_load(filtered_dataset_modelling)
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )
fnsite <- nrow(site_year)
fnop <- length(unique(filtered_dataset_modelling$measurement$op_id))
```


```{r}
fig1_cap <- paste0(
  "**Responses of six community metrics to time, local
  anthropogenic pressures, stream gradient and their interaction**. Responses of
  dissimilarity based on the Simpson index, Turnover, Total abundance, Chao species
  richness, the proportion of non-native species and of non-native abundance.
  Time was quantified by the logged number of years since the first year of
  sampling at a given site added to one. The legacy of past anthropogenic
  pressures and the recent changes in anthropogenic pressures were quantified
  respectively by the Human Footprint index (1993) and the ratio between the
  Human Footprint at the year 2009 and 1993. The stream gradient was summarized
  by the first axis of a PCA preformed on the stream reach characteristics,
  related to the average annual discharge, the distance from the source, and the
  strahler order. All the predictors and responses were standardized prior to model
  evaluation. The Legacy of past anthropogenic pressures, quantified by the
  Human Footprint index (1993) was centered around its median value. Large,
  medium and thin bars depict respectively the Bayesian credible intervals at
  80, 90 and 95%. Please note the broken
  abscissa scale in the framed panels. N = ", fnop, " sampling events over ",
  fnsite, " sites.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

Do we need to name the legend?

```{r save-fig1}
#fig1
ggsave(
  filename = "fig1.pdf",
  plot = fig1,
  path = here("paper", "fig_paper"),
  scale = 1.75,
  width = 88,
  height = 88 * 2.5,
  units = "mm",
  dpi = "print"
)

```

```{r eff, fig.asp = 2.5, fig.width = 88* 0.0393701}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig1.pdf"))
```


## Typology of biodiversity trends

```{r}
tar_load(c(pca_clust, site_cl_rm, site_no_drivers_inla_tot))
tar_load(c(clust_var_alter, site_cl_rm_red, site_env))
pca_data <- site_no_drivers_inla_tot[,
    colnames(site_no_drivers_inla_tot) %in% restricted_dimension &
    !colnames(site_no_drivers_inla_tot) %in% c("perc_exo_sp", "perc_exo_abun")]
```

```{r}
pca_clust <- compute_rotated_pca(pca_data, naxis = 4)
pca_clust3 <- compute_rotated_pca(pca_data, naxis = 3)
pca_clust2 <- compute_rotated_pca(pca_data, naxis = 2)
pca3_var_expl <- scales::percent(max(pca_clust3$rotated$Vaccounted["Cumulative Var", ]))
pca2_var_expl <- scales::percent(max(pca_clust2$rotated$Vaccounted["Cumulative Var", ]))
```

```{r pca-cor-tps, fig.height=8}
axis_l <- list(
  c("CS1", "CS2"),
  c("CS1", "CS3"),
  c("CS1", "CS4"),
#  c("CS1", "CS5"),
  c("CS2", "CS3"),
  c("CS2", "CS4"),
#  c("CS2", "CS5"),
#  c("CS4", "CS5"),
#  c("CS3", "CS5"),
  c("CS3", "CS4")
)

cluster_names <- c(
  "Medium change", "High turnover",
  "Increase in\n species richness", "Decrease in\n total abundance",
  "Decrease in\n species richness", "Low change"
)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", scales::percent((fnsite - sum(nb_clusters)) / fnsite),")"
)

cluster_labels <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))

p_pca_cl_ell <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$normal,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .4,
     replace_var = get_var_replacement_vulgarisation(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 1,
     var_scaling_factor = 3.5
   ) +
 guides(
   colour = guide_legend(
     override.aes = list(size = 10),
     #title.theme = element_blank(),
     title.position = "top",
     title.hjust = .5,
     label.position = "top",
     ncol = 2)
 ) +
 theme(
   legend.position = "bottom",
   panel.background = element_blank(),
   legend.text = element_text(size = 7),
   legend.key = element_rect(fill = NA)) +
 scale_color_viridis(
   discrete = TRUE,
   name = "Cluster assignment", labels = cluster_labels)
)
p_cl <- p_pca_cl_ell[[1]]
leg_cl <- get_legend(
  p_pca_cl_ell[[1]]
)

p_pca_cl_ell <- map(p_pca_cl_ell, ~.x + theme(legend.position = "none"))

p_pca_cl_top <- plot_grid(plotlist = p_pca_cl_ell[c(1, 6)], ncol = 2)

bp_data <- site_cl_rm[, colnames(site_cl_rm) %in% c(restricted_dimension, "siteid", "cl", "riv_str_rc1", "hft_c9309_scaled_no_center")]
p_pca_cl_bt <- target_bp_cl_dist(
  cl_obj = bp_data,
  fct_var_lvl = names(pal_variable)[1:4],
  dodge = .85
  ) +
  scale_color_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  scale_x_discrete(position = "bottom") +
  labs(y = "Scaled temporal trends (SD units)") +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0),
    axis.title.y = element_text(angle = 90, vjust = 0),
    legend.position = "none"
  )
```

```{r} 
pca_clust_cap <- paste0("**PCA biplot on the temporal trends of the
  community metrics at each site, their cluster assignment (upper panel) and the
  boxplots describing the distribution of the temporal trends by cluster (lower
    panel)**. The temporal trends of each community metrics were derived from
  the model with time only. PCA with two and three principal components
  explained respectively ", paste0(pca2_var_expl, " and ", pca3_var_expl), " of
  the variance. The temporal trends of community metrics were clustered using
  the k-means method while excluding 5% of the most outlying sites and sites
  with a doubtful assignement to a cluster were removed ", na_cluster, ".  The
  sites are colored by their cluster belongings. The ellipses represent the 95%
  interval around the clusters assuming a Student's t distribution. The
  clusters were named according to their unique characteristics.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

For the figure 2, I see the main question of whether we need to give to the clusters
or not. I would suggest to put them as medium change, high turnover, increase in
species richness, decrease in total abundance and no change.  

```{r}
fig2 <- plot_grid(
  p_pca_cl_top,
  plot_grid(p_pca_cl_bt, leg_cl, rel_widths = c(1, .25)),
  nrow = 2,
  rel_heights = c(1, .8)
)
#fig2
ggsave(
  filename = "fig2.pdf",
  plot = fig2,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.asp = .9, fig.width = 88 * 0.0393701}
# , fig.cap=pca_clust_cap
knitr::include_graphics(here("paper", "fig_paper", "fig2.pdf"))
```


```{r}
tar_load(c(world_site_sf))
```


```{r}
loc <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  left_join(filtered_dataset_modelling$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```


```{r}
tar_load(filtered_basinatlas_modelling)
site_cl_rm_loc <- site_cl_rm %>%
  select(siteid, cl) %>%
  left_join(loc, by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia")) %>%
  left_join(
    measurement_exo %>%
      distinct(siteid, basin_name),
    by = "siteid")

n_clust_basin <- site_cl_rm_loc %>%
  group_by(ecoregion, country, main_bas) %>%
  summarise(
    n = n(),
    div = length(unique(cl)),
    evenness = ifelse(div == 1, 1, diversity(table(cl)) / log(div))
  )

# Take the most sampled basin by country
fq_pal_bas <- site_cl_rm_loc %>%
  filter(basin_name %in% c("Avon.Moors", "Loire", "Gota.alv")) %>%
  group_by(basin_name, cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq)) %>%
  ungroup()

fq_pal <- site_cl_rm_loc %>%
  filter(ecoregion == "Palearctic") %>%
  group_by(cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq), basin_name = toupper("Palearctic")) %>%
  ungroup()

fq_tab <- rbind(
  fq_pal, fq_pal_bas
)

get_fq_tab_from_basin <- function(
  x = site_cl_rm_loc,
  ecoregion = NULL,
  basin_var = basin_name,
  basins = NULL) {

  if (is.null(names(basins))) {
    names(basins) <- basins
  }

  fq_pal_bas <- x %>%
    filter({{basin_var}} %in% basins) %>%
    group_by({{basin_var}}, cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = str_replace_all(as.character({{basin_var}}), setNames(names(basins), as.character(basins)))
      ) %>%
    ungroup()

  ecoregion2 <- ecoregion# to not mess up filter
  fq_pal <- x %>%
    filter(ecoregion == ecoregion2) %>%
    group_by(cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = toupper(ecoregion)
      ) %>%
    ungroup()

  fq_tab <- rbind(fq_pal, select(fq_pal_bas, cl, freq, pc, basin_name)) %>%
    mutate(
      basin_name = factor(
        basin_name, levels = c(toupper(ecoregion), names(basins))),
      ecoregion = ecoregion
    )
  return(fq_tab)

}

basin_name_palearctic <- n_clust_basin %>%
  filter(ecoregion == "Palearctic", div == 6) %>%
  arrange(desc(n))

basin_names_pal <- site_cl_rm_loc %>%
  filter(main_bas %in% c(2080021030, 2080053790, 2080033320)) %>%
  distinct(main_bas, basin_name) %>%
  filter(basin_name != "Lagan.Swe")

pal_basin <- deframe(basin_names_pal[, 2:1])

tab_palearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Palearctic",
  basin_var = main_bas,
  basins = pal_basin
)

basin_name_nearctic <- n_clust_basin %>%
  filter(ecoregion == "Nearctic", div >= 5) %>%
  arrange(desc(n))

basin_names_nea <- site_cl_rm_loc %>%
  filter(main_bas %in% basin_name_nearctic$main_bas[1:4]) %>%
  distinct(main_bas, basin_name) %>%
  filter(!is.na(basin_name) & basin_name != "Red")


nea_basin <- deframe(basin_names_nea[, 2:1])

tab_nearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Nearctic",
  basin_var = main_bas,
  basins = nea_basin
)

basin_name_australasia <- n_clust_basin %>%
  filter(ecoregion == "Australasia", div >= 5) %>%
  arrange(desc(n))

basin_names_aus <- site_cl_rm_loc %>%
  filter(main_bas %in% basin_name_australasia$main_bas[1:3]) %>%
  distinct(main_bas, basin_name) %>%
  filter(!is.na(basin_name)) %>%
  slice(-1,-3)
aus_basin <- deframe(basin_names_aus[, 2:1])

tab_australasia <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Australasia",
  basin_var = main_bas,
  basins = aus_basin
)

filtered_basinatlas_modelling %>%
  filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
  mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))))%>%
  ggplot() +
  geom_sf(aes(color = main_bas)) +
  geom_sf_text(aes(label = basin_name), colour = "black")


all_basin <- c("Mississippi", "Saint.Laurent", "Potomac", "Thames.UK", "Loire", "Gota.alv", "Avoca", "Brisbane", "Logan") 
names(all_basin) <- letters[seq_along(all_basin)]

tot_tab <- rbind(
  tab_nearctic,
  tab_palearctic,
  tab_australasia) %>%
  left_join(
    site_cl_rm_loc %>%
      filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
      mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))))%>%
      mutate(country = ifelse(basin_name == "Saint.Laurent", "CAN/USA", country)) %>%
      distinct(basin_name, country),
    by = "basin_name"
  ) %>%
  mutate(
    label = map_chr(basin_name,
      ~ifelse(
        any(all_basin %in% .x),
        names(all_basin)[all_basin == .x],
        NA)
      ),
    basin_name = str_replace(basin_name, "\\.", " "),
    basin_name = str_replace(basin_name, "UK|alv", "")
    ) %>%
  group_by(basin_name) %>%
  mutate(
    total_n = sum(freq)) %>%
  ungroup() %>%
  arrange(label) %>%
  mutate(
    country = ifelse(is.na(country), "", paste0(", ", country)),
    basin_name_n = paste0(basin_name, " (", total_n, ")"),
    basin_name_n = ifelse(
      !is.na(label),
      paste0("(", label,") ", basin_name_n),
      basin_name_n
      ),
    basin_name_n = str_replace(basin_name_n, "\\s{2}", " "),
    basin_name_f = factor(basin_name_n, levels = unique(basin_name_n))

  )
lvl_basin <- c(
  "(i) Logan (32)",
  "(h) Brisbane (89)",
  "(g) Avoca (129)",
  "AUSTRALASIA (330)",
  "(f) Gota (50)",
  "(e) Loire (240)",
  "(d) Thames (139)",
  "PALEARCTIC (3470)",
  "(c) Potomac (66)",
  "(b) Saint Laurent (164)",
  "(a) Mississippi (574)",
  "NEARCTIC (1083)"
)
lvl_ecoregion <- c("Nearctic", "Palearctic", "Australasia")
```

```{r}
p_tot_tab <- tot_tab %>%
  mutate(
     basin_name_f = factor(basin_name_n, levels = lvl_basin),
     ecoregion_f = factor(ecoregion, levels = lvl_ecoregion)
    ) %>%
  ggplot(aes(x = pc, y = basin_name_f, fill = as.factor(cl))) +
  geom_col() +
  labs(x = "Proportion") +
  scale_x_continuous(labels = scales::percent, expand = c(0, .01)) +
  theme_cowplot() +
  theme(
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(size = 1, color = "black"),
    legend.position = "none",
    strip.text = element_blank()
    ) +
  facet_grid(rows = vars(ecoregion_f), scale = "free_y") +
  scale_fill_viridis(discrete = TRUE, name = "Cluster")
```


```{r}
tar_load(rivers10)
world_site_sf$cl <- world_site_sf$site %>%
    left_join(site_cl_rm_loc[, c("siteid", "cl", "basin_name")], by = "siteid") %>%
    mutate(cl = relevel(as.factor(cl), ref = 1))

zoom_map_world <- world_site_sf$cl %>%
  st_buffer(dist = .2) %>%
    st_bbox()
unique(world_site_sf$world$continent)

main_map <-
  world_site_sf$world %>%
  filter(continent != "Antarctica") %>%
  ggplot() +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none") +
  coord_sf(
    #xlim = zoom_map_world[c("xmin", "xmax")],
    #ylim = zoom_map_world[c("ymin", "ymax")],
    expand = FALSE)

main_map4zoom <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 4) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none")


zoom_map <- list(
  north_am = "USA",
  eng = "GBR",
  south_eu = c("FRA", "ESP", "BEL"),
  north_eu = c("FIN", "NOR", "SWE"),
  aus = "AUS"
)
zoom_map_basin_coord <- map(all_basin,
  ~world_site_sf$cl %>%
    filter(basin_name %in% .x) %>%
    st_bbox()
)

zoom_map_coord <- map(zoom_map,
  ~world_site_sf$cl %>%
    filter(country %in% .x) %>%
    st_bbox()
)

zoom_map_coord_df <- map_dfr(zoom_map_coord,
  ~setNames(as.numeric(.x), names(zoom_map_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  label = LETTERS[seq_len(length(zoom_map_coord))],
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
zoom_map_basin_coord_df <- map_dfr(zoom_map_basin_coord,
  ~setNames(as.numeric(.x), names(zoom_map_basin_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  LABEL = LETTERS[seq_len(length(zoom_map_basin_coord))],
  label = letters[seq_len(length(zoom_map_basin_coord))],
  width_basin = xmax - xmin,
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
```

```{r}
basin_map <- filtered_basinatlas_modelling %>%
  filter(main_bas %in% c(pal_basin, nea_basin, aus_basin)) %>%
  mutate(basin_name = str_replace_all(main_bas, get_rev_vec_name_val(c(pal_basin, nea_basin, aus_basin))), 
    label = str_replace_all(basin_name, get_rev_vec_name_val(all_basin)),
    label2 = str_replace_all(label, c("i" = "  i")),
  )

main_map_rect_basin <- main_map +
  geom_sf(data = basin_map, color = "black", fill = NA) +
  geom_sf_text(data = basin_map, aes(label = label2), colour = "black", size = 7, vjust = -.3, hjust = 0) +
theme(legend.position = "none")
```

```{r}
p_main_map_rect <- main_map_rect_basin +
  draw_plot(leg_cl, x = -100, y = zoom_map_world["ymin"] + 5, vjust = 0, hjust = 0)

save_plot(
  here("doc", "fig", "global_map.png"),
  p_main_map_rect,
  base_height = 3.71,
  base_asp = 2.618,
)

```
```{r, eval=FALSE}
p_zoom_map <- map2(zoom_map_coord, zoom_map_coord_df$label,
  ~main_map4zoom +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 7, vjust = 1.2, hjust = -.2) +
    theme(
      legend.position = "none",
      panel.border = element_rect(size = 1, color = "black")
    )
)
p_zoom_map_basin <- map2(zoom_map_basin_coord, zoom_map_basin_coord_df$label,
  ~main_map4zoom +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 7, vjust = 1.2, hjust = -.2) +
    theme(
      legend.position = "none",
      panel.border = element_rect(size = 1, color = "black")
    )
)
```


```{r}
inset_basin <- map(sort(basin_map$label),
  function(l) {
    x <- basin_map %>%
    filter(label == l)
   x %>%
    ggplot() +
    geom_sf(color = NA) +
    annotate(geom = 'text', label = l, x = -Inf, y = Inf, hjust = 0, vjust = 1, size = 10) +
    theme_void() +
    geom_sf(data = st_intersection(rivers10, x), colour = "lightblue", alpha = .4) +
    geom_sf(data = st_intersection(world_site_sf$cl %>%
        filter(!is.na(cl)), x),
      aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 4) +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position = "none") +
    coord_sf(expand = FALSE)
  }
)
names(inset_basin) <- sort(basin_map$label)
box_basin <- map(setNames(basin_map$geometry, basin_map$label), ~st_bbox(.x))
width_height_box <- map(box_basin,
  ~setNames(
    c(.x["xmax"] - .x["xmin"], .x["ymax"] - .x["ymin"]),
    c("width", "height")
  )
)
```




```{r}
cluster_labels2 <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))
leg_cl_right <- get_legend(
  p_pca_cl_ell[[1]] +
    theme(legend.position = "right") +
    guides(col = guide_legend(
        ncol = 2, override.aes = list(size = 10)
        )) +
    scale_color_viridis(discrete = TRUE, name = "Cluster", labels = cluster_labels2)
)
```

```{r}
refs <- width_height_box[["a"]]
ref_width_basin <- .33
ratio_width_to_a <- map_dbl(width_height_box, ~round(.x["width"] / refs["width"], 2))

fig3_bottom_left3 <- ggdraw() +
  draw_plot(
    inset_basin[["a"]], x = 0, y = 1,
    width = ref_width_basin,
    height = ref_width_basin * refs["height"] / refs["width"],
    vjust = 1, halign = 0, valign = 0) +
  draw_plot(
    inset_basin[["b"]], x = .33, y = 1,
    width = ref_width_basin,
    height = ref_width_basin*width_height_box$b["height"]/width_height_box$b["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["c"]], x = .66, y = 1,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$c["height"] / width_height_box$c["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["d"]], x = 0, y = .66,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$d["height"] / width_height_box$d["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["e"]], x = .33, y = .66,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$e["height"] / width_height_box$e["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["f"]], x = .66, y = .66,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$f["height"] / width_height_box$f["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["g"]], x = 0, y = .33,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$g["height"] / width_height_box$g["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["h"]], x = 0.33, y = .33,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$h["height"] / width_height_box$h["width"],
    vjust = 1) +
  draw_plot(
    inset_basin[["i"]], x = 0.66, y = .33,
    width = ref_width_basin,
    height = ref_width_basin * width_height_box$i["height"] / width_height_box$i["width"],
    vjust = 1)
```


```{r}
leg_cl <- get_legend(
  p_cl +
    guides(
      colour = guide_legend(
     override.aes = list(size = 10),
     title.theme = element_blank(),
     label.position = "top",
     nrow = 2)
  ) +
theme(
  legend.position = "bottom",
  panel.background = element_blank(),
  legend.text = element_text(size = 11),
  legend.key = element_rect(fill = NA)
))

bottom_left <- plot_grid(plotlist = inset_basin, ncol = 3)
bottom_right <- plot_grid(p_tot_tab, leg_cl, ncol = 1, rel_heights = c(1, .5))

bottom <- plot_grid(bottom_left, bottom_right, ncol = 2, rel_widths = c(1, .5))

fig3 <- plot_grid(
  main_map_rect_basin + coord_sf(expand = FALSE),
  bottom,
  ncol = 1, rel_heights = c(1, 1))
ggsave(
  filename = "fig3.pdf",
  plot = fig3,
  path = here("paper", "fig_paper"),
  scale = 5.0,
  width = 88,
  height = 88 * .8,
  units = "mm",
  dpi = "print"
)
```

```{r}
map_cl_cap <- "**Spatial distribution of the clusters of biodiversity temporal
trends**. Top panel: spatial distribution of the the clusters with insets of
the most sampled hydrographic basins by realms. Right panel: cluster frequency
distribution in the three most represented Realms (in capital letters) and their
most sampled hydrographic basins, corresponding to the insets displayed on the left panel.
The number of sites are displayed between parenthesis."
```

```{r cl-map, fig.asp = .65, fig.width = 88* 0.0393701}
knitr::include_graphics(here("paper", "fig_paper", "fig3.pdf"))
```




# Figure legends

- Figure 1: `r knitr::knit(text = fig1_cap)` 

- Figure 2: `r knitr::knit(text = pca_clust_cap)`

- Figure 3: `r knitr::knit(text = map_cl_cap)`

\newpage

# Table

```{r}
tar_load(c(gaussian_inla_rand, r2))
library(coda)

tu <- r2 %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  mutate(
    r2_mvp_marg95hpd = map(r2_mvp_marg, ~HPDinterval(as.mcmc(.x))),
    r2_mvp_marg95hpdci = map2_chr(r2_mvp_marg95hpd, r2_mvp_marg_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
          "]")
      ),
    r2_mvp_cond95hpd = map(r2_mvp_cond, ~HPDinterval(as.mcmc(.x))),
    r2_mvp_cond95hpdci = map2_chr(r2_mvp_cond95hpd, r2_mvp_cond_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
          "]")
      )
  )


tab_rand <- gaussian_inla_rand %>%
  filter(
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
  select(-ci_level) %>%
  mutate(across(c(mean, low, high), ~round(., 3))) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    term = str_remove(term, "Precision for the |Precision for |"),
    term = replacement_random_term()[term],
    ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
  arrange(response, desc(term)) %>%
  select(
    `Response variable` = response,
    Term = term,
    `Standard deviation` = ci
  )

tab_rand2 <- tab_rand %>%
  left_join(
    tu %>%
      mutate(response = get_var_replacement_vulgarisation()[response]) %>%
      select(
        `Response variable` = response,
        `Marg. R2` = r2_mvp_marg95hpdci,
        `Cond. R2` = r2_mvp_cond95hpdci
        ),
    by = "Response variable"
  ) %>%
select(1, 4, 5, 2, 3) %>%
mutate(`Response variable` = factor(`Response variable`, levels = names(pal_variable))) %>%
arrange(`Response variable`)
```

```{r}
tab_rand_cap <- "Marginal and conditional mean R-squared of the models and the mean standard deviation estimated for the random effect and the error terms. [95% CI]: Credible Interval computed using Highest Posterior Density method."
tab_rand2 %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap) %>%
  collapse_rows(columns = c(1, 2, 3), latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down"))
```

# Instructions from  NEE 


Effective figure preparation will enhance the readability of your manuscript –
our image preparation guidelines will help you to produce effective
publication-quality figures. In addition, please consider the following
important requirements:  

## Images

All figures must be cited in sequence within the main article text in the form Fig. 1, Fig. 2.

Figure panels should be prepared at a minimum resolution of 300 dpi and saved at a maximum width of 180 mm.  

Use a 5–7 pt san serif font for standard text labelling and Symbol font for Greek characters. 

Use scale bars, not magnification factors, and include error bars where appropriate. 

Do not flatten labelling or scale/error bars onto images – uneditable or low-resolution images are two of the most common reasons for delay in manuscript preparation.  

## Figure legends

Include a brief title for each figure with a short description of each panel cited in sequence. 

Ensure the legend does not exceed the word limit of the article type.

Avoid methodological detail.

Use verbal cues to describe keys, eg. "open red triangles", not visual cues or symbols.

Include a description of centre values (median or average) and all error
bars and how they were calculated.  Give an indication of sample size (n
number), state the statistical test used and provide P values.




