---
title: "Main figures of the manuscript"
author: Danet, A., Giam, X., Olden, J. and Comte L.
output:
  bookdown::pdf_document2:
    toc: true
---


```{r setup, include=FALSE}
source(here::here("start_rmd.R"))
#knitr::opts_chunk$set(cache = TRUE)
library(ade4)
library(factoextra)
library(patchwork)

knitr::opts_chunk$set(
  echo = FALSE,
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>",
  fig.path = "fig_paper/knitr-",
  fig.retina = 1, # Control using dpi
  fig.width = 2.25,  # generated images
  fig.pos = "htp",  # pdf mode
  fig.align = "center",
  dpi = 300,
  dev = "png",
  dev.args = list(png = list(type = "cairo-png")),
  optipng = "-o1 -quiet"
)
```

# Options

## Color blind palettes

- For variables: [palette from coolors.co](https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996)
- For clusters: the discrete version of the [viridis palette](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html)

```{r}
# control also the order of the legend
restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_sp", "perc_exo_abun")
```


```{r set-color-palette}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")

#pal <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")
#pal2 <- palette_coolors("https://coolors.co/palette/01befe-ffdd00-ff7d00-ff006d-adff02-8f00ff")
#pal_variable <- palette_coolors("https://coolors.co/0f122a-4ba3a9-e4dd73-d6b594-ae5996")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")

names(pal_variable) <- get_var_replacement_vulgarisation()[restricted_dimension]
#scale_color_brewer(palette = "RdYlBu") +
#scale_color_viridis(discrete=TRUE) +
```

```{r loading-targets, include=FALSE}
tar_load(c(gaussian_inla_exo_std_effects, gaussian_inla_std_effects,
    measurement_exo))
```


# Figures

## Responses of five community metrics to time, anthropogenic pressures and stream gradient


```{r}
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  filter(response %in% restricted_dimension) %>%
  mutate(
    term = str_replace_all(term,
      get_model_term_replacement_paper_figure()),
    response = get_var_replacement_vulgarisation()[response]
    )
term_level <- c(
      "Time",
      "Stream gradient",
      "Past pressures",
      "Recent pressures",
      "Time x\nStream gradient",
      "Time x\nPast pressures",
      "Time x\nRecent pressures",
      "Time x\nStream gradient x\nPast pressures",
      "Time x\nStream gradient x\nRecent pressures",
      "Time x\nPast pressures x\nRecent pressures"
          )
# width_bar
base_width <- .2
increment <- .25
tu %<>%
  mutate(
    width_bar = case_when(
      width_bar == 1 ~ base_width,
      width_bar == 2 ~ base_width + increment,
      width_bar == 3 ~ base_width + increment * 2,
      TRUE ~ width_bar

    )

  )

```

```{r, fig.show="hide"}
library(ggbreak)
p1 <- tu %>%
  filter(facet == "main") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = pal_variable,
    term_level = term_level) +
  scale_x_break(c(.22, .55))

p2 <- tu %>%
  filter(facet == "interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(scale_color = pal_variable,
    term_level = term_level) +
  scale_x_break(c(.135, .195))

p3 <- tu %>%
  filter(facet == "dbl_interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    scale_color = pal_variable,
    term_level = term_level,
    legend_present = TRUE,
    xaxis_title = TRUE
    ) +
  labs(x = "Standardized slope coefficients (SD unit)")

leg_dis <- get_legend(p3 +
 guides(
   colour = guide_legend(nrow = 2)) +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 10),
    legend.title = element_blank()
  )
)

fig1 <- plot_grid(
  print(p1),
  print(p2),
  p3 + theme(legend.position = "none"),
  leg_dis,
  rel_heights = c(1, 1, 1, .1),
  ncol = 1)
```

```{r}
tar_load(filtered_dataset_modelling)
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )
fnsite <- nrow(site_year)
fnop <- length(unique(filtered_dataset_modelling$measurement$op_id))
```


```{r}
fig1_cap <- paste0(
  "**Responses of five community metrics to time, local
  anthropogenic pressures, stream gradient and their interaction**. Responses of
  dissimilarity based on the Simpson index, Total abundance, Chao species
  richness, the percentage of exotic species and of exotic species abundance.
  Time was quantified by the logged number of years since the first year of
  sampling at a given site added to one. The legagy of past anthropogenic
  pressures and the recent changes in anthropogenic pressures were quantified
  respectively by the Human Footprint index (1993) and the ratio between the
  Human Footprint at the year 2009 and
1993. The stream gradient was quantified by the first axis of a PCA preformed on
the stream reach characteristics, related to the average annual discharge,
the distance from the source, and the strahler order. All the predictors were
standardized prior to model evaluation. The Legacy of past anthropogenic
pressures, quantified by the Human Footprint index (1993) was centered around
its median value. Large, medium and thin bars depict respectively the bayesian
credible intervals at 80, 90 and 95%. Main effects but time were not included
for the site dissimilarity metrics (See methods).  Please
note the broken abscisse scale in the framed panels. N = ", fnop, " monitoring
events over ", fnsite, " sites.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

Do we need to name the legend?

```{r save-fig1}
#fig1
ggsave(
  filename = "fig1.pdf",
  plot = fig1,
  path = here("paper", "fig_paper"),
  scale = 1.75,
  width = 88,
  height = 88 * 3.1,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.asp = 3.1, fig.width = 2.25}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig1.png"))
```


## Typology of biodiversity trends

```{r}
tar_load(c(pca_clust, site_cl_rm, site_no_drivers_inla_tot))
tar_load(c(clust_var_alter, site_cl_rm_red, site_env))
pca_data <- site_no_drivers_inla_tot[,
    colnames(site_no_drivers_inla_tot) %in% restricted_dimension &
    !colnames(site_no_drivers_inla_tot) %in% c("perc_exo_sp", "perc_exo_abun")]
```
```{r}
tar_load(c(k4_fac_50_red, site_env))
k4_fac_50_red <- tclust(
     x = scale(pca_data,
       center = FALSE),
     iter.max = 100,
     k = 4,
     alpha = 0.05,
     restr.fact = 50,
     warnings = 2
   )
plot(k4_fac_50_red)
site_cl_rm_red <- get_cluster_df(
     tclust_obj = k4_fac_50_red,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
```


```{r}
pca_clust <- compute_rotated_pca(pca_data, naxis = 4)
pca_clust3 <- compute_rotated_pca(pca_data, naxis = 3)
pca_clust2 <- compute_rotated_pca(pca_data, naxis = 2)
pca3_var_expl <- scales::percent(max(pca_clust3$rotated$Vaccounted["Cumulative Var", ]))
pca2_var_expl <- scales::percent(max(pca_clust2$rotated$Vaccounted["Cumulative Var", ]))
p_rotated_pca_clust <- my_pca_plot(
  pca_clust$rotated,
  replace_var = get_var_replacement())
```

```{r}
p_pca_clust <- plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80
   )
```

```{r pca-cor-tps, fig.height=8}
axis_l <- list(
  c("RC1", "RC2"),
  c("RC1", "RC3"),
  c("RC1", "RC4"),
#  c("RC1", "RC5"),
  c("RC2", "RC3"),
  c("RC2", "RC4"),
#  c("RC2", "RC5"),
#  c("RC4", "RC5"),
#  c("RC3", "RC5"),
  c("RC3", "RC4")
)

cluster_names <- c(
  "Medium change", "High turnover",
  "Increase in\n species richness", "Decrease in\n total abundance",
  "Decrease in\n species richness", "Low change"
)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", scales::percent((fnsite - sum(nb_clusters)) / fnsite),")"
)

cluster_labels <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))

p_pca_cl_ell <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .4,
     replace_var = get_var_replacement_vulgarisation(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 3.5
   ) +
 guides(
   colour = guide_legend(
     override.aes = list(size = 10),
     title.theme = element_blank(),
     label.position = "top",
     ncol = 1)
 ) +
 theme(
   legend.position = "bottom",
   panel.background = element_blank(),
   legend.text = element_text(size = 10),
   legend.key = element_rect(fill = NA)) +
 scale_color_viridis(
   discrete = TRUE,
   name = "Cluster", labels = cluster_labels)
)
leg_cl <- get_legend(
  p_pca_cl_ell[[1]]
)

p_pca_cl_ell <- map(p_pca_cl_ell, ~.x + theme(legend.position = "none"))

p_pca_cl_top <- plot_grid(plotlist = p_pca_cl_ell[c(1, 6)], ncol = 2)

bp_data <- site_cl_rm[, colnames(site_cl_rm) %in% c(restricted_dimension, "siteid", "cl", "riv_str_rc1", "hft_c9309_scaled_no_center")]
p_pca_cl_bt <- target_bp_cl_dist(cl_obj = bp_data) +
  scale_color_viridis(discrete = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0),
    legend.position = "none"
  )

```

```{r} 
pca_clust_cap <- paste0("**PCA biplot on the temporal trends of the
  community metrics at each site, their cluster assignment (upper panel) and the
  boxplots describing the distribution of the temporal trends by cluster (lower
    panel)**. The temporal trends of each community metrics were obtained from a
  model without anthropogenic pressures and extracted from random effect using
  BLUP (see methods). The principal components of the PCA were rotated with the
  varimax algorithm to increase the representation of the variables on the
  principal components (RC: rotated components). PCA with two and three
  principal components explained respectively", paste0(pca2_var_expl, " and ", pca2_var_expl)," of the variance. The temporal trends of community
  metrics were clustered using the k-means method while excluding 5%
   of the most outlying data to avoid the identification of spurious clusters.
  Sites with a doubtful assignement to a cluster were removed ", na_cluster, ".
  The sites are colored by their cluster belongings. The ellipses represent the
  95% interval around the clusters assuming a Student's t distribution. The
  clusters were named according to their unique characteristics.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

For the figure 2, I see the main question of whether we need to give to the clusters
or not. I would suggest to put them as medium change, high turnover, increase in
species richness, decrease in total abundance and no change.  

```{r}
fig2 <- plot_grid(
  p_pca_cl_top,
  plot_grid(p_pca_cl_bt, leg_cl, rel_widths = c(.8, .2)),
  nrow = 2,
  rel_heights = c(1, .7)
)
```
```{r save-fig2}
#fig2
ggsave(
  filename = "fig2.pdf",
  plot = fig2,
  path = here("paper", "fig_paper"),
  scale = 2.0,
  width = 88,
  height = 88 * .8,
  units = "mm",
  dpi = "print"
)
```

```{r, fig.width = 4.75, fig.asp = 1.7}
# , fig.cap=pca_clust_cap
knitr::include_graphics(here("paper", "fig_paper", "fig2.png"))
```


## Spatial distribution of biodiversity trends 

```{r}
tar_load(c(world_site_sf))
```


```{r}
loc <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  left_join(filtered_dataset_modelling$site_quali, by = "siteid") %>%
  st_as_sf(coords = c("longitude", "latitude"),
  crs = 4326)
```


```{r}
site_cl_rm_loc <- site_cl_rm %>%
  select(siteid, cl) %>%
  left_join(loc, by = "siteid") %>%
  filter(ecoregion %in% c("Palearctic", "Nearctic", "Australasia")) %>%
  left_join(
    measurement_exo %>%
      distinct(siteid, basin_name),
    by = "siteid")

n_clust_basin <- site_cl_rm_loc %>%
  group_by(ecoregion, country, basin_name) %>%
  summarise(
    n = n(),
    div = length(unique(cl)),
    evenness = ifelse(div == 1, 1, diversity(table(cl)) / log(div))
  )

# Take the most sampled basin by country
fq_pal_bas <- site_cl_rm_loc %>%
  filter(basin_name %in% c("Avon.Moors", "Loire", "Gota.alv")) %>%
  group_by(basin_name, cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq)) %>%
  ungroup()

fq_pal <- site_cl_rm_loc %>%
  filter(ecoregion == "Palearctic") %>%
  group_by(cl) %>%
  summarise(freq = n()) %>%
  mutate(pc = prop.table(freq), basin_name = toupper("Palearctic")) %>%
  ungroup()

fq_tab <- rbind(
  fq_pal, fq_pal_bas
)

get_fq_tab_from_basin <- function(
  x = site_cl_rm_loc,
  ecoregion = NULL,
  basins = NULL) {

  fq_pal_bas <- x %>%
    filter(basin_name %in% basins) %>%
    group_by(basin_name, cl) %>%
    summarise(freq = n()) %>%
    mutate(pc = prop.table(freq)) %>%
    ungroup()

  ecoregion2 <- ecoregion# to not mess up filter
  fq_pal <- site_cl_rm_loc %>%
    filter(ecoregion == ecoregion2) %>%
    group_by(cl) %>%
    summarise(freq = n()) %>%
    mutate(
      pc = prop.table(freq),
      basin_name = toupper(ecoregion)
      ) %>%
    ungroup()

  fq_tab <- rbind(fq_pal, fq_pal_bas) %>%
    mutate(
      basin_name = factor(
        basin_name, levels = c(toupper(ecoregion), basins)),
      ecoregion = ecoregion
    )
  return(fq_tab)

}

basin_name_palearctic <- n_clust_basin %>%
  filter(ecoregion == "Palearctic", div == 6) %>%
  arrange(desc(n))

tab_palearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Palearctic",
  basins = c("Seine", "Derwent.UK", "Umealven")
)

basin_name_nearctic <- n_clust_basin %>%
  filter(ecoregion == "Nearctic", div >= 5) %>%
  arrange(desc(n))

tab_nearctic <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Nearctic",
  basins = c("Mississippi", "Saint.Laurent", "Columbia")
)

basin_name_australasia <- n_clust_basin %>%
  filter(ecoregion == "Australasia", div >= 5) %>%
  arrange(desc(n))

tab_australasia <- get_fq_tab_from_basin(
  x = site_cl_rm_loc,
  ecoregion = "Australasia",
  basins = c("Murray.Darling", "Brisbane", "Logan")
)

all_basin <- c("Columbia", "Mississippi", "Saint.Laurent", "Derwent.UK", "Seine", "Umealven",
  "Murray.Darling", "Brisbane", "Logan"
)
names(all_basin) <- letters[seq_along(all_basin)]

tot_tab <- rbind(
  tab_nearctic,
  tab_palearctic,
  tab_australasia) %>%
  left_join(
    site_cl_rm_loc %>%
      filter(basin_name %in% .$basin_name) %>%
      mutate(country = ifelse(basin_name == "Saint.Laurent", "CAN/USA", country)) %>%
      distinct(basin_name, country),
    by = "basin_name"
  ) %>%
  mutate(
    label = map_chr(basin_name,
      ~ifelse(
        any(all_basin %in% .x),
        names(all_basin)[all_basin == .x],
        NA)
      ),
    basin_name = str_replace(basin_name, "\\.", " "),
    basin_name = str_replace(basin_name, "UK", "")
    ) %>%
  group_by(basin_name) %>%
  mutate(
    total_n = sum(freq)) %>%
  ungroup() %>%
  arrange(label) %>%
  mutate(
    country = ifelse(is.na(country), "", paste0(", ", country)),
    basin_name_n = paste0(basin_name, " (", total_n, country, ")"),
    basin_name_n = ifelse(
      !is.na(label),
      paste0("(", label,") ", basin_name_n),
      basin_name_n
      ),
    basin_name_f = factor(basin_name_n, levels = unique(basin_name_n)),

  )
```

```{r}
p_tot_tab <- tot_tab %>%
  mutate(
    ecoregion = toupper(ecoregion)
    ) %>%
  ggplot(aes(x = pc, y = basin_name_f, fill = as.factor(cl))) +
  geom_col() +
  labs(x = "Proportion") +
  scale_x_continuous(labels = scales::percent, expand = c(0, .01)) +
  theme_cowplot() +
  theme(
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(size = 1, color = "black"),
    legend.position = "none",
    strip.text = element_blank()
    ) +
  facet_grid(rows = vars(ecoregion), scale = "free_y") +
  scale_fill_viridis(discrete = TRUE, name = "Cluster")
```



```{r}
tar_load(rivers10)
world_site_sf$cl <- world_site_sf$site %>%
    left_join(site_cl_rm_loc[, c("siteid", "cl", "basin_name")], by = "siteid") %>%
    mutate(cl = relevel(as.factor(cl), ref = 1))

zoom_map_world <- world_site_sf$cl %>%
  st_buffer(dist = .2) %>%
    st_bbox()

main_map <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none") +
  coord_sf(
    #xlim = zoom_map_world[c("xmin", "xmax")],
    #ylim = zoom_map_world[c("ymin", "ymax")],
    expand = FALSE)

main_map4zoom <- ggplot(world_site_sf$world) +
  geom_sf(color = NA) +
  theme_void() +
  geom_sf(data = rivers10, colour = "lightblue", alpha = .4) +
  geom_sf(data = world_site_sf$cl %>%
    filter(!is.na(cl)),
  aes(fill = cl), pch = 21, color = "white", alpha = .3, size = 4) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "none")


zoom_map <- list(
  north_am = "USA",
  eng = "GBR",
  south_eu = c("FRA", "ESP", "BEL"),
  north_eu = c("FIN", "NOR", "SWE"),
  aus = "AUS"
)
zoom_map_basin_coord <- map(all_basin,
  ~world_site_sf$cl %>%
    filter(basin_name %in% .x) %>%
    st_bbox()
)

zoom_map_coord <- map(zoom_map,
  ~world_site_sf$cl %>%
    filter(country %in% .x) %>%
    st_bbox()
)

zoom_map_coord_df <- map_dfr(zoom_map_coord,
  ~setNames(as.numeric(.x), names(zoom_map_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  label = LETTERS[seq_len(length(zoom_map_coord))],
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
zoom_map_basin_coord_df <- map_dfr(zoom_map_basin_coord,
  ~setNames(as.numeric(.x), names(zoom_map_basin_coord[[1]])) %>%
    enframe(.),
  .id = "zoom") %>%
pivot_wider(names_from = "name", values_from = "value") %>%
mutate(
  LABEL = LETTERS[seq_len(length(zoom_map_basin_coord))],
  label = letters[seq_len(length(zoom_map_basin_coord))],
  width_basin = xmax - xmin,
  xmean = (xmax + xmin) / 2,
  ymean = (ymax + ymin) / 2
)
```

```{r}
main_map_rect <- main_map +
  geom_text(
    data = zoom_map_coord_df,
    aes(x = xmin, y = ymean, label = label),
    vjust = -.55, hjust = 0, size = 7) +
  theme(legend.position = "none")

```
```{r}
main_map_rect_basin <- main_map +
  geom_text(
    data = zoom_map_basin_coord_df,
    aes(x = xmin, y = ymax, label = label),
    vjust = -.6, hjust = 0, size = 5) +
  geom_rect(
    data = zoom_map_basin_coord_df,
    aes(
      xmin = xmin,
      xmax = xmax,
      ymin = ymin,
      ymax = ymax
      ),
    fill = NA,
    colour = "black",
    size = 0.6
  ) +
  theme(legend.position = "none")
```


```{r}
p_main_map_rect <- main_map_rect +
  draw_plot(leg_cl, x = 0, y = zoom_map_world["ymin"] + 5, vjust = 0)

save_plot(
  here("doc", "fig", "global_map.png"),
  main_map_rect,
  base_height = 3.71,
  base_asp = 2.618,
)

p_zoom_map <- map2(zoom_map_coord, zoom_map_coord_df$label,
  ~main_map4zoom +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 7, vjust = 1.2, hjust = -.2) +
    theme(
      legend.position = "none",
      panel.border = element_rect(size = 1, color = "black")
    )
)
p_zoom_map_basin <- map2(zoom_map_basin_coord, zoom_map_basin_coord_df$label,
  ~main_map4zoom +
    coord_sf(
      xlim = .x[c("xmin", "xmax")],
      ylim = .x[c("ymin", "ymax")],
      expand = FALSE) +
    annotate("text", x = .x["xmin"], y = .x["ymax"],
      label = .y, size = 7, vjust = 1.2, hjust = -.2) +
    theme(
      legend.position = "none",
      panel.border = element_rect(size = 1, color = "black")
    )
)
```
```{r, eval=FALSE}
p_zoom_map_basin[[2]]
```



```{r}
map_cl_cap <- "**Distribution of the clusters of biodiversity temporal trends** (without
cluster being NAs, see legend Fig. 2). Left panel: Spatial distribution of the
the clusters with insets of the (A) United States of America (USA), (B) Great Britain (GBR), (C) France (FR),
(D) Sweden (SWE) and (E) Australia (AUS). Right panel: cluster frequency distribution in the
three most represented Realms (in capital letters) and their most sampled
hydrographic basins. The number of sites are displayed between parenthesis.
"
```
```{r}
cluster_labels2 <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))
leg_cl_right <- get_legend(
  p_pca_cl_ell[[1]] +
    theme(legend.position = "right") +
    guides(col = guide_legend(
        ncol = 2, override.aes = list(size = 10)
        )) +
    scale_color_viridis(discrete = TRUE, name = "Cluster", labels = cluster_labels2)
)
```

```{r, eval = FALSE}
width_map_cl <- 12.0
dev.new(width = width_map_cl, height = width_map_cl*.42, units = "cm", res = 300, pointsize = 7)
```
```{r, eval = FALSE}
width_map_cl <- 4000
png(
  filename = here("paper", "fig_paper", "fig3.png"),
  width = width_map_cl, height =  width_map_cl*.42, pointsize = 5,
  units = "px", res = 300)
```

```{r map-cl3, fig.width = 4.75, fig.asp = .42, fig.show = "hide"}
layout <- "
AAAAAH
AAAAAH
BDEFGC
"
map_cl_fin <- main_map_rect + p_zoom_map$north_am + leg_cl_right +
  p_zoom_map$eng + p_zoom_map$south_eu + p_zoom_map$north_eu + p_zoom_map$aus + p_tot_tab +
  plot_layout(design = layout)
map_cl_fin
dev.off()
```
```{r, eval=FALSE}
dev.copy(x11,
  file = here("paper", "graphics", "fig3.png"),
  )

width_map_cl <- 4.75
dev.print(
  file =  here("paper", "graphics", "fig3.png"),
  ) # prints it
dev.off()
```

```{r map-cl-fin, fig.width = 4.75, fig.asp = .42}
#, fig.cap=map_cl_cap
knitr::include_graphics(here("paper", "fig_paper", "fig3_screenshot.png"))
```




```{r map-cl, fig.width = 4.75, fig.asp = 2, eval=FALSE} 
#, fig.cap=map_cl_cap
fig3_top <- plot_grid(main_map_rect_basin, p_tot_tab,
  align = "h", axis = "lr", rel_widths = c(1, .65))
ggsave(
  filename = "fig3_top.pdf",
  plot = fig3_top,
  path = here("paper", "fig_paper"),
  scale = 4.0,
  width = 88,
  height = 88 * .3,
  units = "mm",
  dpi = "print"
)
fig3_bottom_left <- plot_grid(plotlist = p_zoom_map_basin, nrow = 3, align = "v", axis = "b")
ggsave(
  filename = "fig3_bottom_left.pdf",
  plot = fig3_bottom_left,
  path = here("paper", "fig_paper"),
  scale = 4.0,
  width = 88,
  height = 88 * .7,
  units = "mm",
  dpi = "print"
)

fig3_bottom_left_1st_row <- plot_grid(
  plotlist = p_zoom_map_basin[1:3],
  nrow = 1,
  align = "h",
  axis = "l",
  rel_widths = zoom_map_basin_coord_df$width_basin[1:3]
)
fig3_bottom_left_2nd_row <- plot_grid(
  plot_grid(
    plotlist = p_zoom_map_basin[4:6],
    nrow = 1,
    align = "h",
    axis = "b"),
  NULL,
  align = "v",
  axis = "l",
  nrow = 1
)
fig3_bottom_left_3rd_row <- plot_grid(
  plot_grid(plotlist = p_zoom_map_basin[7:9], nrow = 1,
  align = "h", axis = "l"),
NULL,
  nrow = 1,
  rel_widths = c(zoom_map_basin_coord_df$width_basin[7:9], 1)

  )

fig3_bottom_left2 <- plot_grid(
  fig3_bottom_left_1st_row,
  fig3_bottom_left_2nd_row,
  fig3_bottom_left_3rd_row,
  nrow = 3)
ggsave(
  filename = "fig3_bottom_left2.pdf",
  plot = fig3_bottom_left2,
  path = here("paper", "fig_paper"),
  scale = 5.0,
  width = 44,
  height = 44 * .9,
  units = "mm",
  dpi = "print"
)


fig3_bottom <- plot_grid(
  fig3_bottom_left2, leg_cl_right,
  ncol = 2, align = "v", axis = "b",
  rel_widths = c(1, .2)
)

fig3 <- plot_grid(fig3_top, fig3_bottom, nrow = 2, rel_widths = c(1, 1))
fig3

```
```{r}
fig3_bottom_left3 <- ggdraw() +
  draw_plot(
    p_zoom_map_basin[[1]], x = 0, y = 1, width = .33, height = .33,
    vjust = 1, halign = 0, valign = 0) +
  draw_plot(
    p_zoom_map_basin[[2]], x = .33, y = 1, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[3]], x = .66, y = 1, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[4]], x = 0, y = .66, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[5]], x = .33, y = .66, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[6]], x = .66, y = .66, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[7]], x = 0, y = .33, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[8]], x = 0.33, y = .33, width = .33, height = .33,
    vjust = 1) +
  draw_plot(
    p_zoom_map_basin[[9]], x = 0.66, y = .33, width = .33, height = .33,
    vjust = 1)
```

```{r}
fig3 <- plot_grid(
  plot_grid(main_map_rect_basin, p_tot_tab,align = "h", axis = "lr", rel_widths = c(1, .65), nrow = 1),
  plot_grid(fig3_bottom_left3, leg_cl, NULL, nrow = 1, rel_widths = c(1, .1, .7)),
  ncol = 1
  )
ggsave(
  filename = "fig3.pdf",
  plot = fig3,
  path = here("paper", "fig_paper"),
  scale = 5.0,
  width = 88,
  height = 88 * .65,
  units = "mm",
  dpi = "print"
)
```



```{r, eval = FALSE}
layout <- "
AAAAAB
AAAAAB
CDELLL
FGHLLL
IJKLLL
"
map_cl_fin <- main_map_rect_basin + p_tot_tab +
  p_zoom_map_basin[[1]] +  p_zoom_map_basin[[2]] + p_zoom_map_basin[[3]] +
  p_zoom_map_basin[[4]] +  p_zoom_map_basin[[5]] + p_zoom_map_basin[[6]] +
  p_zoom_map_basin[[7]] +  p_zoom_map_basin[[8]] + p_zoom_map_basin[[9]] +
  leg_cl_right +
  plot_layout(design = layout)
map_cl_fin
ggsave(
  filename = "fig3.pdf",
  plot = map_cl_fin,
  path = here("paper", "fig_paper"),
  scale = 4.0,
  width = 88,
  height = 88 * .5,
  units = "mm",
  dpi = "print"
)
```

```{r, eval = FALSE}
layout <- "
ABC
DEF
GHI
"
map_cl_fin <-
  p_zoom_map_basin[[1]] +  p_zoom_map_basin[[2]] + p_zoom_map_basin[[3]] +
  p_zoom_map_basin[[4]] +  p_zoom_map_basin[[5]] + p_zoom_map_basin[[6]] +
  p_zoom_map_basin[[7]] +  p_zoom_map_basin[[8]] + p_zoom_map_basin[[9]] +
  plot_layout(design = layout)
map_cl_fin
ggsave(
  filename = "fig3_bottom_left2.pdf",
  plot = map_cl_fin,
  path = here("paper", "fig_paper"),
  scale = 4.0,
  width = 88,
  height = 88 * .5,
  units = "mm",
  dpi = "print"
)
```


```{r, eval=FALSE}
leg_cl_right <- get_legend(p_pca_cl_ell[[1]] + theme(legend.position = "right"))

top_right <- align_plots(p_zoom_map$north_am, leg_cl_right, align = 'v', axis = 't')

fig3_top <- plot_grid(main_map_rect,
  plot_grid(top_right[[1]], top_right[[2]], nrow = 2),
  ncol = 2, rel_widths = c(1, .5),
  align = "h", axis = "t"
)
fig3_bottom <- plot_grid(
p_zoom_map$eng, p_zoom_map$south_eu,
  p_zoom_map$north_eu,
   p_zoom_map$aus,p_tot_tab,
  ncol = 5, axis = "l", rel_widths = c(1,1,1,1, 1.3) 
)
fig3 <- plot_grid(fig3_top, fig3_bottom, nrow = 2, rel_heights = c(1, .5))
fig3
```

# Figure legends

- Figure 1: `r knitr::knit(text = fig1_cap)` 

- Figure 2: `r knitr::knit(text = pca_clust_cap)`

- Figure 3: `r knitr::knit(text = map_cl_cap)`


# Instructions from Science 

Creating your figures It is best to create your figures as vector-based files
such as those produced by Adobe Illustrator. Vector-based files will give us
maximum flexibility for sizing your figures properly without losing resolution,
as they can be altered in size while maintaining high print-quality resolution.
We cannot accept PowerPoint files or files that are not readable by Adobe
Photoshop, Macromedia Freehand, or Adobe Illustrator. To keep file sizes
reasonable, please save art at a resolution of 150 to 300 dots per inch (dpi)
for initial submission. A higher resolution applies for figures submitted at the
revision stage – see instructions for preparing a revised manuscript. Digital
color art should be submitted as CMYK (Cyan, Magenta, Yellow, Black) rather than
RGB (Red, Green, Blue).

Paper The width of figures, when printed, will usually be **5.5 cm** (2.25 inches or
1 column) or **12.0 cm** (4.75 inches or 2 columns). Bar graphs, simple line graphs,
and gels may be reduced to a smaller width. Symbols and lettering should be
large enough to be legible after reduction [a reduced size of about 7 points (2
mm) high, and not smaller than 5 points]. Avoid wide variation in type size
within a single figure. In laying out information in a figure, the objective is
to maximize the space given to presentation of the data. Avoid wasted white
space and clutter.

- The figure’s title should be at the beginning of the figure legend, not in the figure itself.

- Include the figure’s identifying number (e.g., “Fig. 1”) on the same manuscript page that includes the figure.

- Keys to symbols, if needed, should be kept as simple as possible and be
  positioned so they do not needlessly enlarge the figure. Details can be put
  into the captions.

- Use solid symbols for plotting data if possible (unless data overlap or there
  are multiple symbols). Size symbols so that they will be distinguishable when
  the figure is reduced (6 pt minimum). Line widths should be legible upon
  reduction (minimum of 0.5 pt at the final reduced size).

- Panels should be set close to each other, and common axis labels should not be
  repeated.

- Scales or axes should not extend beyond the range of the data plotted.

- Use scale bars in place of, or in addition to, magnifications. Do not use
  minor tick marks in scales or grid lines. Avoid using y-axis labels on the
  right that repeat those on the left.

- Color-mix and contrast considerations

- Avoid using red and green together. Color blind individuals will not be able
  read the figure.
 
- Please do not use colors that are close in hue to identify different parts of
  a figure.
 
- Avoid using grayscale.
 
- Use white type and scale bars over darker areas of images.
 
- Units should be metric and follow SI convention.

- Typefaces and labels
  - Please observe the following guidelines for labels on graphs and figures:
  - Use a sans-serif font whenever possible (we prefer Helvetica).
  - Simple solid or open symbols reduce well.
  - Label graphs on the ordinate and abscissa with the parameter or variable
    being measured, the units of measure in parentheses, and the scale. Scales
    with large or small numbers should be presented as powers of 10.
  - Avoid the use of light lines and screen shading. Instead, use
    black-and-white, hatched, and cross-hatched designs for emphasis.
  - Capitalize the first letter in a label only, not every word (and proper
    nouns, of course).
  - Units should be included in parentheses. Use SI notation. If there is room,
    write out variables – e.g., Pressure (MPa), Temperature (K).
  - Variables are always set in italics or as plain Greek letters (e.g., P, T,
    m). The rest of the text in the figure should be plain or bold text.
  - Type on top of color in a color figure should be in bold face. Avoid using
    color type.
  - When figures are assembled from multiple gels or micrographs, a line or
    space should indicate the border between two original images.
  - Use leading zeros on all decimals – e.g., 0.3, 0.55 – and only report
    significant digits.
  - Use capital letters for part labels in multipart figures – A, B, C, etc.
    These should be 9 pt and bold in the final figure. When possible, place part
    labels at the upper left-hand corner of each figure part; if a part is an
    image, set labels inside the perimeter so as not to waste space.
  - Avoid subpart labels within a figure part; instead, maintain the established
    sequence of part labels [e.g., use A, B, C, D, E instead of A, B, C(a),
    C(b), C©]. If use of subpart labels is unavoidable, use lowercase letters
    (a, b, c). Use numbers (1, 2, 3) only to represent a time sequence of
    images.
  - When reproducing images that include labels with illegible
    computer-generated type (e.g., units for scale bars), omit such labels and
    present the information in the legend instead.
  - Sequences may be reduced considerably, so the typeface in the original
    should be clear. There should be about 130 characters and spaces per line
    for a sequence occupying the full width of the printed page and about 84
    characters and spaces per line for a sequence occupying two columns.

Modification of figures Science does not allow certain electronic enhancements
or manipulations of micrographs, gels, or other digital images. Figures
assembled from multiple photographs or images, or non-concurrent portions of the
same image, must indicate the separate parts with lines between them. Linear
adjustment of contrast, brightness, or color must be applied to an entire image
or plate equally. Nonlinear adjustments must be specified in the figure legend.
Selective enhancement or alteration of one part of an image is not acceptable.
In addition, Science may ask authors of papers returned for revision to provide
additional documentation of their primary data.


