---
title: "Past and recent anthropogenic pressures drives rapid changes in riverine fish communities"
author: "Alain Danet, Xingli Giam, Julian D. Olden, Lise Comte"
date: ""
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    keep_tex: true
    spacing: double
    number_sections: false
  officedown::rdocx_document:
bibliography: "bibliography.bib"
csl: "nature.csl"
link-citations: true
toc: false
linestretch: 2.0
---


<!--always_allow_html: true-->
<!--header-includes:-->
  <!--- \usepackage[left]{lineno}-->
  <!--- \linenumbers-->
  <!--- \hypersetup{backref=true}-->

```{r setup, include=FALSE}
library(rmarkdown)
library(officedown)
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.path = "graphics/knitr-",
                      fig.retina = 1.618, # Control using dpi
                      fig.width = 6,  # generated images
                      fig.pos = "H",  # pdf mode
                      #fig.align = "center",
                      dpi = if (knitr::is_latex_output()) 72 else 300,
                      out.width = "100%",
                      dev = "svg",
                      dev.args = list(png = list(type = "cairo-png")),
                      optipng = "-o1 -quiet")

library(here)
source(here::here("R", "misc.R"))
source(here::here("R", "variable_shortcut.R"))
source(here::here("R", "basic_stat.R"))
source(here::here("R", "summary_distribution.R"))
source(here::here("R", "pca_methods.R"))
library(tidyverse)
library(magrittr)
library(cowplot)
library(targets)
library(kableExtra)
library(coda)


if (Sys.info()["login"] == "alain")
  file.copy(
    from = "~/Documents/post-these/references.bib",
    to = here("paper", "bibliography.bib")
  )
```




```{r load-targets, include=FALSE}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))

fnsite <- nrow(filtered_dataset_modelling$location)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))

tar_load(inla_no_drivers_effects)
tar_load(c(trends, trends80, trends90))
tar_load(c(pred_number, pred_inla, pred_data_explanation))

restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_abun", "perc_exo_sp")
names(restricted_dimension) <-
  get_var_replacement_vulgarisation()[restricted_dimension]

tar_load(c(gaussian_inla_rand, r2, clust_var, exo_resp_var))
```

```{r}
tar_load(c(gaussian_inla_std_effects, gaussian_inla_exo_std_effects))
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects)
ci80 <- tu %>%
  filter(ci_level == "level:0.80")
ci90 <- tu %>%
  filter(ci_level == "level:0.90")
ci95 <- tu %>%
  filter(ci_level == "level:0.95")
```
```{r global-trends}
abun_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_total_abundance)
  * log(10 + 1),
  r = 1)
abun_trends <- str_replace(abun_trends, "\\[ ", "\\[")
rich_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_chao_richness)
  * log(10 + 1),
  r = 1
)
hill_trends <- p_ci(
  trends$hillebrand_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
jac_trends <- p_ci(
  trends$jaccard_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
tu_trends <- p_ci(
  trends$turnover_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
ne_trends <- p_ci(
  trends$nestedness_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)

exo_trends <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends90 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends90[[.x]] * log(10 + 1), r = 4, p = FALSE)
)
names(exo_trends90) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends80 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends80[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends80) <- c("perc_exo_sp", "perc_exo_abun")
```

```{r}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))
tar_load(add_dataset_ref)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))
```



```{r}
nsitetot <- length(unique(site_desc_loc$siteid))
nmeas <- nrow(measurement)
nsp <- length(unique(measurement$species))
nop <- length(unique(measurement$op_id))
```

```{r}
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )

fnmeas <- format(nrow(filtered_dataset_modelling$measurement), big.mark = ",")
fnsp <- length(unique(filtered_dataset_modelling$measurement$species))
fnsite <- format(nrow(site_year), big.mark = ",")
fnop <- format(length(unique(filtered_dataset_modelling$measurement$op_id)),
  big.mark = ",")
#, big.mark=","

mspan <- median(site_year$span)
mcpl <- scales::percent(median(site_year$completeness))
mbl <- median(site_year$min)

eco <- table(filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  pull(ecoregion)
) / nrow(filtered_dataset_modelling$location)

per_eco <- scales::percent(table_to_vec(eco), accuracy = 1)

pays <- table(filtered_dataset_modelling$location$country
) / nrow(filtered_dataset_modelling$location)
pays_vec <- table_to_vec(pays)

per_pays <- scales::percent(sort(pays_vec, decreasing = TRUE), accuracy = 1)
per_s4pays <- scales::percent(sum(sort(pays_vec, decreasing = TRUE)[1:4]))
```

```{r}
tss <- map(setNames(c("min", "completeness", "span"), c("min", "completeness", "span")),
  ~summary_distribution(site_year[[.x]])[c("median", "1st_quart", "2nd_quart")]
)
tss$min <- paste0(tss$min["median"], " [", tss$min["1st_quart"], ",", tss$min["2nd_quart"], "]")
tss$completeness <- round(tss$completeness * 100)
tss$completeness <- paste0(tss$completeness["median"], "% [", tss$completeness["1st_quart"], "%,", tss$completeness["2nd_quart"], "%]")
tss$span <- paste0(tss$span["median"], " [", tss$span["1st_quart"], ",", tss$span["2nd_quart"], "]")
```

```{r}
restricted_dimension <- c("log_total_abundance", "log_chao_richness",
  "perc_exo_sp", "perc_exo_abun", "hillebrand_dis_scaled", "turnover_scaled")

source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")
names(pal_variable) <- get_var_replacement_vulgarisation()[restricted_dimension]
```


```{r, results="hide", eval=FALSE}
word_count <- wordcountaddin::text_stats(here("paper", "main_text.Rmd"))
readable <- wordcountaddin::readability(filename = here("paper", "main_text.Rmd"), quiet = TRUE)
```

```{r, results = "hide", eval=FALSE}
word_count
```

- Alain Danet: School of Biological Sciences, Illinois State University, Normal,
  Illinois, USA; Current address: School of Biosciences, University of Sheffield, Western Bank,
  S10 2TN, Sheffield, UK; https://orcid.org/0000-0002-1592-9483
- Xingli Giam: Department of Ecology and Evolutionary Biology, The University of
  Tennessee, Knoxville, Tennessee, USA; https://orcid.org/0000-0002-5239-9477
- Julian D. Olden: School of Aquatic and Fishery Sciences, University of
  Washington, Seattle, Washington, USA; https://orcid.org/0000-0003-2143-1187
- Lise Comte: School of Biological Sciences, Illinois State University, Normal,
  Illinois, USA; https://orcid.org/0000-0001-8030-0019

\pagebreak

# Abstract

Understanding how and why local communities change is a pressing task for
conservation, especially in freshwater systems. It remains challenging because
of the complexity of biodiversity changes, driven by the spatio-temporal
heterogeneity of human pressures. Using a compilation of riverine fish community
timeseries across three biogeographic realms, we assessed how past and recent
anthropogenic pressures drive community changes across both space and time. We
found evidence of rapid changes in community composition of 30% per decade
characterized by significant changes of the dominant species, together with a
13% increase in total abundance per decade, and a 7% increase in species
richness per decade. The spatial heterogeneity in these trends could be traced
back to the strength and timing of anthropogenic pressures and was mediated by
non-native species introductions. Specifically, we demonstrate that the negative
effects of anthropogenic pressures on species richness and total abundance were
compensated over time by the establishment of non-native species, a pattern
consistent with previously reported biotic homogenization at the global scale.
Overall, our study suggests that accounting for the complexity of community
changes and its drivers is a crucial step to reach global conservation goals.

# Introduction

Biological communities are undergoing dramatic reassembly in response to an
array of ever-growing human impacts[@zavaleta_ecosystem_2009]. Changes in
species composition and not necessarily systematic reductions in local-scale
species richness are becoming increasingly recognised[@dornelas_assemblage_2014;
@blowes_geography_2019], often resulting in ecosystem consequences manifested
across large spatial scales[@primack_biodiversity_2018; @moore_response_2017].
Repeated calls have been made for greater scientific clarity regarding how
heterogeneous rates of species losses and gains across space may shift
community structure over time[@mcgill_fifteen_2015]. Advancing this knowledge is
particularly relevant for freshwater ecosystems, where vertebrate populations
are declining substantially faster than those in terrestrial or marine
systems[@tickner_bending_2020].

Land use conversion is a persistent and pervasive threat to freshwater
ecosystems[@reid_emerging_2019] with striking repercussions for freshwater fish
biodiversity[@chen_threshold_2020; @comte_human_2021]. Dense urban and
cultivated areas are often associated with reduced species richness and
abundance[@newbold_global_2015; @gal_effect_2019], and shifts in local community
composition towards more tolerant and ubiquitous species that can cope with
degraded conditions[@tonella_importance_2018; @su_morphological_2020].
Non-native species can also play a disproportionate role in the reassembly of
communities over time[@leprieur_fish_2008; @moore_response_2017;
@bernery_freshwater_2022; @villeger_homogenization_2011], and have dramatic
effects on native species when they become invasive[@gallardo_global_2016],
including the widespread homogenization of faunas[@olden_homogocene_2018]. Hubs
of human activities such as human settlements, transport and trade are also
responsible for major habitat alterations and increased accessibility, resulting
in more frequent non-native introduction events and opportunities for
spread[@chapman_invasion_2020; @lockwood_role_2005; @gallardo_importance_2015].
Human activities may therefore have opposing effects on local diversity by
decreasing the number and abundance of native species, while concurrently
promoting the establishment and spread of non-native species that can increase
community total abundance and species richness[@mcgill_fifteen_2015;
@primack_biodiversity_2018]. Understanding community changes therefore requires
going beyond analyses of changes in the number of species or individuals by
considering concomitant changes in species identity[@dornelas_assemblage_2014; @blowes_geography_2019; @scott_native_2001;
@hillebrand_biodiversity_2018].

Community composition and trajectories are influenced by past anthropogenic
pressures that can generate transient ecological dynamics and long-lasting
biotic ‘legacies’[@jackson_balancing_2010]. Given the high spatio-temporal
heterogeneity of anthropogenic pressures[@venter_sixteen_2016], ignoring the
long-term antecedent effects of historical pressures and their recent changes
can greatly impede our understanding of the drivers of community change.
Additionally, habitat structure and connectivity can enhance or dampen community
responses to anthropogenic pressures by mediating dispersal among
habitats[@altermatt_river_2013]. Accounting for past and recent anthropogenic
pressures as well as spatial distribution of habitats may therefore improve our
understanding of community changes.

This study investigates how, and the potential mechanisms of why riverine fish
communities change spatially and temporally from local to continental extents.
To do so, we leveraged a compilation of 4,476 riverine fish community
time series[@comte_rivfishtime_2021] that had been repeatedly sampled over the last three decades in
various river basins across three biogeographic realms. We quantified temporal
changes in total abundance, species richness, and community composition across
local communities, including in the share of non-native species. We next
characterised the typology of community temporal trends by examining the
covariation among different community metrics, and trajectories of community
change across spatial scales. We finally assessed how fish community changes
could be traced back to the spatio-temporal changes in anthropogenic pressures
and stream longitudinal position. Outcomes of this study further our
understanding of the complexity of local community changes by addressing the
effects of global change and advancing new knowledge that can inform actions
seeking to curb the current freshwater biodiversity crisis.



# Results


```{r}
extract_pred <- function (x = NULL, resp = NULL, val_to_extract = NULL) {

  ci_low <- x[[resp]]$quant0.025[val_to_extract]
  ci_high <- x[[resp]]$quant0.975[val_to_extract]

  # Does the ci at 95 overlap?
  ci_overlap <- ci_low[val_to_extract[1]] > ci_high[val_to_extract[2]] |
    ci_high[val_to_extract[1]] < ci_low[val_to_extract[2]]

  list(
    val = x[[resp]]$mean[val_to_extract],
    ci_overlap = !ci_overlap
  )
}
#' Get percentage of difference, the first value being the reference
get_ratio <- function(x, r = 1) {
  #reduce(x, `/`)
  out <- round((x[2] - x[1]) / x[1] * 100, r)
  paste0(out, "%")
}
```

```{r}
tar_load(pred_number)
```

```{r}
pred_hft93_t0 <- map(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0)),
  ~extract_pred(
    x = pred_number$pred_hft93_t0,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t0[[.x]]$val), r = 0)
)
other_hft93_int_max <- map_chr(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0))[
    !names(pred_number$pred_hft93_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft9309_t0_inc <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_inc[[.x]]$val), r = 0)
)

other_hft9309_0_inc_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_inc[[.x]]$val, r = 0)
  )

pred_hft9309_t0_dec <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "div/2")
  )
)

abun_rich_hft9309_0_dec_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_dec[[.x]]$val), r = 0)
)

other_hft9309_0_dec_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_dec[[.x]]$val, r = 0)
  )
```

```{r}
pred_rivstr_t0 <- map(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0)),
  ~extract_pred(
    x = pred_number$pred_rivstr_t0,
    resp = .x,
    val_to_extract = c("min", "max")
  )
)

abun_rich_riv_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_rivstr_t0[[.x]]$val), r = 0)
)
other_riv_int_max <- map_chr(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0))[
    !names(pred_number$pred_rivstr_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_rivstr_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft93_t10 <- map(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10)),
  ~extract_pred(
    x = pred_number$pred_hft93_t10,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t10[[.x]]$val), r = 0)
)
other_hft93_int_max_t10 <- map_chr(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10))[
    !names(pred_number$pred_hft93_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t10[[.x]]$val, r = 0)
  )
```

```{r}
pred_hft9309_t10 <- map(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t10,
    resp = .x,
    val_to_extract = c("div/2", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t10[[.x]]$val), r = 0)
)
other_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10))[
    !names(pred_number$pred_hft9309_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t10[[.x]]$val, r = 0)
  )
```


```{r}
sphft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "hft_ix_c93")
sphft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c93")


sphft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "hft_ix_c93")
sphft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c93")

sphft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", r = 3)
sphft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", r = 3)
sphft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90", term = "hft_ix_c9309_log2_ratio", r = 2)
sphft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", )
```
```{r, results = "hide"}
r2turn <- r2[r2$response == "turnover_scaled", ]$r2_mvp_cond95hpdci
r2rich <- r2[r2$response == "log_chao_richness", ]$r2_mvp_cond95hpdci
r2 %>%
  filter(response %in% restricted_dimension) %>%
  arrange(desc(r2_mvp_cond_mean))
```

```{r}
bold_pattern <- "(\\*\\*(.*)\\*\\*)"

```


```{r}
trends_cap <- paste0("**Distribution of community temporal trends across sites**: (a) total
  abundance, (b) species richness, (c) proportion of non-native abundance, (d)
  proportion of non-native richness, (e) Simpson temporal dissimilarity, and (f)
  Jaccard turnover. Temporal trends per decade were estimated from a
  hierarchical Bayesian model including time as sole predictor (See Methods). The
  histograms show the Best Linear Unbiased Predictor (BLUP) estimated at each
  site and the dots below the histograms represent the average of the posterior distribution with
  bars depicting the Bayesian credible intervals at 95\\%.
  The dashed lines denote no temporal trend.", " N = ", fnop, " sampling
  events across ", fnsite, " sites.") %>%
  str_replace_all("\\s+", " ")
if (knitr::is_latex_output()){
 trends_cap <- str_replace(trends_cap, bold_pattern, "\\\\textbf{\\2}")
}
```
```{r trends, fig.cap=trends_cap, fig.asp = 1.5, out.width = "100%"}
knitr::include_graphics(here("paper", "fig_paper", "p_trends.pdf"))
```

```{r}
tm <- map(setNames(c("min", "completeness", "span"), c("min", "completeness", "span")),
  ~summary_distribution(site_year[[.x]])[c("median", "min", "max")]
)
#tm$min <- paste0(tm$min["median"], " [", tm$min["min"], ",", tm$min["max"], "]")
#tm$completeness <- round(tm$completeness * 100)
#tm$completeness <- paste0(tm$completeness["median"], "% [", tss$completeness["1st_quart"], "%,", tss$completeness["2nd_quart"], "%]")
#tm$span <- paste0(tss$span["median"], " [", tss$span["1st_quart"], ",", tss$span["2nd_quart"], "]")
```

## Community temporal trends

Riverine fish communities have demonstrated remarkable change over recent
decades (Fig. 1; range first survey year: `r tm$min["min"]` - `r tm$min["max"]`
[median = `r tm$min["median"]`]; time span: `r tm$span["min"]` - `r tm$span["max"]`
years [median = `r tm$span["median"]`]; see Fig. S1 for more details on the time
series). By estimating temporal trends with a hierarchical Bayesian modeling
approach that accounts for spatial variation at both hydrographic river basin
and site levels (see Methods for a detailed description of the model), we found
that communities have increased in both total community abundance and species
richness, but decreased in the proportional abundance of non-native species in
recent decades. We found strong evidence for an average increase in total
community abundance (average Credible Interval 95%: `r abun_trends` per decade,
Fig. 1a) and in species richness (CI 95%:
`r rich_trends` per decade, Fig. 1b) over time. By contrast, we found an average decline in the proportion
of non-native species abundance (moderate evidence, CI 90%:
`r exo_trends90[["perc_exo_abun"]]` per decade, Fig. 1c), and no evidence for a temporal trend in the proportion of non-native
species richness (CI 80%:
`r exo_trends80[["perc_exo_sp"]]` per decade, Fig. 1d).

Changes in abundance and species richness were accompanied by rapid compositional
reorganisation (strong evidence), with an average decline in community similarity of about 30% per
decade when considering either species abundances (Simpson dissimilarity, CI
95%: `r hill_trends` per decade, hereafter “temporal dissimilarity”, Fig. 1e) or
occurrences (Jaccard dissimilarity, CI 95%: `r jac_trends` per decade, Fig.
S2a). The consistency in the Simpson and Jaccard dissimilarity metrics indicated
that changes in temporal dissimilarity resulted from changes in the identity of
the dominant rather than of the rare species. The partitioning of the Jaccard
dissimilarity index into turnover, describing composition changes arising from
species replacement, and nestedness, describing changes arising from species
gains or losses from a common species pool, further showed a comparable increase
over time (CI 95%: `r tu_trends` and `r ne_trends` per decade respectively; Fig.
1f and S2b). This suggests that changes in community composition were driven by
species replacement in the community, in addition to species losses or gains.

Beyond overall temporal trends, considerable spatial heterogeneity exists across
sites (Fig. 1) even within the same river basin (Supplementary Map S1). For
example, the communities located along the Thames river displayed a variety of
temporal trends
including decreases in richness, decreases in abundance or high turnover
(Supplementary Map S1). The (random) slope of time in our hierarchical model
varied much more (i.e., up to more than twice as much) across sites within river
basins than across different basins for all community metrics (Table S1). This
indicated that relatively finer-scale environmental variation within river
basins has a greater effect on temporal trends than do larger-scale
environmental or biogeographical variation across river basins.


## Typology of community temporal trends and their covariation

```{r}
tar_load(site_cl_rm)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters), accuracy = 1)
fnsite_brut <- nrow(filtered_dataset_modelling$location)
na_cluster <- paste0("(N = ",
  fnsite_brut - sum(nb_clusters), ", ", round((fnsite_brut - sum(nb_clusters)) / fnsite_brut * 100),"\\%)"
)
tar_load(site_no_drivers_inla_tot)
pca_data <- site_no_drivers_inla_tot[,
    colnames(site_no_drivers_inla_tot) %in% restricted_dimension &
    !colnames(site_no_drivers_inla_tot) %in% c("perc_exo_sp", "perc_exo_abun")]
pca_clust <- compute_rotated_pca(pca_data, naxis = 4)
var_exp <- round(pca_clust$normal$eig / sum(pca_clust$normal$eig) * 100)
names(var_exp) <- colnames(pca_clust$normal$c1)
```


```{r}
pca_clust_cap <- paste0("**Covariation among the temporal trends in community metrics and
  characterization of community trajectories**. (a, b) PCA biplot of the community
  temporal trends and their cluster assignment (upper panel). (c) boxplots
  displaying the distribution of the temporal trends by cluster. (d) Cluster
  frequencies across the three main realms. The sites are coloured according to
  their cluster assignment. The ellipses in (a-b) display the 95\\% intervals around
  the clusters assuming a Student’s t distribution. The clusters were named
  according to their main characteristics. Sites not assigned to a cluster because
  of affiliation uncertainty ", na_cluster, " are displayed in Fig. S3.", " N = ",
  fnop, " sampling events across ", fnsite, " sites.") %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 pca_clust_cap <- str_replace(pca_clust_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r eff, fig.cap = pca_clust_cap, fig.asp = .9, out.width = "80%"}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "clust_figure.pdf"))
```

There was a moderate level of association among the different community trajectory
metrics; the first two principal components axes explained `r sum(var_exp[1:2])`%
of the total variability among fish communities (Fig. 2). Temporal trends in
community composition (i.e. temporal dissimilarity and turnover) were positively
associated as were temporal trends in total abundance and species richness;
however these two sets of trajectories appeared orthogonal to each other (Fig.
2a). Using a k-mean trimmed clustering method (see Methods), we further detected six distinct
types of community trajectories (Fig. 2c). The largest cluster was
characterised by moderate changes along all biodiversity dimensions: medium
temporal increases in total abundance and species richness, temporal
dissimilarity and turnover (‘medium change’; `r per_cluster[1]` of the sites).
The second cluster was associated with communities showing strong turnover but
moderate increases in total abundance, species richness and temporal
dissimilarity (‘high turnover’; `r per_cluster[2]` of the sites). The third,
fourth and fifth clusters were characterised by temporal community changes along
a single dimension: a strong increase in species richness (‘increase in species
richness’; `r per_cluster[3]` of the sites), a strong decline in total abundance
(‘decrease in total abundance’; `r per_cluster[4]` of the sites) or a strong
decline in species richness (‘decrease in species richness’; `r per_cluster[5]`
of the sites), respectively. The last and smallest cluster was associated with
communities that remained relatively stable over time (‘low change’;
`r per_cluster[6]` of the sites). The relative frequency of the different
community trajectories was similar across the three main biogeographic realms
(Fig. 2d).


## Drivers of community temporal trends

```{r}
hft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")

hft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 2)
hft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", )
hft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")
hft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")

hft2abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")

rivhftabun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftrich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 4)
rivhftexor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftexoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhfthill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftturn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)

rivhft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 4)
rivhft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")
rivhft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")

riv1abun <- get_effect_ci(
  resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", )
riv1hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")
riv1turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")

```

We detected complex synergies between the legacy of past anthropogenic pressures
and the effects of recent anthropogenic human pressures on community temporal
trends mediated by non-native species and abiotic conditions, when we
explored additional predictors associated with the human
footprint index and stream longitudinal position (Fig. 3a, see model predictions
in Fig. S4). Specifically, we found strong evidence that a higher degree of past
anthropogenic pressures
(i.e. human footprint index of 1993 corresponding to the beginning of the time
series) was associated with faster increases in total abundance and species
richness (resp.
CI 95%:$\beta\prime=$ `r hft93abun` in blue and `r hft93rich` in green, Fig.
3a). We also uncovered evidence for an interaction with the
stream longitudinal position (i.e. PCA axis with high values associated with a
higher Strahler order, a higher distance from source, and a higher annual
discharge), such as the legacy effects of past anthropogenic pressures on total
abundance (strong evidence) and species richness (weak evidence) were buffered
in more downstream areas (resp. CI 95%:$\beta\prime =$ `r rivhftabun` and CI
80%:$\beta\prime =$ `r rivhftrich`, Fig. 3a). Similar results were obtained using raw
or coverage-based species richness (See methods, Fig. S5).

Past anthropogenic pressures were also associated with changes in community
composition. We found evidence (albeit weak) that a higher degree of past
anthropogenic pressures was associated with an increase in the proportion of
non-native richness over time (CI 80%:$\beta\prime =$ `r hft93exor`, yellow,
Fig. 3a), and that this effect was enhanced in more downstream areas (CI
90%:$\beta\prime =$ `r rivhftexor`, Fig. 3a). Although we found no overall
associations between past anthropogenic pressures and temporal trends in
non-native species abundance (CI 80%:$\beta\prime =$ `r hft93exoa` in orange,
Fig. 3a), we found moderate evidence that a higher degree of past anthropogenic
pressures resulted in a higher rate of increase in non-native species abundance
in the most downstream areas (CI 90%: 0.033 [0.003,0.064], Fig. 3a). We also
found that a higher degree of past anthropogenic pressures were associated with
faster rates of increases in temporal dissimilarity and turnover (resp. CI
95%:$\beta\prime =$ `r hft93hill` in red and `r hft93turn` in purple, Fig. 3a),
irrespective of the stream longitudinal position
(resp. CI 80%:$\beta\prime =$ `r rivhfthill` and `r rivhftturn`, Fig. 3a), a
result consistent between Jaccard and Simpson-based dissimilarity (Fig. S5).

Recent increases in anthropogenic pressures (i.e. ratio of the human footprint
index between 2009 and 1993) were found to have a context-specific effect on
total abundance and species richness as well as to hasten community
reorganisation through increases in the share of non-native species and faster
rates of temporal dissimilarity and turnover (Fig. 3a, see model prediction in
Fig. S4). More specifically, we found strong evidence of an antagonistic effect
between past and recent anthropogenic pressures on total abundance (CI 95%:$\beta\prime
=$ `r hft2abun`, Fig. 3a), such as the rate of increase observed across
the historically most degraded sites was lower when these sites experienced a
recent increase in anthropogenic pressures, although recent anthropogenic
pressures per se had no effect on the temporal trends in total abundance (CI
80%:$\beta\prime =$ `r hft09abun`, Fig. 3a). Similarly, recent changes in
anthropogenic pressures did not have an overall effect on the temporal trends in
species richness (CI 80%:$\beta\prime =$ `r hft09rich`, Fig. 3a) but
we found moderate evidence for a positive interaction with the stream longitudinal
position (CI 90%:$\beta\prime =$ `r rivhft09rich`, Fig. 3a), indicating that
recent increases in anthropogenic pressures were associated with faster
increases in species richness over time in more downstream areas.

Recent increases in anthropogenic pressures were also associated with more
rapid increases in the proportion of non-native species abundance in more
downstream areas (CI 90%:$\beta\prime =$ `r rivhft09exoa`, Fig. 3a), but
recent changes in anthropogenic pressures had no overall effect (CI
80%:$\beta\prime =$ `r hft09abun`, Fig. 3a). When considering the share of non-native species
richness, we found moderate evidence that a recent increase in anthropogenic
pressures was associated with an increase in the proportion of non-native
species (CI 90%:$\beta\prime =$ `r hft09exor`, Fig. 3a). This effect was particularly
pronounced in the historically most degraded sites and in the most downstream
areas (resp. CI 90%:$\beta\prime =$
`r hft2exor` and `r rivhft09exor`, Fig. 3a). In
addition, we found strong evidence that a recent increase in anthropogenic
pressures resulted in stronger temporal dissimilarity and turnover (resp. CI 95%
$\beta\prime =$ `r hft09hill` and `r hft09turn`, Fig. 3a). This effect
was hastened in the most historically degraded sites (resp. CI 95%:$\beta\prime =$
`r hft2hill` and `r hft2turn`, Fig. 3a), but not affected by the
stream longitudinal position (resp. CI 80%:$\beta\prime =$
`r rivhft09hill` and `r rivhft09turn`). By
contrast, our results indicate that higher recent anthropogenic pressures in the
historically most degraded sites was associated with lower rates of increase in
total abundance and species richness, but a higher rate of increase in
non-native richness and higher rates of temporal dissimilarity and turnover (see
model predictions in Fig. S4).

```{r}
fig1_cap <- paste0("**Drivers of temporal changes and spatial
  variation in fish community metrics**. Effects of anthropogenic pressures and stream longitudinal position on (a)
  temporal changes and (b) spatial variation in fish community metrics. Community
  metrics include total abundance, species richness, proportional abundance and
  richness of non-native species, Simpson temporal dissimilarity, and Jaccard
  turnover. Points depict the average of the posterior distributions. Large,
  medium and thin bars depict the Bayesian credible intervals at 80, 90 and
  95\\%, respectively. Please note the broken abscissa scale in (a). N = ",
  fnop," sampling events across ", fnsite," sites.") %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 fig1_cap <- str_replace(fig1_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r fig1, fig.cap = fig1_cap, fig.asp = 2.5, out.width = "100%"}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "p_effect.pdf"))
```



## Drivers of community variation across space

```{r}
# Remove minus for the text
abun_rich_hft93_int_max <- setNames(str_replace(abun_rich_hft93_int_max, "-", ""),
names(abun_rich_hft93_int_max)
)
abun_rich_hft9309_0_inc_by2 <- setNames(str_replace(abun_rich_hft9309_0_inc_by2, "-", ""),
names(abun_rich_hft9309_0_inc_by2)
)



```


 Spatial variation in community structure was strongly associated with past and
 recent anthropogenic pressures and with stream longitudinal position
 (i.e. single model effects independent of time, Fig. 3b). We found that a
 higher degree of past anthropogenic pressures was associated with lower total
 abundance (strong evidence; Fig. 3b, blue), with the most ‘degraded’ sites
 (i.e. with a human footprint index =
`r round(pred_data_explanation$hft_ix_c93["max"],1)`) displaying a total abundance
 `r abun_rich_hft93_int_max["log_total_abundance"]` lower than the most ‘intact’ sites (i.e. with a human footprint index =
`r round(pred_data_explanation$hft_ix_c93["intact"],1)`). By
 contrast, a higher degree of past anthropogenic pressures was associated with
 higher species richness (strong evidence; Fig. 3b, green), with the most
 degraded sites displaying `r abun_rich_hft93_int_max["log_chao_richness"]` more species than the most intact sites.

Recent increases in anthropogenic pressures were strongly associated with lower
total abundance and species richness (Fig. 3b). More specifically, sites that
experienced a two-fold increase in recent anthropogenic pressures had `r abun_rich_hft9309_0_inc_by2["log_total_abundance"]`
 lower
total abundance and `r abun_rich_hft9309_0_inc_by2["log_chao_richness"]` lower species richness than sites that had not undergone
such pressures. Stream longitudinal position was strongly associated with
species richness - the most downstream sites displayed three times more species
than the most upstream sites (Fig. 3b).

Anthropogenic pressures and stream longitudinal position were associated with
spatial variation in the average proportion of non-native fish species.
Sites that had experienced a higher degree of past and recent anthropogenic
pressures had a higher proportion of non-native individuals and species (strong
evidence; Fig. 3b, orange and yellow). The proportion of non-native individuals
was three times higher in the most degraded sites than the most intact sites (`r scales::percent(pred_hft93_t0$perc_exo_abun$val["max"])` versus
`r scales::percent(pred_hft93_t0$perc_exo_abun$val["intact"])`), and a proportion of non-native species in the former was more than
double that of the latter sites (`r scales::percent(pred_hft93_t0$perc_exo_sp$val["max"])` versus
`r scales::percent(pred_hft93_t0$perc_exo_sp$val["intact"])`). Further, a two-fold increase in
recent anthropogenic pressure increased the proportion of non-native individuals
and species by `r other_hft9309_0_inc_by2["perc_exo_abun"]` and
`r other_hft9309_0_inc_by2["perc_exo_sp"]`, respectively. The downstream-most sites had `r other_riv_int_max["perc_exo_abun"]`
higher proportional non-native abundance and `r other_riv_int_max["perc_exo_sp"]` higher proportional non-native
richness than the upstream-most sites (Fig. 3b). Finally, a larger
share of the variance in the community metrics was explained by site and basin
identity rather than by the fixed effects alone (R² conditional varying from
0.15 for turnover to 0.80 for species richness vs. R² marginal varying from 0.02
for species richness to 0.07 for community turnover; Table 1).


```{r}
tar_load(c(r2, gaussian_inla_rand))
tar_load(gaussian_inla_rand_no_drivers)

ti <- r2 %>%
  filter(response %in% c(restricted_dimension, exo_resp_var))
tab_rand <- gaussian_inla_rand %>%
  filter(
    term %in% paste0("Precision for ", c("main_bas1", "siteid1")),
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
select(-ci_level) %>%
mutate(across(c(mean, low, high), ~round(., 3))) %>%
mutate(
  response = get_var_replacement_vulgarisation()[response],
  term = str_remove(term, "Precision for the |Precision for |"),
  term = replacement_random_term_table()[term],
  ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
arrange(response, desc(term)) %>%
select(
  `Response variable` = response,
  `Spatial scale` = term,
  `Temporal trends s.d.` = ci
) %>%
  left_join(
    ti %>%
      mutate(response = get_var_replacement_vulgarisation()[response]) %>%
      select(
        `Response variable` = response,
        `Marg. $R^2$` = r2_mvp_marg95hpdci,
        `Cond. $R^2$` = r2_mvp_cond95hpdci
        ),
      by = "Response variable"
      ) %>%
select(`Response variable`, `Spatial scale`, `Marg. $R^2$`, `Cond. $R^2$`, `Temporal trends s.d.`) %>%
mutate(`Response variable` = factor(`Response variable`, levels = names(pal_variable))) %>%
arrange(`Response variable`)

tab_rand_cap <- "**Marginal and Conditional $R^2$ of the hierarchical Bayesian model for each
community metric**. The models included several predictors (fixed effects
illustrated in Fig. 3) and accounted for spatial variations at the
hydrographic river basin and site levels (random effects). Marginal $R^2$
accounts for fixed effects and conditional $R^2$ accounts for both fixed and random
effects. Mean $R^2$ [95\\% CI]: Credible Interval computed using the Highest
Posterior Density method." %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 tab_rand_cap <- str_replace(tab_rand_cap, bold_pattern, "\\\\textbf{\\2}")
}
```


```{r, eval=knitr::is_latex_output()}
tab_rand %>%
  filter(`Spatial scale` == "Site") %>%
  select(1, 3, 4) %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap, escape = F) %>%
#  add_header_above(c(" " = 2, "Temporal trends s.d." = 2)) %>%
#  collapse_rows(columns = c(1, 2), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```

```{r, eval=!knitr::is_latex_output(), fig.cap = tab_rand_cap, fig.asp = .65, out.width = "50%"}
knitr::include_graphics(here("paper", "fig_paper", "table.png"))
```

# Discussion

Recent decades have witnessed substantial shifts in riverine fish communities
characterised by marked increases in species richness and total abundance over
time, accompanied by a strong pattern of species replacement. We found that fish
species richness has increased at a rate of ~7% per decade although no net
change in species richness had been previously reported in terrestrial and in
marine systems[@vellend_global_2013; @dornelas_assemblage_2014;
@blowes_geography_2019]. We also estimated an overall increase in total fish
abundance of ~13% per decade estimated in this study, which matches the increase
of 11% per decade reported for freshwater
insects[@van_klink_meta-analysis_2020]. This is also consistent with several
regional assessments of freshwater population trends in the Palearctic, such as
the reported increase in freshwater insect occupancy documented in the UK or the
increase in freshwater animal LPI (Living Planet Index) in the Netherlands since
the 1990s[@outhwaite_complex_2020; @van_strien_modest_2016]. However, this
finding contrasts with dramatic LPI declines reported at the global scale for
freshwater species and particularly fish megafauna, as well as with other
regional assessments of fish assemblages[@he_global_2019; @reid_emerging_2019].
We further found a faster average temporal trend in Jaccard dissimilarity (31%
vs. 10% per decade) but a slower average turnover (17% vs. 28% per decade) than
previously reported across a diversity of marine, freshwater and terrestrial
assemblages[@dornelas_assemblage_2014; @blowes_geography_2019]. This indicates
that riverine fish communities are experiencing strong richness and
compositional changes in recent decades.

These recent biotic changes are linked to complex spatio-temporal processes
involving past and recent human impact on the environment and their interaction
with stream network position. Higher past anthropogenic pressures were
associated with faster rates of species richness and total abundance increases
over time, suggesting a recovery from the legacy of past disturbances. Previous
studies suggested that the adoption of numerous legislations targeting
improvements in water quality in the EU and the USA since the 1970s, as well as
a decrease in the negative effects of agriculture could be partly responsible
for those increases despite the surrounding habitat
changes[@langford_long-term_2009; @van_klink_meta-analysis_2020;
@outhwaite_agriculture_2022]. The fact
that most of the study sites (92%) were already highly degraded at the beginning
of the study period, i.e. they had a human footprint index > 4 in 1993[@williams_change_2020], could
lend support to the recovery hypothesis.

A higher degree of past anthropogenic pressures was also associated with a
higher share of non-native species; this effect increasing in downstream sites.
This indicates that the introduction and establishment of non-native species
contributed most substantively to the fish community changes through time in the
sites that suffered the greatest past (pre-1993) degradation, and particularly
the most downstream ones. Specifically, the increase in local species richness
over time could result from introduction of non-native species from ongoing
spatial homogenization[@villeger_homogenization_2011], a pattern well supported
by metacommunity models[@mouquet_community_2003] and already documented across
river basins in the Nearctic and Palearctic
realms[@villeger_homogenization_2011]. This is in line with findings that higher
densities of human population, urban areas and roads – all included in the human
footprint index — can promote non-native species richness by increasing the
number and frequency of introduction events[@anas_drivers_2021;
@leprieur_fish_2008; @bernery_freshwater_2022]. Anthropogenic pressures can also
alter the instream habitat to be more conducive for non-native species that are
often ubiquitous and habitat generalists[@tonella_importance_2018;
@su_morphological_2020], giving them a competitive advantage over native species
that are less suited to the new conditions[@bernery_freshwater_2022;
@byers_impact_2002; @olden_life-history_2006; @haubrock_two_2021]. A higher
degree of past anthropogenic pressures was also associated with faster rates of
species replacement and shift in species dominance over time. This suggests that
the legacy effects of past habitat degradation are characterised by shifts
towards species that are better adapted to degraded
environments[@chen_threshold_2020], to which non-native species contribute
disproportionately[@dornelas_assemblage_2014; @blowes_geography_2019].

This study uncovered important interaction effects between past and recent human
pressures in driving the rate of change in several community metrics,
highlighting the importance of considering both the degree and timing of
anthropogenic pressures. For example, as discussed above, communities that
experienced greater past degradation had actually seen an increase in richness
in recent years, mediated in part by the establishment of non-native species.
However, high rates of recent human impact in these sites were linked to an
increased share of non-native species while reducing total richness,
demonstrating that any recovery in the native fish community in previously
degraded sites would be severely compromised if human impacts were allowed to
continue. Conversely, these findings clearly illustrate opportunities to reduce
human impact in previously degraded lands to benefit freshwater biodiversity[@tickner_bending_2020].
In turn, the fact that non-native species were more abundant in both
historically or recently degraded sites but that no direct association was
uncovered in terms of non-native temporal trends can be explained, at least in
part, by commonly reported time lags between the first recorded introductions
and the establishment of self-sustaining populations, which includes time for
biological acceptance and local adaptation[@bernery_freshwater_2022]. Our results
demonstrate that recent habitat degradation can result in simultaneous negative
and positive effects on native and non-native species, respectively[@mcgill_fifteen_2015;
@dornelas_balance_2019], and
highlights the conservation challenges associated with the identification and
management of biodiversity changes in the context of transient community
dynamics[@jackson_balancing_2010]. All together, our results show that past and
recent anthropogenic pressures did and are persisting to drive rapid community
changes across space and time, driven by non-native species and important
species replacement, which contrasts with a hypothesis of a recovery
in freshwater systems[@langford_long-term_2009; @van_klink_meta-analysis_2020;
@outhwaite_agriculture_2022].

Longitudinal position along the river network was found to mediate temporal
biodiversity trends, with the most downstream sites experiencing faster rates of
community change over time. This finding may be explained by the higher
connectivity of larger rivers with other tributaries, which in turn gives more
opportunity for local colonization[@altermatt_river_2013] and the establishment
of metacommunity dynamics[@tonkin_role_2018]. Likewise, it is not entirely
surprising that community changes were found to be more heterogeneous at the
local scale than at the basin or realm scales and that the spatial structure of
the model explained much more of the variance in the community metrics than the
fixed effects. This likely reflects the characteristics of riverine habitats,
and especially their dendritic structure and isolation within drainage basins,
which determine environmental filtering and dispersal
opportunities[@dias_global_2014; @olden_conservation_2010]. In addition, we
focused chiefly on community reorganisation arising from land use pressures,
therefore disregarding the potential interactions with other global drivers of
change such as climate change and more localized threats such as water
withdrawals[@comte_climate_2021; @outhwaite_agriculture_2022].

Our results further confirm that temporal changes in species composition can be
decoupled from changes in species richness in freshwater systems. Previously,
this has been shown in many marine and terrestrial systems, but across a smaller
set of freshwater assemblages[@dornelas_assemblage_2014;
@blowes_geography_2019]. Various community trajectories can be linked to a
complex mosaic of ecological drivers such as the degree and timing of
anthropogenic pressures and position of the sites within watersheds. It follows
that the similar frequencies in community trajectories detected across realms
together with the restricted number of sites displaying a low degree of change
likely reflects the spatially and temporally heterogeneous patterns in human
pressures. We recognize that recent increases in anthropogenic pressures are
most prevalent in tropical biodiversity hotspots[@venter_global_2016], while our
study has a spatial coverage limited to historically industrialised countries
and in mostly temperate biomes. Consequently, species richness and abundance
increases as well as the decoupling of compositional changes from richness
changes may not be universal phenomena, and more heterogeneous patterns of
biotic change may manifest at the global scale once we consider tropical fish
communities. Nonetheless, our analyses were conducted on the best available
temporal riverine fish dataset at this time, and they provide evidence linking
the multidimensionality of community changes past and present environmental
challenges as well as habitat context. Our study also provides a framework for
future research that merge multiple scales of both time and
space[@mcgill_fifteen_2015; @primack_biodiversity_2018], as more tropical data
are collected and become available.

In conclusion, our study uncovered complex but consistent effects of past and present
anthropogenic pressures and stream network position on riverine fish
communities both in time and space. We showed that the timing of anthropogenic
pressures matters, because past and recent pressures can have contrasting and
interactive effects on community trends, partly mediated by non-native species.
Our study further shows that considering multiple biodiversity facets can shed
light on the complex mechanisms by which communities change over time. Looking
forward, we emphasise the increasing need to investigate biotic changes across
spatial scales to better reconcile reported local gains and global declines in
biodiversity[@vellend_plant_2017; @primack_biodiversity_2018;
@mcgill_fifteen_2015]. The increasing availability of community timeseries and
environmental data across large areas is invaluable for understanding how past
and present human pressures have impacted biodiversity across taxa and
ecosystems, and for implementing conservation policies to mitigate these
impacts.

# Methods

## Fish community time series

We used the RivFishTime database[@comte_rivfishtime_2021], a compilation of more than 12,000 time
series containing species abundances of riverine fish communities, which we
completed with time series from Canada and the USA (Table S2). The final
database mainly covered western and northern Europe, northern America, and
southeastern Australia. We selected time series having at least 5 years of data
over a 10-year period as well as a consistent sampling protocol and abundance
unit. As several sites had been sampled using different sampling methods (e.g.
electrofishing, seining, Table S3) and/or over different periods of the year, we
selected for each site only the sampling events that were performed using the
most frequent protocol (i.e. the mode) and within 1.5 month of the most
frequently sampled month (i.e. 45 days before or after). When there were several
sampling events in a given year, we selected the sampling that took place at the
closest date from the most frequently sampled date of the site. Finally, we
excluded 1,340 sites that had been limed as part of the long-term Swedish liming
program (available at https://kalkdatabasen.lansstyrelsen.se/)[@svenson_swedish_1995] to avoid
including sites whose environmental conditions had been experimentally
manipulated. The data selection resulted in `r fnsite` fish community time series,
totalling `r fnop` sampling events, `r fnmeas` species abundance records, and
`r fnsp` freshwater fish species. The median time span of the time series was of
`r tss$span` years ([25th quantile, 75th quantile]), their median completeness was
of `r tss$completeness` (see Fig. S1 for the complete distribution), while the median
first study year was `r tss$min`. The sites were mostly located in the
Palearctic (`r per_eco["Palearctic"]`), Nearctic (`r per_eco["Nearctic"]`) and Australasia (`r per_eco["Australasia"]`). Four countries gathered
85% of the sites, namely Great Britain (`r per_pays["GBR"]`), France (`r per_pays["FRA"]`), Sweden (`r per_pays["SWE"]`), and
the USA (`r per_pays["USA"]`, Table S3).

## Community metrics

```{r}
effort_unit <- table(
  filtered_op_protocol_modelling$unitabundance,
  is.na(filtered_op_protocol_modelling$sampledlength_m)
) / nrow(filtered_op_protocol_modelling)

u_no_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "TRUE"]
  )
)
u_tot_na_eff <- effort_unit[, colnames(effort_unit) == "TRUE"] /
  (effort_unit[, colnames(effort_unit) == "TRUE"] +
    effort_unit[, colnames(effort_unit) == "FALSE"])
per_u_tot_na_eff <- scales::percent(u_tot_na_eff)

u_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "FALSE"]
  )
)
u_eff <- scales::percent(table_to_vec(effort_unit[, 1]), accuracy = 1)

unitvec <- table(filtered_op_protocol_modelling$unitabundance) /
  nrow(filtered_op_protocol_modelling)

u_per <- scales::percent(table_to_vec(unitvec))
```

We assessed community changes in riverine fish communities using several
biodiversity facets related to total abundance, species richness, the share of
non-native species and community composition (Table S4). Total abundance was
reported in number of individuals (`r u_per["Count"]` of the sampling events), density of
individuals per 100 $m^2$ (`r u_per["Ind.100m2"]`), Catch Per Unit Effort (CPUE,
`r u_per["CPUE"]`), and Leslie index (`r u_per["Leslie_index"]`, Table S3).
Although we selected for strict protocol consistency, 70% or more of the
sampling events by unit of abundance did not report sampling effort, preventing
us from harmonising count, abundance density and CPUE[@comte_rivfishtime_2021].

```{r}
#see adjust_abun_chao()
cor_chao_rich <-  cor(
  modelling_data$chao_richness,
  modelling_data$species_nb,
  method = "spearman") %>%
round(., 2)

cor_log_chao_rich <-  cor( modelling_data$log_chao_richness,
  modelling_data$log_species_nb, method = "spearman") %>% round(., 2)
```

As sampled species richness is a negatively biased estimator of the “true”
species richness, we corrected sampled species richness with the coverage-based
rarefaction and extrapolation methodology[@chao_coverage-based_2012]. The
estimated coverage of a sample is positively related to the number of
individuals and negatively related to the number of singletons. We fixed the
coverage of all samples at 98.5% via rarefaction and extrapolation using the R
package iNEXT[@hsieh_inext_2016] to make species richness comparable across
samples. We did not always have a direct estimate of the number of individuals
and number of singletons to compute the sampling coverage, as
`r u_per["Ind.100m2"]` of the abundances were measured as density values and
`r u_per["CPUE"]` as CPUE. In this case, we first divided each
species density ($x_i$) by the minimum value in the community and rounded each
value to the nearest integer (i.e. $x^{\prime}_i = round(1 / min(x_i))$, where
$x^{\prime}_i$ is the estimated abundance of the i-th species) to obtain
at least one singleton species, i.e. a species with one
individual. However, we note that both covered-based and raw species richness
estimates were highly correlated (Spearman’s $\rho = 0.97$ for both raw variables and log
transformed ones), and the choice of the metric did not influence our
interpretations regarding the patterns and drivers of species richness changes
(Fig. S5).

```{r}
nat_ori <- table(measurement_exo$native_exotic_origin) / nrow(measurement_exo)
nat_per <- scales::percent(table_to_vec(nat_ori), accuracy = 0.1)
nat_per2 <- scales::percent(table_to_vec(nat_ori), accuracy = 0.01)
sp_country_handmade <- measurement_exo %>%
  filter(native_exotic_origin == "handmade") %>%
  distinct(species, country)
```


The biogeographic origin of the fish species describing whether species were
native or introduced to a given drainage basin was retrieved using a global
database documenting species status across drainage basins of the
world[@tedesco_global_2017] (`r nat_per["tedesco"]` of the species occurrences,
Table S3). For the sites falling outside the river basins provided in the global
database[@tedesco_global_2017], such as for the sites located close to the
shore, we used the closest basin within the same country. For species not
included in a given drainage basin, we determined the origin of the species at
the country scale using Fishbase[@froese_fishbase_2021]
(`r nat_per["autofishbase"]` of species occurrences). Given the spatial extent
of the USA, we completed the global database with the Nonindigenous Aquatic
Species (NAS) database developed by the US Geological Survey
(https://nas.er.usgs.gov/) using US states as spatial grain
(`r nat_per2["usgs"]` of the species occurrences). We completed the remaining
species origins at the country scale, using national atlases and Fishbase data
in neighbouring countries, such as for *Piaractus brachypomus* and *Rutilus
rutilus* in the USA (`r nat_per["handmade"]` of the species occurrences,
Table S3). We then estimated the percentage of non-native species with respect
to both abundance and species richness for each sampling event (Table S4).


### Dissimilarity metrics

We used the complement of the Jaccard similarity index (i.e., Jaccard
dissimilarity, which we denote as $J$) to characterise temporal dissimilarity in
community composition at each site, taking the first year of sampling of a
community as the reference community. This index is based on presence/absence
and is simply the sum of species gains and losses over the total number of
species across two samples (eq. \@ref(eq:jac)). It thus measures the proportion
of species not shared between two samples.

\begin{equation}
  J = \dfrac{S_{gain} + S_{loss}}{S_{tot}}
  (\#eq:jac)
\end{equation}

with $S_{gain}$, $S_{loss}$, $S_{tot}$ being the numbers of immigrant,
extirpated and total species respectively.

We further partitioned the Jaccard dissimilarity index into two
complementary indices, Turnover ($J_t$) and Nestedness
($J_n$), respectively $J_t = (2 * min(S_{loss}, S_{gain})) / (S_{common} + (2 *
min(S_{loss}, S_{gain})))$ and $J_n = 1 - J_t$,
$S_{common}$ being the number of species present in both communities[@baselga_betapart_2012]. High
Turnover values indicate that the changes in community composition resulting
from species replacement, whereas high values of Nestedness indicate species
gains or losses from a nested community, i.e. that a community is a subset of
the other[@baselga_temporal_2015].

We further characterised temporal dissimilarity with the Simpson-based
dissimilarity index[@hillebrand_biodiversity_2018] ($H_d$, eq. \@ref(eq:hill)). This
index is based on species relative abundances and their variation across two
samples. Simpson-based dissimilarity index is based on the Simpson diversity
index and thus gives higher weight to changes in the abundant species, whereas
Jaccard dissimilarity index gives equal weight to each species. Simpson-based
dissimilarity index thus quantifies the extent of changes in the identity of the
dominant species[@hillebrand_biodiversity_2018]. Both high Jaccard and Simpson
dissimilarity values indicate changes in composition resulting from changes in
the abundant species, whereas conjointly high Jaccard and low Simpson
dissimilarity values indicate composition changes resulting from changes in the
species with low relative abundances.

\begin{equation}
\begin{aligned}
H_d &= 1 - H \\
H_d &= 1 - \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}
(\#eq:hill)
\end{aligned}
\end{equation}

with $i$: species $i$, $p$: relative abundance and $\prime$: the focal community

## Environmental drivers

```{r}
n_na_riveratlas <- analysis_dataset[is.na(analysis_dataset$log_dist_up_km), ] %>%
  distinct(siteid) %$% nrow(.)
v_rvat <- scales::percent(
  (nrow(analysis_dataset) - n_na_riveratlas) /
    nrow(analysis_dataset)
  )

nb_op9309 <- sum(
  filtered_op_protocol_modelling$year >= 1993 &
  filtered_op_protocol_modelling$year <= 2009
)
perc_op9309 <- scales::percent(nb_op9309 / nrow(filtered_op_protocol_modelling))

nb_opb93 <- sum(
  filtered_op_protocol_modelling$year < 1993
)
perc_opb93 <- scales::percent(nb_opb93 / nrow(filtered_op_protocol_modelling))
nb_opa09 <- sum(
  filtered_op_protocol_modelling$year > 2009
)
perc_opa09 <- scales::percent(nb_opa09 / nrow(filtered_op_protocol_modelling))
```

```{r}
tar_load(pca_riv_str)
perc_var_rc1 <- pca_riv_str$rotated$Vaccounted["Proportion Var", "RC1"] %>%
  scales::percent(.)
tar_load(riveratlas_site)
env <- riveratlas_site[,
        colnames(riveratlas_site) %in%
          c("siteid", setNames(get_river_atlas_significant_var(), NULL))
        ] %>%
          sf::st_drop_geometry() %>%
          mutate(
              riv_str_rc1 =  pca_riv_str$rotated$scores[, "RC1"],
              riv_str_rc2 =  pca_riv_str$rotated$scores[, "RC2"]
          )
cor_env <- cor(env[, colnames(env) != "siteid"], method = "spearman") %>%
  round(., 2)
cor_env_rc1 <- cor_env["riv_str_rc1", ]
```

We quantified the degree of anthropogenic pressures using the human footprint
index[@venter_global_2016; @venter_sixteen_2016], extracted from the HydroAtlas database at the reach scale[@linke_global_2019; @robinson_earthenv-dem90_2014]
(reach length resolution of 450 metres). We did so by snapping the sites to the
closest stream segment using a one-kilometre buffer (99% of the sites). The
human footprint index aggregates an array of human pressures, including
population density, the extent of urban, forested, cropland and pastureland
areas, but also transportation hubs such as roads, railways, and navigable
pathways. It does so by combining remote sensing data, systematic surveys and
modelling from ground data, making it less prone to errors[@venter_global_2016]. The human
footprint index ranges from 0 to 50, with values superior to four being
considered in a degraded state[@williams_change_2020]. This index has been previously related to
species extinction and risk of biological invasion[@di_marco_changes_2018; @williams_change_2020]. To capture both the
effects of the legacy of past anthropogenic pressures and of its recent changes,
we considered the human footprint index computed in 1993 and 2009 (i.e. 16 years
span). Specifically, the human footprint index of 1993 was used as a measure of
past anthropogenic pressures at the beginning of the study period and the ratio
between the human footprint of 2009 and 1993 as a measure of the recent changes
in anthropogenic pressures (only `r perc_opb93` of the samplings took place
before 1993, while `r perc_op9309` took place between 1993 and 2009 and
`r perc_opa09` after 2009; Fig. S1). In order to obtain interpretable
coefficients of recent changes in human footprint, we log-transformed the ratio
of human footprint with a base 2, such
as values of -1 and 1 represented a division by two and a multiplication by two
of the human footprint between 1993 and 2009, respectively. In river networks,
the environmental heterogeneity and connectivity along the longitudinal stream
position (upstream-downstream) strongly shape species occurrences, immigration
rates and community composition[@altermatt_river_2013]. To capture this longitudinal gradient, we
first described stream characteristics at each site by the altitude (m), slope
(deg.), average annual discharge ($m^3.s^{-1}$), distance from source (km), and Strahler
order that we extracted from the HydroAtlas database at the reach
scale[@linke_global_2019; @robinson_earthenv-dem90_2014]. We did so by snapping
the sites to the closest stream segment using a one-kilometre
buffer (99% of the sites). We next performed a Principal Component Analysis over
the site stream characteristics on the log-transformed (after adding absolute
minimum values plus one to avoid few negative values in altitude: ) and
standardising all the variables, i.e. centring and scaling. We orthogonally
rotated the two first principal components using the varimax criterion[@kaiser_varimax_1958], to
increase the quality of the variable representation (i.e. their loadings) on the
two first principal components. The first rotated component was positively
related to average annual discharge, distance from source and Strahler order and
captured `r perc_var_rc1` of the variance (Fig. S6), and was subsequently used as a composite
variable describing the stream longitudinal position from upstream to
downstream. The correlation coefficients indicate little covariations among the
predictors (maximum correlation of 0.09 found between past and recent pressures,
Fig. S7).



```{r}
# Resolution of hydrorivers:
#https://www.hydrosheds.org/products/hydrorivers
```

## Statistical analysis

To estimate community temporal trends, we first modelled the different
community metrics (Y) as dependent of time ($\beta_0Time_t$, eq. \@ref(eq:gen)), measured as the
number of years since the beginning of the sampling at each site. The
statistical model (eq. \@ref(eq:gen)) was adapted according to the nature of the
response variable. For total abundance, we added the measurement unit of
abundance as a categorical variable both as a main effect and in interaction
with time[@van_klink_meta-analysis_2020]. We set the factor level ‘raw count’ as the reference level such
that the temporal trends in total abundance in the main text and supplementary
materials are expressed in raw count (i.e. number of individuals). For
dissimilarity metrics, we set the intercept fixed at zero as dissimilarity
metrics at each site was 0 at the beginning of the time series. We accounted for
the hierarchical spatial structure in the data by assigning random effects on
the intercept ($\alpha$) and on the slope of the temporal trends ($\beta_0$) conditional on basin
identity ($n$) and on site identity ($i$) nested within basin ($i|n$). The random effects
and the error terms were modelled as a Normal distribution of mean 0 and
variance ($\sigma^2$).

\begin{equation}
\begin{aligned}
    Y_{i|n, t} &= \alpha + \beta_0Time_t + \epsilon_{i|n, t}
  (\#eq:gen)
\end{aligned}
\end{equation}

- $\alpha = \alpha_0 + a_n + a_{i|n}$
- $\beta_0 = \mu + b_n + b_{i|n}$
- $a_n, a_{i|n}, b_n, b_{i|n}, \epsilon_{i|n, t} \sim \mathcal{N}(0,\,\sigma^{2})$
- $n$: hydrographic basin, $i$: site $i$, $t$: time $t$



To assess the drivers of community change, we then incorporated additional
covariates into the models (eq. \@ref(eq:drivers)): the legacy of past
anthropogenic pressures measured by the human footprint index of 1993, the
recent changes in anthropogenic pressures measured by the ratio between the
human footprint index of 2009 and 1993 ($X_k$), and the stream longitudinal
position estimated by the rotated PCA axis. We included two-way interactions between
time and the ecological drivers ($\sum_{k = 1}\beta_{0k}Time_tX_k$) to test how
stream longitudinal position and anthropogenic pressures affect the temporal trends in
community metrics. We further included the three-way interactions between time and
the pairs of other ecological drivers ($\sum_{k = 1, k \neq
l}\beta_{0kl}Time_tX_kX_l$) to examine the presence of synergistic or
antagonistic effects between anthropogenic pressures and stream longitudinal
position on the temporal trends in community metrics (i.e., the results in Fig. 3a).
We included all the predictors as main effects ($\sum_{k=1}\beta_kX_k$) to capture the effects of the
ecological drivers on the spatial variation in average community composition
metrics through time, except when modelling the dissimilarity metrics (i.e. we
only included the effects of ecological drivers on the temporal trends) (i.e.,
the results in Fig. 3b). We did so because dissimilarity metrics quantify the
community change at a given time point ($t = 0 \ldots N$) at a given site from the first
time period ($t = 0$) and therefore bounded by 0 and 1 at each site; we thus did
not expect average differences in dissimilarity related to any other factors
than time.


\begin{equation}
\begin{aligned}
    Y_{i|n, t} &= \alpha + \beta_0Time_t + \sum_{k=1}\beta_kX_k + \sum_{k=1}\beta_{0k}Time_tX_k + \sum_{k=1, k \neq l}\beta_{0kl}Time_tX_kX_l + \epsilon_{i|n, t}
  (\#eq:drivers)
\end{aligned}
\end{equation}

- $k, l \in [1,2,3]$: ecological drivers including stream gradient, legacy of past and recent changes in anthropogenic pressures



All the response variables were modelled with a Gaussian distribution following
previous studies modelling temporal trends in total abundance, species richness
and community composition at the global scale[@dornelas_assemblage_2014;
@blowes_geography_2019; @van_klink_meta-analysis_2020]. Other error structures
might be more appropriate to model response variables bounded between 0 and 1 or
ratio of discrete numbers such as the dissimilarity metrics and the proportion
of non-native species. However, doing so allowed to obtain easily interpretable
coefficients across all community metrics (e.g. temporal
trends cannot be interpreted  as rates of change when modelled using a logit
scale such as when using a beta distribution). In addition, a previous study
using similar models[@blowes_geography_2019] found that slope coefficients
estimated with a gaussian error and a beta error had a Spearman correlation
superior to 0.90 and gave qualitatively similar results. We therefore believe
that this choice is not likely to alter our conclusions.

```{r}
tar_load(tab_waic)
perc_dec_waic <- scales::percent(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]]) / tab_waic[["Year nb"]]))
dec_waic <- round(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]])))
```
We log-transformed the number of years as $\log(year + 1)$ as it improved the quality
of the model fitting to the data, decreasing the WAIC[@gelman_understanding_2014; @vehtari_practical_2017] by `r dec_waic` on average
(`r perc_dec_waic`) across community metrics facets (Table S5). It suggested
the presence of non-linearity in the temporal trends, which is particularly
expected in the case of bounded variables such as the dissimilarity metrics. We
log-transformed total abundance and species richness, then their temporal trends
are multiplicative and can be expressed in percentage change by unit of time. We
then derived the percentage of change by decade in species richness and total
abundance by back transforming $\beta_0$ using a time value of $\log(10 + 1)$ as
follows: $(e^{\beta_0 \times \log(10 + 1)} - 1) \times 100$.


In order to compare the strength of the effects among predictors across
community metrics, we scaled both community metrics and the predictors by their
standard deviation prior to model fit. As our models contain interactions,
the individual slope coefficients could be difficult to interpret without
centering the predictors around ecological relevant
values[@gelman_scaling_2008]. As an example, the average temporal trends
estimated by $\beta_0$ in eq.\@ref(eq:drivers) can only be interpreted when all
the $X_k = 0$. Hence, we centred past anthropogenic pressures and longitudinal
stream position around their average values. The variables quantifying time and
recent changes in anthropogenic pressures were not centred, because then the
main effects of the ecological predictors ($\sum_{k=1}\beta_k$) would indicate
their baseline effects (i.e. when time is equal to 0 and without recent changes
in anthropogenic pressures).

The models were evaluated in a Bayesian framework using Integrated Nested
Laplacian Approximation[@rue_approximate_2009; @rue_bayesian_2017] (INLA), which
approximates the posterior distribution of the parameters and then do not rely
on Markov chains and Monte Carlo simulations, and thus is a computationally
efficient method to evaluate Bayesian models. We computed the credible intervals
at 80%, 90% and 95% using the Highest Posterior Density
method[@hyndman_computing_1996], which can respectively be interpreted as weak,
moderate and strong evidence of an effect when the interval does not include
0[@van_klink_meta-analysis_2020; @mastrandrea_guidance_2010]. The statistical
models were implemented using the `INLA` R package[@rue_approximate_2009], with
defaults uninformative priors. The prior distribution of fixed coefficients
followed a flat zero centred normal distribution ($\mathcal{N}(\mu,\, \sigma^2)
= \mathcal{N}(0,\, 1000)$). The prior distribution of the random effects and the
gaussian error ($\epsilon_{it}$, eq. \@ref(eq:gen)) followed a log gamma
distribution with shape and inverse scale parameters ($\mathcal{G}(s, \, \tau) =
\mathcal{G}(1, \, 5.10^-5)$). We then back-transformed the estimated
coefficients to the standard deviations attributed to the random effects and
the gaussian error ($\sigma = 1 / \sqrt{\tau}$). We checked that the slope
coefficients, random effects and the temporal trends by basin and site were
similar than with an implementation in frequentist. Then, we concluded that the
quality of parameter inference did not suffer from the uninformative priors.

We checked the overall quality of the model fit to the data by plotting the
fitted versus the observed values (Fig. S8). We visually inspected the PIT and
CPO (respectively Posterior Integral Transform and Conditional Predictive
Ordinate) distribution to assess both the quality of data representation, and
the frequency of outliers. There was very little multicollinearity in the model, as all
Variance Inflation Factors were around 1 (Table S6).

We computed $R^2$ to assess the quality of the fit of the Bayesian models. We
then computed marginal ($R^2_m$) and conditional ($R^2_c$) R-squared,
respectively associated with the variance explained by the fixed effects and the variance
explained by both the fixed and random effects[@nakagawa_general_2013]. We only
included the random effects on the intercept in the $R^2$ computation, i.e. the
basin effect ($a_n$) and the site effect ($a_{i|n}$), as the inclusion of the
variance attributed to random slopes is much more complex and was shown to not change
the results[@nakagawa_general_2013; @lahuis_explained_2014]. We computed the
variance associated with each predicted value from their posterior distribution,
following recommendations to take in account the variability associated with
the priors[@gelman_r-squared_2019]. We then reported the mean marginal and
conditional $R^2$ associated the 95% credible interval computed using the
Highest Posterior Density method.

$$
R^2_m = \dfrac{Var_{fit}}{Var_{fit} + Var_{res}} = \dfrac{\sigma^2(\hat{y_i})}{\sigma^2(\hat{y_i}) + \sigma^2(y_i - \hat{y_i})}
$$

$$
R^2_c = \dfrac{Var_{fit} + (a_n)^2 + (a_{i|n})^2}{Var_{fit}  + (a_n)^2 + (a_{i|n})^2 + Var_{res}}
$$

$y_i$ and $\hat{y_i}$ being respectively the observations and the predicted
values, $Var_{fit}$ and $Var_{res}$ being respectively the variance of
predictive means and the variance of the residuals[@gelman_r-squared_2019].
$a_n$ and $a_{i|n}$ are respectively the standard deviation on the random
intercept associated to the hydrographic basin and the site.


## Typology of temporal trends

To estimate the covariations among multiple dimensions of community change, we
performed a PCA on the temporal trends in the community metrics estimated at
each site (i.e. using the predictions of the models in percentage per decade
using the Best Linear Unbiased Prediction method). We used four variables in
this analysis: temporal trends in total species richness, community abundance,
temporal dissimilarity and turnover. We excluded the two variables describing
the non-native species composition (proportion of non-native abundance and
richness) because their predicted temporal trends at the site level displayed a
very low variation compared to the other variables, which in turn exerted a
disproportionate constraint on the analysis. In addition, we performed a
clustering analysis to identify distinct types of community trajectories using
the trimmed k-means method[@fritz_tclust_2012], a robust clustering method because it avoids the
identification of spurious clusters. The method consists of trimming the  most
outlying data in the multidimensional space, the number of dimensions being the
number of community metrics. To choose a relevant number of clusters, we plotted
the log-likelihood of the trimmed classification as a function of the proportion
of the most outlying data trimmed ($\alpha$) and the number of clusters (Fig. S9). We
thus selected a partition of temporal community changes in six clusters with
$\alpha=5\%$ (see Fig. S10 with four clusters). We did not constrain the algorithm for the
relative size or shape of the clusters, as we had no a priori expectation about
them. The clustering algorithm was run for a minimum number of 100 iterations
and up to a maximum of 125 iterations. To further control for the quality of the
cluster assignment, we discarded any fish community for which the second-best
cluster assignment was 50% better than the first one by comparing the degree of
affiliation to the clusters[@fritz_tclust_2012]. The clustering was performed using tclust R
package[@fritz_tclust_2012].


## Reproducibility and open science statement

The manuscript and the supplementary materials are written in Rmarkdown, i.e.
combining code and text, and are available on github
[(alaindanet/RivFishTimeBiodiversityFacets)](https://github.com/alaindanet/RivFishTimeBiodiversityFacets).
We further implemented a code pipeline using the `targets` R package to ensure
that the code, the data, the figures, the manuscript and the results are up
to date.


## Acknowledgements

We thank Joacim Näslund for his assistance accessing the data from the long-term
Swedish liming program. We also thank all the monitoring programs and
researchers for their continuous efforts of data collection and for making these
data publicly available; this study would not be possible without their efforts
and generosity. In particular, we would like to acknowledge the authors who made
their data available for this study (Table S2). We further thank Suzanne
Bonnamour, Colin Fontaine, Grégoire Loïs, Maud Mouchet, and Emmanuelle Porcher
at the Centre d’Écologie et des Sciences de la Conservation as well as Andrew P
Beckerman and Thomas F Johnson at the University of Sheffield for their very
constructive feedbacks on the study. J.O. was supported by the Richard C. and
Lois M. Worthington Endowed Professor in Fisheries Management from the School of
Aquatic and Fishery Sciences, University of Washington.

# References {-}

<div id="refs"></div>



