---
title: "Past and recent anthropogenic pressures drive community changes over space and time in riverine fish assemblages"
author: "Alain Danet, Xingli Giam, Julian Olden, Lise Comte"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::word_document2:
  bookdown::pdf_document2:
    keep_tex: true
bibliography: "bibliography.bib"
csl: nature.csl
link-citations: true
indent: true
spacing: double
---

<!--header-includes:-->
  <!--- \usepackage[left]{lineno}-->
  <!--- \linenumbers-->
  <!--- \hypersetup{backref=true}-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.path = "graphics/knitr-",
                      fig.retina = 1.618, # Control using dpi
                      fig.width = 6,  # generated images
                      fig.pos = "t",  # pdf mode
                      fig.align = "center",
                      dpi = if (knitr::is_latex_output()) 72 else 300,
                      out.width = "100%",
                      dev = "svg",
                      dev.args = list(png = list(type = "cairo-png")),
                      optipng = "-o1 -quiet")

library(here)
source(here::here("R", "misc.R"))
source(here::here("R", "variable_shortcut.R"))
source(here::here("R", "basic_stat.R"))
source(here::here("R", "summary_distribution.R"))
library(tidyverse)
library(magrittr)
library(cowplot)
library(targets)
library(kableExtra)


if (Sys.info()["login"] == "alain")
  file.copy(
    from = "~/Documents/post-these/references.bib",
    to = here("paper", "bibliography.bib")
  )
```

```{r load-targets, include=FALSE}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))


fnsite <- nrow(filtered_dataset_modelling$location)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))

tar_load(inla_no_drivers_effects)
tar_load(c(trends, trends80, trends90))
tar_load(c(pred_number, pred_inla, pred_data_explanation))
```
```{r}
table_to_vec <- function(x) {
  setNames(as.numeric(x), names(x))
}
get_comp <- function(
  pred = pred_number,
  type = "pred_hft93_t0",
  resp = NULL,
  lvl_comp = NULL
  ) {
  pred[[type]][[resp]][["mean"]][lvl_comp]
}
```
```{r}
tar_load(c(gaussian_inla_std_effects, gaussian_inla_exo_std_effects))
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects)
ci80 <- tu %>%
  filter(ci_level == "level:0.80")
ci90 <- tu %>%
  filter(ci_level == "level:0.90")
ci95 <- tu %>%
  filter(ci_level == "level:0.95")
```
```{r global-trends}
abun_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_total_abundance)
  * log(10 + 1),
  r = 1)
abun_trends <- str_replace(abun_trends, "\\[ ", "\\[")
rich_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_chao_richness)
  * log(10 + 1),
  r = 1
)
hill_trends <- p_ci(
  trends$hillebrand_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
jac_trends <- p_ci(
  trends$jaccard_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
tu_trends <- p_ci(
  trends$turnover_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
ne_trends <- p_ci(
  trends$nestedness_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)

exo_trends <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends90 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends90[[.x]] * log(10 + 1), r = 4, p = FALSE)
)
names(exo_trends90) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends80 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends80[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends80) <- c("perc_exo_sp", "perc_exo_abun")
```


```{r, results="hide", eval=FALSE}
word_count <- wordcountaddin::text_stats(here("paper", "main_text.Rmd"))
readable <- wordcountaddin::readability(filename = here("paper", "main_text.Rmd"), quiet = TRUE)
```
```{r, results = "hide", eval=FALSE}
word_count
```
- Now 3578 words without abstract and references (max NEE: 3500)

---
#- TODO: 
#  - [ ] Is it possible to capture the number of spliting of fish species in the
#    database? (if not available, may be prepare a mail for fishbase)
#
#- Article guidelines by Nature in Ecology and Evolution: 
#  - Main text – up to 3,500 words, excluding abstract, Methods, references and figure legends.
#  - Abstract – up to 200 words, unreferenced. 
#  - Display items – up to 6 items (figures and/or tables). 
#  - Extended Data – up to 10 items (figures and/or tables, linked from the main text in the html version of the paper).
#  - Article should be divided as follows: 
#    - Introduction (without heading, up to 500 words of referenced text on the background of the work) 
#    - Results (concise, focused account of the findings)
#    - Discussion
#    - Online Methods.
#- Results and Methods should be divided by topical subheadings; the Discussion does not contain subheadings.
#- References – as a guideline, we typically recommend up to 50.
---

\pagebreak

# Abstract (up to 200 words; now: 200)

Human pressures constitute a major driver of global biodiversity decline. Local
community responses are less clear, especially in freshwater systems where
recent increases in abundance and occupancy were reported. We analyzed a
timeseries compilation of fish abundance in riverine systems across three
biogeographic realms to quantity the effects of anthropogenic pressures on
community changes over space and time. We show that past and recent
anthropogenic pressures result in lower total abundance (-29%) while having a
proportion of non-native richness and abundance three to five times higher than
"intact" sites. We found a global increase in species richness (+13%) and in
total abundance (+7%) by decade, driven by past anthropogenic pressures,
concomitant to an increasing share of non-native species, strong species
replacement and changes in dominance, in accordance with previously reported
biotic homogenization. Past and recent anthropogenic pressures had antagonistic
effects on species richness and total abundance trends over time, but also
synergistics on increasing composition changes and non-native richness. We
further show that community trajectories are homogeneously distributed across
realms but highly heterogeneous at site scale. We highlight that linking local
community changes to reported biotic homogenization explains why reported local
gains and global declines in biodiversity are not contradictory.


# Introduction (up to 500 words / 496 words)

Whereas global diversity is reported to decline at an alarming
rate[@diaz_global_2019], local diversity shows no net change in species
richness over time in marine and terrestrial assemblages[@vellend_global_2013;
@dornelas_assemblage_2014; @blowes_geography_2019], lower declines and even
increase[@van_klink_meta-analysis_2020; @outhwaite_complex_2020]. Those
contrasting diversity trends call for further investigations to better
understand how ecological communities change at local scale.

Habitat degradation is recognised as one of the main drivers of biodiversity
losses across ecosystems[@diaz_global_2019; @caro_inconvenient_2022;
@maxwell_biodiversity_2016]. Dense urban and cultivated areas are 
associated with reduced species richness and total abundance in terrestrial
vertebrates assemblages[@newbold_global_2015] and
invertebrates[@outhwaite_agriculture_2022]. Human activities also alter
community composition by the introduction of native and non-native species by
propagule pressure and habitat disturbance[@leprieur_fish_2008;
@bernery_freshwater_2022; @villeger_homogenization_2011], which are generally
tolerant and ubiquitous species which can can cope with degraded
habitats[@tonella_importance_2018; @su_morphological_2020]. In particular,
non-native species play a disproportionate role in the recomposition of
ecological communities over time[@kuczynski_concomitant_2018;
@toussaint_historical_2014; @leprieur_fish_2008], and have dramatic effects on
assemblages when they become invasive[@gallardo_global_2016]. 
Anthropogenic pressures have therefore antagonistic effects on local diversity
because habitat degradation are expected to decrease species richness and total
abundance, while the introduction native and non-native species, are expected to
increase species richness and total abundance. 

Anthropogenic pressures are highly heterogeneous over space and time. For
instance, places such as Europe and Northeastern America are under the highest
historical human influence, i.e. in terms of cumulation of population density,
of cropland and urban areas, and built infrastructures in
general[@sanderson_human_2002]. While human influence decreased recently in
those areas, it has dramatically increased in more recently industrialized places
which are also the location of most biodiversity hotspots,
such as Southeastern America, Centralwestern Africa, South Asia and Eastern
Asia[@venter_sixteen_2016]. Take in account the spatio-temporal heterogeneities in
human pressures might then help to disentangle responses due to the legacy of
past or to recent changes in anthropogenic pressures. The multidimensional
nature of biodiversity concept[@lyashevska_how_2012; @chase_embracing_2018]
constitutes another layer of complexity in analyzing community changes, as
temporal trends in species richness can be unrelated to changes in species
composition and dominance for example[@dornelas_assemblage_2014;
@blowes_geography_2019; @scott_native_2001; @hillebrand_biodiversity_2018].
Then, a better understanding of community changes might require the use of
multiple indices which account for changes in abundance but also in species
identity.

This study addresses those research gaps by investigating the effects of both
past and recent changes in anthropogenic pressures over space and time on
riverine fish communities across several biogeographic realms. We further assess
the heterogeneity of community trajectories over space and time. Freshwater
systems constitute a timely case because human pressure are even considered to be
more dramatic. They cover a small area of terrestrial land but are also the
recipients of the pollution from byproducts of human activities
[@reid_emerging_2019], Non-native species are particularly present
[@leprieur_fish_2008] and were shown to play a disproportionate role in
homogenization of fish communities [@villeger_homogenization_2011]. Moreover,
recent reports of increase in abundance and occupancy over the last decades in
freshwater invertebrate assemblages[@van_klink_meta-analysis_2020;
@outhwaite_complex_2020], which contrasts with findings in terrestrial systems,
and calls for further investigations in freshwater systems.


# Results


```{r}
tar_load(site_year)
tss <- map(setNames(c("min", "completeness", "span"), c("min", "completeness", "span")),
  ~summary_distribution(site_year[[.x]])[c("median", "1st_quart", "2nd_quart")]
)

tss$min <- paste0(tss$min["median"], " [", tss$min["1st_quart"], ",", tss$min["2nd_quart"], "]")
tss$completeness <- round(tss$completeness * 100)
tss$completeness <- paste0(tss$completeness["median"], "% [", tss$completeness["1st_quart"], "%,", tss$completeness["2nd_quart"], "%]")
tss$span <- paste0(tss$span["median"], " [", tss$span["1st_quart"], ",", tss$span["2nd_quart"], "]")
```


```{r}
extract_pred <- function (x = NULL, resp = NULL, val_to_extract = NULL) {

  ci_low <- x[[resp]]$quant0.025[val_to_extract]
  ci_high <- x[[resp]]$quant0.975[val_to_extract]

  # Does the ci at 95 overlap? 
  ci_overlap <- ci_low[val_to_extract[1]] > ci_high[val_to_extract[2]] |
    ci_high[val_to_extract[1]] < ci_low[val_to_extract[2]]

  list(
    val = x[[resp]]$mean[val_to_extract],
    ci_overlap = !ci_overlap
  )
}
#' Get percentage of difference, the first value being the reference
get_ratio <- function(x, r = 1) {
  #reduce(x, `/`)
  out <- round((x[2] - x[1]) / x[1] * 100, r)
  paste0(out, "%")
}
```

```{r}
tar_load(pred_number)
```

```{r}
pred_hft93_t0 <- map(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0)),
  ~extract_pred(
    x = pred_number$pred_hft93_t0,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t0[[.x]]$val), r = 0)
)
other_hft93_int_max <- map_chr(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0))[
    !names(pred_number$pred_hft93_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft9309_t0_inc <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_inc[[.x]]$val), r = 0)
)

other_hft9309_0_inc_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_inc[[.x]]$val, r = 0)
  )

pred_hft9309_t0_dec <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "div/2")
  )
)

abun_rich_hft9309_0_dec_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_dec[[.x]]$val), r = 0)
)

other_hft9309_0_dec_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_dec[[.x]]$val, r = 0)
  )
```

```{r}
pred_rivstr_t0 <- map(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0)),
  ~extract_pred(
    x = pred_number$pred_rivstr_t0,
    resp = .x,
    val_to_extract = c("min", "max")
  )
)

abun_rich_riv_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_rivstr_t0[[.x]]$val), r = 0)
)
other_riv_int_max <- map_chr(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0))[
    !names(pred_number$pred_rivstr_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_rivstr_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft93_t10 <- map(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10)),
  ~extract_pred(
    x = pred_number$pred_hft93_t10,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t10[[.x]]$val), r = 0)
)
other_hft93_int_max_t10 <- map_chr(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10))[
    !names(pred_number$pred_hft93_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t10[[.x]]$val, r = 0)
  )
```

```{r}
pred_hft9309_t10 <- map(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t10,
    resp = .x,
    val_to_extract = c("div/2", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t10[[.x]]$val), r = 0)
)
other_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10))[
    !names(pred_number$pred_hft9309_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t10[[.x]]$val, r = 0)
  )
```


## Community changes over space

Our dataset comprised 4476 riverine fish community timeseries that have been
repeatedly sampled over the last decades (baseline: `r tss$min`;
span: `r tss$span` years; completeness:`r tss$completeness`; median [25th
quantile,75th quantile]), mainly in Western and Northern Europe, Northern
Eastern America, South Eastern Australia and Japan
from the RivFishTime database[@comte_rivfishtime_2021] and additional monitoring
programs (Table S1, Fig. S1). We derived estimates of community changes and its
drivers from a hierarchical Bayesian model including hydrographic basin and the
sites, nested in basin. We quantified anthropogenic pressures using the human
footprint index, a cumulative index including infrastructures, urbanization and
agricultural land use and population density[@sanderson_human_2002], and which
has been previously related to species extinction and biological invasion
risks[@di_marco_changes_2018; @gallardo_importance_2015]. We quantified the
legacy of past anthropogenic pressures with the human footprint index of 1993,
as only 7% of the monitoring surveys were realized before this date (Fig. S1).
We found strong evidence that higher past anthropogenic pressures resulted in higher
species richness (Fig. 1), as most degraded sites (human footprint index = 
`r round(pred_data_explanation$hft_ix_c93["max"],1)`) have 
`r abun_rich_hft93_int_max["log_chao_richness"]` more species than "intact"
sites (human footprint index = `r round(pred_data_explanation$hft_ix_c93["intact"],1)`).
Sites subject to higher past anthropogenic pressures also had a higher
proportion of non-native richness and non-native abundance (strong evidence,
Fig. 1), such as the most degraded sites had a proportion of non-native species
richness (`r scales::percent(pred_hft93_t0$perc_exo_sp$val["max"])`) twice
higher than intact sites (`r scales::percent(pred_hft93_t0$perc_exo_sp$val["intact"])`)
and a proportion of non-native species abundance three times higher 
(`r scales::percent(pred_hft93_t0$perc_exo_abun$val["max"])` and
`r scales::percent(pred_hft93_t0$perc_exo_abun$val["intact"])` resp.). 
We found also strong evidence that higher past anthropogenic pressures resulted in
lower total abundance (Fig. 1), such as most degraded sites had a total abundance
`r abun_rich_hft93_int_max["log_total_abundance"]` lower than intact sites. In
contrast, we found strong evidence that recent increases in anthropogenic
pressures, quantified by the ratio of the human footprint index
between 2009 and 1993, was associated with communities displaying on average
lower species richness and total abundance. Sites that have been subject to a
recent twofold increase in anthropogenic had a species richness
`r abun_rich_hft9309_0_inc_by2["log_chao_richness"]` and a total abundance 
`r abun_rich_hft9309_0_inc_by2["log_total_abundance"]` lower compared to site
that have not undergone recent changes in antropogenic pressures. We also
found strong evidence that sites that have undergone recent twofold increase in
anthropogenic pressures had a proportion of non-native species richness and
abundance half higher (resp.  +`r other_hft9309_0_inc_by2["perc_exo_sp"]` and 
+`r other_hft9309_0_inc_by2["perc_exo_abun"]`) than sites that have not changed
recently in anthropogenic pressures. We found strong evidence that stream
gradient, synthetized by a PCA axis related to strahler order, distance from
source, and annual discharge, modulate species richness and non-exotic species
presence, most downstream sites having three times more species than most
upstream streams, as well as a proportion in non-native species richness and
abundance respectively `r other_riv_int_max["perc_exo_sp"]` and 
`r other_riv_int_max["perc_exo_abun"]` higher.


## Global community changes over time

We derived global temporal trends from a model without anthropogenic drivers.
We found an overall increase  in species richness and total abundance, together
with strong reorganization in community composition. More specifically, our
results indicated strong evidence for a global increase over time in total
abundance  (Credible Interval 95%: `r abun_trends` by decade) and in species
richness (CI 95%: `r rich_trends` by dec.). We further found moderate evidence
for a global decline in the proportion of non-native species abundance of (CI
90%: `r exo_trends[["perc_exo_abun"]]` by dec.), but no evidence for a net
temporal trend in the proportion of non-native species richness (CI 80%: 
`r exo_trends[["perc_exo_sp"]]` by dec.). We found strong evidence that
community composition changes fast, with one third of the species changes 
after a decade (jaccard dissimilarity, CI 95%: `r jac_trends` by dec.), and we
found rougly similar trends for Simpson dissimilarity index, which is based on
species relative abundance. Turnover, which describes composition changes arising from species
replacement, and nestedness, describing changes arising from species gains and
losses from a common pool, displayed a comparable increase over time  (CI 95%:
`r tu_trends` by dec), corresponding to an equal share from the rate of increase
of the Jaccard dissimilarity index (Fig. S8). Together, it indicates that
composition changes were related to changes in species richness and species
identity but also changes in dominance structure, i.e. changes in the identity
of the dominant species.

## Effect of anthropogenic pressures on community changes over time


```{r}
hft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
```

We found strong evidence that past anthropogenic pressures increased the
temporal trends of total abundance and species richness (resp. CI95%:$\beta\prime =$ 
`r hft93abun` and `r hft93rich`, Fig. 1). We also found weak evidence that past
anthropogenic pressures increased the proportion of non-native richness over
time (CI 80%:$\beta\prime =$ `r hft93exor`, Fig. 1), but no evidence that they
affect the proportion of non-native abundance (CI 80%:$\beta\prime =$
`r hft93exoa`, Fig. 1). We also found strong evidence that past anthropogenic
pressures increased temporal dissimilarity and turnover over time, i.e. respectively
indicating changes in species dominance and species replacement (resp. CI
95%:$\beta\prime =$ `r hft93hill` and `r hft93turn`).


```{r}
hft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 2)
hft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", )
hft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")
hft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")
```

We did not found evidence for an effect of recent anthropogenic
pressures on the temporal trends of both total abundance and species richness
(resp. CI 80%: $\beta\prime =$ `r hft09abun` and `r hft09rich`, Fig. 1). However, we found
moderate evidence that recent increase in anthropogenic pressures increase
the proportion in non-native richness over time (CI 90%: $\beta\prime =$ `r hft09exor`,
Fig. 1) but not the proportion of non-native abundance (CI 80%: $\beta\prime =$
`r hft09exoa`, Fig. 1). We found also strong evidence that recent increase in
anthropogenic pressures resulted in stronger temporal dissimilarity and turnover 
(resp. CI 95%: $\beta\prime =$ `r hft09hill` and `r hft09turn`, Fig. 1).

```{r}
hft2abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
```

We also found strong evidence for antagonistic effect between past and recent
changes in anthropogenic pressures on the temporal trends of total abundance (CI
95%: $\beta\prime =$ `r hft2abun`, Fig.1), meaning that recent anthropogenic
pressures decreased more temporal trends of total abundance in sites that were
previously more degraded.  We did not find evidence for such interaction for
species richness (CI 80%: $\beta\prime =$ `r hft2rich`, Fig. 1). In constrast,
we found moderate evidence for a synergistic effect between past and recent
anthropogenic pressures on the increase of the proportion of non-native species,
but not of non-native abundance (resp. CI 90%: $\beta\prime =$ `r hft2exor` and
CI 80% `r hft2exoa`, Fig.1). Finally, we found strong evidence for a synergistic
between past and recent anthropogenic pressures on the increase of temporal
dissimilarity and turnover (resp. CI 95%: $\beta\prime =$ `r hft2hill`
and `r hft2turn`, Fig.1).

## Effect of the stream gradient on community changes over time 

```{r}
rivhftabun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftrich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 4)
rivhftexor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftexoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhfthill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftturn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)

rivhft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 4)
rivhft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")
rivhft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")
```

```{r}
riv1abun <- get_effect_ci(
  resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", )
riv1hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")
riv1turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")
```

We found strong evidence that the stream gradient, from upstream to downstream,
increased the temporal trends of both total abundance and species
richness (resp. CI 95%: $\beta\prime =$ `r riv1abun` and `r riv1rich`, Fig. 1).
Furthermore, there was strong evidence that the increase of the proportion of
non-native species richness and abundance over time are higher downstream than upstream 
(resp. CI 95%: $\beta\prime =$ `r riv1exor` and `r riv1exoa`, Fig. 1).
Conjointly, we found strong evidence that the stream gradient increased temporal
dissimilarity and turnover (resp. CI 95%: $\beta\prime =$ `r riv1hill` and `r riv1turn`,
Fig. 1). We also found that past and recent changes in anthropogenic pressures
interact with the stream gradient. We found that both past and recent changes in
anthropogenic pressures have a synergistic effect on the increase of the
proportion of non-native species richness (resp. CI 90%: $\beta\prime =$ `r rivhftexor` and
CI 80%: $\beta\prime =$ `r rivhft09exor`, Fig. 1), and  of non-native species
abundance (resp. CI 95%: $\beta\prime =$ `r rivhftexoa` and
CI 90%: $\beta\prime =$ `r rivhft09exoa`, Fig. 1). In contrast, we found
evidence that stream gradient have an antagonistic effect with past
anthropogenic pressures on both on species richness and total abundance temporal
trends (resp. CI 95%: $\beta\prime =$ `r rivhftrich` and CI 80%: $\beta\prime =$
`r rivhftabun`, Fig. 1), meaning that the positive effect of past anthropogenic
pressures on species richness and total abundance temporal trends are lower
downstream than upstream. We found moderate evidence that stream gradient has a
antagonistic effect with recent increase in anthropogenic pressures on the
temporal trends of species richness (resp. CI 90%: $\beta\prime =$
`r rivhft09rich`), but we found no effects on total abundance. In contrast, we
found no evidence that both past and recent changes in anthropogenic pressures
have an interacting effect with the stream gradient on temporal dissimilarity
and turnover. 

## Typology of community temporal trends

There was a strong heterogeneity among the temporal trends in the different
community metrics as illustrated by the principal component analysis. We found
that the first axis was related to temporal changes in community composition,
i.e. dissimilarity and turnover, while the second axis was related to the
temporal trends in species richness and total abundance (Fig. 2). The third axis
was related to opposite temporal trends in species richness and in total
abundance and the fourth axis was related to opposite temporal trends in
temporal dissimilarity and turnover.  We further derived six distinct
types of community trajectories from the sites temporal trends by using a k-mean
trimmed clustering method. Around 40% of the sites were attributed to a cluster
associated with medium temporal increases in species richness and total
abundance, as well as medium temporal trends in dissimilarity and turnover (Fig.
2). The second cluster (16% of the sites) was related to communities displaying
a high turnover but moderate increases in species richness, total abundance and
dissimilarity over time. The third, fourth and fifth clusters (resp. 13%, 12%
and 9% of the sites, Fig. 2) were related to an increase in species richness
over time, to a decline in total abundance and to a decline in species richness
over time, respectively. The last cluster (7% of the sites) was related to
relatively stable communities over time.  Importantly, the different community
trajectories were observed across all biogeographic realms with similar
frequencies but showed basin-specific patterns (Fig. 3). For instance, the
Potamac basin (US, Fig. 3c) displayed with relatively few sites corresponding to
declines in total abundance but much higher proportion of sites displaying
strong turnover, i.e. species replacement.  We also found that Thames basin
(UK, Fig. 3d) displayed higher proportion of sites corresponding to a decrease
in species richness and total abundance but low proportion corresponding to low
community changes. We further found that for all community metrics, the variance
in the temporal trends, was higher for the site identity (nested in basin) than
for hydrographic basin. Expect for total abundance and species richness, the
variance attributed to site was at least twice higher than the one attributed to
basin (Table 1).

# Discussion

Our results suggests that both past and recent anthropogenic pressures leave a
strong spatial imprint on riverine fish communities. The most degraded sites in
the past had an proportion of non-native species and abundance two times and
three times higher than "intact" sites, in line with findings that higher
density of human population, urban areas and roads, all present in the human
footprint index, increase non-native richness by increasing propagule
pressure[@anas_drivers_2021; @leprieur_fish_2008; @bernery_freshwater_2022].
Anthropogenic pressures can further increase the establishment success of
non-native species by modifying environmental conditions, creating new niche
opportunities, in a way that native species loose their prior competitive
advantage due to local adaptation over the non-native[@bernery_freshwater_2022;
@byers_impact_2002; @olden_life-history_2006]. It suggests that the higher
species richness found in sites more degraded in the past is partly related to
the higher share of non-natives, as non-native introductions is higher than
native extirpation in Nearctic and Palearctic
realms[@villeger_homogenization_2011], which should result in higher overall
species richness. However, both past and recent increase in anthropogenic
pressures resulted in a lower total abundance, in accordance with the abundant
literature showing that land degradation have detrimental effects on the total
abundance and species richness of terrestrial vertebrates and
invertebrates[@newbold_global_2015; @outhwaite_agriculture_2022]. 

The global increase in species richness and total abundance over time,
accompanied by a strong species replacement and changes in dominant species,
suggest important ongoing changes in fish riverine communities. Interestingly,
the global increase of 13% in total abundance by decade found in this study,
closely match the 11% per decade reported for freshwater
insects[@van_klink_meta-analysis_2020]. Is is also consistent with other
regional assessments of freshwater animal populations, the reported
increase in freshwater insect occupancy found in the UK and increase in
freshwater animal LPI (Living Planet Index) in Netherlands since the
1990s[@outhwaite_complex_2020; @van_strien_modest_2016], but contrasts with
dramatic LPI declines of freshwater megafauna reported at
worldwide scale[@he_global_2019] and with regional assessments of fish
assemblages[@moraga_century_2022]. The global increase in fish species richness over time
contrasts with the absence of net changes reported across terrestrial
and marine assemblages[@vellend_global_2013; @dornelas_assemblage_2014;
@blowes_geography_2019]. Higher past anthropogenic pressures resulted in a
larger increase in species richness and total abundance over time, suggesting an
increase from the legacy of past disturbances. Previous studies suggested that
the adoption of numerous legislations targeting improvements in freshwater water
quality in EU and US since 1970s and a decline of the negative effects from
agriculture over time could be partly responsible for those increase despite
habitat degradation[@langford_long-term_2009; @van_klink_meta-analysis_2020;
@outhwaite_agriculture_2022]. Most of our monitored sites (92%) could
be considered in an initial state of degradation at the beginning of the study
period, i.e. had a human footprint index superior to four in
1993[@williams_change_2020], could therefore lend support to the recovery
hypothesis. 

However, higher past anthropogenic pressures resulted in a greater increasing
share of non-native species over time, which suggests that non-native species
contributes disproportionately to the increase in species richness estimated
over time in riverine fish communities. Then, the increase of local species
richness over time could result from the differential between introduction and
extirpation from on-going spatial homogenization[@villeger_homogenization_2011],
as predicted by metacommunity models[@mouquet_community_2003]. By contrast, past
anthropogenic pressures had no effect on the share of non-native species
abundance over time while had a positive one over space, which might be due to
the residential time needed between introduction and
establishment[@bernery_freshwater_2022]. Established non-native species were
shown to be mostly ubiquitous and generalists species[@tonella_importance_2018;
@su_morphological_2020], with extreme morphological and traits that
disproportionately increase functional richness and divergence in fish riverine
communities[@toussaint_non-native_2018]. Past anthropogenic pressures also
resulted in higher rates of species replacement and changes in species dominance
over time, in accordance with findings that non-native species play an important
role in temporal dissimilarity and turnover in fish riverine
communities[@toussaint_historical_2014; @kuczynski_concomitant_2018]. Changes in
dominance are predicted to alter species interactions, coexistence among species
and ultimately ecosystem functioning[@hillebrand_consequences_2008]. Taken
together, our results suggest that the legacy of past degradation lead to
an ongoing adaptation to degraded environments, with a disproportionate
contribution of non-native species, accompanied by large species replacement and
changes in dominant species identity. However, a more definitive interpretation
of those increases in species richness and total abundance in freshwater systems
would require a precise assessment of habitat quality and of the tolerance of
the species composing the communities in these areas in an degraded state, as
native tolerant species might also contribute to on-going changes[@mccune_gains_2013].

In contrast, recent addition in anthropogenic pressure decreases the temporal
trends of species richness and total abundance, particularly in location of
higher past degradation. It suggests that the increase in species richness and
abundance from high past anthropogenic pressures was not happening in the sites
that continued to experience an increase in anthropogenic pressures. A reason
might be that we considered recent changes in anthropogenic pressures as
multiplicative, i.e. using a ratio, such as sites having high anthropogenic pressures in the past
had an higher absolute increase in anthropogenic pressures than sites having
lower pressures in the past. In contrast, past and recent increase in
anthropogenic pressures have additive and synergistic effects on increasing the
proportion of non-native species richness over time, on increasing temporal
dissimilarity both in term of changes in dominance and species replacement. All
together, our results highlight that considering the timing of anthropogenic
pressures[@mccomb_editorial_2020; @brooks_combined_2019;@orr_towards_2020] and
the species identity and role is crucial to better understanding community
changes over space and time.

Community changes over time lied in different dimensions that we attempted to
regroup in different trajectory complexes, i.e. changes in species richness,
total abundance, turnover or medium/low community changes over time.  Our result
in are in accordance with findings that temporal changes in composition are
poorly related to temporal trends in species richness[@dornelas_assemblage_2014;
@blowes_geography_2019; @hillebrand_biodiversity_2018; @chase_embracing_2018].
Furthermore, our results suggest that community changes are more heterogeneous
at local scale than at the basin and realm scale, as indicated higher variance
in temporal trends found at the site scale than at the basin scale and the
relative homogeneous distribution of cluster across realms. It might be a
characteristic of riverine systems, which are highly constrained by the stream
gradient and by basin limits, which in turn determine environmental filtering
and potential of dispersal [ref]. Our results suggests the spatial distribution
in anthropogenic pressures and their timing constitutes another layer adding to
the high heterogeneity of community changes at local scale. The random
intercepts of the hierarchical model, related to the spatial scale, captured
much more variance in the community metrics than the fixed effects. It could be
related to biogeographic factors related to post-glaciation fish colonization,
climatic factors, and physical barriers which further explains species
composition differences among fish riverine communities[@abell_freshwater_2008;
@villeger_homogenization_2011]. It might also be related to a too coarse spatial
resolution of anthropogenic pressures and its synthetic nature, which explains
only a part of the variance in community metrics.

Our study uncovered the relationships between community changes and
anthropogenic pressures in riverine fish communities over space and time.  Our
result suggests that recent increase in species richness and total abundance
over time might be related to on-going homogenization of fish riverine
communities as indicated by the increasing share of non-native species.  This
interpretation is supported by previous findings[@leprieur_fish_2008;
@villeger_homogenization_2011; @toussaint_historical_2014;
@kuczynski_concomitant_2018], suggesting that water quality improvement might
not be the main driver of recent increases in freshwater systems. Our study also
highlights the strong legacy of human pressure on species richness, total
abundance, and share of non-native species in fish riverine communities. Our
study has a spatial coverage limited to historically industrialized countries,
whereas the highest recent increase in anthropogenic pressures happened in
current biodiversity hotspots. Our results suggest that they result in more
dramatic community changes, in line with previous findings[@he_global_2019;
@leprieur_fish_2008]. Our study confirms that community changes over time are
multidimensional and spatially heterogeneous, drove in part by the heterogeneity
of human pressures over space in time. Human pressures have also antagonistic
effects on species richness and abundance, as ecosystem degradation should lead
to local extinction while propagule pressure should lead to local colonization
and regional homogenization. Further promising investigations include the
assessment of the potentially interacting effects between anthropogenic
pressures and climate change[@comte_climate_2021; @outhwaite_agriculture_2022;
@reid_emerging_2019], further considering the characteristics of the species
driving community changes[@su_morphological_2020]. Our study further confirms
that linking local community changes to reported on-going community
homogenization at regional scale is crucial to understand why reported local
gains and global declines in biodiversity are not
contradictory[@vellend_plant_2017; @primack_biodiversity_2018;
@mcgill_fifteen_2015].

# Methods

```{r}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))
tar_load(add_dataset_ref)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))
```



```{r}
nsitetot <- length(unique(site_desc_loc$siteid))
nmeas <- nrow(measurement)
nsp <- length(unique(measurement$species))
nop <- length(unique(measurement$op_id))
```

```{r}
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )

fnsite <- nrow(site_year)
fnmeas <- nrow(filtered_dataset_modelling$measurement)
fnsp <- length(unique(filtered_dataset_modelling$measurement$species))
fnop <- length(unique(filtered_dataset_modelling$measurement$op_id))

mspan <- median(site_year$span)
mcpl <- scales::percent(median(site_year$completeness))
mbl <- median(site_year$min)

eco <- table(filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  pull(ecoregion)
) / nrow(filtered_dataset_modelling$location)

per_eco <- scales::percent(table_to_vec(eco), accuracy = 1)

pays <- table(filtered_dataset_modelling$location$country
) / nrow(filtered_dataset_modelling$location)
pays_vec <- table_to_vec(pays)

per_pays <- scales::percent(sort(pays_vec, decreasing = TRUE), accuracy = 1)
per_s4pays <- scales::percent(sum(sort(pays_vec, decreasing = TRUE)[1:4]))

# Add database
```

```{r}
tss <- map(setNames(c("min", "completeness", "span"), c("min", "completeness", "span")),
  ~summary_distribution(site_year[[.x]])[c("median", "1st_quart", "2nd_quart")]
)
tss$min <- paste0(tss$min["median"], " [", tss$min["1st_quart"], ",", tss$min["2nd_quart"], "]")
tss$completeness <- round(tss$completeness * 100)
tss$completeness <- paste0(tss$completeness["median"], "% [", tss$completeness["1st_quart"], "%,", tss$completeness["2nd_quart"], "%]")
tss$span <- paste0(tss$span["median"], " [", tss$span["1st_quart"], ",", tss$span["2nd_quart"], "]")
```



## Fish community time series

We used the RivFishTime database[@comte_rivfishtime_2021], a compilation of
more than 12,000 time series containing species abundances of riverine fish
communities. The database mainly covers western and northern Europe, northern
America, and southeastern Australia. We completed the database with time series
from Canada and United States (Table S1), following the same criteria than
RivFishTime for integration[@comte_rivfishtime_2021].

We selected time series having at least 5 years of data
over a 10 year period as well as a consistent sampling protocol. As
several sites had been sampled using different sampling methods (e.g.
electrofishing, seining) and/or over different periods of the year, we selected
for each site only the sampling events that were performed using the most
frequent protocol (i.e. the mode) and within 1.5 month of the most frequently
sampled month (i.e. 45 days before or after). When there were several sampling
events the same year, we selected the sampling that took place at the closest
date from the most sampled date of the site. We further checked that the
reported unit of abundance was consistent for each time series.

The data selection resulted in `r fnsite` fish community time series, totalling
`r fnop` sampling events, `r fnmeas` species abundance records, and `r fnsp`
freshwater fish species. The median time span was of `r tss$span`
years ([25th quantile, 75th quantile]), the median baseline of the time series
was `r tss$min`, and the median completeness of the time series was of `r tss$completeness` (see
Fig. S2 for the complete distribution).
The sites were mostly located in Palearctic (`r per_eco["Palearctic"]`),
Nearctic (`r per_eco["Nearctic"]`) and Australasia (`r per_eco["Australasia"]`).
Four countries gathered `r per_s4pays` of the sites, namely Great Britain
(`r per_pays["GBR"]`), France (`r per_pays["FRA"]`), Sweden (`r per_pays["SWE"]`),
and the United States (`r per_pays["USA"]`, Table S4).

## Community metrics 

We assessed community changes in riverine fish communities using several
biodiversity facets related to community composition, non-native species,
species richness and total abundance (Table S7).

### Dissimilarity metrics

We characterized temporal dissimilarity in community composition in each site,
taking the first year of sampling of a community as the reference community.
We first used the complement of the Jaccard similarity index (J). This index is
based on presence/absence and is simply the sum of species gains and losses over
the total number of species across two samples (eq. \@ref(eq:jac)). It thus
measures the proportion of species not shared between two samples.

$$
J = \dfrac{S_{gain} + S_{loss}}{S_{tot}}
  (\#eq:jac)
$$ 

with $S_{gain}$, $S_{loss}$, $S_{tot}$ being the numbers of immigrant,
extirpated and total species respectively.

We further partitioned the Jaccard dissimilarity index into two sets
of complementary indices. The first set was Appearance and Disappearance,
respectively the proportion of colonizing species ($S_{gain} / S_{tot}$) and
the proportion of extirpated species ($S_{loss} / S_{tot}$). The second set
was Turnover ($J_t$) and Nestedness ($J_n$), respectively
$J_t = (2 * min(S_{loss}, S_{gain})) / (S_{common} + (2 * min(S_{loss},
S_{gain})))$ and $J_n = 1 - J_t$[@baselga_betapart_2012] , $S_{common}$ being
the number of species present in both communities. High Turnover values indicate
that the changes in community composition resulting from species replacement,
whereas high values of Nestedness indicate species gains or losses from a nested
community, i.e. that a community is a subset of the other[@baselga_temporal_2015].

We further characterized temporal dissimilarity  with the Simpson-based
dissimilarity index[@hillebrand_biodiversity_2018] ($H_d$, \@ref(eq:hill)). 
This index is based on species relative abundances and their variation across
two samples. Simpson-based dissimilarity
index is based on the Simpson diversity index and thus gives higher weight to
changes in the abundant species, whereas Jaccard dissimilarity index gives equal
weight to each species. Simpson-based dissimilarity index thus quantifies the
extent of changes in the identity of dominant
species[@hillebrand_biodiversity_2018]. Both high Jaccard and Simpson
dissimilarity values thus indicate changes in composition implying changes in
the abundant species, whereas conjointly high Jaccard and low Simpson
dissimilarity values indicate composition changes in species of low relative
abundances. 

$$
\begin{aligned}
H_d &= 1 - H \\
H_d &= 1 - \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}
(\#eq:hill)
\end{aligned}
$$ 

with $i$: species $i$, $p$: relative abundance and $\prime$: the focal community



```{r}
effort_unit <- table(
  filtered_op_protocol_modelling$unitabundance,
  is.na(filtered_op_protocol_modelling$sampledlength_m)
) / nrow(filtered_op_protocol_modelling)

u_no_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "TRUE"]
  )
)
u_tot_na_eff <- effort_unit[, colnames(effort_unit) == "TRUE"] /
  (effort_unit[, colnames(effort_unit) == "TRUE"] +
    effort_unit[, colnames(effort_unit) == "FALSE"])
per_u_tot_na_eff <- scales::percent(u_tot_na_eff)

u_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "FALSE"]
  )
)
u_eff <- scales::percent(table_to_vec(effort_unit[, 1]), accuracy = 1)

unitvec <- table(filtered_op_protocol_modelling$unitabundance) /
  nrow(filtered_op_protocol_modelling)

u_per <- scales::percent(table_to_vec(unitvec))
```

Total abundance was reported in number of individuals (`r u_per["Count"]` of the sampling
events), density of individuals per 100 $m^2$ (`r u_per["Ind.100m2"]`), Catch Per
Unit Effort (`r u_per["CPUE"]`), and Leslie index (`r u_per["Leslie_index"]`,
Table S3).
Although we selected for strict protocol consistency, 70% or more of the
sampling events by unit of abundance did not reported sampling effort,
preventing us to harmonize count, abundance density and Catch Per Unit Effort[@comte_rivfishtime_2021].


```{r}
#see adjust_abun_chao()
cor_chao_rich <-  cor(
  modelling_data$chao_richness,
  modelling_data$species_nb,
  method = "spearman") %>%
round(., 2)

cor_log_chao_rich <-  cor(
  modelling_data$log_chao_richness,
  modelling_data$log_species_nb,
  method = "spearman") %>%
round(., 2)
```
As sampled species richness is a negatively biased estimator of the "true"
species richness, we corrected sampled species richness with the coverage-based
rarefaction and extrapolation methodology [@chao_coverage-based_2012]. The
estimated coverage of a sample is positively related to the number of
individuals and negatively related to number of singletons. We fixed the
coverage of all samples at 98.5% via rarefaction and extrapolation using the R
package `iNEXT`[hsieh_inext_2016], to make species richness to be comparable
across samples.

We did not always have direct access to the number of individuals and number of
singletons to compute the sampling coverage, as `r u_per["Ind.100m2"]` of the abundances
were measured as density by 100 $m^2$ and `r u_per["CPUE"]` as Catch per Unit
Effort. In this case, we first divided each species abundance ($x_i$) by
the minimum values of abundance in the community (i.e. $x^{\prime}_i =
1 / min(x_i)$), which we further rounded so that each community had at least one singleton
species, i.e. a species with one individual. The correlation was very high
between raw species richness and Chao richness (Spearman's $\rho = `r cor_chao_rich`$ for
both raw variables and log transformed ones, Fig. S3).

## Stream gradient and anthropogenic pressures

```{r}
n_na_riveratlas <- analysis_dataset[is.na(analysis_dataset$log_dist_up_km), ] %>%
  distinct(siteid) %$% nrow(.)
v_rvat <- scales::percent(
  (nrow(analysis_dataset) - n_na_riveratlas) /
    nrow(analysis_dataset)
  )

nb_op9309 <- sum(
  filtered_op_protocol_modelling$year >= 1993 &
  filtered_op_protocol_modelling$year <= 2009
)
perc_op9309 <- scales::percent(nb_op9309 / nrow(filtered_op_protocol_modelling))

nb_opb93 <- sum(
  filtered_op_protocol_modelling$year < 1993
)
perc_opb93 <- scales::percent(nb_opb93 / nrow(filtered_op_protocol_modelling))
nb_opa09 <- sum(
  filtered_op_protocol_modelling$year > 2009
)
perc_opa09 <- scales::percent(nb_opa09 / nrow(filtered_op_protocol_modelling))
```

```{r}
tar_load(pca_riv_str)
perc_var_rc1 <- pca_riv_str$rotated$Vaccounted["Proportion Var", "RC1"] %>%
  scales::percent(.)
tar_load(riveratlas_site)
env <- riveratlas_site[,
        colnames(riveratlas_site) %in%
          c("siteid", setNames(get_river_atlas_significant_var(), NULL))
        ] %>%
          sf::st_drop_geometry() %>%
          mutate(
              riv_str_rc1 =  pca_riv_str$rotated$scores[, "RC1"],
              riv_str_rc2 =  pca_riv_str$rotated$scores[, "RC2"]
          )
cor_env <- cor(env[, colnames(env) != "siteid"], method = "spearman") %>%
  round(., 2)
cor_env_rc1 <- cor_env["riv_str_rc1", ]
```


In dendritic networks, the environmental heterogeneity and connectivity along
the longitudinal (upstream-downstream) gradient strongly shape species
occurrences, immigration rates and community composition[@altermatt_river_2013].
To capture this stream gradient, we described stream characteristics at each
site by the altitude (m), slope (deg.), average annual discharge ($m^3.s^{-1}$),
distance from source (km), and strahler order that we extracted from the
HydroAtlas database[@linke_global_2019; @robinson_earthenv-dem90_2014, Table
S8]. We did so by snapping the sites to the closest stream segment using a one
kilometer buffer (`r v_rvat` of the sites).  We performed a Principal Component
Analysis over the site stream characteristics after log transforming (added
absolute minimum values plus one to avoid negative values, $x^{\prime}_i = x_i +
min(x_i) + 1$) and standardizing all the variables, i.e. centering and scaling.
We orthogonally rotated the two first principal components, using the varimax
criterion[@kaiser_varimax_1958; @revelle_psych_2019], to increase the quality of
the variable representation (i.e. their loadings) on the two first principal
components. The first rotated component was positively related to average annual
discharge, distance from source and Strahler order and capturing 
`r perc_var_rc1` of the variance (Fig. S4), and then was used as a composite
variable describing the stream gradient from upstream to downstream.

We quantified the degree of anthropogenic pressures using the human footprint
index[@venter_global_2016; @venter_sixteen_2016]. The human footprint index
aggregates an array of human pressures, including population density, the extent
of forested, cropland and pasture land areas, but also the extent of built
environments such as roads, railways, electric infrastructures, and navigable
pathways (Fig.  S5). It does so by combining remote sensing data, systematic
surveys and modelling from ground data, making it less prone to
errors[@venter_global_2016]. The human footprint index ranges from 0 to 50, with
values superior to four being considered in a degraded
state[@williams_change_2020]. To capture both the effects of the legacy of past
anthropogenic pressures and its recent changes, we considered the human
footprint index computed in 1993 and 2009 (i.e. 16 years span). Specifically,
the human footprint index of 1993 was used as a measure of the legacy of past
anthropogenic pressures and the ratio between the human footprint of 2009 and
1993 as a measure of the recent changes in anthropogenic pressures.  In order to
obtain interpretable coefficients of recent changes in human footprint, we
log-transformed the ratio of human footprint with a base 2. Then, a value of
minus one and one represent a division by two and a multiplication by two of the
human footprint between 1993 and 2009, respectively. Only `r perc_opb93` of the
samplings took place before 1993, while `r perc_op9309` took place between 1993
and 2009 and `r perc_opa09` after 2009 (Fig. S1). The human footprint index
values were extracted from the HydroAtlas database at the reach scale [original
resolution of 450meters, @linke_global_2019]. The human footprint indexes of
1993 and 2009 were not correlated with the stream gradient (Spearman's $\rho$ of
`r cor_env_rc1["hft_ix_c93"]` and `r cor_env_rc1["hft_ix_c09"]` respectively).

```{r}
# Resolution of hydrorivers:
#https://www.hydrosheds.org/products/hydrorivers
```


```{r}
nat_ori <- table(measurement_exo$native_exotic_origin) / nrow(measurement_exo)
nat_per <- scales::percent(table_to_vec(nat_ori), accuracy = 0.1)
nat_per2 <- scales::percent(table_to_vec(nat_ori), accuracy = 0.01)
```

```{r}
sp_country_handmade <- measurement_exo %>%
  filter(native_exotic_origin == "handmade") %>%
  distinct(species, country)
```

The biogeographic origin of the fish species describing whether species were
native or introduced to a given drainage basin was retrieved using the global
database of @tedesco_global_2017 (`r nat_per["tedesco"]` of the species
occurrences). For the sites
falling outside of the river basins provided in @tedesco_global_2017, such as
for the sites located close to the shore, we used the closest basin in the
country. For species not included in a given drainage
basin, we determined the origin of the species at the country scale using
Fishbase [@froese_fishbase_2021] (`r nat_per["autofishbase"]` of species
occurrences). Given the spatial extent of the United States, we completed
the global database with the Nonindigenous Aquatic Species (NAS) database
developed by the
U.S. Geological Survey ([https://nas.er.usgs.gov/](https://nas.er.usgs.gov/)),
at the US state scale (`r nat_per2["usgs"]` of the species occurrences).
We completed the remaining species origins at the country scale, using
national atlases and Fishbase data in neighboring countries, such as for
*Piaractus brachypomus* and *Rutilus rutilus* in the United States 
(`r nat_per["handmade"]` of the species occurrences, Table S6). We then
estimated the percentage of non-native species for each sampling events, both
for species richness and abundances (Table S7).

## Statistical analysis


We modelled the temporal trends of the different biodiversity facets ($Y$) as
dependant of time ($\beta_0Time_t$, eq. \@ref(eq:gen)) measured as the number
of years since the beginning of the sampling at each site with $t_0 = 0$, the
stream gradient measured by the rotated PCA axis over stream characteristics,
the legacy of past anthropogenic pressures measured by the human footprint index
of 1993, and the recent changes in anthropogenic pressures measured by the ratio
between the human footprint index of 2009 and 1993. We included all the
predictors as main effects ($\sum_{k=1}\beta_kX_k$) to capture the differences
in biodiversity facets attributed to spatial effects of the ecological drivers.
We further included interactions between time and the ecological drivers
($\sum_{k=0, l\neq k}\beta_{kl}X_kX_l$) to test how stream gradient and
anthropogenic pressures affect the temporal trends in
biodiversity facets. Finally, we included the triple interactions between time
and the pairs of other ecological drivers ($\sum_{k=0, m \neq
n\neq k}\beta_{kmn}X_kX_mX_n$) to test for the presence synergistic
or antagonistic effects of the stream gradient and anthropogenic pressures on
the temporal trends in biodiversity facets.

Furthermore, the statistical model (eq. \@ref(eq:gen)) was adapted according of
the nature of the variables, namely total abundance and dissimilarity metrics.
For total abundance, we added the measurement unit of abundance as a categorical
variable both as a main effect and in interaction with time
[@van_klink_meta-analysis_2020]. We set raw count as the reference factor level
such as the temporal trends in total abundance in the main text and
supplementary materials are expressed in raw count. We modelled dissimilarity
metrics with the intercept fixed at zero as dissimilarity
metrics at each site was 0 at the beginning of the time series. 
Futhermore, we did not include the main effects of ecological drivers ($\sum_{k=1}\beta_kX_k$
term from eq. \@ref(eq:gen)) in the modelling of dissimilarity metrics, i.e. we
only included the effects of ecological drivers on the temporal trends. We did
so because dissimilarity metrics were relative to the site and bounded between 0 and 1, so 
we did not expect average differences in dissimilarity which are not due to
differences in the temporal trends.

We accounted for the spatial structure of the data by adding random effects to
the intercept ($\alpha$) and the slope of the temporal trends ($\beta_0$) on the
basin identity ($n$) and on the site identity ($i$), nested in basin ($i|n$). The
random effects and the error terms were modelled as a Normal distribution of
mean 0 and variance ($\sigma^2$).



$$
\begin{aligned}
    Y_{i|n, t} &= \alpha + \beta_0Time_t + \sum_{k=1}\beta_kX_k + \sum_{k=0, l\neq k}\beta_{kl}X_kX_l + \sum_{k=0, m \neq l\neq k}\beta_{klm}X_kX_lX_m + \epsilon_{i|n, t}
  (\#eq:gen)
\end{aligned}
$$ 


- $\alpha = \alpha_0 + a_n + a_{i|n}$
- $\beta_0 = \mu + b_n + b_{i|n}$
- $k, l, m \in [1,2,3]$: ecological drivers including stream gradient, legacy of past and recent changes in anthropogenic pressures
- $a_n, a_{i|n}, b_n, b_{i|n}, \epsilon_{i|n, t} \sim \mathcal{N}(0,\,\sigma^{2})$
- $n$: hydrographic basin, $i$: site $i$, $t$: time $t$

All the response variables were modelled with a Gaussian distribution following
previous studies modelling temporal trends of community composition, species
richness and total abundance at the global scale [@dornelas_assemblage_2014;
@blowes_geography_2019; @van_klink_meta-analysis_2020]. Other error structures might
be more appropriate to model response variables bounded between 0 and 1 and
representing ratio of discrete numbers such as the dissimilarity metrics and the
proportion of non-native species, doing so allows to obtain easily interpretable
coefficients across all biodiversity facets (e.g. temporal trends are not
interpretable as rates of change when modelled using a logit scale such as when
using a beta distribution). In addition, @blowes_geography_2019 previously found
that slope coefficients estimated with a gaussian error and a beta error had a
Spearman correlation superior to 0.90 and give qualitatively similar results. We
therefore believe that this choice is not likely to alter our conclusions.


```{r}
tar_load(tab_waic)
perc_dec_waic <- scales::percent(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]]) / tab_waic[["Year nb"]]))
dec_waic <- round(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]]))) 
```

We log-transformed the number of years as $\log(year + 1)$ as it improved the
quality of the model fitting to the data, decreasing the WAIC [Watanabe-Akaike
information criterion, @gelman_understanding_2014; @vehtari_practical_2017] by 
`r dec_waic` in average (`r perc_dec_waic`) (Table S11). It
suggests the presence of non-linearity in the temporal trends, which is
particularly expected in the case of bounded variables such as the dissimilarity
metrics. The rate of community change per decade is then found for a time
value of $\log(10 + 1)$, i.e. `r round(log(10 + 1), 2)`. We further log-transformed with a base 2
the recent changes in anthropogenic pressures quantified by the ratio
of human footprint index between 2009 and 1993, i.e.
$\log_2(HFT_{2009} / HFT_{1993})$. Then, a value of minus one and one
represent respectively a division by two and a multiplication by two of the
human footprint between 1993 and 2009. We log-transformed total abundance and
Chao species richness, then their temporal trends are multiplicative and can be
expressed in percentage change by unit of time. We derived percentage change by
decade in species richness and total abundance by back transforming $\beta_0$
such as: $(e^{\beta_0 \times \log(10 + 1)} - 1) \times 100$.


In order to compare the magnitude of the effects of time, stream gradient, and
anthropogenic pressures among biodiversity facets and to compare the magnitude
of the effects of the predictors, we scaled both biodiversity facets and the
predictors by their standard deviation prior to the model evaluation.

As our models contain interactions, the individuals slope coefficients can be
difficult to interpret without centering the predictors around ecological
relevant values [@gelman_scaling_2008]. As an example, the average temporal
trends estimated by $\beta_0$ in eq.\@ref(eq:gen) can only be interpreted when
all the $X_k = 0$. Without centering, it means that $\beta_0$ is interpretable
when the past anthropogenic pressures and the stream gradient are equal to 0.
Hence, we centered past antropogenic pressures and stream gradient around their
average values. The variables quantifying recent changes in anthropogenic
pressures was not centered, as 0 values indicate no recent changes in
anthropogenic pressures.  Time variable was not centered either because then the
main effects of the ecological drivers ($\sum_{k=1}\beta_k$) can be interpreted
as a baseline effect, i.e. when time is equal to 0.


The models were evaluated in a Bayesian framework using Integrated Nested
Laplacian Approximation (INLA), which approximates the posterior distribution of
the parameters and then do not rely on Markov chains and Monte Carlo
simulations, and then is a computationally efficient method to evaluate Bayesian
models [@rue_approximate_2009; @rue_bayesian_2017].  When estimating conjointly
the temporal trends at multiple locations, an advantage of the Bayesian approach
is the estimation of credible intervals around the temporal trends estimated at
each location. A second advantage is that it allows the computation of credible
intervals, which translates in the probability that an unobserved parameter
falls in a given interval, to the difference with frequentist approach
[@greenland_statistical_2016]. We computed the credible intervals at 80%, 90%
and 95% using Highest Posterior Density method [@hyndman_computing_1996]. When 0
is outside the credible intervals of the coefficients at 80%, 90% and 95%, they
can respectively be interpreted as weak, moderate and strong evidence of an
effect [@van_klink_meta-analysis_2020; @mastrandrea_guidance_2010]. The model
evaluation was performed with the `INLA` R package [@rue_approximate_2009].

INLA models were evaluated with defaults uninformative priors. The prior
distribution of fixed coefficients followed a flat zero centered normal
distribution ($\mathcal{N}(\mu,\, \sigma^2) = \mathcal{N}(0,\, 1000)$). The
prior distribution of the random effects and the gaussian error
($\epsilon_{it}$, eq. \@ref(eq:gen)) followed a log gamma distribution with
shape and inverse scale parameters ($\mathcal{G}(s, \, \tau) = \mathcal{G}(1, \,
5.10^-5)$). We then back-transformed the estimated coefficients to 
to the standard deviations attributed to the random effects and the
gaussian error ($\sigma = 1 / \sqrt{\tau}$). We checked that the slope
coefficients, random effects and the temporal trends by basin and site were
similar than with an implementation in frequentist. Then, we concluded that the
quality of parameter inference did not suffer from the uninformative priors.

We checked the model validity visually by plotting the fitted versus the
observed values (Fig. S6). We visually inspected the PIT and CPO (respectively
Posterior Integral Transform and Conditional Predictive Ordinate) distribution
to assess both the overall quality of fitting, and the frequency of outliers. 
There was very multicollinearity in the model, as all Variance Inflation Factors
were around 1 (Table S10).

We computed $R^2$ to assess the quality of the fit of the bayesian models.  We
then computed marginal ($R^2_m$)and conditional ($R^2_c$) R-squared,
respectively associated to the variance explained by fixed effects and the one
explained by both fixed and random effects [@nakagawa_general_2013]. We only
included the random effects on the intercept in the $R^2$ computation, i.e. the
basin effect ($a_n$) and the site effect ($a_{i|n}$), as the inclusion of the
variance attributed to random slopes is much complex and was shown to not change
the results [@nakagawa_general_2013; @lahuis_explained_2014]. 
We computed the variance associated of each predicted values from their
posterior distribution (`inla.rmarginal` in `INLA` R package),
following @gelman_r-squared_2019 recommendations to take in account the variability
associated with the priors ($\theta$). As we computed the variance of predicted values for
each observation, we computed R-squared values associated to each observation to
obtained the R-squared distribution [@gelman_r-squared_2019]. We then reported
the mean marginal and conditional R-squared associated the 95% credible
interval computed using the Highest Posterior Density method.  

$$
R^2_m = \dfrac{Var_{fit}}{Var_{fit} + Var_{res}} = \dfrac{\sigma^2(\hat{y_i})}{\sigma^2(\hat{y_i}) + \sigma^2(y_i - \hat{y_i})}
$$

$$
R^2_c = \dfrac{Var_{fit} + (a_n)^2 + (a_{i|n})^2}{Var_{fit}  + (a_n)^2 + (a_{i|n})^2 + Var_{res}}
$$

$y_i$ and $\hat{y_i}$ being respectively the observations and the
predicted values, $Var_{fit}$ and $Var_{res}$ being respectively the variance of
predictive means and the variance of the residuals, @gelman_r-squared_2019.
$a_n$ and $a_{i|n}$ are respectively the standard deviation on the random
intercept associated to the hydrographic basin and the site.


## Assessing the dimensionality of temporal community changes

We performed a PCA over the temporal trends of community metrics at the site
level to find the linear combination of variables that explained the most
variance and separates linearly uncorrelated variables. In complement, we
performed a clustering analysis to identity types of community trajectories. The
temporal trends for each biodiversity facet and site were extracted by the Best
Linear Unbiased Prediction method. We did not include the temporal trends of the
variables describing composition of non-native species as the they are part of
biodiversity [@schlaepfer_non-native_2018] and the changes in the proportion of
non-native species displayed little variation, then it was of little
interest to include them in the dimensionality analysis.

```{r}
tar_load(site_cl_rm)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", scales::percent((fnsite - sum(nb_clusters)) / fnsite),")"
)
```


We performed clustering using the trimmed k-means method [@fritz_tclust_2012], a
robust clustering method because it avoids the identification of spurious
clusters. The method consists of trimming the $\alpha$ most outlying data while
taking in account the multidimentional structure, the number of dimension being
the number of community metric. To choose a relevant number of clusters, we
plotted the trimmed log-likelihood of the function as a function of the
proportion of the most outlying data trimmed ($alpha$) (Fig. S7). We thus
selected a partition of temporal community changes in six clusters with
$\alpha=5\%$. We did not constraint the algorithm for the relative size of shape
of the clusters, as we had no apriori expectation about them. The clustering
algorithm was run for a minimum number of one hundred iterations and up to 125.
To further control for the quality of each fish community changes assignment to
a given cluster, we discarded any fish community for which the second best
cluster assignment was 50% better than the first one, we did so by comparing the
degree of affiliation to the clusters [@fritz_tclust_2012]. The clustering was
performed using `tclust` R package.


## Reproducibility and open science statement

The main text, the present document and the supplementary materials are written
in Rmarkdown, i.e. combining code and text, and are available on github. We
further implement a code pipeline using the `targets` R package to ensure that
all the code, the data, the figures, the manuscript and the results are up to
date.

# References {-}

<div id="refs"></div>


# Figure legends

```{r}
fig1_cap <- paste0(
  "**Responses of six community metrics to time, local
  anthropogenic pressures, stream gradient and their interaction**. Responses of
  dissimilarity based on the Simpson index, Turnover, Total abundance, Chao species
  richness, the proportion of non-native species and of non-native abundance.
  Time was quantified by the logged number of years since the first year of
  sampling at a given site added to one. The legacy of past anthropogenic
  pressures and the recent changes in anthropogenic pressures were quantified
  respectively by the Human Footprint index (1993) and the ratio between the
  Human Footprint at the year 2009 and 1993. The stream gradient was summarized
  by the first axis of a PCA preformed on the stream reach characteristics,
  related to the average annual discharge, the distance from the source, and the
  strahler order. All the predictors and responses were standardized prior to model
  evaluation. The Legacy of past anthropogenic pressures, quantified by the
  Human Footprint index (1993) was centered around its median value. Large,
  medium and thin bars depict respectively the Bayesian credible intervals at
  80, 90 and 95%. Please note the broken
  abscissa scale in the framed panels. N = ", fnop, " sampling events over ",
  fnsite, " sites.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

```{r} 
pca_clust_cap <- paste0("**PCA biplot on the temporal trends of the
  community metrics at each site, their cluster assignment (upper panel) and the
  boxplots describing the distribution of the temporal trends by cluster (lower
    panel)**. The temporal trends of each community metrics were derived from
  the model with time only. The temporal trends of community metrics were clustered using
  the k-means method while excluding 5% of the most outlying sites and sites
  with a doubtful assignement to a cluster were removed ", na_cluster, ".  The
  sites are colored by their cluster belongings. The ellipses represent the 95%
  interval around the clusters assuming a Student's t distribution. The
  clusters were named according to their unique characteristics.") %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

```{r}
map_cl_cap <- "**Spatial distribution of the clusters of biodiversity temporal
trends**. Top panel: spatial distribution of the the clusters with insets of
the most sampled hydrographic basins by realms. Right panel: cluster frequency
distribution in the three most represented Realms (in capital letters) and their
most sampled hydrographic basins, corresponding to the insets displayed on the left panel.
The number of sites are displayed between parenthesis."
```

- Figure 1: `r knitr::knit(text = fig1_cap)` 

- Figure 2: `r knitr::knit(text = pca_clust_cap)`

- Figure 3: `r knitr::knit(text = map_cl_cap)`

# Figures


```{r eff, fig.asp = 2.5, fig.width = 88* 0.0393701}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig1.pdf"))
```

```{r, fig.asp = .9, fig.width = 88 * 0.0393701}
# , fig.cap=pca_clust_cap
knitr::include_graphics(here("paper", "fig_paper", "fig2.pdf"))
```

```{r cl-map, fig.asp = .65, fig.width = 88* 0.0393701}
knitr::include_graphics(here("paper", "fig_paper", "fig3.pdf"))
```

# Table

```{r}

restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_abun", "perc_exo_sp")
names(restricted_dimension) <-
  get_var_replacement_vulgarisation()[restricted_dimension]

tar_load(c(gaussian_inla_rand, r2, clust_var, exo_resp_var))
library(coda)

tu <- r2 %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  mutate(
    r2_mvp_marg95hpd = map(r2_mvp_marg, ~HPDinterval(as.mcmc(.x))),
    r2_mvp_marg95hpdci = map2_chr(r2_mvp_marg95hpd, r2_mvp_marg_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
          "]")
      ),
    r2_mvp_cond95hpd = map(r2_mvp_cond, ~HPDinterval(as.mcmc(.x))),
    r2_mvp_cond95hpdci = map2_chr(r2_mvp_cond95hpd, r2_mvp_cond_mean,
      ~paste0(
        format(round(.y, 2), nsmall = 2),
        " [",
        format(round(.x[, "lower"], 2), nsmall = 2),
        ",",
        format(round(.x[, "upper"], 2), nsmall = 2),
          "]")
      )
  )

tab_rand <- gaussian_inla_rand %>%
  filter(
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
  select(-ci_level) %>%
  mutate(across(c(mean, low, high), ~round(., 3))) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    term = str_remove(term, "Precision for the |Precision for |"),
    term = replacement_random_term()[term],
    ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
  arrange(response, desc(term)) %>%
  select(
    `Response variable` = response,
    Term = term,
    `Standard deviation` = ci
  )

tab_rand2 <- tab_rand %>%
  left_join(
    tu %>%
      mutate(response = get_var_replacement_vulgarisation()[response]) %>%
      select(
        `Response variable` = response,
        `Marg. R2` = r2_mvp_marg95hpdci,
        `Cond. R2` = r2_mvp_cond95hpdci
        ),
    by = "Response variable"
  ) %>%
select(1, 4, 5, 2, 3) %>%
mutate(`Response variable` = factor(`Response variable`, levels =
    names(restricted_dimension))) %>%
arrange(`Response variable`)
```

```{r}
library(flextable)
tab_rand_cap <- "Marginal and conditional mean R-squared of the models and the mean standard deviation estimated for the random effect and the error terms. [95% CI]: Credible Interval computed using Highest Posterior Density method."
ft <- flextable(tab_rand2) %>%
  theme_zebra()
ft <- set_caption(ft, tab_rand_cap, 
  autonum = officer::run_autonum(seq_id = "tab", bkm = "rand"))
merge_v(ft, j = c("Response variable", "Marg. R2", "Cond. R2"))
```

