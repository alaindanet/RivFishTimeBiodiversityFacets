---
title: "Past and recent anthropogenic pressures drive community changes over space and time in riverine fish communities"
author: "Alain Danet, Xingli Giam, Julian D. Olden, Lise Comte"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    keep_tex: true
    spacing: double
    number_sections: false
  officedown::rdocx_document:
bibliography: "bibliography.bib"
csl: nature.csl
link-citations: true
toc: false
linestretch: 2.0
---

<!--always_allow_html: true-->
<!--header-includes:-->
  <!--- \usepackage[left]{lineno}-->
  <!--- \linenumbers-->
  <!--- \hypersetup{backref=true}-->

```{r setup, include=FALSE}
library(officedown)
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.path = "graphics/knitr-",
                      fig.retina = 1.618, # Control using dpi
                      fig.width = 6,  # generated images
                      fig.pos = "t",  # pdf mode
                      #fig.align = "center",
                      dpi = if (knitr::is_latex_output()) 72 else 300,
                      out.width = "100%",
                      dev = "svg",
                      dev.args = list(png = list(type = "cairo-png")),
                      optipng = "-o1 -quiet")

library(here)
source(here::here("R", "misc.R"))
source(here::here("R", "variable_shortcut.R"))
source(here::here("R", "basic_stat.R"))
source(here::here("R", "summary_distribution.R"))
library(tidyverse)
library(magrittr)
library(cowplot)
library(targets)
library(kableExtra)
library(coda)


if (Sys.info()["login"] == "alain")
  file.copy(
    from = "~/Documents/post-these/references.bib",
    to = here("paper", "bibliography.bib")
  )
```

```{r load-targets, include=FALSE}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))


fnsite <- nrow(filtered_dataset_modelling$location)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))

tar_load(inla_no_drivers_effects)
tar_load(c(trends, trends80, trends90))
tar_load(c(pred_number, pred_inla, pred_data_explanation))

restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_abun", "perc_exo_sp")
names(restricted_dimension) <-
  get_var_replacement_vulgarisation()[restricted_dimension]

tar_load(c(gaussian_inla_rand, r2, clust_var, exo_resp_var))
```
```{r}
table_to_vec <- function(x) {
  setNames(as.numeric(x), names(x))
}
get_comp <- function(
  pred = pred_number,
  type = "pred_hft93_t0",
  resp = NULL,
  lvl_comp = NULL
  ) {
  pred[[type]][[resp]][["mean"]][lvl_comp]
}
```
```{r}
tar_load(c(gaussian_inla_std_effects, gaussian_inla_exo_std_effects))
tu <- rbind(gaussian_inla_std_effects, gaussian_inla_exo_std_effects)
ci80 <- tu %>%
  filter(ci_level == "level:0.80")
ci90 <- tu %>%
  filter(ci_level == "level:0.90")
ci95 <- tu %>%
  filter(ci_level == "level:0.95")
```
```{r global-trends}
abun_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_total_abundance)
  * log(10 + 1),
  r = 1)
abun_trends <- str_replace(abun_trends, "\\[ ", "\\[")
rich_trends <- p_ci(
  log_beta_to_perc_rate(trends$log_chao_richness)
  * log(10 + 1),
  r = 1
)
hill_trends <- p_ci(
  trends$hillebrand_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
jac_trends <- p_ci(
  trends$jaccard_dis_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
tu_trends <- p_ci(
  trends$turnover_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)
ne_trends <- p_ci(
  trends$nestedness_scaled
  * log(10 + 1),
  r = 2, p = FALSE
)

exo_trends <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends90 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends90[[.x]] * log(10 + 1), r = 4, p = FALSE)
)
names(exo_trends90) <- c("perc_exo_sp", "perc_exo_abun")

exo_trends80 <- map_chr(c("perc_exo_sp", "perc_exo_abun"),
  ~p_ci(trends80[[.x]] * log(10 + 1), r = 3, p = FALSE)
)
names(exo_trends80) <- c("perc_exo_sp", "perc_exo_abun")
```

```{r}
tar_load(c(site_desc_loc, measurement))
tar_load(c(modelling_data, filtered_dataset_modelling, analysis_dataset))
tar_load(filtered_op_protocol_modelling)
tar_load(c(measurement_exo, modelling_data_exo))
tar_load(add_dataset_ref)

measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))
```



```{r}
nsitetot <- length(unique(site_desc_loc$siteid))
nmeas <- nrow(measurement)
nsp <- length(unique(measurement$species))
nop <- length(unique(measurement$op_id))
```

```{r}
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span)
    )

fnsite <- nrow(site_year)
fnmeas <- nrow(filtered_dataset_modelling$measurement)
fnsp <- length(unique(filtered_dataset_modelling$measurement$species))
fnop <- length(unique(filtered_dataset_modelling$measurement$op_id))

mspan <- median(site_year$span)
mcpl <- scales::percent(median(site_year$completeness))
mbl <- median(site_year$min)

eco <- table(filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  pull(ecoregion)
) / nrow(filtered_dataset_modelling$location)

per_eco <- scales::percent(table_to_vec(eco), accuracy = 1)

pays <- table(filtered_dataset_modelling$location$country
) / nrow(filtered_dataset_modelling$location)
pays_vec <- table_to_vec(pays)

per_pays <- scales::percent(sort(pays_vec, decreasing = TRUE), accuracy = 1)
per_s4pays <- scales::percent(sum(sort(pays_vec, decreasing = TRUE)[1:4]))

# Add database
```

```{r}
tss <- map(setNames(c("min", "completeness", "span"), c("min", "completeness", "span")),
  ~summary_distribution(site_year[[.x]])[c("median", "1st_quart", "2nd_quart")]
)
tss$min <- paste0(tss$min["median"], " [", tss$min["1st_quart"], ",", tss$min["2nd_quart"], "]")
tss$completeness <- round(tss$completeness * 100)
tss$completeness <- paste0(tss$completeness["median"], "% [", tss$completeness["1st_quart"], "%,", tss$completeness["2nd_quart"], "%]")
tss$span <- paste0(tss$span["median"], " [", tss$span["1st_quart"], ",", tss$span["2nd_quart"], "]")
```

```{r}
restricted_dimension <- c("log_total_abundance", "log_chao_richness",
  "perc_exo_sp", "perc_exo_abun", "hillebrand_dis_scaled", "turnover_scaled")

source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")
names(pal_variable) <- get_var_replacement_vulgarisation()[restricted_dimension]
```


```{r, results="hide", eval=FALSE}
word_count <- wordcountaddin::text_stats(here("paper", "main_text.Rmd"))
readable <- wordcountaddin::readability(filename = here("paper", "main_text.Rmd"), quiet = TRUE)
```

```{r, results = "hide", eval=FALSE}
word_count
```
- Now 3578 words without abstract and references (max NEE: 3500)

- Alain Danet: School of Biological Sciences, Illinois State University, Normal,
  Illinois, USA; School of Biosciences, University of Sheffield, Western Bank,
  S10 2TN, Sheffield, UK; https://orcid.org/0000-0002-1592-9483
- Xingli Giam: Department of Ecology and Evolutionary Biology, The University of
  Tennessee, Knoxville, Tennessee, USA
- Julian D. Olden: School of Aquatic and Fishery Sciences, University of
  Washington, Seattle, Washington, USA; https://orcid.org/0000-0003-2143-1187
- Lise Comte: School of Biological Sciences, Illinois State University, Normal,
  Illinois, USA; https://orcid.org/0000-0001-8030-0019

---
#- TODO:
#  - [ ] Is it possible to capture the number of spliting of fish species in the
#    database? (if not available, may be prepare a mail for fishbase)
#
#- Article guidelines by Nature in Ecology and Evolution:
#  - Main text – up to 3,500 words, excluding abstract, Methods, references and figure legends.
#  - Abstract – up to 200 words, unreferenced.
#  - Display items – up to 6 items (figures and/or tables).
#  - Extended Data – up to 10 items (figures and/or tables, linked from the main text in the html version of the paper).
#  - Article should be divided as follows:
#    - Introduction (without heading, up to 500 words of referenced text on the background of the work)
#    - Results (concise, focused account of the findings)
#    - Discussion
#    - Online Methods.
#- Results and Methods should be divided by topical subheadings; the Discussion does not contain subheadings.
#- References – as a guideline, we typically recommend up to 50.
---

\pagebreak

# Abstract (up to 200 words; now: 199)

Understanding local communities change is a pressing task for conservation,
especially in freshwater systems. It remains challenging because of the
complexity of biodiversity changes, driven by spatio-temporal heterogeneity of
human pressures. Using a compilation of riverine fish community timeseries
across three biogeographic realms, we assessed how past and recent anthropogenic
pressures drive community changes both in space and time. We found a global
increase of 13% in total abundance and 7% in species richness per decade driven
by historical anthropogenic pressures. We further found strong species
replacement of 30% per decade, with strong changes in species dominance,
consistent with previously reported biotic homogenization at broader spatial
scales. Our results suggest that the detrimental effects of anthropogenic
pressures on species richness and total abundance are compensated over time by
the establishment of non-native species. We also found a strong variation in
community changes and a high spatial heterogeneity in community trajectory at
the site scale, that could be held by the heterogeneity in the timing and the
degree of anthropogenic pressures, and in the position along stream gradient. We
suggest that accounting for the complexity of community changes and its drivers
is a crucial step to reach our conservation goals.


# Introduction (up to 500 words; now: 482 words)

Biological communities are undergoing dramatic reassembly in response to an
array of human impacts[@zavaleta_ecosystem_2009]. Changes in species composition
and not necessarily systematic reductions in local-scale species richness are
becoming increasingly recognized[@dornelas_assemblage_2014;
@blowes_geography_2019], resulting in ecosystem impacts manifested across large
spatial scales[@primack_biodiversity_2018; @moore_response_2017]. Accordingly,
there have been repeated calls for a better understanding of how heterogeneous
rates of species losses and gains across the landscape are driving shifts in
community structure over time[@mcgill_fifteen_2015]. This knowledge is
particularly needed for freshwater ecosystems, where vertebrate populations are
declining twice as fast as those in terrestrial or marine
systems[@tickner_bending_2020].

Land use conversion is a persistent and pervasive threat to freshwater
ecosystems[@reid_emerging_2019] with demonstrable effects on fish
biodiversity[@chen_threshold_2020; @comte_human_2021]. While dense urban and
cultivated areas are generally associated with reduced species richness and
total abundance in both vertebrates[@newbold_global_2015; @gal_effect_2019] and
invertebrates[@outhwaite_agriculture_2022; @chen_threshold_2020], human
activities also alter local community composition by favouring tolerant and
ubiquitous species that can cope with degraded
habitats[@tonella_importance_2018; @su_morphological_2020]. In particular,
non-native fish species can play a disproportionate role in the recomposition of
communities over time[@leprieur_fish_2008; @bernery_freshwater_2022;
@villeger_homogenization_2011], and have dramatic effects on native species when
they become invasive[@gallardo_global_2016], resulting in biotic homogenization,
i.e. a widespread convergence of historically distinct
faunas[@olden_defining_2006]. Anthropogenic pressures may therefore have
antagonistic effects on local diversity because habitat degradation is expected
to decrease native species richness and total abundance, while the spread of
non-native species is expected to increase local species richness and total
abundance[@mcgill_fifteen_2015; @primack_biodiversity_2018].

Understanding community changes therefore requires going beyond analyses of
changes in the number of species or individuals by considering concomitant
changes in the identity of species[@dornelas_assemblage_2014;
@blowes_geography_2019; @scott_native_2001; @hillebrand_biodiversity_2018]. In
addition, the spatial-temporal heterogeneity in the degree of anthropogenic
pressures[@venter_sixteen_2016] calls for more detailed investigations of
community changes across space, time, while accounting for environmental
gradient and anthropogenic pressures.

We tackled this challenge by assessing the effects of past and recent
anthropogenic pressures, and of the stream gradient on the changes of riverine
fish communities in space and time. To do so, we used a compilation of 4476
riverine fish community timeseries[@comte_rivfishtime_2021] that had been
repeatedly sampled over the last three decades (first survey year: `r tss$min`;
time span: `r tss$span` years; timeseries completeness: `r tss$completeness`; median
[25th quantile,75th quantile]) across three biogeographic
realms. We first estimated the mean temporal changes in species richness, total
abundance and community composition across communities, including the temporal
changes in the share of non-native species. We then investigated the covariation
and the typology of community temporal trends across different community
metrics, and analyzed their spatial distribution across spatial scales. We
finally assessed how these community changes could be traced back to the
spatio-temporal changes in human pressures and the position along the
longitudinal stream gradient. This study aims to advance the understanding of the
complexity of local community changes by addressing the effects of anthropogenic
pressures and thereby improve the knowledge necessarily to address the current
biodiversity crisis.

# Results


```{r}
extract_pred <- function (x = NULL, resp = NULL, val_to_extract = NULL) {

  ci_low <- x[[resp]]$quant0.025[val_to_extract]
  ci_high <- x[[resp]]$quant0.975[val_to_extract]

  # Does the ci at 95 overlap?
  ci_overlap <- ci_low[val_to_extract[1]] > ci_high[val_to_extract[2]] |
    ci_high[val_to_extract[1]] < ci_low[val_to_extract[2]]

  list(
    val = x[[resp]]$mean[val_to_extract],
    ci_overlap = !ci_overlap
  )
}
#' Get percentage of difference, the first value being the reference
get_ratio <- function(x, r = 1) {
  #reduce(x, `/`)
  out <- round((x[2] - x[1]) / x[1] * 100, r)
  paste0(out, "%")
}
```

```{r}
tar_load(pred_number)
```

```{r}
pred_hft93_t0 <- map(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0)),
  ~extract_pred(
    x = pred_number$pred_hft93_t0,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t0[[.x]]$val), r = 0)
)
other_hft93_int_max <- map_chr(
  setNames(names(pred_number$pred_hft93_t0), names(pred_number$pred_hft93_t0))[
    !names(pred_number$pred_hft93_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft9309_t0_inc <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_inc[[.x]]$val), r = 0)
)

other_hft9309_0_inc_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_inc[[.x]]$val, r = 0)
  )

pred_hft9309_t0_dec <- map(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t0,
    resp = .x,
    val_to_extract = c("0", "div/2")
  )
)

abun_rich_hft9309_0_dec_by2 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t0_dec[[.x]]$val), r = 0)
)

other_hft9309_0_dec_by2 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t0), names(pred_number$pred_hft9309_t0))[
    !names(pred_number$pred_hft9309_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t0_dec[[.x]]$val, r = 0)
  )
```

```{r}
pred_rivstr_t0 <- map(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0)),
  ~extract_pred(
    x = pred_number$pred_rivstr_t0,
    resp = .x,
    val_to_extract = c("min", "max")
  )
)

abun_rich_riv_int_max <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_rivstr_t0[[.x]]$val), r = 0)
)
other_riv_int_max <- map_chr(
  setNames(names(pred_number$pred_rivstr_t0), names(pred_number$pred_rivstr_t0))[
    !names(pred_number$pred_rivstr_t0) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_rivstr_t0[[.x]]$val, r = 0)
  )
```


```{r}
pred_hft93_t10 <- map(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10)),
  ~extract_pred(
    x = pred_number$pred_hft93_t10,
    resp = .x,
    val_to_extract = c("intact", "max")
  )
)

abun_rich_hft93_int_max_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft93_t10[[.x]]$val), r = 0)
)
other_hft93_int_max_t10 <- map_chr(
  setNames(names(pred_number$pred_hft93_t10), names(pred_number$pred_hft93_t10))[
    !names(pred_number$pred_hft93_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft93_t10[[.x]]$val, r = 0)
  )
```

```{r}
pred_hft9309_t10 <- map(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10)),
  ~extract_pred(
    x = pred_number$pred_hft9309_t10,
    resp = .x,
    val_to_extract = c("div/2", "inc/2")
  )
)

abun_rich_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(c("log_total_abundance", "log_chao_richness"),
    c("log_total_abundance", "log_chao_richness")),
  ~ get_ratio(exp(pred_hft9309_t10[[.x]]$val), r = 0)
)
other_hft9309_0_inc_by2_t10 <- map_chr(
  setNames(names(pred_number$pred_hft9309_t10), names(pred_number$pred_hft9309_t10))[
    !names(pred_number$pred_hft9309_t10) %in% c("log_chao_richness",
      "log_total_abundance")],
  ~ get_ratio(pred_hft9309_t10[[.x]]$val, r = 0)
  )
```


```{r}
sphft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "hft_ix_c93")
sphft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c93")


sphft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "hft_ix_c93")
sphft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "hft_ix_c93")
sphft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c93")

sphft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", r = 3)
sphft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", r = 3)
sphft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90", term = "hft_ix_c9309_log2_ratio", r = 2)
sphft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "hft_ix_c9309_log2_ratio", )
```
```{r, results = "hide"}
r2turn <- r2[r2$response == "turnover_scaled", ]$r2_mvp_cond95hpdci
r2rich <- r2[r2$response == "log_chao_richness", ]$r2_mvp_cond95hpdci
r2 %>%
  filter(response %in% restricted_dimension) %>%
  arrange(desc(r2_mvp_cond_mean))
```

## Average community temporal trends

Our results indicated strong average changes in riverine fish communities over
the last decades, with average increase in species richness and total abundance,
and changes in community composition were related to changes in species richness
and species identity but also changes in dominance structure, i.e. changes in
the identity of the dominant species. We estimated average community changes
with a hierarchical Bayesian model including the number of years since the first
survey as sole predictor and accounting for the variation at the river basin
and at the site levels (see Methods). More specifically, we found strong
evidence for an average increase over time in total community abundance (average
Credible Interval 95%: `r abun_trends` per decade, Fig. S1) and in species
richness (CI 95%: `r rich_trends` per decade). By contrast, we found an average
decline in the proportion of non-native species abundance (CI 90%:
`r exo_trends[["perc_exo_abun"]]` per decade), and no evidence for a net average trend in the
proportion of non-native species richness (CI 80%: `r exo_trends[["perc_exo_sp"]]` per
decade). We also found strong evidence of fast community reorganization, with an
average decline in community similarity of about 30% per decade when considering
either species relative abundances (Simpson dissimilarity, CI 95%: `r hill_trends` per decade, hereafter “temporal dissimilarity”) or occurrences
(Jaccard dissimilarity, CI 95%: `r jac_trends` per decade). The partition of
the Jaccard dissimilarity index into turnover, describing composition changes
arising from species replacement, and nestedness, describing changes arising
from species gains and losses from a common species pool, showed a comparable
increase over time (CI 95%: `r tu_trends` per decade; Fig. S2). This
indicated that riverine fish communities did not only experience changes in
species richness and in total abundance, but also important changes in species
identity.

## Typology of community temporal trends and their covariation

Our results indicated a low degree of covariation in the site level temporal
trends of the different community metrics and showed six distinct types of
community changes (Fig. 1). A Principal Component Analysis (PCA) indicated that
temporal trends in community composition, i.e. temporal dissimilarity and
turnover, were largely independent of temporal trends in species richness and
total abundance (axes CS1 & CS2 explaining 69% of the total variability among
fish communities; Fig. 1a). In addition, temporal trends in species richness and
total abundance on one hand and temporal dissimilarity and turnover on the other
hand tended to be negatively associated (axes CS3 & CS4 explaining 31% of the
variability among fish communities; Fig. 1b). We further highlighted six
distinct types of community trajectories (Fig. 1c) using a k-mean trimmed
clustering method (see Methods). The largest cluster was characterized by
moderate changes along all biodiversity dimensions: medium temporal increases in
species richness and total abundance, temporal dissimilarity and turnover
(‘medium change’; 40% of the sites). The second cluster was associated with
communities displaying a strong turnover but moderate increases in species
richness, total abundance and temporal dissimilarity (‘high turnover’; 16% of
the sites). The third, fourth and fifth clusters were characterized by temporal
community changes along a single dimension: a strong increase in species
richness (‘increase in species richness’; 13% of the sites), a strong decline in
total abundance (‘decrease in total abundance’; 12% of the sites) and a strong
decline in species richness (‘decrease in species richness’; 9% of the sites),
respectively. The last and smallest cluster was associated with communities that
remained relatively stable over time (‘low change’; 7% of the sites).

```{r}
tar_load(site_cl_rm)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", round((fnsite - sum(nb_clusters)) / fnsite * 100),"\\%)"
)
```

```{r}
pca_clust_cap <- paste0("**Covariation among the temporal trends in biodiversity metrics
and characterization of community trajectories**. **a**, **b**, PCA biplot of the community
temporal trends and their cluster assignment (upper panel). **c**, boxplots
displaying the distribution of the temporal trends by cluster (lower panel). The
sites are colored by their cluster belongings. The ellipses 95\\%
  intervals around the clusters assuming a Student’s t distribution. The
clusters were named according to their unique characteristics.",
" Sites not assigned to a cluster are not displayed ", na_cluster, ".") %>%
str_replace_all("\n|\r", " ") %>%
str_replace_all("  ", " ")
```


```{r eff, fig.cap = pca_clust_cap, fig.asp = .9, out.width = "80%"}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig2.pdf"))
```

Importantly, the different community trajectories were observed across all
biogeographic realms with similar frequencies, although some variability was
apparent across river basins (Fig. 2j). For instance, the Potomac basin (U.S.,
Fig. 2c) displayed relatively few sites associated with declines in total
abundance, but a much higher proportion of sites associated with a strong
turnover or low change in community composition. In contrast, the Thames basin
(U.K., Fig. 2d) displayed a lower proportion of sites associated with low
community changes and instead a higher proportion of sites displaying a decrease
in species richness and total abundance. We further found that the variance in
the temporal community trends was up to twice higher across sites rather than
across river basins for all community metrics (Table 1), indicating that the
biodiversity changes varied more within than between basins.

```{r}
map_cl_cap <- paste0("**Distribution of community trajectories**.
Insets of the most sampled Realms, namely I) Palearctic, II) Nearctic and III)
Australasia displaying the location of their three most sampled basins (a to i).
(j) Cluster frequency distribution in the three most represented Realms (in
capital letters) and their most sampled hydrographic basins, corresponding to
the insets (a to i). The numbers of sites are displayed
between parentheses. Site not assigned to a cluster are
not displayed ", na_cluster, ".") %>%
str_replace_all("  ", " ") %>%
str_replace_all("\n|\r", " ")
```

```{r cl-map, fig.cap=map_cl_cap, fig.asp = 1.1, out.width = "80%"}
knitr::include_graphics(here("paper", "fig_paper", "fig3_alt2.pdf"))
```

```{r}
tar_load(c(r2, gaussian_inla_rand))

ti <- r2 %>%
  filter(response %in% c(clust_var, exo_resp_var))
tab_rand <- gaussian_inla_rand %>%
  filter(
    term %in% paste0("Precision for ", c("main_bas1", "siteid1")),
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
select(-ci_level) %>%
mutate(across(c(mean, low, high), ~round(., 3))) %>%
mutate(
  response = get_var_replacement_vulgarisation()[response],
  term = str_remove(term, "Precision for the |Precision for |"),
  term = replacement_random_term_table()[term],
  ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
arrange(response, desc(term)) %>%
select(
  `Response variable` = response,
  `Spatial scale` = term,
  `Temporal trends s.d.` = ci
) %>%
  left_join(
    ti %>%
      mutate(response = get_var_replacement_vulgarisation()[response]) %>%
      select(
        `Response variable` = response,
        `Cond. R2` = r2_mvp_cond95hpdci
        ),
      by = "Response variable"
      ) %>%
select(1, 4, 2, 3) %>%
mutate(`Response variable` = factor(`Response variable`, levels = names(pal_variable))) %>%
arrange(`Response variable`)

tab_rand_cap <- "**R2 and temporal trend variation**. Mean conditional R2 are
reported. Variation in temporal trends according to the spatial scale is estimated from the
standard deviation of the random slope associated to time effects. [95\\% CI]:
Credible Interval computed using Highest Posterior Density method." %>%
str_replace_all("  ", " ") %>%
str_replace_all("\n|\r", " ")
```

```{r, eval=TRUE}
tab_rand %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap) %>%
  collapse_rows(columns = c(1, 2), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```

```{r, eval=FALSE, fig.cap = tab_rand_cap, fig.asp = .65, out.width = "50%"}
knitr::include_graphics(here("paper", "fig_paper", "table.png"))
```


## Drivers of community temporal trends

```{r}
hft93abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c93")
hft93hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")
hft93turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c93")

hft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 3)
hft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90", term = "log1_year_nb:hft_ix_c9309_log2_ratio", r = 2)
hft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80", term = "log1_year_nb:hft_ix_c9309_log2_ratio", )
hft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")
hft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95", term = "log1_year_nb:hft_ix_c9309_log2_ratio")

hft2abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio", r = 3)
hft2exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.80",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")
hft2turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:hft_ix_c93:hft_ix_c9309_log2_ratio")

rivhftabun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftrich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 4)
rivhftexor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftexoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhfthill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)
rivhftturn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c93", r = 3)

rivhft09abun <- get_effect_ci(resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 4)
rivhft09exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.90",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio", r = 3)
rivhft09hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")
rivhft09turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.80",
  term = "log1_year_nb:riv_str_rc1:hft_ix_c9309_log2_ratio")

riv1abun <- get_effect_ci(
  resp = "log_total_abundance", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1rich <- get_effect_ci(resp = "log_chao_richness", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exor <- get_effect_ci(resp = "perc_exo_sp", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", r = 2)
riv1exoa <- get_effect_ci(resp = "perc_exo_abun", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1", )
riv1hill <- get_effect_ci(resp = "hillebrand_dis_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")
riv1turn <- get_effect_ci(resp = "turnover_scaled", ci_lvl = "level:0.95",
  term = "log1_year_nb:riv_str_rc1")
```

Our results showed a higher degree of past anthropogenic pressures and more
downstream areas were associated with higher rates of species richness and total
abundance increase, while recent increases in anthropogenic pressures interacted
with past anthropogenic pressures to drive faster declines in total abundance.
Our results also showed that a higher degree of past anthropogenic pressures,
recent increases in anthropogenic pressures, and more downstream areas were all
associated with higher rates of increase in the share of non-native species,
faster rates of species replacement, and of changes in species dominance (Fig.
3).  We assessed the drivers of community changes over time using the same
hierarchical Bayesian models accounting for the variations at the basin and at
the site level, but adding the position along the stream gradient as well as the
degree of past and recent anthropogenic pressures and their interactions as
predictors. We assessed the effects of the drivers on community temporal trends
using their interaction with time. We captured the position of the fish
communities along the stream gradient using a synthetic PCA axis, with higher
values indicating more downstream areas associated with a higher Strahler order,
a higher distance from source, and a higher annual discharge. The degree of
anthropogenic pressures experienced by the fish communities and its recent
changes was assessed using the human footprint index[@venter_sixteen_2016]. We assessed past
anthropogenic pressures using the human footprint index of 1993 as only 7% of
the monitoring surveys were realized before this date (Fig. S4), while the
recent changes in anthropogenic pressures throughout the study period were
assessed using the ratio of the human footprint index between 2009 and
1993.Overall, the hierarchical spatial structure of the models captured well the
variance in the community changes, with the R² conditional on the random
intercepts varying from `r r2turn` (average [CI 95%]) for turnover to `r r2rich`
for species richness (Table 1), although the random effects explained more
variation than the fixed effects (Table S1).

Our results indicated that communities that had experienced a higher degree of
past anthropogenic pressures displayed faster rates of increased in terms of
increases in species richness, total abundance, temporal dissimilarity and
turnover, concomitant with faster increases in non-native species share, but
that these effects varied according to the position of the sites along the
stream gradient (Fig. 3). More specifically, we found strong evidence that a
higher degree of past anthropogenic pressures was associated with faster
increases in total abundance and species richness (resp. CI 95%:$\beta\prime =$
`r hft93abun` in blue and `r hft93rich` in green, Fig. 3a), these effects being
buffered in more downstream areas (resp. CI 80%:$\beta\prime =$ `r rivhftabun`
and CI 95%: $\beta\prime =$ `r rivhftrich`, Fig. 3b). We also found some
evidence that a higher degree of past anthropogenic pressures was associated
with an increase in the proportion of non-native richness over time (CI
80%:$\beta\prime =$ `r hft93exor`, yellow, Fig. 3a), and that this effect was
enhanced in more downstream areas (CI 90%:$\beta\prime =$ `r rivhftexor`, Fig.
3b). Although we did not find evidence for an overall effect of past
anthropogenic pressures on the rate of changes in non-native species abundance
(CI 80%:$\beta\prime =$ `r hft93exoa` in orange, Fig. 3a), we found moderate
evidence that a higher degree of past anthropogenic pressures resulted in a
higher rate of increase in non-native species abundance in the most downstream
areas (CI 90%:$\beta\prime =$ `r rivhftexoa`, Fig. 3b). Furthermore, we found
strong evidence that a higher degree of past anthropogenic pressures was
associated with a faster rate in temporal dissimilarity and turnover (resp. CI
95%:$\beta\prime =$ `r hft93hill` in red and `r hft93turn` in purple, Fig. 3a),
irrespective of the position along the stream gradient (resp. CI
80%:$\beta\prime =$ `r rivhfthill` and `r rivhftturn`, Fig. 3b). Lastly, we
found strong evidence that the stream gradient had an overall effect on the rate
of biodiversity changes over time, such as downstream areas experienced faster
rates of change for all the metrics considered: total abundance (CI
95%:$\beta\prime =$ `r riv1abun`, Fig. 3a), species richness (`r riv1rich`),
proportion of non-native species richness (`r riv1exor`), proportion of
non-native abundance (`r riv1exoa`), temporal dissimilarity (`r riv1hill`) and
turnover (`r riv1turn`).

Recent increases in anthropogenic pressures were found to hasten community
reorganization through increases in the share of non-native species and faster
rates of species replacement and changes in species dominance, but to counteract
overall increases in total abundance (Fig. 3).  More specifically, we found
strong evidence of an antagonistic effect between past and recent anthropogenic
changes on total abundance (CI 95%:$\beta\prime =$ `r hft2abun`, Fig. 3b), such
as the rate of increase observed across the historically most degraded sites was
lower when these sites experienced a recent increase in anthropogenic pressures
-- although we did not find evidence of an overall effect of recent
anthropogenic pressures on the temporal trends in total abundance (CI
80%:$\beta\prime =$ `r hft09abun`, Fig. 3a). By contrast, we did not find
evidence that recent changes in anthropogenic pressures mediated the effect of
historical ones (CI 80%:$\beta\prime =$ `r hft2rich`) or had an overall effect
on the temporal trends in species richness (CI 80%:$\beta\prime =$
`r hft09rich`, Fig. 3a), except through an interaction with the stream gradient
(CI 90%:$\beta\prime =$ `r rivhft09rich`, Fig. 3b). This indicated that recent
increases in anthropogenic pressures was associated with faster increases in
species richness over time only in the most downstream areas. When considering
the share of non-native species richness, we found moderate evidence that a
recent increase in anthropogenic pressures was associated with an increase in
the proportion of non-native species (CI 90%:$\beta\prime =$ `r hft09exor`, Fig.
3a). This effect was particularly pronounced in the historically most degraded
sites and in the most downstream areas (resp. CI 90%:$\beta\prime =$
`r hft2exor` and `r rivhft09exor`, Fig. 3b). We also found moderate evidence
that a recent increase in anthropogenic pressures resulted in a higher increase
in the proportion of non-native species abundance over time in the most
downstream sites (CI 90%:$\beta\prime =$ `r rivhft09exoa`, Fig. 3b), although
recent changes in anthropogenic pressures had no overall effect (CI 80%:
$\beta\prime =$ `r hft09exoa`, Fig. 3a). In addition, we found strong evidence
that a recent increase in anthropogenic pressures resulted in stronger temporal
dissimilarity and turnover (resp. CI 95%: $\beta\prime =$ `r hft09hill` and
`r hft09turn`, Fig. 3a). This effect was hastened in the most historically
degraded sites (resp. CI 95%:$\beta\prime =$ `r hft2hill` and `r hft2turn`, Fig.
3b), but not affected by the position of the sites along the stream gradient
(resp. CI 80%:$\beta\prime =$ `r rivhft09hill` and `r rivhft09turn`).

```{r}
fig1_cap <- paste0("Changes in riverine fish communities through time, anthropogenic pressures and
stream gradient. (a) single effects, (b) effects of anthropogenic pressures and
stream gradient on temporal trends, (c) interacting effects among anthropogenic
pressures and stream gradient on temporal trends.  Community metrics include
total community abundance, species richness, proportion of non-native species
and non-native abundance, Simpson dissimilarity, and turnover. Points depict the
average of posterior distribution. Large, medium and thin bars depict the
Bayesian credible intervals at 80, 90 and 95\\%, respectively. Please note the
broken abscissa scale in the framed panels. N = ", fnop," sampling events over ", fnsite,"
sites.") %>%
str_replace_all("  ", " ") %>%
str_replace_all("\n|\r", " ")
```

```{r fig1, fig.cap = fig1_cap, fig.asp = 2.5, out.width = "50%"}
#, fig.cap=fig1_cap
knitr::include_graphics(here("paper", "fig_paper", "fig1.pdf"))
```



## Drivers of community changes across space

Our results indicated strong community changes across space associated with
anthropogenic pressures and position along the stream gradient, particularly for
the share of non-native species (Fig. 3c). We evaluated evidences for effects of
the drivers on spatial community changes by assessing their single effects, i.e.
independent of time, using the same model as before (Fig. 3). We then report
comparison based on the model prediction as done in previous studies using space
for time substitution[@newbold_global_2015]. We found that a higher degree of
past anthropogenic pressures was associated with lower total abundance (strong
evidence; Fig. 3c, blue), with the most ‘degraded’ sites (i.e. with a human
footprint index = `r round(pred_data_explanation$hft_ix_c93["max"],1)`)
displaying a total abundance `r abun_rich_hft93_int_max["log_total_abundance"]`
lower than the most ‘intact’ sites (i.e. with a human footprint index =
`r round(pred_data_explanation$hft_ix_c93["intact"],1)`). In addition, we found
that a higher degree of past anthropogenic pressures was associated with higher
species richness (strong evidence; Fig. 3c, green), with the most degraded sites
displaying `r abun_rich_hft93_int_max["log_chao_richness"]` more species than
the most intact sites. Sites subjected to a higher degree of past anthropogenic
pressures also had a higher proportion of non-native richness and non-native
abundance (strong evidence; Fig. 3c, yellow and orange), such as the most
degraded sites had a proportion of non-native species richness twice higher than
intact sites (`r scales::percent(pred_hft93_t0$perc_exo_sp$val["max"])` versus
`r scales::percent(pred_hft93_t0$perc_exo_sp$val["intact"])`), and a proportion
of non-native species abundance three times higher
( `r scales::percent(pred_hft93_t0$perc_exo_abun$val["max"])` versus
`r scales::percent(pred_hft93_t0$perc_exo_abun$val["intact"])`).

In contrast, we found strong evidence that recent increases in anthropogenic
pressures were associated with communities displaying on average lower total
abundance and species richness but an increased share of non-native species
(Fig. 3c). More specifically, sites that had been subjected to a recent two-fold
increase in anthropogenic pressures displayed total abundance
`r abun_rich_hft9309_0_inc_by2["log_total_abundance"]` and species richness
`r abun_rich_hft9309_0_inc_by2["log_chao_richness"]` lower compared to sites
that had not undergone recent degradations. Similarly, a two-fold increase in
anthropogenic pressures was associated with a half higher proportion of
non-native species richness (+`r other_hft9309_0_inc_by2["perc_exo_sp"]`) and
abundance (+`r other_hft9309_0_inc_by2["perc_exo_abun"]`). The longitudinal
stream gradient was also associated with marked spatial variation. The most
downstream sites displayed three times more species than the most upstream
sites, as well as a higher proportion of non-native species richness
(+`r other_riv_int_max["perc_exo_sp"]`) and abundance
(+`r other_riv_int_max["perc_exo_abun"]`).

# Discussion

The global increase in species richness and total abundance over time,
accompanied by a strong species replacement and changes in dominant species,
indicate important ongoing changes in fish riverine communities. Interestingly,
although no net changes in species richness have been reported in terrestrial
and in marine systems[@vellend_global_2013; @dornelas_assemblage_2014;
@blowes_geography_2019], the global increase of 13% in total abundance per
decade estimated in this study closely matches the increase of 11% per decade
reported for freshwater insects[@van_klink_meta-analysis_2020]. It is also
consistent with several regional assessments of freshwater population trends in
the Paleartic, such as the reported increase in freshwater insect occupancy
documented in the UK or the increase in freshwater animal LPI (Living Planet
Index) in the Netherlands since the 1990s[@outhwaite_complex_2020;
@van_strien_modest_2016]. Nonetheless, this finding contrasts with dramatic LPI
declines reported at the global scale for freshwater fishes and particularly
megafauna as well as with other regional assessments of fish assemblages[e.g.,
@he_global_2019].

We found that these contrasted community changes could be traced back to the
spatio-temporal changes in human pressures and the position of the sites along
the longitudinal stream gradient. Indeed, higher past anthropogenic pressures
were associated with higher rates of species richness and total abundance
increases over time, suggesting a recovery from the legacy of past disturbances.
Previous studies suggested that the adoption of numerous legislations targeting
improvements in water quality in the E.U. and the U.S. since the 1970s, as well
as a decrease in the negative effects of agriculture could be partly responsible
for those increases despite the surrounding habitat
changes[@langford_long-term_2009; @van_klink_meta-analysis_2020;
@outhwaite_agriculture_2022]. The fact that most of our monitored sites (92%)
could be considered in an initial state of degradation at the beginning of the
study period, i.e. had a human footprint index > 4 in
1993[@williams_change_2020], could therefore lend support to the recovery
hypothesis.

However, a higher degree of past anthropogenic pressures was also associated
with a greater increasing share of non-native species, especially in downstream
areas. This indicates that non-native species contributed disproportionately to
the temporal changes observed in riverine fish communities. It follows that the
increase in local species richness over time could result from the differential
between introduction and extirpation from ongoing spatial homogenization[@villeger_homogenization_2011], as
already documented across river basins in the Nearctic and Palearctic realms[@villeger_homogenization_2011].
Metacommunity models also predicts that increases in dispersal result in
increase of local species richness, concomitant with a spatial homogenization[@mouquet_community_2003].
This is in line with findings that higher densities of human population, urban
areas and roads - all included in the human footprint index - can promote
non-native species richness by increasing propagule pressure, i.e. by increasing
the number and the frequency of introduction events[@anas_drivers_2021;
@leprieur_fish_2008; @bernery_freshwater_2022]. Anthropogenic pressures can
further increase the establishment success of non-native species that are often
ubiquitous and generalists[@tonella_importance_2018; @su_morphological_2020] by
modifying environmental conditions, and giving them a competitive advantage over
native species that are less adapted to the new conditions[@bernery_freshwater_2022;
@byers_impact_2002; @olden_life-history_2006; @haubrock_two_2021].

A higher degree of past anthropogenic pressures also resulted in higher rates of
species replacement and changes in species dominance over time. Taken together,
this suggests that the legacy effects of past habitat degradation are
characterised by shifts in dominant species and species identity towards species
that are better adapted to degraded environments, to which non-native species
contribute disproportionately[@toussaint_historical_2014;
@kuczynski_concomitant_2018]. However, a more definitive interpretation of those
increases in species richness and total abundance documented in freshwater
systems would require a precise assessment of habitat quality and of the
tolerance of the species composing the communities in the areas in a degraded
state, as native tolerant species might also contribute to the ongoing
changes[@mccune_gains_2013]. In this respect, considering species
characteristics such as their degree of anthropophily or habitat niche width,
may provide a more direct assessment of how the degree of ubiquity and
generalism changed over time in these communities.

Our results further show that past and recent anthropogenic pressures interact
to drive community changes, highlighting the importance of considering both the
degree and timing of anthropogenic pressure changes. For instance, the increase
in total abundance over time in the most historically degraded sites was not
observed when these sites were exposed to a recent increase in anthropogenic
pressures. In addition, past and recent anthropogenic pressures had a
synergistic effect, driving faster rates of increase of the share of non-native
species richness. Overall, it highlights that recent habitat degradation can
result in simultaneous negative effects on natives but positive effects on
non-natives. Furthermore, the highest recent increases in anthropogenic
pressures happened in current biodiversity hotspots[@venter_global_2016] while
our study has a spatial coverage limited to historically industrialized
countries. Then, our findings suggest that increases in species richness and
total abundance might not be universal phenomena and that more dramatic
community changes are to be expected at the global scale[@leprieur_fish_2008;
@he_global_2019].

Community changes over space, i.e. the space-for-time substitution expected to
capture long-term biodiversity changes, confirm those antagonistic effects of
anthropogenic pressures. Indeed, the most historically degraded sites were
characterised by a higher number of species, whereas the sites that had
experienced a recent increase in anthropogenic pressures displayed a
comparatively lower number of species. However, both the sites the most
historically degraded and those that underwent recent increases in anthropogenic
pressures displayed a lower total abundance. Overall those results are  in
accordance with the abundant literature showing that land degradation results in
lower species richness and total abundance over space[@newbold_global_2015;
@outhwaite_agriculture_2022]. Our results also suggest that community changes in
space reveal the effects of anthropogenic pressures at a longer timescale.
Indeed, while past and recent changes in anthropogenic pressures had no effect
on the temporal trends in the proportion of non-native species abundance, the
historically or recently degraded sites displayed an overall higher proportion
of non-native species abundance. This can be explained by the residence time of
non-native species between their first recorded introduction and successful
establishment, which includes time for biological acceptance and local
adaptation for example[@bernery_freshwater_2022].

Our results confirm that temporal changes in species composition can be
decoupled from changes in species richness, similarly to what has been observed
in marine and terrestrial communities[@dornelas_assemblage_2014;
@blowes_geography_2019]. We uncovered different community trajectories
characterised by changes along only one or several biodiversity dimensions,
i.e. changes in species richness, total abundance, turnover or medium/low
community changes over time. Those contrasted community trajectories likely
result from the complex mosaic in the degree and timing of anthropogenic
pressures. For example, the clusters related to temporal increases in total
abundance and species richness likely correspond to sites historically degraded
whereas the cluster associated with strong turnover may be related to recent
increases in anthropogenic pressures in historically degraded sites that
resulted in slow increase in species richness and total abundance, but fast
species replacement, due in part by the establishment of non-native species.
Overall, it suggests that the multidimensionality of community changes can be
traced back to the pressures that experienced those communities, calling for
further investigations on the drivers of heterogeneous community changes.

The location of the sites along the stream gradient also explains variation in
the temporal biodiversity trends, with the downstream sites experiencing faster
rates of community changes over time. It may be explained by the higher
connectivity of downstream sites with other tributaries, which in turn gives
more opportunity for local colonization[@altermatt_river_2013]. The stream
gradient position was also found to mediate the effect of anthropogenic
pressures, decreasing or enhancing the temporal biodiversity changes depending
on the community metric considered. It is thus not surprising that community
changes were found to be more heterogeneous at the local scale than at the basin
and realm scales. It may reflect the characteristics of riverine habitats, and
especially their dendritic structure and isolation within drainage basins, which
in turn determine environmental filtering and dispersal
opportunities[@dias_global_2014; @altermatt_river_2013]. Furthermore, we found
that the spatial structure of the model captured much more variance in the
community metrics than the fixed effects, confirming previous findings21. It
might be related to differences in community composition arising from
environmental drivers not included in our models such as climatic
factors[@dias_global_2014] and climate change[@comte_climate_2021;
@outhwaite_agriculture_2022], human-driven flow alteration[@reid_emerging_2019],
and the relative coarseness of anthropogenic
pressures.

Our study uncovered the complex associations between community changes and
anthropogenic pressures in riverine fish communities both in space and time. We
showed that the timing of anthropogenic pressures matters, because they can have
antagonistic effects on species richness and abundance, partly mediated by
non-native species. Overall, the concordance between our results at local scale
and the previously reported ongoing community homogenization at regional scale
highlights that linking biodiversity changes across spatial scales is crucial to
understand why reported local gains and global declines in biodiversity are not
contradictory[@vellend_plant_2017; @primack_biodiversity_2018;
@mcgill_fifteen_2015]. Thus, a promising area of investigation is to assess the
direct link between local community changes and biotic homogenization among
sites is a promising area of investigation[@leprieur_fish_2008;
@villeger_homogenization_2011; @toussaint_historical_2014;
@kuczynski_concomitant_2018]. Our study further highlights that considering
multiple biodiversity facets can help us understand the complex mechanisms by
which community reassemble. The increasing availability of community timeseries
and of environmental data across large areas is therefore invaluable to
understand how human pressures have affected and are persisting to affect
biodiversity across taxa and ecosystems, which is crucial to adequately
implement conservation policies.

# Methods




## Fish community time series

We used the RivFishTime database[@comte_rivfishtime_2021], a compilation of more than 12,000 time
series containing species abundances of riverine fish communities. The database
mainly covers western and northern Europe, northern America, and southeastern
Australia. We completed the database with time series from Canada and United
States (Table S2), following the same criteria as RivFishTime for
integration[@comte_rivfishtime_2021].

We selected time series having at least 5 years of data over a 10-year period as
well as a consistent sampling protocol. As several sites had been sampled using
different sampling methods (e.g. electrofishing, seining) and/or over different
periods of the year, we selected for each site only the sampling events that
were performed using the most frequent protocol (i.e. the mode) and within 1.5
month of the most frequently sampled month (i.e. 45 days before or after). When
there were several sampling events in a given year, we selected the sampling
that took place at the closest date from the most frequently sampled date of the
site. We further checked that the reported unit of abundance was consistent for
each time series. Finally, we excluded 1340 sites located in the long-term
Swedish liming program[@svenson_swedish_1995] to avoid the inclusion of numerous
manipulated sites.

The data selection resulted in `r fnsite` fish community time series, totalling
`r fnop` sampling events, `r fnmeas` species abundance records, and `r fnsp`
freshwater fish species. The median time span of the time series was of
`r tss$span` years ([25th quantile, 75th quantile]), their median completeness
was of `r tss$completeness` (see Fig. S4 for the complete distribution), while
the median first study year was `r tss$min`. The sites were mostly located in
Palearctic (`r per_eco["Palearctic"]`), Nearctic (`r per_eco["Nearctic"]`) and
Australasia (`r per_eco["Australasia"]`). Four countries gathered `r per_s4pays`
of the sites, namely Great Britain (`r per_pays["GBR"]`), France
(`r per_pays["FRA"]`), Sweden (`r per_pays["SWE"]`), and the United States
(`r per_pays["USA"]`, Table S3).


## Community metrics

```{r}
effort_unit <- table(
  filtered_op_protocol_modelling$unitabundance,
  is.na(filtered_op_protocol_modelling$sampledlength_m)
) / nrow(filtered_op_protocol_modelling)

u_no_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "TRUE"]
  )
)
u_tot_na_eff <- effort_unit[, colnames(effort_unit) == "TRUE"] /
  (effort_unit[, colnames(effort_unit) == "TRUE"] +
    effort_unit[, colnames(effort_unit) == "FALSE"])
per_u_tot_na_eff <- scales::percent(u_tot_na_eff)

u_eff <- scales::percent(
  table_to_vec(
    effort_unit[, colnames(effort_unit) == "FALSE"]
  )
)
u_eff <- scales::percent(table_to_vec(effort_unit[, 1]), accuracy = 1)

unitvec <- table(filtered_op_protocol_modelling$unitabundance) /
  nrow(filtered_op_protocol_modelling)

u_per <- scales::percent(table_to_vec(unitvec))
```

We assessed community changes in riverine fish communities using several
biodiversity facets related to species richness and total abundance, non-native
species and community composition (Table S4). Total abundance was reported in
number of individuals (`r u_per["Count"]` of the sampling events), density of
individuals per 100 $m^2$ (`r u_per["Ind.100m2"]`), Catch Per Unit Effort
(`r u_per["CPUE"]`), and Leslie index (`r u_per["Leslie_index"]`, Table S3).
Although we selected for strict protocol consistency, 70% or more of the
sampling events by unit of abundance did not report sampling effort, preventing
us from harmonising count, abundance density and Catch Per Unit
Effort[@comte_rivfishtime_2021].

```{r}
#see adjust_abun_chao()
cor_chao_rich <-  cor(
  modelling_data$chao_richness,
  modelling_data$species_nb,
  method = "spearman") %>%
round(., 2)

cor_log_chao_rich <-  cor( modelling_data$log_chao_richness,
  modelling_data$log_species_nb, method = "spearman") %>% round(., 2)
```

As sampled species richness is a negatively biased estimator of the “true”
species richness, we corrected sampled species richness with the coverage-based
rarefaction and extrapolation methodology[@chao_coverage-based_2012]. The
estimated coverage of a sample is positively related to the number of
individuals and negatively related to the number of singletons. We fixed the
coverage of all samples at 98.5% via rarefaction and extrapolation using the R
package iNEXT[@hsieh_inext_2016] to make species richness comparable across
samples. We did not always have a direct estimate of the number of individuals
and number of singletons to compute the sampling coverage, as
`r u_per["Ind.100m2"]` of the abundances were measured as density by 100  and
`r u_per["CPUE"]` as Catch per Unit Effort. In this case, we first divided each
species abundance ($x_i$) by the minimum values of abundance in the community
(i.e. $x^{\prime}_i = 1 / min(x_i)$), which we further rounded so that each
community had at least one singleton species, i.e. a species with one
individual. The correlation was very high between raw species richness and Chao
richness (Spearman's $\rho =$ `r cor_chao_rich` for both raw variables and log
transformed ones, Fig. S5).

```{r}
nat_ori <- table(measurement_exo$native_exotic_origin) / nrow(measurement_exo)
nat_per <- scales::percent(table_to_vec(nat_ori), accuracy = 0.1)
nat_per2 <- scales::percent(table_to_vec(nat_ori), accuracy = 0.01)
sp_country_handmade <- measurement_exo %>%
  filter(native_exotic_origin == "handmade") %>%
  distinct(species, country)
```

The biogeographic origin of the fish species describing whether species were
native or introduced to a given drainage basin was retrieved using a global
database[@tedesco_global_2017] (`r nat_per["tedesco"]` of the species
occurrences). For the sites falling outside the river basins provided in the
global database[@tedesco_global_2017], such as for the sites located close to
the shore, we used the closest basin within the same country. For species not
included in a given drainage basin, we determined the origin of the species at
the country scale using Fishbase[@froese_fishbase_2021]
(`r nat_per["autofishbase"]` of species occurrences). Given the spatial extent
of the United States, we completed the global database with the Nonindigenous
Aquatic Species (NAS) database developed by the U.S. Geological Survey
(https://nas.er.usgs.gov/) using U.S. states as spatial grain (`r nat_per2["usgs"]`
of the species occurrences). We completed the remaining
species origins at the country scale, using national atlases and Fishbase data
in neighbouring countries, such as *Piaractus brachypomus* and *Rutilus rutilus*
in the United States (`r nat_per["handmade"]` of the species occurrences, Table
S6). We then estimated the percentage of non-native species for each sampling
event, both for species richness and abundances (Table S7).

### Dissimilarity metrics

We characterised temporal dissimilarity in community composition in each site,
taking the first year of sampling of a community as the reference community. We
first used the complement of the Jaccard similarity index (J). This index is
based on presence/absence and is simply the sum of species gains and losses over
the total number of species across two samples (eq. \@ref(eq:jac)). It thus
measures the proportion of species not shared between two samples.

\begin{equation}
  J = \dfrac{S_{gain} + S_{loss}}{S_{tot}}
  (\#eq:jac)
\end{equation}

with $S_{gain}$, $S_{loss}$, $S_{tot}$ being the numbers of immigrant,
extirpated and total species respectively.

We further partitioned the Jaccard dissimilarity index into two sets of
complementary indices. The first set was Turnover ($J_t$) and Nestedness
($J_n$), respectively $J_t = (2 * min(S_{loss}, S_{gain})) / (S_{common} + (2 *
min(S_{loss}, S_{gain})))$ and $J_n = 1 - J_t$[@baselga_betapart_2012] ,
$S_{common}$ being the number of species present in both communities. High
Turnover values indicate that the changes in community composition resulting
from species replacement, whereas high values of Nestedness indicate species
gains or losses from a nested community, i.e. that a community is a subset of
the other[@baselga_temporal_2015]. The second set was Appearance and
Disappearance, respectively the proportion of colonizing species ($S_{gain} /
S_{tot}$) and the proportion of extirpated species ($S_{loss} / S_{tot}$).

We further characterised temporal dissimilarity with the Simpson-based
dissimilarity index[@hillebrand_biodiversity_2018] ($H_d$, eq. \@ref(eq:hill)). This
index is based on species relative abundances and their variation across two
samples. Simpson-based dissimilarity index is based on the Simpson diversity
index and thus gives higher weight to changes in the abundant species, whereas
Jaccard dissimilarity index gives equal weight to each species. Simpson-based
dissimilarity index thus quantifies the extent of changes in the identity of
dominant species[@hillebrand_biodiversity_2018]. Both high Jaccard and Simpson
dissimilarity values indicate changes in composition resulting from changes in
the abundant species, whereas conjointly high Jaccard and low Simpson
dissimilarity values indicate composition changes resulting from changes in the
species with low relative abundances.

\begin{equation}
\begin{aligned}
H_d &= 1 - H \\
H_d &= 1 - \dfrac{\sum_i (p_i - p^{\prime}_i)^2}{\sum_i p_i^2 + \sum_i p^{\prime2}_i - \sum_i p_i p^{\prime}_i}
(\#eq:hill)
\end{aligned}
\end{equation}

with $i$: species $i$, $p$: relative abundance and $\prime$: the focal community




## Environmental drivers

```{r}
n_na_riveratlas <- analysis_dataset[is.na(analysis_dataset$log_dist_up_km), ] %>%
  distinct(siteid) %$% nrow(.)
v_rvat <- scales::percent(
  (nrow(analysis_dataset) - n_na_riveratlas) /
    nrow(analysis_dataset)
  )

nb_op9309 <- sum(
  filtered_op_protocol_modelling$year >= 1993 &
  filtered_op_protocol_modelling$year <= 2009
)
perc_op9309 <- scales::percent(nb_op9309 / nrow(filtered_op_protocol_modelling))

nb_opb93 <- sum(
  filtered_op_protocol_modelling$year < 1993
)
perc_opb93 <- scales::percent(nb_opb93 / nrow(filtered_op_protocol_modelling))
nb_opa09 <- sum(
  filtered_op_protocol_modelling$year > 2009
)
perc_opa09 <- scales::percent(nb_opa09 / nrow(filtered_op_protocol_modelling))
```

```{r}
tar_load(pca_riv_str)
perc_var_rc1 <- pca_riv_str$rotated$Vaccounted["Proportion Var", "RC1"] %>%
  scales::percent(.)
tar_load(riveratlas_site)
env <- riveratlas_site[,
        colnames(riveratlas_site) %in%
          c("siteid", setNames(get_river_atlas_significant_var(), NULL))
        ] %>%
          sf::st_drop_geometry() %>%
          mutate(
              riv_str_rc1 =  pca_riv_str$rotated$scores[, "RC1"],
              riv_str_rc2 =  pca_riv_str$rotated$scores[, "RC2"]
          )
cor_env <- cor(env[, colnames(env) != "siteid"], method = "spearman") %>%
  round(., 2)
cor_env_rc1 <- cor_env["riv_str_rc1", ]
```

In dendritic networks, the environmental heterogeneity and connectivity along
the longitudinal (upstream-downstream) gradient strongly shape species
occurrences, immigration rates and community composition[@altermatt_river_2013].
To capture this stream gradient, we described stream characteristics at each
site by the altitude (m), slope (deg.), average annual discharge ($m^3.s^{-1}$),
distance from source (km), and Strahler order that we extracted from the
HydroAtlas database[@linke_global_2019; @robinson_earthenv-dem90_2014]. We did
so by snapping the sites to the closest stream segment using a one-kilometre
buffer (`r v_rvat` of the sites). We performed a Principal Component Analysis
over the site stream characteristics after log transforming (added absolute
minimum values plus one to avoid negative values, $x^{\prime}_i = x_i + min(x_i)
+ 1$)) and standardising all the variables, i.e. centring and scaling. We
orthogonally rotated the two first principal components using the varimax
criterion[@kaiser_varimax_1958], to increase the quality of the variable
representation (i.e. their loadings) on the two first principal components.
The first rotated component was positively related to average annual
discharge, distance from source and Strahler order and capturing
`r perc_var_rc1` of the variance (Fig. S6), and was subsequently used as a
composite variable describing the stream gradient from upstream to downstream.

We quantified the degree of anthropogenic pressures using the human footprint
index[@venter_global_2016; @venter_sixteen_2016]. The human footprint index aggregates an array of human pressures,
including population density, the extent of forested, cropland and pastureland
areas, but also the extent of built environments such as roads, railways,
electric infrastructures, and navigable pathways (Fig. S7). It does so by
combining remote sensing data, systematic surveys and modelling from ground
data, making it less prone to errors[@venter_global_2016]. The human footprint index ranges from 0
to 50, with values superior to four being considered in a degraded state[@williams_change_2020]. This
index has been previously related to species extinction and risk of biological
invasion25,26. To capture both the effects of the legacy of past anthropogenic
pressures and of its recent changes, we considered the human footprint index
computed in 1993 and 2009 (i.e. 16 years span). Specifically, the human
footprint index of 1993 was used as a measure of past anthropogenic pressures
and the ratio between the human footprint of 2009 and 1993 as a measure of the
recent changes in anthropogenic pressures. In order to obtain interpretable
coefficients of recent changes in human footprint, we log-transformed the ratio
of human footprint with a base 2, such as a value of -1 and 1 represent a
division by two and a multiplication by two of the human footprint between 1993
and 2009, respectively. Only `r perc_opb93` of the samplings took place before 1993, while
`r perc_op9309` took place between 1993 and 2009 and `r perc_opa09` after 2009 (Fig. S4). The human
footprint index values were extracted from the HydroAtlas database at the reach
scale[@linke_global_2019] (original resolution of 450 meters). The human footprint indexes of 1993
and 2009 were not correlated with the stream gradient (Spearman’s  of
`r cor_env_rc1["hft_ix_c93"]` and `r cor_env_rc1["hft_ix_c09"]` respectively).

We quantified the degree of anthropogenic pressures using the human footprint
index[@venter_global_2016; @venter_sixteen_2016]. The human footprint index
aggregates an array of human pressures, including population density, the extent
of forested, cropland and pasture land areas, but also the extent of built
environments such as roads, railways, electric infrastructures, and navigable
pathways (Fig.  S7). It does so by combining remote sensing data, systematic
surveys and modelling from ground data, making it less prone to
errors[@venter_global_2016]. The human footprint index ranges from 0 to 50, with
values superior to four being considered in a degraded
state[@williams_change_2020]. To capture both the effects of the legacy of past
anthropogenic pressures and its recent changes, we considered the human
footprint index computed in 1993 and 2009 (i.e. 16 years span). Specifically,
the human footprint index of 1993 was used as a measure of the legacy of past
anthropogenic pressures and the ratio between the human footprint of 2009 and
1993 as a measure of the recent changes in anthropogenic pressures.  In order to
obtain interpretable coefficients of recent changes in human footprint, we
log-transformed the ratio of human footprint with a base 2. Then, a value of
minus one and one represent a division by two and a multiplication by two of the
human footprint between 1993 and 2009, respectively. Only `r perc_opb93` of the
samplings took place before 1993, while `r perc_op9309` took place between 1993
and 2009 and `r perc_opa09` after 2009 (Fig. S4). The human footprint index
values were extracted from the HydroAtlas database at the reach
scale[@linke_global_2019] (original resolution of 450meters). The human
footprint indexes of 1993 and 2009 were not correlated with the stream gradient
(Spearman's $\rho$ of `r cor_env_rc1["hft_ix_c93"]` and
`r cor_env_rc1["hft_ix_c09"]` respectively).

```{r}
# Resolution of hydrorivers:
#https://www.hydrosheds.org/products/hydrorivers
```



## Statistical analysis

We modelled the temporal trends of the different biodiversity facets ($Y$) as
dependant of time ($\beta_0Time_t$, eq. \@ref(eq:gen)) measured as the number of
years since the beginning of the sampling at each site with $t_0 = 0$, the
stream gradient measured by the rotated PCA axis over stream characteristics,
the legacy of past anthropogenic pressures measured by the human footprint index
of 1993, and the recent changes in anthropogenic pressures measured by the ratio
between the human footprint index of 2009 and 1993. We included all the
predictors as main effects ($\sum_{k=1}\beta_kX_k$) to capture the differences
in biodiversity facets attributed to spatial effects of the ecological drivers.
We further included interactions between time and the ecological drivers
($\sum_{k=0, l\neq k}\beta_{kl}X_kX_l$) to test how stream gradient and
anthropogenic pressures affect the temporal trends in biodiversity facets.
Finally, we included the triple interactions between time and the pairs of other
ecological drivers ($\sum_{k=0, m \neq n\neq k}\beta_{kmn}X_kX_mX_n$) to test
for the presence of synergistic or antagonistic effects of the stream gradient
and anthropogenic pressures on the temporal trends in biodiversity facets. A
version of the model included time as sole predictor (i.e. only $\beta_0Time_t$)
was used to assess average community temporal trends.

Furthermore, the statistical model (eq. \@ref(eq:gen)) was adapted according to the
nature of the variables, namely total abundance and dissimilarity metrics. For
total abundance, we added the measurement unit of abundance as a categorical
variable both as a main effect and in interaction with
time[@van_klink_meta-analysis_2020]. We set raw count as the reference factor
level such as the temporal trends in total abundance in
the main text and supplementary materials are expressed in raw count. We
modelled dissimilarity metrics with the intercept fixed at zero as dissimilarity
metrics at each site was 0 at the beginning of the time series. Furthermore, we
did not include the main effects of ecological drivers ($\sum_{k=1}\beta_kX_k$
term from eq. \@ref(eq:gen)) in the modelling of dissimilarity metrics, i.e. we
only included the effects of ecological drivers on the temporal trends. We did
so because dissimilarity metrics were relative to the site and bounded between 0
and 1, so we did not expect average differences in dissimilarity which are not
due to differences in the temporal trends.

We accounted for the spatial structure of the data by adding random effects to
the intercept ($\alpha$) and the slope of the temporal trends ($\beta_0$) on the
basin identity ($n$) and on the site identity ($i$), nested in basin ($i|n$).
The random effects and the error terms were modelled as a Normal distribution of
mean 0 and variance ($\sigma^2$).

\begin{equation}
\begin{aligned}
    Y_{i|n, t} &= \alpha + \beta_0Time_t + \sum_{k=1}\beta_kX_k + \sum_{k=0, l\neq k}\beta_{kl}X_kX_l + \sum_{k=0, m \neq l\neq k}\beta_{klm}X_kX_lX_m + \epsilon_{i|n, t}
  (\#eq:gen)
\end{aligned}
\end{equation}


- $\alpha = \alpha_0 + a_n + a_{i|n}$
- $\beta_0 = \mu + b_n + b_{i|n}$
- $k, l, m \in [1,2,3]$: ecological drivers including stream gradient, legacy of past and recent changes in anthropogenic pressures
- $a_n, a_{i|n}, b_n, b_{i|n}, \epsilon_{i|n, t} \sim \mathcal{N}(0,\,\sigma^{2})$
- $n$: hydrographic basin, $i$: site $i$, $t$: time $t$

All the response variables were modelled with a Gaussian distribution following
previous studies modelling temporal trends of community composition, species
richness and total abundance at the global scale[@dornelas_assemblage_2014;
@blowes_geography_2019; @van_klink_meta-analysis_2020]. Other error structures might
be more appropriate to model response variables bounded between 0 and 1 and
representing ratio of discrete numbers such as the dissimilarity metrics and the
proportion of non-native species. However, doing so allows to obtain easily interpretable
coefficients across all biodiversity facets (e.g. temporal trends are not
interpretable as rates of change when modelled using a logit scale such as when
using a beta distribution). In addition, a previous study using similar
models[@blowes_geography_2019] found that slope coefficients estimated with a
gaussian error and a beta error had a Spearman correlation superior to 0.90 and
give qualitatively similar results. We therefore believe that this choice is not
likely to alter our conclusions.


```{r}
tar_load(tab_waic)
perc_dec_waic <- scales::percent(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]]) / tab_waic[["Year nb"]]))
dec_waic <- round(mean((tab_waic[["Log (Year nb + 1)"]] - tab_waic[["Year nb"]])))
```

We log-transformed the number of years as $\log(year + 1)$ as it improved the
quality of the model fitting to the data, decreasing the
WAIC[@gelman_understanding_2014; @vehtari_practical_2017] by `r dec_waic` in
average (`r perc_dec_waic`) (Table S11). It
suggests the presence of non-linearity in the temporal trends, which is
particularly expected in the case of bounded variables such as the dissimilarity
metrics. The rate of community change per decade is then found for a time
value of $\log(10 + 1)$, i.e. `r round(log(10 + 1), 2)`. We log-transformed total abundance and
Chao species richness, then their temporal trends are multiplicative and can be
expressed in percentage change by unit of time. We derived percentage change by
decade in species richness and total abundance by back transforming $\beta_0$
such as: $(e^{\beta_0 \times \log(10 + 1)} - 1) \times 100$.

In order to compare the magnitude of the effects of time, stream gradient, and
anthropogenic pressures among biodiversity facets and to compare the magnitude
of the effects of the predictors, we scaled both biodiversity facets and the
predictors by their standard deviation prior to the model fitting.
As our models contain interactions, the individuals slope coefficients could be
difficult to interpret without centering the predictors around ecological
relevant values[@gelman_scaling_2008]. As an example, the average temporal
trends estimated by $\beta_0$ in eq.\@ref(eq:gen) can only be interpreted when
all the $X_k = 0$. Without centering, it means that $\beta_0$ is interpretable
when the past anthropogenic pressures and the stream gradient are equal to 0.
Hence, we centered past anthropogenic pressures and stream gradient around their
average values. The variables quantifying recent changes in anthropogenic
pressures was not centered, as 0 values indicate no recent changes in
anthropogenic pressures.  Time variable was not centered either because then the
main effects of the ecological drivers ($\sum_{k=1}\beta_k$) can be interpreted
as a baseline effect, i.e. when time is equal to 0.

The models were evaluated in a Bayesian framework using Integrated Nested
Laplacian Approximation[@rue_approximate_2009; @rue_bayesian_2017] (INLA), which
approximates the posterior distribution of the parameters and then do not rely
on Markov chains and Monte Carlo simulations, and thus is a computationally
efficient method to evaluate Bayesian models. When estimating conjointly the
temporal trends at multiple locations, an advantage of the Bayesian approach is
the estimation of credible intervals around the temporal trends estimated at
each location, which translates in the probability that an unobserved parameter
falls in a given interval, to the difference with the frequentist
approach[@greenland_statistical_2016]. We computed the credible intervals at
80%, 90% and 95% using the Highest Posterior Density
method[@hyndman_computing_1996]. When 0 is outside the credible intervals of the
coefficients at 80%, 90% and 95%, they can respectively be interpreted as weak,
moderate and strong evidence of an effect[@van_klink_meta-analysis_2020;
@mastrandrea_guidance_2010]. The model evaluation was performed with the `INLA`
R package[@rue_approximate_2009].


INLA models were evaluated with defaults uninformative priors. The prior
distribution of fixed coefficients followed a flat zero centered normal
distribution ($\mathcal{N}(\mu,\, \sigma^2) = \mathcal{N}(0,\, 1000)$). The
prior distribution of the random effects and the gaussian error
($\epsilon_{it}$, eq. \@ref(eq:gen)) followed a log gamma distribution with
shape and inverse scale parameters ($\mathcal{G}(s, \, \tau) = \mathcal{G}(1, \,
5.10^-5)$). We then back-transformed the estimated coefficients to
to the standard deviations attributed to the random effects and the
gaussian error ($\sigma = 1 / \sqrt{\tau}$). We checked that the slope
coefficients, random effects and the temporal trends by basin and site were
similar than with an implementation in frequentist. Then, we concluded that the
quality of parameter inference did not suffer from the uninformative priors.

We checked the model validity visually by plotting the fitted versus the
observed values (Fig. S8). We visually inspected the PIT and CPO (respectively
Posterior Integral Transform and Conditional Predictive Ordinate) distribution
to assess both the overall quality of fitting, and the frequency of outliers.
There was very multicollinearity in the model, as all Variance Inflation Factors
were around 1 (Table S3).

We computed $R^2$ to assess the quality of the fit of the bayesian models.  We
then computed marginal ($R^2_m$)and conditional ($R^2_c$) R-squared,
respectively associated to the variance explained by fixed effects and the one
explained by both fixed and random effects [@nakagawa_general_2013]. We only
included the random effects on the intercept in the $R^2$ computation, i.e. the
basin effect ($a_n$) and the site effect ($a_{i|n}$), as the inclusion of the
variance attributed to random slopes is much complex and was shown to not change
the results [@nakagawa_general_2013; @lahuis_explained_2014]. We computed the
variance associated of each predicted values from their posterior distribution,
following  recommendations to take in account the variability associated with
the priors[@gelman_r-squared_2019] ($\theta$). As we computed the variance of
predicted values for each observation, we computed $R^2$ values associated to
each observation to obtained the $R^2$ distribution[@gelman_r-squared_2019]. We
then reported the mean marginal and conditional $R^2$ associated the 95%
credible interval computed using the Highest Posterior Density method.

$$
R^2_m = \dfrac{Var_{fit}}{Var_{fit} + Var_{res}} = \dfrac{\sigma^2(\hat{y_i})}{\sigma^2(\hat{y_i}) + \sigma^2(y_i - \hat{y_i})}
$$

$$
R^2_c = \dfrac{Var_{fit} + (a_n)^2 + (a_{i|n})^2}{Var_{fit}  + (a_n)^2 + (a_{i|n})^2 + Var_{res}}
$$

$y_i$ and $\hat{y_i}$ being respectively the observations and the predicted
values, $Var_{fit}$ and $Var_{res}$ being respectively the variance of
predictive means and the variance of the residuals[@gelman_r-squared_2019].
$a_n$ and $a_{i|n}$ are respectively the standard deviation on the random
intercept associated to the hydrographic basin and the site.


## Typology of temporal trends

We performed a PCA over the temporal trends of community metrics at the site
level to find the linear combination of variables that explained the most
variance and separates linearly uncorrelated variables. In addition, we
performed a clustering analysis to identify types of community trajectories. The
temporal trends for each community metrics at the site level were extracted
using the Best Linear Unbiased Prediction method. We did not include the
temporal trends of the variables describing composition of non-native species as
the they are already included in the community
metrics[@schlaepfer_non-native_2018] and the temporal trends in the proportion
of non-native species displayed little variation compared to the other metrics.


We performed clustering using the trimmed k-means method[@fritz_tclust_2012], a robust clustering
method because it avoids the identification of spurious clusters. The method
consists of trimming the $\alpha$ most outlying data while taking in account the
multidimentional structure, the number of dimensions being the number of
community metrics. To choose a relevant number of clusters, we plotted the
trimmed log-likelihood of the function as a function of the proportion of the
most outlying data trimmed ($\alpha$) (Fig. S9). We thus selected a partition of
temporal community changes in six clusters with $\alpha=5\%$ (See Fig. S10 with four
clusters). We did not constraint the algorithm for the relative size or shape of
the clusters, as we had no a priori expectation about them. The clustering
algorithm was run for a minimum number of one hundred iterations and up to 125.
To further control for the quality of each fish community changes assignment to
a given cluster, we discarded any fish community for which the second-best
cluster assignment was 50% better than the first one, we did so by comparing the
degree of affiliation to the clusters[@fritz_tclust_2012]. The clustering was performed using
`tclust` R package.


## Reproducibility and open science statement

The manuscript and the supplementary materials are written in Rmarkdown,
i.e. combining code and text, and are available on github. We further
implemented a code pipeline using the `targets` R package to ensure that all the
code, the data, the figures, the manuscript and the results are up to date.

# References {-}

<div id="refs"></div>



