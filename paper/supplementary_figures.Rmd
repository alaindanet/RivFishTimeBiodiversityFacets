---
title: "Supplementary Figures and Tables"
subtitle: "Past and recent anthropogenic pressures drive rapid changes in riverine fish communities"
author: "Alain Danet, Xingli Giam, Julian D. Olden, Lise Comte"
date: ""
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    keep_tex: true
    df_print: paged
    toc: false
bibliography: "bibliography.bib"
always_allow_html: true
header-includes:
  \usepackage{float}
  \usepackage{booktabs}
  \usepackage{colortbl}
  \usepackage{caption}
  \renewcommand{\thetable}{S\arabic{table}}
  \renewcommand{\thefigure}{S\arabic{figure}}
---

```{r options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "graphics/knitr-",
  fig.retina = 1.618, # Control using dpi
  fig.width = 6,  # generated images
  fig.pos = "H",  # pdf mode
  fig.align = "center",
  dpi = 72,#if (knitr::is_latex_output()) 72 else 300,
  out.width = "80%"
  )
options(kableExtra.latex.load_packages = TRUE)
library(kableExtra)
```

```{r library, include = FALSE}
source(here::here("start_rmd.R"))
#theme_set(theme_cowplot())
#theme_update(axis.text = element_text(size = 8))
library(gt)
library(gtsummary)
library(ggbreak)
```

```{r}
get_tbl_summary <- function(df = NULL) {

t1 <- df %>%
  tbl_summary(statistic = all_continuous() ~ "{N_nonmiss}", missing = "no") %>%
  modify_header(stat_0 ~ "**N (no missing)**")

t2 <- df %>%
  tbl_summary(statistic = all_continuous() ~
    "{median} ({p25}, {p75})",
  missing = "no") %>%
  modify_header(stat_0 ~ "Median (1st Q, 3rd Q)")

t3 <- df %>%
  tbl_summary(statistic = all_continuous() ~
    "({min}, {max})",
  missing = "no") %>%
  modify_header(stat_0 ~ "(Min, Max)")

tbl_merge(list(t1, t2, t3)) %>%
  modify_footnote(everything() ~ NA_character_) %>%
  modify_spanning_header(everything() ~ NA_character_)

}
ecdf_fun <- function(x, perc) ecdf(x)(perc)
```

```{r}
source("https://raw.githubusercontent.com/EmilHvitfeldt/emilfun/master/R/palette_scrapers.R")
pal_variable <- palette_coolors("https://coolors.co/588aee-68de9f-f4ec7b-feb35d-ed6e6e-b885ff")

pal_variable2 <- palette_coolors("https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff")

legend_order <- c(
  "log_total_abundance", "log_chao_richness",
  "perc_exo_abun", "perc_exo_sp",
  "hillebrand_dis_scaled", "turnover_scaled"
)

names(pal_variable) <- get_var_replacement_vulgarisation()[legend_order]

restricted_dimension <- c(
  "log_total_abundance", "log_chao_richness",
  "perc_exo_abun", "perc_exo_sp",
  "hillebrand_dis_scaled", "turnover_scaled"
)

bold_pattern <- "(\\*\\*(.*)\\*\\*)"
```

```{r}
tar_load(c(add_dataset_ref))
tar_load(filtered_op_protocol_modelling)
tar_load(filtered_dataset_modelling)
tar_load(c(modelling_data, modelling_data_exo))
tar_load(c(clust_var, exo_resp_var, facet_var))
tar_load(riveratlas_site)
tar_load(c(
    site_no_drivers_inla_tot, site_env,
    gaussian_inla_std_effects, gaussian_inla_exo_std_effects)
)

tar_load(c(measurement_exo))
# filter
measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))
```

# Supplementary figures

```{r tab-loc-u, results = "hide"}
location_site <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  group_by(ecoregion, country)

location_summary <- location_site %>%
    summarise(n = n(), .groups = "drop") %>%
    mutate(
      method = "Site location (Country, Realm)",
      country_realm = paste0("(", country,  ", ", ecoregion, ")"),
      percent = scales::percent(n / sum(n), accuracy = .01)
    ) %>%
    arrange(desc(ecoregion), desc(n)) %>%
    rename(realm = ecoregion) %>%
    rename_with(str_to_sentence)
```

```{r}
year_op_cap <- "**Distribution of sampling event years**. The years 1993 and 2009
are highlighted, corresponding to the years of the Human Footprint Index
assessments, which were used to quantify past and recent pressures (See Methods)." %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 year_op_cap <- str_replace(year_op_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r y-op, fig.cap=year_op_cap}
seg <- tibble(
 x = c(1993, 2009),
 y = c(0, 0),
 xend = x,
 yend = c(7500, 6500)
)

nb_op9309 <- sum(
  filtered_op_protocol_modelling$year >= 1993
)
perc_op9309 <- scales::percent(sum(filtered_op_protocol_modelling$year >= 1993)
  / nrow(filtered_op_protocol_modelling))

txt <- tibble(
 x = c(1987, 1993, 2001, 2008, 2009, 2015),
 y = c(7500, 7500, 6000, 7500, 6500, 6000),
 label = c(
   paste0(
   scales::percent(sum(filtered_op_protocol_modelling$year <= 1993)
     / nrow(filtered_op_protocol_modelling)),
   " in [", min(filtered_op_protocol_modelling$year), ",1993]"
   )
   ,
   "1993",

   paste0(
scales::percent(sum(filtered_op_protocol_modelling$year >= 1993 & filtered_op_protocol_modelling$year <= 2009)
  / nrow(filtered_op_protocol_modelling)),
   " in [1993,2009]"
   ),
 paste0(
   scales::percent(sum(filtered_op_protocol_modelling$year >= 1993)
     / nrow(filtered_op_protocol_modelling)),
   " in [1993,", max(filtered_op_protocol_modelling$year), "]"
   ),
 "2009",
 paste0(
scales::percent(sum(filtered_op_protocol_modelling$year >= 2009)
  / nrow(filtered_op_protocol_modelling)),
   " in [2009,", max(filtered_op_protocol_modelling$year), "]"
   )
 )
) %>%
mutate(label = str_replace(label, "in ", "in\n")) %>%
filter(! x %in% c(1993, 2009))

distr_protocol <- filtered_op_protocol_modelling %>%
  ggplot(aes(x = year)) +
  geom_histogram() +
  scale_x_continuous(breaks = c(1960, 1980, 1993, 2000, 2009, 2020)) +
  geom_segment(data = seg,
    aes(x = x, y = y, xend = xend, yend = yend),
    lwd = 1, color = "gray80", linetype = "dashed"
    ) +
  labs(x = "Year", y = "Number of sampling events") +
  geom_label(data = txt,
    aes(x = x, y = y, label = label), size = 2
  ) +
theme(text = element_text(size = 8))
```

```{r}
tar_load(site_year)
site_year %<>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic"))
```

```{r}
seg_bl <- tibble(
 x = c(1993, 2009),
 y = c(0, 0),
 xend = x,
 yend = c(700, 600)
)
txt_bl <- tibble(
 x = c(1987, 1993, 2001, 2008, 2009, 2015),
 y = c(700, 700, 600, 700, 600, 600),
 label = c(
   paste0(
   scales::percent(sum(site_year$min <= 1993)
     / nrow(site_year)),
   " in [", min(site_year$min), ",1993]"
   )
   ,
   "1993",
   paste0(
scales::percent(sum(site_year$min >= 1993 & site_year$min <= 2009)
  / nrow(site_year)),
   " in [1993,2009]"
   ),
 paste0(
   scales::percent(sum(site_year$min >= 1993)
     / nrow(site_year)),
   " in [1993,", max(site_year$min), "]"
   ),
 "2009",
 paste0(
scales::percent(sum(site_year$min >= 2009)
  / nrow(site_year)),
   " in [2009,", max(site_year$min), "]"
   )
 )
) %>%
mutate(label = str_replace(label, "in ", "in\n")) %>%
filter(! x %in% c(1993, 2009))

p_baseline_year <- site_year %>%
  ggplot(aes(x = min)) +
  geom_histogram() +
  scale_x_continuous(breaks = c(1960, 1980, 1993, 2000, 2009, 2020),
  limits = c(1960, 2020)
    ) +
  labs(x = "First sampling year", y = "Number of sites") +
  geom_segment(data = seg_bl,
    aes(x = x, y = y, xend = xend, yend = yend),
    lwd = 1, color = "gray80", linetype = "dashed"
    ) +
  geom_label(data = txt_bl,
    aes(x = x, y = y, label = label), size = 2
  )+
theme(text = element_text(size = 8))
```

```{r}
p_span <- site_year %>%
  ggplot(aes(x = cat_span, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Time span (year)", y = "Number of sites") +
  theme(text = element_text(size = 8))

p_completness <- site_year %>%
  ggplot(aes(x = cat_completeness, fill = ecoregion)) +
  geom_bar() +
  labs(
    x = "Completeness of time series (nb samplings / time span)",
    y = "Number of sites"
  ) +
  theme(text = element_text(size = 8))
```

```{r, eval = FALSE}
tar_load(p_timeseries)
ggsave(
  filename = "coverage_timeseries.png",
  plot = p_timeseries,
  path = here("paper", "fig_paper"),
  scale = 2.4,
  width = 80,
  height = 80 * 1.0,
  units = "mm",
  dpi = "print"
)
```


```{r}
cap <- "**Distribution of (a) year of all sampling events (b) first year of the
time series,
(c) time span and (d) completeness of the time series**. In (a) and (b), the
lines display the year 1993 and 2009. The years 1993 and 2009 correspond to the
years of the human footprint index assessments, which were used to quantify past
and recent anthropogenic pressures (See Methods)." %>%
str_replace_all("  ", " ") %>%
str_replace_all("\n|\r", " ")

if (knitr::is_latex_output()){
 cap <- str_replace(cap, bold_pattern, "\\\\textbf{\\2}")
}

```

```{r base-span-cpl, fig.cap=cap, fig.width = 8, fig.asp = 1}
leg_ecoregion <- get_legend(
  p_span +
    theme(legend.position = "bottom", legend.justification = "center") +
    guides(fill = guide_legend(""))

)
top <- plot_grid(distr_protocol, p_baseline_year, ncol = 2, labels = c("a", "b"))
mid <- plot_grid(
  p_span + theme(legend.position = "none"),
  p_completness + theme(legend.position = "none"),
  ncol = 2,
  labels = c("c", "d")
  )

timeseries_dist <- plot_grid(top, mid, leg_ecoregion,
  ncol = 1, rel_heights = c(1, 1, .1)
  )

ggsave(
  filename = "timeseries_dist.pdf",
  plot = timeseries_dist,
  path = here("paper", "fig_paper"),
  scale = 2.4,
  width = 80,
  height = 80 * 1.0,
  units = "mm",
  dpi = "print"
)
knitr::include_graphics(here("paper", "fig_paper", "timeseries_dist.pdf"))
```

```{r}
tar_load(p_site_trends_ts_caracteristics)
ggsave(
  filename = here("paper", "fig_paper",
    "p_site_trends_ts_caracteristics.png"),
  plot = p_site_trends_ts_caracteristics,
  scale = 3.2,
  width = 80,
  height = 80 * 1.2,
  units = "mm",
  dpi = "print"
)
```

```{r}
tar_load(p_hft_mu_venter)

ggsave(
  filename = here("paper", "fig_paper",
    "p_hft_mu_venter.png"),
  plot = p_hft_mu_venter,
  scale = 2.2,
  width = 80,
  height = 80 * 1.0,
  units = "mm",
  dpi = "print"
)
```



```{r}
fnsite <- format(nrow(filtered_dataset_modelling$location), big.mark = ",")
fnop <- format(length(unique(filtered_dataset_modelling$measurement$op_id)),
  big.mark = ",")
trends_cap <- paste0("**Distribution of community temporal trends across sites**
  for Jaccard dissimilarity and Jaccard Nestedness. Temporal trends per decade
were estimated from a hierarchical Bayesian model including time as sole
predictor (See Methods). The histograms show the Best Linear Unbiased Predictor
(BLUP) estimated at each site and the dots the average posterior distribution
with bars depicting the Bayesian credible intervals at
95\\%. The dashed lines refer to no temporal trend.", "
N = ", fnop, " sampling events across ", fnsite, " sites.") %>%
  str_replace_all("\\s+", " ")
if (knitr::is_latex_output()){
 trends_cap <- str_replace(trends_cap, bold_pattern, "\\\\textbf{\\2}")
}
```
```{r trends-dist, fig.cap=trends_cap, fig.asp = 1.1, out.width = "80%"}
knitr::include_graphics(here("paper", "fig_paper", "p_trends_supp.pdf"))
```



```{r}
tar_load(site_cl_rm)
fnsite_brut <- nrow(filtered_dataset_modelling$location)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite_brut - sum(nb_clusters), ", ", round((fnsite_brut - sum(nb_clusters)) / fnsite_brut * 100),"\\%)"
)
```

```{r}
pca_clust_cap <- paste0("**Covariation among the community temporal trends and
  characterization of community trajectories**. (a, b) PCA biplot of the community
  temporal trends and their cluster assignment where the sites are colored
  according to their cluster assignment. (c) Boxplots
  displaying the distribution of the temporal trends by cluster. (d) Cluster
  frequencies across the three main biogeographic realms. The ellipses in (a-b) display the 95\\% intervals around
  the clusters assuming a Student’s t distribution. The clusters were named
  according to their main characteristics. Contrary to Fig. 2 (Main text), we included the sites whose cluster
affiliation was uncertain ('NA', black color, ", na_cluster, ".",
" NA clusters are well distributed over the PCA (a-b), which is confirmed by the
distribution of community metric temporal trends (c). We observe a few more NAs
in the Nearctic realm (+5\\%, i.e. around 40 sites over 897).") %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 pca_clust_cap <- str_replace(pca_clust_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r cl-map, fig.cap=pca_clust_cap, fig.asp = 1.1, out.width = "80%"}
knitr::include_graphics(here("paper", "fig_paper", "clust_figure_na.pdf"))
```


```{r}
ti = tar_read(gaussian_inla_std, branches = which(facet_var == "log_species_nb"))
log_species_richness_effect  <- format_inla_model_list(x = ti, response_to_skip = NULL)

col <- c(
  "darkgreen",
  pal_variable[get_var_replacement_vulgarisation()[
      c("log_chao_richness", "hillebrand_dis_scaled")
      ]],
  "darkred"
  )
names(col)[c(1,4)] <- get_var_replacement_vulgarisation()[c("log_species_nb", "jaccard_dis_scaled")]

tu_full <- rbind(
  log_species_richness_effect,
  gaussian_inla_std_effects,
  gaussian_inla_exo_std_effects
  ) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  filter(response %in% c("log_species_nb", "log_chao_richness", "hillebrand_dis_scaled", "jaccard_dis_scaled")) %>%
  mutate(
    term = str_replace_all(term, get_model_term_replacement_paper_figure()),
    response = get_var_replacement_vulgarisation()[response],
    response_f = factor(response, levels = names(col)),
    )
```


```{r, fig.show = "hide"}
theme_set(theme_grey())
p_tps_effect2 <- tu_full %>%
  filter(str_detect(term, "Time")) %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(col),
    term_level = get_term_level(),
    xaxis_title = TRUE,
    legend = TRUE
    ) +
  labs(x = expression(
      paste("Standardized slope coefficients ",
        beta, "' (", "s.d. unit)",
        sep = "")
    )
    ) +
  scale_x_break(c(.105, .17), scales = .2, ticklabels = c(.20, .25)) +
  scale_x_break(c(.28, .65),  scales = .2, ticklabels = c(.60, .70)) +
  theme_bw() +
  theme(
    axis.line.y.right = element_blank(),
    axis.ticks.y.right = element_blank(),
    axis.text.y.right = element_blank(),
    #plot.margin = margin(5, 5, 5, 5, "pt"),
    #plot.background = element_rect(fill = NA, color = "black"),
    panel.border = element_rect(fill = "transparent")
  ) +
  theme(legend.position = "right", legend.justification = "left") +
  guides(colour = guide_legend(ncol = 1, byrow = FALSE, reverse = TRUE))

leg <- get_legend(p_tps_effect2)
p_tps_effect <- plot_grid(
  print(p_tps_effect2 + theme(legend.position = "none")), leg,
  ncol = 1,
  rel_heights = c(1, .1)
)
```

```{r, fig.show = "hide", results = "hide"}
p_space_effect2 <- tu_full %>%
  filter(!str_detect(term, "Time")) %>%
  arrange(response, desc(width_bar)) %>%
  plot_inla_fixed_effect(
    scale_color = rev(col),
    term_level = get_term_level(),
    xaxis_title = TRUE,
    legend = TRUE
    ) +
  theme_bw() +
  labs(x = expression(atop(paste("Standardized slope coefficients ",
        beta, "'",sep = ""), "(s.d. unit)"))) +
  theme(legend.position = "none",
    legend.justification = "right"
    ) +
  guides(colour = guide_legend(nrow = 1, byrow = FALSE, reverse = TRUE))
```
```{r, fig.show = "hide", results = "hide"}
p_effect <- plot_grid(
  print(p_tps_effect2 +
    theme(
      legend.position = "none",
      text = element_text(size = 11),
      axis.title.x = element_text(hjust = .75),
      axis.title.y = element_blank(),
      plot.margin = margin(0, 0, 0, 0, "pt"),
      )
    ),
  plot_grid(
    NULL,
    p_space_effect2 +
      theme(
        text = element_text(size = 11),
        axis.title.y = element_blank(),
        legend.position = "none"
      ),
    get_legend(p_tps_effect2 +
      theme(legend.position = "right", legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        ) +
      guides(colour = guide_legend(ncol = 1, byrow = FALSE, reverse = TRUE,
          title.position = "top"))
      ),
    ncol = 1,
    rel_heights = c(.015, 1, 1)
    ),
  ncol = 2,
  labels = "auto",
  #hjust = -1.5
  label_x = c(.02, 0),
  label_y = c(.995, .995),
  rel_widths = c(1,.65)
  )

ggsave(
  filename = "p_effect_supp.pdf",
  plot = p_effect,
  path = here("paper", "fig_paper"),
  scale = 3,
  width = 88,
  height = 88 * .9,
  units = "mm",
  dpi = "print"
)
```
```{r}
theme_set(theme_bw())
```



```{r}
pred_hft_cap <- "**Predictions of community metric changes over
time according to past human pressures and recent changes in human pressures
using a hierarchical Bayesian model**. Total abundance is expressed in count,
species richness in number of species (raw), while non-native abundance, non-native
abundance, dissimilarity and turnover are expressed in proportion. No pressure,
medium pressure, and highly degraded past pressure levels correspond
respectively to values of human footprint index for the year 1993 of 2.5 (intact
ecosystem), 16.8 (median value in our dataset), and 45.6 (maximum value in the
dataset). Recent pressure levels represent change in human footprint index
between the years 1993 and 2009 (see Methods for details). The central lines display
the mean, while the lower and upper lines display the credible intervals at
95\\% of the average posterior distribution." %>%
  str_replace_all("\\s+", " ")
if (knitr::is_latex_output()){
 pred_hft_cap <- str_replace(pred_hft_cap, bold_pattern, "\\\\textbf{\\2}")
}
```


```{r, out.width = "70%", out.height = "85%", fig.cap = pred_hft_cap}
knitr::include_graphics(here("paper", "fig_paper", "p_pred_hft.pdf"))
```

```{r}
std_tot_cap <- "**Effects of anthropogenic pressures and longitudinal stream position on (a)
community temporal changes and (b) community spatial variations**. See
Fig. 3 in the main text for details. We compare coverage corrected species
richness (Richness) with raw species richness (Richness (raw)) and Simpson
dissimilarity (Dissimilarity) with Jaccard dissimilarity (Jaccard
  dissimilarity). We observe that using coverage based species richness or raw
species richness does not affect the results. Similarly, we observe consistent
effect sizes for Simpson and Jaccard dissimilarity indices, meaning that
observed changes in community composition concerned abundant species and thus
changes in the identity of dominant species (see
  Methods)." %>%
  str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 std_tot_cap <- str_replace(std_tot_cap, bold_pattern, "\\\\textbf{\\2}")
}
```


```{r std-tot, fig.width = 8, fig.asp = .5, fig.cap=std_tot_cap}
knitr::include_graphics(here("paper", "fig_paper", "p_effect_supp.png"))
```


```{r}
tar_load(pca_riv_str)
```


```{r}
cap_pca_riv <- "**Rotated principal component analysis (PCA) over the physical and hydrological characteristics of
the sites**. PCA axes (Rotated Component, RC) were rotated using the varimax algorithm
(See Methods). The first axis is related to the average discharge, Strahler
order and the distance from source, and was subsequently used in the statistical
modelling as a composite variable intended to summarise the longitudinal stream position from upstream
to downstream." %>%
  str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 cap_pca_riv <- str_replace(cap_pca_riv, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r pca-riv-str, fig.width = 6, fig.asp = 1, fig.cap=cap_pca_riv}
p_pca_riv_str <- plot_pca_clust(
  .data = pca_riv_str$rotated,
  site_cl = NULL,
  xaxis = "RC1", yaxis = "RC2",
  ctb_thld = .4, label_size = 2,
  size_abscisse_segment = .25,
  size_arrows_segment = .25,
  force = 10, force_pull = 1,
  var_scaling_factor = NULL,
  seed = NA,
  replace_var = get_rev_vec_name_val(get_river_atlas_significant_var()),
  add_variable = TRUE,
  add_point = FALSE,
  add_ellipse = FALSE
)
p_pca_riv_str
```

```{r}
lc_hft <- riveratlas_site %>%
  st_drop_geometry() %>%
  select(any_of(c("siteid",
        get_land_class_var()[str_detect(names(get_land_class_var()), "catchment")]
  ))) %>%
  left_join(
    modelling_data %>%
    distinct(siteid, hft_ix_c93, hft_ix_c9309_log2_ratio, riv_str_rc1) %>%
    select(any_of(c("siteid",
          get_rev_vec_name_val(get_model_term_replacement_paper_figure()[c("riv_str_rc1", "hft_ix_c93",
            "hft_ix_c9309_log2_ratio")])
  )
  )
      ),
    by = "siteid"
  ) %>%
  select(-siteid)

alter_cor_data <-
    modelling_data %>%
    distinct(siteid, riv_str_rc1, hft_ix_c93, hft_ix_c9309_log2_ratio) %>%
    select(riv_str_rc1, hft_ix_c93, hft_ix_c9309_log2_ratio)
```

```{r}
cor_lc_hft <- cor(lc_hft,
  method = "spearman"
)
#corrplot::corrplot(cor_clust, type = "upper", diag = FALSE, tl.srt = 15)
p_cor_lc_hft <- ggcorrplot::ggcorrplot(
  cor_lc_hft, hc.order = FALSE, type = "lower",
  lab = TRUE, tl.srt = 15, legend.title = "Spearman Corr") +
theme(legend.position = c(.45, .95), legend.direction = "horizontal") +
guides(colour = guide_legend(title.position = "top"))

ggsave(
  filename = "p_cor_lc_hft.pdf",
  plot = p_cor_lc_hft,
  path = here("paper", "fig_paper"),
  scale = 2.6,
  width = 80,
  height = 80 * 1,
  units = "mm",
  dpi = "screen"
)
```

```{r}
cor_cap <- "**Spearman correlations among the ecological drivers** used in the
hierarchical Bayesian model as well as with additional population density land
use variables. Land use data and population density were extracted from
HydroAtlas and are meant to illustrate the covariations of various
human pressures with the human footprint index. We show the correlation with the
extents of forest, pasture, and cropland for year 2000, urban extent for year 2015
and population density for year 2010 (See Linke et al., 2019 for details). We
observe very low correlations among the ecological drivers (longitudinal stream
  position, past
  pressures and recent pressures). Past pressures (human footprint index for year
  1993) are positively correlated with population density, urban extent and
cropland extent, but are negatively correlated with forest extent." %>%
  str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 cor_cap <- str_replace(cor_cap, bold_pattern, "\\\\textbf{\\2}")
}
```


```{r cor-lc-hft, fig.width = 14, fig.cap=cor_cap}
knitr::include_graphics(here("paper", "fig_paper", "p_cor_lc_hft.pdf"))

```


```{r}
tar_load(p_drivers_ts_caracteristic)
ggsave(
  filename = "p_drivers_ts_caracteristic.pdf",
  plot = p_drivers_ts_caracteristic,
  path = here("paper", "fig_paper"),
  scale = 2.2,
  width = 80,
  height = 80 * 1.0,
  units = "mm",
  dpi = "screen"
)
ggsave(
  filename = "p_drivers_ts_caracteristic.png",
  plot = p_drivers_ts_caracteristic,
  path = here("paper", "fig_paper"),
  scale = 2.2,
  width = 80,
  height = 80 * 1.0,
  units = "mm",
  dpi = "screen"
)
```



```{r, results = "hide", fig.show = "hide"}
tar_load(obs_fit)
tar_load(gaussian_inla_exo_std)
cpo <- gaussian_inla_exo_std %>%
  mutate(
    cpo_pit = map(mod, ~inla.cpo(.x)),
    cpo = map(cpo_pit, ~.x$cpo$cpo),
    pit = map(cpo_pit, ~.x$cpo$pit)
    ) %>%
  select(-mod)

r2_obs_fit <- obs_fit %>%
  filter(response %in% legend_order) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    response = factor(response, levels = get_var_replacement_vulgarisation()[legend_order])
    ) %>%
  group_by(response) %>%
  summarise(
    cor = round(cor(y = fit, x = obs), 2),
    r2 = round((cor(y = fit, x = obs))^2, 2),
    gelman_r2 = round(var(fit) / (var(fit) + var(obs - fit)), 2),
    lab_r2 = paste0("~~~~R^2 == ", gelman_r2),
    lab = paste0("\n~~~~rho == ", cor),
    n = n(),
    obs = -Inf,#(max(obs) - min(obs)) * .10,
    fit = Inf#(max(fit) - min(fit)) * .90,
  )
```

```{r, results = "hide", fig.show = "hide"}

p_obs_fit <- obs_fit %>%
  filter(response %in% legend_order) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    response = factor(response, levels = get_var_replacement_vulgarisation()[legend_order])
    ) %>%
  ggplot(aes(x = obs, y = fit)) +
  geom_point(alpha = .3, color = "gray70", pch = 20) +
  geom_abline(slope = 1, intercept = 0, size = 1) +
  geom_text(data = r2_obs_fit,
    aes(label = lab), parse = TRUE,
    vjust = 1, hjust = 0
    ) +
  facet_wrap(vars(response), scales = "free", ncol = 2) +
  labs(x = "Observed values", y = "Fitted values") +
  geom_rug(alpha = .05) +
  theme(strip.background = element_blank())
ggsave(
  filename = "obsfit.jpg",
  plot = p_obs_fit,
  path = here("paper", "fig_paper"),
  scale = 2.0,
  width = 90,
  height = 90 * 1,
  units = "mm",
  dpi = "retina"
)
```

```{r}
N <- unique(r2_obs_fit$n)
obs_fit_cap <- paste0("**Fitted values of the models vs observed values** (N = ",N,"
  sampling events). The black line displays the bisection, i.e. the intercept
and slope are respectively 0 and 1. Sticks located at the abscissa and ordinate
axis represent the density of values. The Pearson's correlation coefficient is
displayed in each panel. Total abundance and species richness values are log-transformed.
The model predicted the data reasonnably well, but it tended to
overestimate low values and underestimate high values, especially for the
proportion of non-native species and dissimilarity.") %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 obs_fit_cap <- str_replace(obs_fit_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r fit-obs, fig.cap = obs_fit_cap, out.width="80%"}
knitr::include_graphics(
  path =here("paper", "fig_paper", "obsfit.jpg"),
  auto_pdf = FALSE
)
```


```{r}
tar_load(c(clust_curv_site, clust_curv_site_fac_50))
tar_load(c(k6_fac_1, sup_clust_size_fac1))
```

```{r}
cap_clust_curv <- "**Objective function quantifying the goodness of the k-means
clustering** according to the percentage of data being removed (the most outliers
  data in the multidimentional space). The different lines indicate differences
in the goodness of fit for different number of clusters, as indicated by the
numbers. In the results presented in the main text, we removed 5\\% of the data
($\\alpha$ = 5\\%). We chose six clusters for our analyses as the goodness of fit
increased only marginally from 6 to 7 clusters (and beyond). However, because of
the small increases in goodness of fit observed from 4 to 5 clusters, we also
tested the sensitivity of our conclusions regarding the community trajectories
using 4 clusters  (see Fig. S10)." %>%
  str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 cap_clust_curv <- str_replace(cap_clust_curv, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r, fig.show = "hide"}
library(tclust)
p1 <- ~{plot(clust_curv_site)}
p2 <- ~{plot(clust_curv_site_fac_50)}
p <- plot_grid(
  ggdraw(p1),
  ggdraw(p2),
  ncol = 2
)
```


```{r, fig.width = 12, fig.asp = .8, fig.cap=cap_clust_curv}
plot(clust_curv_site)
```


```{r}
tar_load(site_no_drivers_inla)
site_trends_dec <- site_no_drivers_inla %>%
  mutate(
    across(c(turnover_scaled, hillebrand_dis_scaled),
      ~.x * log(10 + 1) * 100)
    ) %>%
  mutate(across(
      c(log_chao_richness, log_total_abundance),
      ~log_beta_to_perc_rate(.x) * log(10 + 1)
      )) %>%
  select(turnover_scaled, hillebrand_dis_scaled,
    log_chao_richness, log_total_abundance) %>%
  rownames_to_column(var = "siteid")
```

```{r k4, results = "hide"}
k4_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, c("log_total_abundance", "log_chao_richness",
    "hillebrand_dis_scaled", "turnover_scaled")] %>% mutate(across(everything(), ~scale(., center =
      FALSE)[,1])),
  iter.max = 150,
  k = 4,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
site_k4_fac_1_cl <- get_cluster_df(
     tclust_obj = k4_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
```

```{r}
bp_cl_dist_cap <- "**Distribution of temporal trends per decade by variable and
cluster, with four clusters**. With four clusters instead of six,
we do not observe the clusters related to changes in community
composition (Fig. 2, main text)." %>%
  str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 bp_cl_dist_cap <- str_replace(bp_cl_dist_cap, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r, fig.width = 10, fig.asp = .6, fig.cap=bp_cl_dist_cap}
bp_data <- site_cl_rm[, colnames(site_cl_rm) %in% c(restricted_dimension, "siteid", "cl", "riv_str_rc1", "hft_c9309_scaled_no_center")]
bp_data_dec_trends_10y <- site_k4_fac_1_cl[, !colnames(site_k4_fac_1_cl) %in% c("turnover_scaled", "hillebrand_dis_scaled",
    "log_chao_richness", "log_total_abundance")] %>%
left_join(site_trends_dec, by = "siteid")

p_pca_cl_bt <- target_bp_cl_dist(
  cl_obj = bp_data_dec_trends_10y,
  fct_var_lvl = names(pal_variable)[c(1:2, 5:6)],
  dodge = .85
  ) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(position = "top") +
  ylim(-75, 150) +
  labs(y = "Temporal trends per decade (%)") +
  theme(
    axis.text.x = element_text(angle = 0, vjust = 0),
    axis.title.y = element_text(angle = 90, vjust = 0),
    legend.position = "bottom"
  ) +
guides(color = FALSE)

ggsave(
  filename = "cl_bt_supp.pdf",
  plot = p_pca_cl_bt,
  path = here("paper", "fig_paper"),
  scale = 2.5,
  width = 88,
  height = 88 * .5,
  units = "mm",
  dpi = "print"
)
```

```{r bp-k4, fig.cap=bp_cl_dist_cap, fig.asp = .5, out.width = "80%"}
knitr::include_graphics(here("paper", "fig_paper", "cl_bt_supp.pdf"))
```


\newpage

# Supplementary tables


```{r, eval=FALSE}
tab_pred_cap <- "**Values and signification of predictor variables used in the
main text**."
if (knitr::is_latex_output()){
 tab_pred_cap <- str_replace(tab_pred_cap, bold_pattern, "\\\\textbf{\\2}")
}
tab_pred %>%
  kbl(booktabs = T,
    label = "tab-pred",
    caption = tab_pred_cap) %>%
  column_spec(4, width = "5cm") %>%
  collapse_rows(columns = c(1, 2), latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
tar_load(gaussian_inla_rand_no_drivers)
library(coda)

tab_rand <- gaussian_inla_rand_no_drivers %>%
  filter(
    term %in% paste0("Precision for ", c("main_bas1", "siteid1")),
    ci_level == "level:0.95",
    response %in% c(restricted_dimension, exo_resp_var)
    ) %>%
  select(-ci_level) %>%
  mutate(across(c(mean, low, high), ~round(., 3))) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    term = str_remove(term, "Precision for the |Precision for |"),
    term = replacement_random_term()[term],
    ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
  arrange(response, desc(term)) %>%
  select(
  `Response variable` = response,
  `Spatial scale` = term,
  `Temporal trends s.d.` = ci
  )

tab_rand2 <- tab_rand %>%
  mutate(`Response variable` = factor(`Response variable`, levels = names(pal_variable))) %>%
  arrange(`Response variable`)
```

```{r}
tab_rand_cap <- "**Random effects associated with the estimation of the temporal trends
computed from the model containing only time as fixed predictor**. [95\\% CI]: Credible Interval computed using
the Highest Posterior Density method." %>%
  str_replace_all("\\s+", " ")
if (knitr::is_latex_output()) {
  tab_rand_cap <- str_replace(tab_rand_cap, bold_pattern, "\\\\textbf{\\2}")
}

tab_rand2 %>%
  pivot_wider(names_from = "Spatial scale", values_from = "Temporal trends s.d.") %>%
  select(1, 3, 2) %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap) %>%
  add_header_above(c(" " = 1, "Temporal trends s.d." = 2)) %>%
  collapse_rows(columns = c(1, 2), valign = "middle", latex_hline = "major") %>%
  kable_styling(latex_options = c("hold_position"))
```


```{r}
source_table <- read_csv(
  here::here("inst", "extdata", "RivFishTIME_SourceTable.csv"),
  locale = locale(encoding = "UTF-8")
)
tar_load(published_rivfishtime_characteristic)

url_pattern <- "http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+"

reference <- source_table %>%
  filter(str_detect(SourceID, "\\[")) %>%
  mutate(
    source_id = str_extract(SourceID, "\\[([0-9]*)\\]"),
    source_id = str_replace(source_id, "\\[([0-9]*)\\]", "\\1"),
    source_id = as.integer(source_id)
  ) %>%
  separate(SourceID, c(NA, "Reference"), sep = "\\[([0-9]*)\\]\\s") %>%
  select(SourceID = source_id, Reference) %>%
  mutate(link = str_extract(Reference, url_pattern))

# Change bad url formatting + update
reference <- reference %>%
  mutate(
    Reference = str_replace_all(
      Reference,
      c(
        "https://wwwp2\\.ymparisto\\.fi/koekalastus_sahko/yhteinen/Login\\.aspx\\?ReturnUrl=%2fkoekalastus_sahko \\[Accessed on 04/09/2019\\]" = "https://wwwp2.ymparisto.fi/koekalastus_sahko/ [Accessed on 04/11/2023]",
        "https://cf\\.pca\\.state\\.mn\\.us/water/watershedweb/wdip/search_more\\.cfm\\?datatype=assessments \\[Accessed on 04/03/2019\\]" = "https://webapp.pca.state.mn.us/surface-water [Accessed on 04/11/2023]",
         "https://aquatic\\.biodata\\.usgs\\.gov/clearCriteria\\.action \\[Accessed on 10/15/2019\\]"= "https://apps.usgs.gov/biodata/ [Accessed on 25/05/2023]",
        "Data are available by contacting: https://www\\.fws\\.gov/southwest/sjrip/" = "Data are available at https://streamsystem\\.org/ [Accessed on 25/05/2023]"

      )
    )
  )

ref <- reference %>%
  group_by(SourceID) %>%
  summarise(Reference = paste0(Reference, sep = ";\n", collapse = ""))

ti <- published_rivfishtime_characteristic %>%
    filter(
      SiteID %in% unique(filtered_dataset_modelling$location$siteid)
      ) %>%
    group_by(SourceID, Country) %>%
    summarise(N = n(), .groups = "drop") %>%
    arrange(desc(N))
ti_ref <- ti %>%
  left_join(ref) %>%
  rename(`Source ID` = SourceID)

country_lvl <- location_summary %>%
  arrange(desc(N)) %>%
  .$Country

data_ref_cap <- "**References of the dataset included in the study**, arranged by sampling size. Numeric Source ID corresponds to the ID from the RivFishTIME database (Comte et al.,
    2021a). N: number of sites." %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
  data_ref_cap <- str_replace(data_ref_cap, bold_pattern, "\\\\textbf{\\2}")
}

add_dataset_ref %>%
  select(`Source ID` = `Source id`, 2, 3, Reference) %>%
  mutate(
    Country = str_replace(Country, "Canada", "CAN"),
    Country = factor(Country, levels = country_lvl),
    ) %>%
  rbind(ti_ref) %>%
  mutate(Reference = str_replace(Reference, "\\.;", ".")) %>%
  arrange(Country, desc(N)) %>%
  kbl(
    longtable = T,
    booktabs = T,
    label = "tab-add-data",
    caption = data_ref_cap) %>%
  kable_styling(
    repeat_header_continued = "\\textit{(Continued on Next Page...)}",
    latex_options = c("striped", "hold_position", "repeat_header")
    ) %>%
  column_spec(4, width = "12cm")
```

```{r, eval = FALSE}
# SourceID of the dataset from RivFishTime used in the study as Lise would like
# to thank them individually:
tar_load(
  c(
    published_rivfishtime_characteristic,
    updated_rivfishtime_characteristic
  )
)

filtered_published_rivfishtime_characteristic <-
  published_rivfishtime_characteristic %>%
  filter(SiteID %in% unique(filtered_dataset_modelling$location$siteid)) %>%
  arrange(SiteID)

source_rivfishtime_modelling <-
  filtered_published_rivfishtime_characteristic %>%
  group_by(SourceID) %>%
  summarise(n = n(), .groups = "drop")
write_csv(
  source_rivfishtime_modelling,
  file = here::here("paper", "sourceid_rivfishtime_modelling.csv")
)
```


```{r tab-pro-ch, results = "hide"}
unique(filtered_dataset_modelling$site_quali$protocol)
site_quali <- filtered_dataset_modelling$site_quali %>%
  mutate(
    protocol = ifelse(
      str_detect(protocol, "Electro"),
      "Electrofishing",
      protocol
      ),
    protocol = ifelse(
      str_detect(protocol, "netting"), "Netting", protocol
      ),
    protocol = str_replace(protocol, "Netting|Seining", "Seining / Netting")
    )
tab_protocol <- tabyl_df(site_quali, "protocol", digits = 2) %>%
  mutate(
    method = "Protocol",
    protocol = str_replace_all(protocol, "_", " "),
    # For rotenone:
    protocol = str_replace_all(protocol, "([a-z])([A-Z])", "\\1 \\2")
    ) %>%
  rename_with(str_to_sentence)

```
```{r, eval=FALSE}
tab_protocol %>%
  kbl(booktabs = T,
    label = "tab-pro",
    caption = "Protocol occurrence across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



```{r tab-u-ch, results = "hide"}
abun_unit <- tabyl_df(
  filtered_dataset_modelling$site_quali,
  "unitabundance",
  digits = 2) %>%
  mutate(
    method = "Abundance unit",
    unitabundance = str_replace_all(unitabundance, "_", " "),
    unitabundance = str_replace_all(unitabundance, get_unitabun_replacement())
    ) %>%
  rename_with(str_to_sentence) %>%
  rename(`Abundance unit` = Unitabundance)
```

```{r, eval=FALSE}
abun_unit %>%
  kbl(booktabs = T,
    label = "tab-u",
    caption = "Abundance unit across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r, eval=FALSE}
location_summary %>%
  kbl(booktabs = T,
    label = "tab-loc",
    caption = "Realm and country occurrence across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
exotic_source_summary <- measurement_exo[, "native_exotic_origin"] %>%
  group_by(native_exotic_origin) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(
    method = "Source for native species status",
    percent = scales::percent(n / sum(n), accuracy = .01),
    native_exotic_origin = get_nat_origin_replacement()[native_exotic_origin]
    ) %>%
  arrange(desc(n)) %>%
  rename(`Source for native species status` = native_exotic_origin) %>%
  rename_with(str_to_sentence)
```

```{r tab-exo-source-ck, eval=FALSE}
exotic_source_summary %>%
  kbl(booktabs = T,
    label = "tab-exo-source",
    caption = "Data source for native species status in term of species occurrence.") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r met-tab}
method_lvl <- c("Site location (Country, Realm)", "Protocol", "Abundance unit",
  "Source for native species status")
tab_quali <- rbind(
  location_summary %>%
    select(Method, Value = Country_realm, N, Percent),
  tab_protocol %>%
    select(Method, Value = Protocol, N, Percent),
  abun_unit %>%
    select(Method, Value = `Abundance unit`, N, Percent),
  exotic_source_summary %>%
    select(Method, Value = `Source for native species status`, N, Percent)
  ) %>%
mutate(Method = factor(Method, levels = method_lvl)) %>%
filter(Value != "Total") %>%
arrange(Method, desc(N))
```

```{r, eval=TRUE}
tab_quali_cap <- "**Site location, protocol and abundance unit
across sites, and data source for native species status**." %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 tab_quali_cap <- str_replace(tab_quali_cap, bold_pattern, "\\\\textbf{\\2}")
}
tab_quali %>%
  kbl(booktabs = T,
    label = "tab-met",
    caption = tab_quali_cap) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
abun_tmp <- modelling_data %>%
  select(all_of(c("total_abundance", "unitabundance")))
abun_summary <- abun_tmp %>%
  pivot_longer(-unitabundance,
    names_to = "Community metric", values_to = "values") %>%
  filter(`Community metric` == "total_abundance") %>%
  group_by(`Community metric`, unitabundance) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = format(round(median, 2), nsmall = 2),
    `Median (Q1, Q3)` = paste0(median, " (",
      format(round(`1st_quart`, 2), nsmall = 2), ",",
      format(round(`2nd_quart`, 2), nsmall = 2),
      ")"),
    `(Min, Max)` = paste0("(",
      format(round(min, 2), nsmall = 2),
      ",",
      format(round(max, 2), nsmall = 2),
      ")")
  ) %>%
  select(`Community metric`, unitabundance, N = n, `Median (Q1, Q3)`, `(Min, Max)`, median) %>%
  mutate(
    `Community metric` = get_var_replacement_vulgarisation()[`Community metric`],
    `Community metric` = paste0(`Community metric`, " (", unitabundance, ")")
    ) %>%
  arrange(desc(N)) %>%
  select(-median, -unitabundance)
```


```{r tab-resp-ck}
order_resp_var <- c(
        "chao_richness", "perc_exo_abun",
        "perc_exo_sp", "hillebrand_dis_scaled", "turnover_scaled")
tmp <- modelling_data %>%
  left_join(
    modelling_data_exo %>%
      select(siteid, year, perc_exo_sp, perc_exo_abun),
    by = c("siteid", "year")
  ) %>%
  select(all_of(c(order_resp_var)))

resp_summary <- tmp %>%
  pivot_longer(everything(),
    names_to = "Community metric",
    values_to = "values") %>%
  mutate(
    com_f = factor(`Community metric`, levels = order_resp_var)
    ) %>%
  group_by(`Community metric`, com_f) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = format(round(median, 2), nsmall = 2),
    `Median (Q1, Q3)` = paste0(median, " (",
      format(round(`1st_quart`, 2), nsmall = 2), ",",
      format(round(`2nd_quart`, 2), nsmall = 2),
      ")"),
    `(Min, Max)` = paste0("(",
      format(round(min, 2), nsmall = 2),
      ",",
      format(round(max, 2), nsmall = 2),
      ")")
  ) %>%
  arrange(com_f) %>%
  select(`Community metric`, N = n, `Median (Q1, Q3)`, `(Min, Max)`) %>%
  mutate(
    `Community metric` = get_var_replacement_vulgarisation()[`Community metric`]
  )
resp_summary <- rbind(abun_summary, resp_summary)
```

```{r, tab_exo}
exo_sp_var <- c(
  "species_nb_nat", "species_nb_exo",
   "perc_nat_sp", "perc_nat_abun"
)

tmp <- modelling_data_exo %>%
  select(all_of(exo_sp_var))
exotic_compo_summary <- tmp %>%
  pivot_longer(everything(),
    names_to = "Community metric",
    values_to = "values") %>%
  group_by(`Community metric`) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = format(round(median, 2), nsmall = 2),
    `Median (Q1, Q3)` = paste0(median, " (",
      format(round(`1st_quart`, 2), nsmall = 2), ",",
      format(round(`2nd_quart`, 2), nsmall = 2),
      ")"),
    `(Min, Max)` = paste0("(",
      format(round(min, 2), nsmall = 2),
      ",",
      format(round(max, 2), nsmall = 2),
      ")")
  ) %>%
  select(`Community metric`, N = n, `Median (Q1, Q3)`, `(Min, Max)`) %>%
  arrange(`Community metric`)
```

```{r}
restricted_dimension <- c(
  "hillebrand_dis_scaled", "turnover_scaled", "log_total_abundance",
  "log_chao_richness", "perc_exo_abun", "perc_exo_sp")
response_summary_tot <- resp_summary
```



```{r, eval=FALSE, results = "hide"}
response_summary_tot %>%
  kbl(booktabs = T,
    label = "tab-resp",
    caption = "Summary descriptors of response variables distribution"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r tab-exo-ck, eval=FALSE}
exotic_compo_summary %>%
  kbl(booktabs = T,
    label = "tab-exo",
    caption = "Summary distribution of native and non-native species metrics") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
col_pca_riv <- c(
  "dist_up_km", "ord_stra",
  "dis_m3_pyr", "ele_mt_cav", "slp_dg_cav"
)
pca_var_tmp <- riveratlas_site %>%
  select(all_of(col_pca_riv)) %>%
  st_drop_geometry() %>%
  pivot_longer(everything(),
    names_to = "metrics",
    values_to = "values") %>%
  group_by(metrics) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    name = str_replace_all(metrics,
      c(
        get_rev_vec_name_val(get_river_atlas_significant_var()),
        riv_str_rc1 = "PCA axis 1: stream gradient",
        get_model_term_replacement()
      )
    ),
    median = format(round(median, 2), nsmall = 2),
    `Median (Q1, Q3)` = paste0(median, " (",
      format(round(`1st_quart`, 2), nsmall = 2), ",",
      format(round(`2nd_quart`, 2), nsmall = 2),
      ")"),
    `(Min, Max)` = paste0("(",
      format(round(min, 2), nsmall = 2),
      ",",
      format(round(max, 2), nsmall = 2),
      ")"),
    main_text = get_model_term_replacement_paper_figure()[metrics],
  ) %>%
  select(`Stream gradient variable` = name,
    N = n, `Median (Q1, Q3)`, `(Min, Max)`)
```


```{r}
col_eco_drivers <- c("siteid", "hft_ix_c93", "hft_ix_c09")

riveratlas_tmp <- riveratlas_site %>%
  select(all_of(col_eco_drivers)) %>%
  st_drop_geometry() %>%
  left_join(
    modelling_data %>%
      distinct(siteid, year_nb),
    by = "siteid") %>%
  mutate(hft_ix_c93  = hft_ix_c93 / 10,
    hft_ix_c09 = hft_ix_c09 / 10,
    hft_ix_c9309_ratio = hft_ix_c09 / hft_ix_c93) %>%
  select(-siteid, -hft_ix_c09)

evt_summary <- riveratlas_tmp %>%
  pivot_longer(everything(),
    names_to = "metrics",
    values_to = "values") %>%
  group_by(metrics) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    name = str_replace_all(metrics,
      c(
        hft_ix_c9309_ratio = "Recent pressures",
        hft_ix_c93 = "Past pressures",
        year_nb = "Time (year nb since first sampling)"
      )
    ),
    median = format(round(median, 2), nsmall = 2),
    `Median (Q1, Q3)` = paste0(median, " (",
      format(round(`1st_quart`, 2), nsmall = 2), ",",
      format(round(`2nd_quart`, 2), nsmall = 2),
      ")"),
    `(Min, Max)` = paste0("(",
      format(round(min, 2), nsmall = 2),
      ",",
      format(round(max, 2), nsmall = 2),
      ")")
  ) %>%
  select(`Ecological drivers` = name,
    N = n, `Median (Q1, Q3)`, `(Min, Max)`) %>%
  mutate(
    eco_f = factor(
      `Ecological drivers`,
      levels = c("Time (year nb since first sampling)", "Past pressures", "Recent pressures"))
  ) %>%
  arrange(eco_f) %>%
  select(-eco_f)
```

```{r, eval=FALSE}
evt_summary %>%
  kbl(booktabs = T,
    label = "tab-riv",
    caption = "Descriptive statistics for the numerical predictors used for
    modelling. Main text names display the name used in the legend of the
    figures in main text. The community metrics that do not have main text name
    were not used in the analysis reported in main text. The PCA summarising the stream gradient
    was computed with Average annual discharge, Average elevation, Average slope, Distance from source, and Strahler order (Fig. SXX).") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
variable_tot <- rbind(
  response_summary_tot %>%
    mutate( Type = "Response") %>%
    select(Type, Variable = `Community metric`, everything()),
  evt_summary %>%
    mutate(Type = "Predictor") %>%
    select(Type, Variable = `Ecological drivers`, everything()),
  pca_var_tmp %>%
    mutate(Type = "Stream long. position") %>%
    select(Type, Variable = `Stream gradient variable`, everything())
  ) %>%
mutate(
  Variable = str_replace(Variable, "\n", ""),
  `(Min, Max)` = str_replace(`(Min, Max)`, " ", "")
)

var_tot_cap <- "**Summary descriptors of response and predictor variables used in
    the full hierarchical Bayesian model** (Fig. 3, main text). For the stream
    longitudinal position, we display the summary descriptors of the variables used
    to contruct the composite variable (See Methods, main text)." %>%
    str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 var_tot_cap <- str_replace(var_tot_cap, bold_pattern, "\\\\textbf{\\2}")
}

variable_tot %>%
  mutate(
    across(c(`Median (Q1, Q3)`, `(Min, Max)`),
      ~str_replace_all(.x,
      c(
        "\\(\\s" = "(",
        "\\s+" = " ",
        "\\s(\\d)" = "\\1"
      )
      ))) %>%
  kbl(booktabs = T,
    label = "tab-resp",
    caption = var_tot_cap) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>%
  column_spec(column = 2, width="6cm") %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down"))
```

```{r, eval = FALSE}
variable_stat <- tibble(
  category = c(rep("Response variable", 10), rep("Predictor variable", 7)),
  variables = c(clust_var, "perc_exo_sp", "perc_exo_abun", "log1_year_nb",
    "riv_str_rc1", "hft_ix_c93", "hft_ix_c9309_log2_ratio", "unitabundance",
    "main_bas", "siteid"),
  names = c(get_model_term_replacement_paper_figure(),
    get_var_replacement_vulgarisation())[variables],
  var_type = c("Numeric", "Continuous", rep("Proportion", 8), "Continuous",
    "Continuous", "Continuous", "Proportion", "Factor", "Character",
    "Character"),
  unit = c("cf Abundance unit", rep("", 8), "",
  "Number of years", "", "", "", "Factor with 4 levels: Count (reference), Number of individuals by 100 sq meters,
    Catch per Unit Effort (CPUE), Leslie index", "", ""),

  signification = c(
    "Total number of individuals",
    "Coverage corrected richness",
    "Temporal dissimilarity
    (presence/absence)",
    "Temporal dissimilarity
    (relative abundance, Simpson index)",
    "Temporal species
    colonisation",
    "Temporal species
    exptirpation", "Temporal species
    replacement", "Temporal
    nestedness",
    "Proportion of
    non-native species richness",
    "Proportion of
    non-native species abundance", "Time",
    "PCA axis related to average flow,
    distance from source, Strahler order, stream size",
    "Human footprint (1993)",
    "Human footprint ratio
    between 2009 and 1993",
    "Unit of abundance", "Hydrographic basin", "Sampled site"
    ),
    transformation = c("Log", "Log", rep("", 8), "Log + 1", "", "",
      "Log base 2", "", "", "")
    ) %>%
mutate(across(everything(), ~str_remove_all(., "\n")))

variable_stat %>%
  select(-variables, `short name` = names, type = var_type) %>%
  rename_with(str_to_sentence) %>%
  kbl(booktabs = T,
    label = "tab-var-mod",
    caption = "Description of the variables included in the model.") %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>%
  column_spec(4, width = "3cm") %>%
  column_spec(5, width = "3cm") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
tar_load(c(dic_waic_comp_time, clust_var, exo_resp_var))
cap_aic_table <- "**Watanabe-Akaike Information Criterion (WAIC) of the
statistical models fitting temporal trends** with either the number of years (\\#) since
the start of sampling or log-transformed number of years plus one (See Methods).
Most community metrics are best modelled with the log-transformed values." %>%
str_replace_all("\n|\r", " ")

if (knitr::is_latex_output()){
 cap_aic_table <- str_replace(cap_aic_table, bold_pattern, "\\\\textbf{\\2}")
}
```

```{r}
tab_waic <- dic_waic_comp_time %>%
  filter(response %in% c(restricted_dimension, "jaccard_dis_scaled",
      "nestedness_scaled")) %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    response_f = factor(response, levels = c(
        names(pal_variable),
        "Jaccard dissimilarity", "Nestedness"
        )),
    waic = round(waic)
    ) %>%
  select(-dic) %>%
  pivot_wider(names_from = "time", values_from = "waic") %>%
  mutate(
    `Min WAIC` = map2_chr(year_nb, log1_year_nb,
      function(x, y) {
        tmp <- c("year_nb", "log1_year_nb")[which.min(c(x, y))]
        get_model_term_replacement()[tmp]
      }),
    `WAIC difference (to Year nb)` = scales::percent(
      (log1_year_nb - year_nb) / year_nb,
      accuracy = .1
    )
    ) %>%
  rename_with(~str_replace_all(., get_model_term_replacement())) %>%
  rename(Response = response)

tab_waic %>%
  arrange(response_f) %>%
  select(-response_f) %>%
  kbl(booktabs = T,
    label = "tab-aic",
    caption = cap_aic_table
    ) %>%
  column_spec(5, width = "4cm") %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  add_header_above(c(" " = 1, "WAIC" = 2, " " = 2))
```

```{r}
vif_caption <- "**Variance inflation factors (VIF) of the ecological drivers
included in the hierarchical Bayesian model** (Fig. 3, main text). SE factor: inflation of the
standard error of the slope coefficients predicted by the multicollinearity of the
variables. The VIF values were all close to 1, indicating absence of
multicollinearity." %>%
str_replace_all("\\s+", " ")

if (knitr::is_latex_output()){
 vif_caption <- str_replace(vif_caption, bold_pattern, "\\\\textbf{\\2}")
}
```


```{r vif}
dummy_vif <- lm(log_species_nb ~
   log1_year_nb + riv_str_rc1 +
     hft_ix_c9309_log2_ratio +
    hft_ix_c93, modelling_data)
ck_col_data <- check_collinearity(dummy_vif) %>%
  as_tibble() %>%
  mutate(Term = str_replace(get_model_term_replacement_paper_figure()[Term], "\n", " ")) %>%
  rename(`SE factor` = "SE_factor", "Predictive variables" = "Term")
```

```{r}
ck_col_data %>%
  kbl(booktabs = T,
    label = "tab-vif",
    caption = vif_caption,
    digits = 2
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```
