---
title: "Supplementary Figures and Tables"
author: "Danet, A, Giam, X, Olden, J, Comte, L"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::pdf_document2:
    df_print: paged
    toc: true
bibliography: "bibliography.bib"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \renewcommand{\thefigure}{S\arabic{figure}}
  - \renewcommand{\thetable}{S\arabic{table}}
---

```{r options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "graphics/knitr-",
  fig.retina = 1.618, # Control using dpi
  fig.width = 6,  # generated images
  fig.pos = "t",  # pdf mode
  fig.align = "center",
  dpi = if (knitr::is_latex_output()) 72 else 300,
  out.width = "80%",
  dev = "svg",
  dev.args = list(png = list(type = "cairo-png")),
  optipng = "-o1 -quiet")
```

```{r library, include = FALSE}
source(here::here("start_rmd.R"))
theme_set(theme_cowplot())
library(gt)
library(gtsummary)
library(ggbreak)
```

```{r}
get_tbl_summary <- function(df = NULL) {

t1 <- df %>%
  tbl_summary(statistic = all_continuous() ~ "{N_nonmiss}", missing = "no") %>%
  modify_header(stat_0 ~ "**N (no missing)**")

t2 <- df %>%
  tbl_summary(statistic = all_continuous() ~
    "{median} ({p25}, {p75})",
  missing = "no") %>%
  modify_header(stat_0 ~ "Median (1st Q, 3rd Q)")

t3 <- df %>%
  tbl_summary(statistic = all_continuous() ~
    "({min}, {max})",
  missing = "no") %>%
  modify_header(stat_0 ~ "(Min, Max)")

tbl_merge(list(t1, t2, t3)) %>%
  modify_footnote(everything() ~ NA_character_) %>%
  modify_spanning_header(everything() ~ NA_character_)

}
ecdf_fun <- function(x, perc) ecdf(x)(perc)
```
\newpage

# Dataset

```{r}
tar_load(c(add_dataset_ref))
tar_load(filtered_op_protocol_modelling)
tar_load(filtered_dataset_modelling)
tar_load(c(modelling_data, modelling_data_exo))
tar_load(c(clust_var, exo_resp_var))
tar_load(riveratlas_site)
tar_load(c(
    site_no_drivers_inla_tot, site_env,
    gaussian_inla_std_effects, gaussian_inla_exo_std_effects)
)
```

```{r}
add_dataset_ref %>%
  select(-Program, -`Database source`) %>%
  kbl(booktabs = T,
    label = "tab-add-data",
    caption = "Databases included in the current study that were not included in
    RivFishTIME publication (Comte et al., 2021a). Apart from MARIS, these
    databases have already been used in a previous study (Comte et al.,
      2021b). N: number of sites.") %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  column_spec(4, width = "10cm")
```

```{r tab-pro-ch}
tabyl_df(filtered_dataset_modelling$site_quali, "protocol") %>%
  mutate(
    protocol = str_replace_all(protocol, "_", " "),
    # For rotenone:
    protocol = str_replace_all(protocol, "([a-z])([A-Z])", "\\1 \\2")
    ) %>%
  rename_with(str_to_sentence) %>%
  kbl(booktabs = T,
    label = "tab-pro",
    caption = "Protocol occurrence across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r tab-u-ch}
tabyl_df(filtered_dataset_modelling$site_quali, "unitabundance") %>%
  mutate(
    unitabundance = str_replace_all(unitabundance, "_", " "),
    unitabundance = str_replace_all(unitabundance, get_unitabun_replacement())
    ) %>%
  rename_with(str_to_sentence) %>%
  rename(`Abundance unit` = Unitabundance) %>%
  kbl(booktabs = T,
    label = "tab-u",
    caption = "Abundance unit across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r tab-loc-u}
location_site <- filtered_dataset_modelling$location %>%
  mutate(ecoregion = str_replace(ecoregion, "Neartic", "Nearctic")) %>%
  group_by(ecoregion, country)

location_summary <- location_site %>%
    summarise(n = n(), .groups = "drop") %>%
    mutate(
      percent = scales::percent(n / sum(n), accuracy = .01),
    ) %>%
    arrange(desc(ecoregion), desc(n)) %>%
    rename(realm = ecoregion) %>%
    rename_with(str_to_sentence)
location_summary %>%
  kbl(booktabs = T,
    label = "tab-loc",
    caption = "Realm and country occurrence across sites"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
year_op_cap <- "Distribution of year of samplings. Years 1993 and 2009,
corresponding to the two human footprint measurements, are highlighted."
```

```{r y-op, fig.cap=year_op_cap}
nb_op9309 <- sum(
  filtered_op_protocol_modelling$year >= 1993 &
  filtered_op_protocol_modelling$year <= 2009
)
perc_op9309 <- scales::percent(nb_op9309 / nrow(filtered_op_protocol_modelling))

filtered_op_protocol_modelling %>%
  ggplot(aes(x = year)) +
  geom_histogram() +
  geom_vline(
    xintercept = c(1993, 2009),
    lwd = 2, color = "red"
    ) +
  labs(x = "Year", y = "Count") +
  annotate("text", x = 2001, y = 8300,
    label = paste0(
      nb_op9309, " samplings between 1993 and 2009 (", perc_op9309,")"
      )
  )
```

```{r}
site_year <- filtered_dataset_modelling$site_quanti %>%
  filter(variable == "year") %>%
  left_join(filtered_dataset_modelling$location, by = "siteid") %>%
  mutate(
    span = max - min + 1,
    completeness = n / (span),
    cat_span = cut(span, c(0, 10, 20, 30, 40, 70), right = TRUE,
      include.lowest = TRUE
    ),
    cat_completeness = cut(
      completeness, c(0, .1, .25, .5, .75, 1), right = TRUE,
      include.lowest = TRUE
    )
    )
```

```{r}
p_baseline_year <- site_year %>%
  ggplot(aes(x = min)) +
  geom_histogram() +
  labs(x = "Baseline year", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_span <- site_year %>%
  ggplot(aes(x = cat_span, fill = ecoregion)) +
  geom_bar() +
  labs(x = "Year span (year)", y = "Number of sites") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p_completness <- site_year %>%
  ggplot(aes(x = cat_completeness, fill = ecoregion)) +
  geom_bar() +
  labs(
    x = "Completeness of sampling (nb sampling / year span )",
    y = "Number of sites"
  )
```

```{r}
cap <- "Distribution of (A) Baseline year, (B) year span and (3) completeness of
sampling by site."
```

```{r base-span-cpl, fig.cap=cap, fig.height = 12}
leg_ecoregion <- get_legend(p_span + theme(legend.position = "bottom"))
plot_grid(
  p_baseline_year,
  p_span + theme(legend.position = "none"),
  p_completness + theme(legend.position = "none"),
  leg_ecoregion,
  ncol = 1,
  label = "AUTO"
)
```
\newpage

# Biodiversity summary metrics 

## Community metrics 

```{r tab-resp-ck}
tmp <- modelling_data %>%
  left_join(
    modelling_data_exo %>%
      select(siteid, year, perc_exo_sp, perc_exo_abun),
    by = c("siteid", "year")
  ) %>%
  select(all_of(c("chao_richness", "species_nb",
        clust_var, exo_resp_var)))
colnames(tmp) <- c(get_var_replacement(), get_model_term_replacement())[colnames(tmp)]
resp_summary <- tmp %>%
  pivot_longer(everything(),
    names_to = "Community metric",
    values_to = "values") %>%
  group_by(`Community metric`) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = round(median, 2),
    `Median (Q1, Q3)` = paste0(median, " (", round(`1st_quart`, 2), ",", round(`2nd_quart`, 2),
      ")"),
    `(Min, Max)` = paste0("(", round(min, 2), ",", round(max, 2), ")")
  ) %>%
  select(`Community metric`, N = n, `Median (Q1, Q3)`, `(Min, Max)`, median) %>%
  arrange(median) %>%
  select(-median)
  
resp_summary %>%
  kbl(booktabs = T,
    label = "tab-resp",
    caption = "Summary descriptors of response variables distribution"
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
cor_chao_rich <-  cor(
  modelling_data$chao_richness,
  modelling_data$species_nb,
  method = "spearman") %>%
round(., 2)
chao_richness_cap <- paste0("Relationship between Chao-corrected species richness and
species richness, added to their respective distribution. The black line
displays the bissection, i.e. the intercept and slope are respectively 0 and 1.
Spearman's correlation is equal to ", cor_chao_rich, ".")
```


```{r chao-nb, fig.cap = chao_richness_cap}
p <- modelling_data %>%
  ggplot(aes(x = species_nb, y = chao_richness)) +
  geom_point(alpha = .3, color = "gray70") +
  geom_abline(intercept = 0, slope = 1) +
  labs(y = "Chao species richness", x = "Species richness")

ggExtra::ggMarginal(p, type = "histogram")
```


## Exotic species

```{r}
tar_load(c(measurement_exo))
# filter
measurement_exo <- measurement_exo %>%
  filter(op_id %in% unique(modelling_data_exo$op_id))
```


```{r, tab_exo}
exo_sp_var <- c(
  "species_nb_nat", "species_nb_exo",
  "perc_exo_sp", "perc_nat_sp",
  "perc_exo_abun", "perc_nat_abun"
)

exotic_source_summary <-  measurement_exo[, "native_exotic_origin"] %>%
  group_by(native_exotic_origin) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(
    percent = scales::percent(n / sum(n), accuracy = .01),
    native_exotic_origin = get_nat_origin_replacement()[native_exotic_origin]
    ) %>%
  arrange(desc(n)) %>%
  rename(`Source for native species status` = native_exotic_origin) %>%
  rename_with(str_to_sentence)


tmp <- modelling_data_exo %>%
  select(all_of(exo_sp_var))
colnames(tmp) <- get_var_replacement()[colnames(tmp)]
exotic_compo_summary <- tmp %>%
  pivot_longer(everything(),
    names_to = "Community metric",
    values_to = "values") %>%
  group_by(`Community metric`) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = round(median, 2),
    `Median (Q1, Q3)` = paste0(median, " (", round(`1st_quart`, 2), ",", round(`2nd_quart`, 2),
      ")"),
    `(Min, Max)` = paste0("(", round(min, 2), ",", round(max, 2), ")")
  ) %>%
  select(`Community metric`, N = n, `Median (Q1, Q3)`, `(Min, Max)`) %>%
  arrange(`Community metric`)
```

```{r tab-exo-source-ck}
exotic_source_summary %>%
  kbl(booktabs = T,
    label = "tab-exo-source",
    caption = "Data source for native species status in term of species occurrence") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r tab-exo-ck}
exotic_compo_summary %>%
  kbl(booktabs = T,
    label = "tab-exo",
    caption = "Summary distribution of native and non-native species metrics") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

\newpage

# Environmental variables

```{r}
tar_load(pca_riv_str)
```


```{r}
col_pca_riv <- c(
  "siteid", "dist_up_km", "ord_stra",
  "dis_m3_pyr", "ele_mt_cav", "slp_dg_cav",
   "hft_ix_c93", "hft_ix_c09"
)

riveratlas_tmp <- riveratlas_site %>%
  select(all_of(col_pca_riv)) %>%
  st_drop_geometry() %>%
  left_join(
    modelling_data %>%
      distinct(siteid, hft_ix_c9309_log2_ratio),
    by = "siteid") %>%
  select(-siteid) %>%
  mutate(hft_ix_c93  = hft_ix_c93 / 10,
    hft_ix_c09 = hft_ix_c09 / 10,
    hft_ix_c9309_ratio = hft_ix_c09 / hft_ix_c93) %>%
  rename_with(~str_replace_all(.,
        get_rev_vec_name_val(get_river_atlas_significant_var())
    )
  )

evt_summary <- riveratlas_tmp %>%
  pivot_longer(everything(),
    names_to = "Environmental variables",
    values_to = "values") %>%
  group_by(`Environmental variables`) %>%
  summarise(summ = list(enframe(summary_distribution(values)))) %>%
  unnest(summ) %>%
  pivot_wider(names_from = "name", values_from = "value") %>%
  mutate(
    median = round(median, 2),
    `Median (Q1, Q3)` = paste0(median, " (", round(`1st_quart`, 2), ",", round(`2nd_quart`, 2),
      ")"),
    `(Min, Max)` = paste0("(", round(min, 2), ",", round(max, 2), ")")
  ) %>%
  select(`Environmental variables`, N = n, `Median (Q1, Q3)`, `(Min, Max)`) %>%
  arrange(`Environmental variables`)

evt_summary %>%
  kbl(booktabs = T,
    label = "tab-riv",
    caption = "Descriptive statistics for the site environmental descriptors.") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
cap_pca_riv <- "Rotated PCA over the physical and hydrological structure of
streams. The first axis is related the average discharge, Strahler order and the
distance from source. This first axis was used in the statistical modelling as a
composite variable to summarise stream gradient from upstream to upstream."
```

```{r pca-riv-str, fig.cap=cap_pca_riv}
p_pca_riv_str <- plot_pca_clust(
  .data = pca_riv_str$rotated,
  site_cl = NULL,
  xaxis = "RC1", yaxis = "RC2",
  ctb_thld = .4, label_size = 2,
  size_abscisse_segment = .25,
  size_arrows_segment = .25,
  force = 10, force_pull = 1,
  var_scaling_factor = NULL,
  seed = NA,
  replace_var = get_rev_vec_name_val(get_river_atlas_significant_var()),
  add_variable = TRUE,
  add_point = FALSE,
  add_ellipse = FALSE
)
p_pca_riv_str
```

```{r}
lc_hft <- riveratlas_site %>%
  st_drop_geometry() %>%
  select(any_of(c(
        get_land_class_var()[str_detect(names(get_land_class_var()), "catchment")],
        get_river_atlas_significant_var()[
          str_detect(get_river_atlas_significant_var(), "hft_")
          ]
        )))
```

```{r}
cor_lc_hft <- cor(lc_hft,
  method = "spearman"
)
#corrplot::corrplot(cor_clust, type = "upper", diag = FALSE, tl.srt = 15)
p_cor_lc_hft <- ggcorrplot::ggcorrplot(
  cor_lc_hft, hc.order = TRUE, type = "lower",
  lab = TRUE, tl.srt = 15, legend.title = "Spearman Corr") +
theme(legend.position = c(.45, .95), legend.direction = "horizontal") +
guides(colour = guide_legend(title.position = "top"))
```

```{r cor-lc-hft, fig.cap="Spearman correlation between land uses and human footprint indexes"}
p_cor_lc_hft
```

\newpage

# Statistical analysis

## Variable

```{r}
variable_stat <- tibble(
  category = c(rep("Response variable", 10), rep("Predictor variable", 7)),
  variables = c(clust_var, "perc_exo_sp", "perc_exo_abun", "log1_year_nb",
    "riv_str_rc1", "hft_ix_c93", "hft_ix_c9309_log2_ratio", "unitabundance",
    "main_bas", "siteid"),
  names = c(get_model_term_replacement_paper_figure(),
    get_var_replacement_vulgarisation())[variables],
  var_type = c("Numeric", "Continuous", rep("Proportion", 8), "Continuous",
    "Continuous", "Continuous", "Proportion", "Factor", "Character",
    "Character"),
  unit = c("cf Abundance unit", rep("", 8), "",
  "Number of year", "", "", "", "Factor with 4 levels: Count (reference), Number of individuals by 100 sq meters,
    Catch per Unit Effort (CPUE), Leslie index", "", ""),

  signification = c(
    "Total number of individuals",
    "Coverage corrected richness",
    "Temporal dissimilarity
    (presence/absence)",
    "Temporal dissimilarity
    (relative abundance, Simpson index)",
    "Temporal species
    colonisation",
    "Temporal species
    exptirpation", "Temporal species
    replacement", "Temporal
    nestedness",
    "Proportion of
    non-native species richness",
    "Proportion of
    non-native species abundance", "Time",
    "PCA axis related to average flow,
    distance from source, Strahler order, stream size",
    "Human footprint (1993)",
    "Human footprint ratio
    between 2009 and 1993",
    "Unit of abundance", "Hydrographic basin", "Sampled site"
    ),
    transformation = c("Log", "Log", rep("", 8), "Log + 1", "", "", "Log base
      2", "", "", "")
) %>%
mutate(across(everything(), ~str_remove_all(., "\n")))


variable_stat %>%
  select(-variables, `short name` = names, type = var_type) %>%
  rename_with(str_to_sentence) %>%
  kbl(booktabs = T,
    label = "tab-var-mod",
    caption = "Description of the variables included in the model.") %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>%
  column_spec(4, width = "3cm") %>%
  column_spec(5, width = "3cm") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


## Collinearity

```{r}
vif_caption <- "Variance inflation factors on the variables included in the
model. SE factor: inflation of the standard error of slope coefficients
predicted by the multicollinearity of the variables."
```


```{r vif}
dummy_vif <- lm(log_species_nb ~
   log1_year_nb + riv_str_rc1 +
     hft_ix_c9309_log2_ratio +
    hft_ix_c93, modelling_data)
ck_col_data <- check_collinearity(dummy_vif) %>%
  as_tibble() %>%
  mutate(Term = str_replace(get_model_term_replacement()[Term], "\n", " ")) %>%
  rename(`SE factor` = "SE_factor", "Predictive variables" = "Term")
```

```{r}
ck_col_data %>%
  kbl(booktabs = T,
    label = "tab-vif",
    caption = vif_caption
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

The presence of multicollinearity among explicative variables was checked by
measuring the Variance Inflation Factor (VIF) on a model formulation containing only
the main effect, i.e. not the interactions. We did so because main variables ($X_1$,
$X_2$) and the interactions are collinear by construction, interactions being the
products of main variables (i.e. $X_1X_2$). The VIF values were all close to 1
(Table \@ref(tab:tab-vif)), indicating absence of multicollinearity.

## Time modelling

```{r}
tar_load(c(dic_waic_comp_time, clust_var, exo_resp_var))
cap_aic_table <- "WAIC of the statistical models fitting temporal trends with 
either the number of year since the start of sampling or the log of the former 
variable added to one." %>%
str_remove_all("\n")
```

```{r}
tar_load(tab_waic)
tab_waic %>%
  kbl(booktabs = T,
    label = "tab-aic",
    caption = cap_aic_table
    ) %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
add_header_above(c(" " = 1, "WAIC" = 2, " " = 2))
```


## Model validity

```{r}
tar_load(c(obs_fit, r2_obs_fit))
tar_load(gaussian_inla_exo_std)
cpo <- gaussian_inla_exo_std %>%
  mutate(
    cpo_pit = map(mod, ~inla.cpo(.x)),
    cpo = map(cpo_pit, ~.x$cpo$cpo),
    pit = map(cpo_pit, ~.x$cpo$pit)
    ) %>%
  select(-mod)

r2_obs_fit <- obs_fit %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  mutate(response = get_var_replacement_vulgarisation()[response]) %>%
  group_by(response) %>%
  summarise(
    cor = round(cor(y = fit, x = obs), 2),
    r2 = round((cor(y = fit, x = obs))^2, 2),
    gelman_r2 = round(var(fit) / (var(fit) + var(obs - fit)), 2),
    lab_r2 = paste0("~~~~R^2 == ", gelman_r2),
    lab = paste0("\n~~~~rho == ", cor),
    obs = -Inf,#(max(obs) - min(obs)) * .10,
    fit = Inf#(max(fit) - min(fit)) * .90
  )
```

```{r}
obs_fit_cap <- "Fitted values by the models vs observed values. The black line
displays the bisection, i.e. the intercept and slope are respectively 0 and 1.
Sticks located at the abscissa and ordinate axis display value concentration.
The Pearson's correlation coefficient is displayed in each panel."
```


```{r fit-obs, fig.width = 8, fig.asp = 1.2, fig.cap = obs_fit_cap}
obs_fit %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  mutate(response = get_var_replacement_vulgarisation()[response]) %>%
  ggplot(aes(x = obs, y = fit)) +
  geom_point(alpha = .3, color = "gray70") +
  geom_abline(slope = 1, intercept = 0, size = 1) +
  geom_text(data = r2_obs_fit,
    aes(label = lab), parse = TRUE,
    vjust = 1, hjust = 0
    ) +
  facet_wrap(vars(response), scales = "free", ncol = 3) +
  labs(x = "Observed values", y = "Fitted values") +
  geom_rug(alpha = .05)
```

```{r}
tar_load(c(gaussian_inla_var_fitted, gaussian_inla_rand))
r2 <- gaussian_inla_var_fitted %>%
  filter(response %in% c(clust_var, exo_resp_var)) %>%
  left_join(
    get_std_inla_from_rand(inla_rand_tab = gaussian_inla_rand),
    by = "response") %>%
  mutate(
    response = get_var_replacement_vulgarisation()[response],
    r2_mvp_marg = pmap(
      list(var_pred, intercept_main_bas, intercept_main_bassiteid, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2, ..3), epsilon = ..4, type = "marginal")
      ),
    r2_mvp_cond = pmap(
      list(var_pred, intercept_main_bas, intercept_main_bassiteid, epsilon),
      ~r2_mvp(var_pred = ..1, std_intercept = c(..2, ..3), epsilon = ..4, type = "conditional")
      ),
    r2_mvp_marg_mean = map_dbl(r2_mvp_marg, mean),
    r2_mvp_marg_med = map_dbl(r2_mvp_marg, median),
    r2_mvp_marg_sd = map_dbl(r2_mvp_marg, sd),
    r2_mvp_cond_mean = map_dbl(r2_mvp_cond, mean),
    r2_mvp_cond_med = map_dbl(r2_mvp_cond, median),
    r2_mvp_cond_sd = map_dbl(r2_mvp_cond, sd),
    lab_r2_marg = paste0("~~~~R^2 == ", round(r2_mvp_marg_med, 2)),
    lab_r2_cond = paste0("~~~~R^2 == ", round(r2_mvp_cond_med, 2))
  )
```

```{r}
r2 %>%
  mutate(
    `Marginal (s.d.)` = paste0(round(r2_mvp_marg_med, 2), " (",
      round(r2_mvp_marg_sd, 2),")"),
    `Conditional (s.d.)` = paste0(round(r2_mvp_cond_med, 2), " (",
      round(r2_mvp_cond_sd, 2),")")) %>%
  select(`Response variable` = response, `Marginal (s.d.)`, `Conditional (s.d.)`) %>%
  kbl(booktabs = T,
    label = "tab-r2",
    caption = "Bayesian marginal and conditional R-squared from the models with
    ecological drivers. Details of computations are presented in methods.") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



## Clustering of temporal trends

```{r}
tar_load(c(clust_curv_site, clust_curv_site_fac_50))
tar_load(c(k6_fac_1, sup_clust_size_fac1))
```

```{r}
cap_clust_curv <- "Objective function quantifying the goodness of k-means
clustering according the percentage of removed data (most outliers data in the
  multidimentional space) removed. In the results presented in the main text, we
removed 5% of the data. Top and bottom panels displayed results for restricting
factors of 1 and 50 respectively. Restricted factor of 1 was used for the main
text"
```

```{r, fig.show = "hide"}
library(tclust)
p <- plot_grid(
  plot(clust_curv_site),
  plot(clust_curv_site_fac_50),
  nrow = 2
)
```


```{r, fig.cap=cap_clust_curv}
p
```

```{r}
k4_cap <- "Display of the sites in the multidimentional space, colored by their cluster belonging. Number of clusters = 4"
```


```{r k4, fig.cap = k4_cap}
k4_fac_1_cl <- tclust(
  x = site_no_drivers_inla_tot[, clust_var] %>%
  mutate(across(everything(), ~scale(., center = FALSE)[,1])),
  iter.max = 150,
  k = 4,
  alpha = 0.05,
  restr.fact = 1,
  warnings = 2
)
plot(k4_fac_1_cl)
```

```{r}
bp_cl_dist_cap <- "Distribution of scaled temporal trends by variable and
cluster, for four clusters. With four cluster instead of six in the main text,
the clustering groups temporal trends of species richness and of total
abundance and the cluster characterising low change (Fig. 2, main text) is not
present."
```


```{r bp-k4, fig.cap=bp_cl_dist_cap}
site_k4_fac_1_cl <- get_cluster_df(
     tclust_obj = k4_fac_1_cl,
     site_env = site_env,
     assign_threshold = .5,
     clean_method = "rm"
     )
target_bp_cl_dist(cl_obj = site_k4_fac_1_cl) +
  theme(axis.text.x = element_text(angle = 20, vjust = 0))
```


# Supplementary results
 
## Figure with all the biodiversity facets

```{r, fig.show = "hide"}
tu_full <- rbind(gaussian_inla_std_effects,
  gaussian_inla_exo_std_effects) %>%
  filter(!str_detect(term, "unitabundance|Intercept")) %>%
  mutate(
    term = str_replace_all(term, get_model_term_replacement()),
    response = get_var_replacement()[response]
    )

p1_f <- tu_full %>%
  filter(facet == "main") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect() +
  scale_x_break(c(.21, .5))

p2_f <- tu_full %>%
  filter(facet == "interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect()

p3_f <- tu_full %>%
  filter(facet == "dbl_interaction") %>%
  arrange(desc(width_bar)) %>%
  plot_inla_fixed_effect(.,
    legend_present = TRUE,
    xaxis_title = TRUE
    ) +
  labs(x = "Standardized coefficients")

leg_dis_f <- get_legend(p3_f +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 4))
)

figS1 <- plot_grid(
  print(p1_f),
  print(p2_f),
  p3_f + theme(legend.position = "none"),
  leg_dis_f,
  rel_heights = c(1, 1, 1, .2),
  ncol = 1)
```

```{r}
std_tot_cap <- "**Responses of  community metrics to time, local
  anthropogenic pressures, stream gradient and their interaction**. See Fig. 1
in the main text for details. To the difference with the Fig. 2, we
added Jaccard dissimilarity index and its partitions in two sets of
complementary indices, respectively nestedness/turnover, and
appearance/disappearance."
```


```{r std-tot, fig.height = 12, fig.cap=std_tot_cap}
figS1
```

```{r}
tar_load(c(site_cl_rm, site_cl_na))
pca_data <- site_no_drivers_inla_tot[,
    colnames(site_no_drivers_inla_tot) %in% clust_var]
pca_clust <- compute_rotated_pca(pca_data, naxis = 5)
```

```{r}
p_pca_clust <- plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     replace_var = get_var_replacement(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80
   )

axis_l <- list(
  c("RC1", "RC2"),
  c("RC1", "RC3"),
  c("RC1", "RC4"),
  c("RC1", "RC5"),
  c("RC2", "RC3"),
  c("RC2", "RC4"),
  c("RC2", "RC5"),
  c("RC4", "RC5"),
  c("RC3", "RC5"),
  c("RC3", "RC4")
)

cluster_names <- c(
  "Medium change", "High turnover",
  "Increase in\n species richness", "Decrease in\n total abundance",
  "Decrease in\n species richness", "Low change"
)
fnsite <- nrow(site_cl_na)
nb_clusters <- table_to_vec(table(site_cl_rm$cl))
per_cluster <- scales::percent(nb_clusters / sum(nb_clusters))
na_cluster <- paste0("(N = ",
  fnsite - sum(nb_clusters), ", ", scales::percent((fnsite - sum(nb_clusters)) / fnsite),")"
)

cluster_labels <- map2_chr(cluster_names, paste0(nb_clusters, ", ", per_cluster),
  ~paste0(.x, "\n(N = ", .y, ")"))

p_pca_cl_ell <- map(axis_l,
  ~plot_pca_clust(
     .data = pca_clust$rotated,
     site_cl = site_cl_rm,
     add_point = TRUE,
     add_ellipse = TRUE,
     xaxis = .x[1], yaxis = .x[2],
     ctb_thld = .4,
     replace_var = get_var_replacement_vulgarisation(),
     size_arrows_segment = 1,
     label_size = 2.5,
     alpha_point = .2,
     lim_x_y = c(-3.5, 3.5),
     force_pull = 1,
     force = 80,
     var_scaling_factor = 3.5
   ) +
 guides(
   colour = guide_legend(
     override.aes = list(size = 10),
     title.theme = element_blank(),
     label.position = "top",
     ncol = 2)
 ) +
 theme(
   legend.position = "bottom",
   panel.background = element_blank(),
   legend.text = element_text(size = 10),
   legend.key = element_rect(fill = NA)) +
 scale_color_viridis(
   discrete = TRUE,
   name = "Cluster", labels = cluster_labels)
)
leg_cl <- get_legend(
  p_pca_cl_ell[[1]]
)

p_pca_cl_ell <- map(p_pca_cl_ell,
  ~.x + theme(legend.position = "none"))
```

```{r}
pca_total_cap <- "**PCA biplot on the temporal trends of the
  community metrics at each site, and their cluster assignment**. See legend of
the Fig. 2 in main text for details. To the difference with the Fig. 2, we
added Jaccard dissimilarity index and its partitions in two sets of
complementary indices, respectively nestedness/turnover, and
appearance/disappearance." %>%
  str_remove_all("\n|\r") %>%
  str_replace_all("  ", " ")
```

```{r pca-tot, fig.cap = pca_total_cap}
p_pca_cl_top <- plot_grid(
  p_pca_cl_ell[[1]],
  p_pca_cl_ell[[5]],
  p_pca_cl_ell[[8]],
  leg_cl,
  ncol = 2)
```



## Predictions of the model

```{r}
tar_load(c(pred_gaussian_inla, pred_gaussian_inla_exo, pred_data_explanation))

pred_gaussian_inla_tot <- rbind(
  pred_gaussian_inla %>%
    filter(response %in% clust_var),
  pred_gaussian_inla_exo
  )
```

```{r, fig.asp = .7}
for (i in seq_len(nrow(pred_gaussian_inla_tot))) {
  plot_grid(plotlist = pred_gaussian_inla_tot$pred_plot[[i]], ncol = 2)
}
```




```{r}
names(pred_data_explanation)
selected_pred <- list(
  "log1_year_nb" = c("0", "10"),
  "riv_str_rc1" = c("median"),
  "hft_ix_c93" = c("intact", "max"),
  "hft_ix_c9309_log2_ratio" = c("div/2", "inc/2")
)
val_pred_selected <- map2(
  pred_data_explanation, names(pred_data_explanation),
  ~(.x[selected_pred[[.y]]])
)

tab_pred <- enframe(val_pred_selected) %>%
  unnest(value) %>%
  mutate(
    signif = unlist(map(names(pred_data_explanation), ~selected_pred[[.x]])),
    Signification = get_pred_signification()[signif],
    driver_name =  get_model_term_replacement_paper_figure()[name],
    name = str_replace(get_model_term_replacement()[name], "\n", " "),
    value = round(value, 1)
  ) %>%
  select(
    Driver = driver_name,
    `Predictor variable` = name,
    Value = value, Signification
  )
```

```{r}
tab_pred_cap <- "Values and signification of predictor variables used in the
main text."
tab_pred %>%
  kbl(booktabs = T,
    label = "tab-pred",
    caption = tab_pred_cap) %>%
  column_spec(4, width = "5cm") %>%
  collapse_rows(columns = c(1, 2), latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
for (i in seq_along(pred_gaussian_inla_tot$response)) {
  p_list <- map(pred_gaussian_inla_tot$pred_plot[[i]],
    ~ .x + theme(legend.position = "bottom")
  )
  plot_grid(
    plotlist = p_list,
    ncol = 3)
}
```

## Random effect

```{r}
tar_load(gaussian_inla_rand)

tab_rand <- gaussian_inla_rand %>%
  filter(
    ci_level == "level:0.95",
    response %in% c(clust_var, exo_resp_var)
    ) %>%
  select(-ci_level) %>%
  mutate(across(c(mean, low, high), ~round(., 3))) %>%
  mutate(
    response = get_var_replacement()[response],
    term = str_remove(term, "Precision for the |Precision for |"),
    term = replacement_random_term()[term],
    ci = paste0(mean, " [", high,",", low,"]")
  ) %>%
  arrange(response, desc(term)) %>%
  select(`Response variable` = response, Term = term, `Mean [95% CI]` = ci)
```

```{r}
tab_rand_cap <- "Standard deviation estimated by the models for the random
effects and the error term."
tab_rand %>%
  kbl(booktabs = T,
    label = "tab-rand",
    caption = tab_rand_cap) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


